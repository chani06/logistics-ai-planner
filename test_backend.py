"""
‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
"""
import pandas as pd
import sys
import os

# ‡∏õ‡∏¥‡∏î streamlit warnings
os.environ['STREAMLIT_SERVER_HEADLESS'] = 'true'

print("=" * 60)
print("üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - Adjacent Districts")
print("=" * 60)

# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô
print("\nüìÇ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏•‡∏î adjacent_districts.json...")

from app import load_adjacent_districts, are_adjacent_districts, ADJACENT_DISTRICTS

print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ {len(ADJACENT_DISTRICTS)} ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠")

# ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
print("\nüìã ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å):")
for i, ((dist, prov), adjacents) in enumerate(ADJACENT_DISTRICTS.items()):
    if i >= 5:
        break
    adj_str = ", ".join([f"{d}({p})" for d, p in adjacents[:3]])
    if len(adjacents) > 3:
        adj_str += f" +{len(adjacents)-3} more"
    print(f"  ‚Ä¢ {dist} ({prov}) ‚Üí {adj_str}")

# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô are_adjacent_districts
print("\n" + "=" * 60)
print("üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö are_adjacent_districts()")
print("=" * 60)

test_cases = [
    # ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô True
    ("‡∏™‡∏µ‡∏Ñ‡∏¥‡πâ‡∏ß", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏°‡∏ß‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", True),
    ("‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏°‡∏ß‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", True),
    ("‡∏õ‡∏£‡∏∞‡πÇ‡∏Ñ‡∏ô‡∏ä‡∏±‡∏¢", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", True),
    ("‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏ô", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡πÑ‡∏ä‡∏¢‡∏≤", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", True),
    ("‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ö‡πâ‡∏≤‡∏ô‡∏â‡∏≤‡∏á", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", True),
    
    # ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô - ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô True
    ("‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", True),
    
    # ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô - ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô False
    ("‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û", "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏µ‡∏Ñ‡∏¥‡πâ‡∏ß", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", False),
    ("‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", False),
]

passed = 0
failed = 0

for d1, p1, d2, p2, expected in test_cases:
    result = are_adjacent_districts(d1, p1, d2, p2)
    status = "‚úÖ" if result == expected else "‚ùå"
    if result == expected:
        passed += 1
    else:
        failed += 1
    print(f"{status} {d1}({p1}) ‚Üî {d2}({p2}): {result} (expected: {expected})")

print(f"\nüìä ‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö: {passed}/{len(test_cases)} passed, {failed} failed")

# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå)
print("\n" + "=" * 60)
print("üöõ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ")
print("=" * 60)

try:
    from app import process_dataframe, VEHICLE_LIMITS
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    test_data = pd.DataFrame({
        'Code': ['A001', 'A002', 'A003', 'A004', 'A005'],
        'Name': ['‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏µ‡∏Ñ‡∏¥‡πâ‡∏ß', '‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏ß‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á', '‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏Å‡πà‡∏á‡∏Ñ‡∏≠‡∏¢', '‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û'],
        'Weight': [500, 400, 300, 200, 600],
        'Cube': [1.0, 0.8, 0.6, 0.4, 1.2],
        'Lat': [14.8833, 14.6500, 14.7167, 14.5833, 13.7563],
        'Lon': [101.8333, 101.1833, 101.3833, 101.0667, 100.5018],
        'Province': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'District': ['‡∏™‡∏µ‡∏Ñ‡∏¥‡πâ‡∏ß', '‡∏°‡∏ß‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á', '‡πÅ‡∏Å‡πà‡∏á‡∏Ñ‡∏≠‡∏¢', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û'],
        'SubDistrict': ['‡∏™‡∏µ‡∏Ñ‡∏¥‡πâ‡∏ß', '‡∏°‡∏ß‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á', '‡πÅ‡∏Å‡πà‡∏á‡∏Ñ‡∏≠‡∏¢', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û'],
    })
    
    print(f"üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö: {len(test_data)} ‡∏™‡∏≤‡∏Ç‡∏≤")
    print(test_data[['Code', 'Name', 'District', 'Province', 'Weight', 'Cube']].to_string(index=False))
    
    # ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ
    result_df = process_dataframe(test_data, vehicle_type='4W')
    
    print(f"\n‚úÖ ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à!")
    
    if 'MasterTrip' in result_df.columns:
        trips = result_df.groupby('MasterTrip').agg({
            'Code': list,
            'Province': lambda x: list(set(x)),
            'Weight': 'sum',
            'Cube': 'sum'
        })
        
        print(f"\nüì¶ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: {len(trips)} ‡∏ó‡∏£‡∏¥‡∏õ")
        for trip_id, row in trips.iterrows():
            print(f"  Trip {trip_id}: {row['Code']} - {row['Province']} | W:{row['Weight']:.0f} C:{row['Cube']:.2f}")
    else:
        print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå MasterTrip")

except Exception as e:
    print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ: {e}")

print("\n" + "=" * 60)
print("‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")
print("=" * 60)
