"""
ЁЯУЛ р╕кр╕гр╕╕р╕Ы Logic р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕кр╕▓р╕Вр╕▓р╣Ар╕гр╕╡р╕вр╕Зр╕Чр╕гр╕┤р╕Ы - app.py
============================================

ЁЯОп ALGORITHM OVERVIEW:
======================
Route-First + Province-Sorted Trip Assignment

ЁЯУМ р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕лр╕ер╕▒р╕Б:
===============

## Phase -1: р╕Ир╕▒р╕Фр╕Бр╕ер╕╕р╣Ир╕бр╕Хр╕▓р╕б Route (Reference)
- р╕кр╕▓р╕Вр╕▓р╕Чр╕╡р╣Ир╕бр╕╡ Route р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ (р╣Ар╕Кр╣Ир╕Щ MG01, MG02) р╕Хр╣Йр╕нр╕Зр╕нр╕вр╕╣р╣Ир╕Чр╕гр╕┤р╕Ыр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
- р╕Ир╕▒р╕Фр╕Бр╕ер╕╕р╣Ир╕бр╕Бр╣Ир╕нр╕Щр╣Бр╕ер╣Йр╕зр╕Др╣Ир╕нр╕в process

## Phase 0: р╕Ир╕▒р╕Ър╕Др╕╣р╣И Base Code р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
- M862, P862, S862, ZS862 тЖТ р╕Хр╣Йр╕нр╕Зр╕нр╕вр╕╣р╣Ир╕Фр╣Йр╕зр╕вр╕Бр╕▒р╕Щ
- р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕кр╕▓р╕Вр╕▓р╕Юр╕╡р╣Ир╕Щр╣Йр╕нр╕Зр╕Цр╕╣р╕Бр╣Бр╕вр╕Б

## Phase 1: р╕Ир╕▒р╕Ър╕Др╕╣р╣Ир╕кр╕▓р╕Вр╕▓р╕Кр╕╖р╣Ир╕нр╕Др╕ер╣Йр╕▓р╕в
- р╕Др╕ер╕нр╕Зр╕лр╕ер╕зр╕З 3, 4, 8, 10 тЖТ р╕нр╕вр╕╣р╣Ир╕Бр╕ер╕╕р╣Ир╕бр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ

## Main Algorithm (Step 1-4):

### Step 1: р╕Ир╕▒р╕Фр╕Бр╕ер╕╕р╣Ир╕бр╕Хр╕▓р╕б Route
- route_groups: р╕кр╕▓р╕Вр╕▓р╕Чр╕╡р╣Ир╕бр╕╡ Route
- codes_without_route: р╕кр╕▓р╕Вр╕▓р╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕бр╕╡ Route

### Step 2: р╣Ар╕гр╕╡р╕вр╕Зр╕ер╕│р╕Фр╕▒р╕Ър╕кр╕▓р╕Вр╕▓
Sort key: р╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Ф тЖТ р╕нр╕│р╣Ар╕ар╕н тЖТ р╕Хр╕│р╕Ър╕е тЖТ р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕гр╕Ц тЖТ р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З

### Step 3: р╕гр╕зр╕бр╣Ар╕Ыр╣Зр╕Щ list р╣Ар╕Фр╕╡р╕вр╕з
Route groups р╕Бр╣Ир╕нр╕Щ, р╣Бр╕ер╣Йр╕зр╕кр╕▓р╕Вр╕▓р╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕бр╕╡ Route

### Step 4: р╕кр╕гр╣Йр╕▓р╕Зр╕Чр╕гр╕┤р╕Ы (Main Loop)
1. Pop р╕кр╕▓р╕Вр╕▓р╣Бр╕гр╕Б (seed)
2. р╕лр╕▓ Route р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ тЖТ р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Вр╣Йр╕▓р╕Чр╕гр╕┤р╕Ы
3. р╕лр╕▓р╕кр╕▓р╕Вр╕▓р╕Цр╕▒р╕Фр╣Др╕Ы (priority: р╕Хр╕│р╕Ър╕е > р╕нр╕│р╣Ар╕ар╕н > р╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Ф > р╕нр╕│р╣Ар╕ар╕нр╕Хр╕┤р╕Фр╕Бр╕▒р╕Щ)
4. р╣Ар╕Юр╕┤р╣Ир╕бр╕Ир╕Щр╣Ар╕Хр╣Зр╕б capacity тЖТ р╕Хр╕▒р╕Фр╕Чр╕гр╕┤р╕Ыр╣Гр╕лр╕бр╣И

ЁЯУЛ PHASES р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф:
==================

| Phase | р╕Кр╕╖р╣Ир╕н | р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣И |
|-------|------|---------|
| -1 | Route Grouping | р╕гр╕зр╕бр╕кр╕▓р╕Вр╕▓ Route р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ |
| 0 | Base Code | р╕гр╕зр╕бр╕кр╕▓р╕Вр╕▓р╕Юр╕╡р╣Ир╕Щр╣Йр╕нр╕З (M/P/S/ZS) |
| 1 | Similar Name | р╕гр╕зр╕бр╕кр╕▓р╕Вр╕▓р╕Кр╕╖р╣Ир╕нр╕Др╕ер╣Йр╕▓р╕в |
| Main | Trip Assignment | р╕кр╕гр╣Йр╕▓р╕Зр╕Чр╕гр╕┤р╕Ыр╕Хр╕▓р╕б algorithm |
| 1 | Merge Small Trips | р╕гр╕зр╕бр╕Чр╕гр╕┤р╕Ыр╣Ар╕ер╣Зр╕Б (тЙд3 р╕кр╕▓р╕Вр╕▓) |
| 1.75 | Vehicle Constraint | р╣Бр╕вр╕Бр╕кр╕▓р╕Вр╕▓ 4W/JB р╕нр╕нр╕Б |
| 1.77 | Zone Separation | р╣Бр╕вр╕Бр╕кр╕▓р╕Вр╕▓р╕Др╕Щр╕ер╕░ Zone |
| 2 | Vehicle Selection | р╣Ар╕ер╕╖р╕нр╕Бр╕гр╕Цр╕Чр╕╡р╣Ир╣Ар╕лр╕бр╕▓р╕░р╕кр╕б |
| 2.1 | Fix Oversized | р╣Бр╕Бр╣Йр╕гр╕Цр╣Гр╕лр╕Нр╣Ир╣Ар╕Бр╕┤р╕Щр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Ф |
| 6 | Capacity Balance | р╕Бр╕гр╕░р╕Ир╕▓р╕в load р╣Гр╕лр╣Йр╕кр╕бр╕Фр╕╕р╕е |
| 7 | Final Validation | р╣Бр╕вр╕Б/р╕гр╕зр╕бр╕Чр╕гр╕┤р╕Ыр╕Чр╕╡р╣Ир╕Ьр╕┤р╕Фр╕Ыр╕Бр╕Хр╕┤ |
| 8 | Same-Code Merge | р╕гр╕зр╕бр╕кр╕▓р╕Вр╕▓ Code р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ |
| 8.5 | Re-split | р╣Бр╕вр╕Бр╕Чр╕гр╕┤р╕Ыр╕Чр╕╡р╣Ир╣Ар╕Бр╕┤р╕Щ capacity |

ЁЯУМ р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Бр╕▓р╕гр╕гр╕зр╕бр╕кр╕▓р╕Вр╕▓ (can_add_to_trip):
========================================

1. тЬЕ р╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Фр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
2. тЬЕ Route р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
3. тЬЕ р╕нр╕│р╣Ар╕ар╕нр╕Хр╕┤р╕Фр╕Бр╕▒р╕Щ (adjacent_districts.json)
4. тЬЕ р╣Ар╕кр╣Йр╕Щр╕Чр╕▓р╕Зр╕Цр╕Щр╕Щр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ (HIGHWAY_CORRIDORS)
5. тЭМ р╕Хр╣Ир╕▓р╕Зр╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Фр╣Бр╕ер╕░р╣Др╕бр╣Ир╕бр╕╡р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Вр╣Йр╕▓р╕Зр╕Ър╕Щ тЖТ р╣Др╕бр╣Ир╕гр╕зр╕б

ЁЯУМ р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕гр╕Ц:
=============
- р╕Чр╕гр╕┤р╕Ы 4W: р╕кр╕▓р╕Вр╕▓р╣Гр╕лр╕бр╣Ир╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щ 4W р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ
- р╕Чр╕гр╕┤р╕Ы JB: р╕кр╕▓р╕Вр╕▓р╣Гр╕лр╕бр╣Ир╣Ар╕Ыр╣Зр╕Щ JB р╕лр╕гр╕╖р╕н 6W р╣Др╕Фр╣Й
- р╕Чр╕гр╕┤р╕Ы 6W: р╕кр╕▓р╕Вр╕▓р╣Гр╕лр╕бр╣Ир╣Ар╕Ыр╣Зр╕Щр╕нр╕░р╣Др╕гр╕Бр╣Зр╣Др╕Фр╣Й

ЁЯУМ р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕В Nearby (р╕Бр╕Чр╕б/р╕Ыр╕гр╕┤р╕бр╕Ур╕Ср╕е):
================================
- р╕лр╣Йр╕▓р╕б 6W р╣Гр╕Щ nearby р╣Ар╕Фр╣Зр╕Фр╕Вр╕▓р╕Ф
- р╕Цр╣Йр╕▓р╕бр╕╡р╕кр╕▓р╕Вр╕▓р╣Гр╕Фр╕нр╕вр╕╣р╣И nearby р╣Бр╕бр╣Йр╕кр╕▓р╕Вр╕▓р╣Ар╕Фр╕╡р╕вр╕з тЖТ р╣Гр╕Кр╣Й JB р╕кр╕╣р╕Зр╕кр╕╕р╕Ф

ЁЯУМ Capacity Buffer:
==================
- Punthai р╕ер╣Йр╕зр╕Щ: session_state.punthai_buffer (default 100%)
- Maxmart: session_state.maxmart_buffer (default 110%)
- р╕нр╕╖р╣Ир╕Щр╣Ж: р╣Ар╕Йр╕ер╕╡р╣Ир╕в 2 р╕Др╣Ир╕▓

ЁЯУМ Highway Corridors (р╕гр╕зр╕бр╕Вр╣Йр╕▓р╕бр╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Фр╣Др╕Фр╣Й):
========================================
- р╕бр╕┤р╕Хр╕гр╕ар╕▓р╕Ю: р╕кр╕гр╕░р╕Ър╕╕р╕гр╕╡ тЖТ р╕Щр╕Др╕гр╕гр╕▓р╕Кр╕кр╕╡р╕бр╕▓ тЖТ р╕Вр╕нр╕Щр╣Бр╕Бр╣Ир╕Щ тЖТ р╕нр╕╕р╕Фр╕г
- р╕нр╕╡р╕кр╕▓р╕Щр╕Хр╕нр╕Щр╕Ър╕Щ: р╕нр╕╕р╕Фр╕г тЖТ р╕кр╕Бр╕е тЖТ р╕Щр╕Др╕гр╕Юр╕Щр╕б
- р╕нр╕╡р╕кр╕▓р╕Щр╕Хр╕нр╕Щр╕ер╣Ир╕▓р╕З: р╣Вр╕Др╕гр╕▓р╕К тЖТ р╕Ър╕╕р╕гр╕╡р╕гр╕▒р╕бр╕вр╣М тЖТ р╕нр╕╕р╕Ър╕е
- р╣Ар╕лр╕Щр╕╖р╕нр╕Хр╕нр╕Щр╕ер╣Ир╕▓р╕З: р╕Щр╕Др╕гр╕кр╕зр╕гр╕гр╕Др╣М тЖТ р╕Юр╕┤р╕йр╕Ур╕╕р╣Вр╕ер╕Б тЖТ р╕нр╕╕р╕Хр╕гр╕Фр╕┤р╕Хр╕Цр╣М
- р╣Ар╕лр╕Щр╕╖р╕нр╕Хр╕нр╕Щр╕Ър╕Щ: р╕ер╕│р╕Ыр╕▓р╕З тЖТ р╣Ар╕Кр╕╡р╕вр╕Зр╣Гр╕лр╕бр╣И тЖТ р╣Ар╕Кр╕╡р╕вр╕Зр╕гр╕▓р╕в
- р╣Гр╕Хр╣Йр╕Хр╕░р╕зр╕▒р╕Щр╕нр╕нр╕Б: р╕Кр╕╕р╕бр╕Юр╕г тЖТ р╕кр╕╕р╕гр╕▓р╕йр╕Ор╕гр╣М тЖТ р╕Щр╕Др╕гр╕ир╕гр╕╡ тЖТ р╕кр╕Зр╕Вр╕ер╕▓
- р╣Гр╕Хр╣Йр╕Хр╕░р╕зр╕▒р╕Щр╕Хр╕Б: р╕гр╕░р╕Щр╕нр╕З тЖТ р╕Бр╕гр╕░р╕Ър╕╡р╣И тЖТ р╕ар╕╣р╣Ар╕Бр╣Зр╕Х
- р╕Хр╕░р╕зр╕▒р╕Щр╕нр╕нр╕Б: р╕Кр╕ер╕Ър╕╕р╕гр╕╡ тЖТ р╕гр╕░р╕вр╕нр╕З тЖТ р╕Ир╕▒р╕Щр╕Чр╕Ър╕╕р╕гр╕╡
- р╕Бр╕ер╕▓р╕З: р╕нр╕вр╕╕р╕Шр╕вр╕▓ тЖТ р╕ер╕Юр╕Ър╕╕р╕гр╕╡ тЖТ р╕кр╕гр╕░р╕Ър╕╕р╕гр╕╡

ЁЯУМ Early Stopping (Performance):
================================
- Trip Assignment: 15 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡
- Phase 2: 40 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡
- Balance: 35 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡
- Phase 8: 45 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡
- р╣Ар╕Ыр╣Йр╕▓р╕лр╕бр╕▓р╕в: < 1 р╕Щр╕▓р╕Чр╕╡

"""
print(__doc__)
