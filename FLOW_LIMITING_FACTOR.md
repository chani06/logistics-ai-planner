# 🔄 Flow: หลักการเลือกเกณฑ์การตัดทริป (Weight vs Cube)

## 📊 ภาพรวม
ระบบจะวิเคราะห์ข้อมูลทั้งหมดก่อนเริ่มจัดทริป เพื่อหาว่า **น้ำหนัก** หรือ **คิว** เป็นข้อจำกัดหลัก แล้วใช้เกณฑ์เดียวกันสำหรับทุกทริป

---

## 🔀 Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│  START: โหลดข้อมูลสาขาทั้งหมด (test_df)                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 5.5: วิเคราะห์ Global Limiting Factor                 │
│  ฟังก์ชัน: determine_global_limiting_factor(df)             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  วนลูปทุกสาขาใน DataFrame:                                   │
│    ┌─────────────────────────────────────────────┐          │
│    │  1. ดึงข้อมูล: Weight, Cube, max_vehicle       │          │
│    │  2. หาขีดจำกัดรถ: LIMITS[max_vehicle]       │          │
│    │  3. คำนวณ ratio:                             │          │
│    │     - weight_ratio = (weight/max_w) × 100   │          │
│    │     - cube_ratio = (cube/max_c) × 100       │          │
│    │  4. เก็บค่าเข้า list: weight_ratios[]       │          │
│    │                        cube_ratios[]         │          │
│    └─────────────────────────────────────────────┘          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  คำนวณค่าเฉลี่ย:                                            │
│    avg_weight_ratio = sum(weight_ratios) / len(...)         │
│    avg_cube_ratio = sum(cube_ratios) / len(...)             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
                    ┌────┴────┐
                    │ Compare │
                    └────┬────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
┌────────────────────┐         ┌────────────────────┐
│ avg_weight_ratio   │         │ avg_cube_ratio     │
│       ≥            │         │       >            │
│ avg_cube_ratio     │         │ avg_weight_ratio   │
└─────────┬──────────┘         └─────────┬──────────┘
          │                              │
          ▼                              ▼
┌────────────────────┐         ┌────────────────────┐
│ GLOBAL_LIMITING_   │         │ GLOBAL_LIMITING_   │
│ FACTOR = 'weight'  │         │ FACTOR = 'cube'    │
└─────────┬──────────┘         └─────────┬──────────┘
          │                              │
          └──────────────┬───────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  แสดงผล:                                                     │
│  📊 Global Limiting Factor: WEIGHT (avg 75.2% vs 45.3%)     │
│  หรือ                                                        │
│  📊 Global Limiting Factor: CUBE (avg 68.9% vs 52.1%)       │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 6: เริ่มจัดทริป (trip_counter = 1)                    │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  วนลูปจัดสาขาเข้าทริป:                                │
│    ┌─────────────────────────────────────────────┐          │
│    │ เรียกใช้: select_vehicle_for_load(          │          │
│    │   weight, cube, drops,                      │          │
│    │   is_punthai, allowed_vehicles,             │          │
│    │   GLOBAL_LIMITING_FACTOR  ← ส่งค่าเข้าไป    │          │
│    │ )                                            │          │
│    └─────────────────┬───────────────────────────┘          │
│                      ▼                                       │
│    ┌─────────────────────────────────────────────┐          │
│    │ ฟังก์ชัน select_vehicle_for_load:              │          │
│    │   - เช็ครถแต่ละประเภท (4W → JB → 6W)           │          │
│    │   - ตรวจสอบไม่เกินขีดจำกัด (w, c, d)            │          │
│    │   - return (vehicle, GLOBAL_LIMITING_FACTOR) │          │
│    │     ↑ คืนค่าเดิมที่ส่งเข้ามา ไม่คำนวณใหม่ │          │
│    └─────────────────────────────────────────────┘          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  ตรวจสอบมาตรฐาน: meets_minimum_standard(                    │
│    weight, cube, drops, allowed_vehicles,                   │
│    limiting_factor=GLOBAL_LIMITING_FACTOR                   │
│  )                                                           │
└────────────────────────┬────────────────────────────────────┘
                         │
                    ┌────┴────┐
                    │ Check   │
                    └────┬────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
┌────────────────────┐         ┌────────────────────┐
│ limiting_factor    │         │ limiting_factor    │
│    == 'weight'     │         │    == 'cube'       │
└─────────┬──────────┘         └─────────┬──────────┘
          │                              │
          ▼                              ▼
┌────────────────────┐         ┌────────────────────┐
│ เช็ค weight ≥ 70%  │         │ เช็ค cube ≥ 70%    │
│ ของขีดจำกัดรถ      │         │ ของขีดจำกัดรถ      │
└─────────┬──────────┘         └─────────┬──────────┘
          │                              │
          └──────────────┬───────────────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
    ผ่านเกณฑ์                       ไม่ผ่าน
         │                               │
         ▼                               ▼
  ปิดทริป เริ่มทริปใหม่                เพิ่มสาขาต่อ
                         
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  ทุกทริปใช้เกณฑ์เดียวกัน:                                   │
│    - ถ้า GLOBAL_LIMITING_FACTOR = 'weight'                  │
│      → ทุกทริปตัดเมื่อน้ำหนัก ≥ 70% ของขีดจำกัด             │
│    - ถ้า GLOBAL_LIMITING_FACTOR = 'cube'                    │
│      → ทุกทริปตัดเมื่อคิว ≥ 70% ของขีดจำกัด                 │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
                    ┌─────────┐
                    │   END   │
                    └─────────┘
```

---

## 🎯 หลักการสำคัญ

### 1️⃣ **ตัดสินใจครั้งเดียว ใช้ทั้งระบบ**
- วิเคราะห์ข้อมูลทั้งหมดครั้งเดียวในตอนเริ่มต้น
- กำหนด `GLOBAL_LIMITING_FACTOR` เพียงค่าเดียว
- ทุกทริปใช้เกณฑ์เดียวกัน (ไม่แยกตัดสินใจเอง)

### 2️⃣ **เลือกเกณฑ์จากข้อมูลจริง**
- คำนวณ % utilization ของทุกสาขา
- เปรียบเทียบค่าเฉลี่ยระหว่าง weight vs cube
- เลือกตัวที่มีค่าเฉลี่ยสูงกว่า = ข้อจำกัดหลักของข้อมูลชุดนี้

### 3️⃣ **มาตรฐานสม่ำเสมอ**
- ทุกทริปตรวจสอบมาตรฐาน 70% ในมิติเดียวกัน
- ไม่มีการที่ทริป 1 ดู weight, ทริป 2 ดู cube
- ความสม่ำเสมอในการจัดทริปทั้งวัน/ทั้งรอบ

---

## 📋 ตัวอย่างการทำงาน

### กรณีที่ 1: น้ำหนักเป็นตัวจำกัด
```
สาขา A: น้ำหนัก 2000kg (80%), คิว 2.5m³ (40%)
สาขา B: น้ำหนัก 1750kg (70%), คิว 2.0m³ (35%)
สาขา C: น้ำหนัก 1875kg (75%), คิว 2.8m³ (50%)

คำนวณ:
- avg_weight_ratio = (80 + 70 + 75) / 3 = 75.0%
- avg_cube_ratio = (40 + 35 + 50) / 3 = 41.7%

ผลลัพธ์:
📊 Global Limiting Factor: WEIGHT (avg 75.0% vs cube 41.7%)

การจัดทริป:
→ ทุกทริปต้องมีน้ำหนัก ≥ 70% ของขีดจำกัดรถถึงจะปิดทริป
→ คิวไม่ถูกใช้เป็นเกณฑ์ตัดทริป (แต่ยังเช็คไม่เกินขีดจำกัด)
```

### กรณีที่ 2: คิวเป็นตัวจำกัด
```
สาขา D: น้ำหนัก 1000kg (40%), คิว 5.5m³ (85%)
สาขา E: น้ำหนัก 875kg (35%), คิว 6.0m³ (90%)
สาขา F: น้ำหนัก 1125kg (45%), คิว 5.2m³ (80%)

คำนวณ:
- avg_weight_ratio = (40 + 35 + 45) / 3 = 40.0%
- avg_cube_ratio = (85 + 90 + 80) / 3 = 85.0%

ผลลัพธ์:
📊 Global Limiting Factor: CUBE (avg 85.0% vs weight 40.0%)

การจัดทริป:
→ ทุกทริปต้องมีคิว ≥ 70% ของขีดจำกัดรถถึงจะปิดทริป
→ น้ำหนักไม่ถูกใช้เป็นเกณฑ์ตัดทริป (แต่ยังเช็คไม่เกินขีดจำกัด)
```

---

## ⚙️ ฟังก์ชันที่เกี่ยวข้อง

### 1. `determine_global_limiting_factor(df)`
**Input:** DataFrame ของสาขาทั้งหมด  
**Output:** `'weight'` หรือ `'cube'`  
**หน้าที่:** วิเคราะห์ข้อมูลทั้งหมด หาว่าตัวไหนเป็นข้อจำกัดหลัก

### 2. `select_vehicle_for_load(..., global_limiting_factor)`
**Input:** พารามิเตอร์ของโหลด + GLOBAL_LIMITING_FACTOR  
**Output:** `(vehicle, limiting_factor)`  
**หน้าที่:** เลือกรถที่เหมาะสม คืนค่า limiting_factor เดิมที่ส่งเข้ามา

### 3. `meets_minimum_standard(..., limiting_factor)`
**Input:** พารามิเตอร์ของทริป + limiting_factor  
**Output:** `True/False`  
**หน้าที่:** เช็คว่าทริปผ่านมาตรฐาน 70% ในมิติที่กำหนด

---

## ✅ ข้อดีของแนวทางนี้

1. **สม่ำเสมอ**: ทุกทริปใช้เกณฑ์เดียวกัน ไม่สับสน
2. **ยืดหยุ่น**: ปรับตามลักษณะข้อมูลจริงแต่ละวัน
3. **โปร่งใส**: แสดงผลชัดเจนว่าเลือกเกณฑ์ไหน ทำไม
4. **มาตรฐาน**: ทริปทั้งหมดมีคุณภาพใกล้เคียงกัน
5. **ประสิทธิภาพ**: ลดการตัดสินใจซ้ำซ้อนในแต่ละทริป

---

## 🔧 การปรับแต่งในอนาคต

หากต้องการปรับเกณฑ์:

1. **เปลี่ยน Threshold มาตรฐาน**: แก้ที่ `meets_minimum_standard()` จาก 70% เป็นค่าอื่น
2. **เปลี่ยนวิธีคำนวณ**: แก้ `determine_global_limiting_factor()` เช่น ใช้ median แทน average
3. **เพิ่มเงื่อนไขพิเศษ**: เช่น กำหนดตายตัวว่าจังหวัดไหนใช้เกณฑ์ไหน

---

**สร้างเมื่อ:** 24 ธันวาคม 2568  
**เวอร์ชัน:** 1.0
