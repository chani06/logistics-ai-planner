import pandas as pd

"""
Logistics Planner 
"""

import streamlit as st
import pandas as pd
import numpy as np
import pickle
import os
import glob
from datetime import datetime, time as datetime_time, timedelta
import io
from math import radians, sin, cos, sqrt, atan2
import json

# Google Sheets Integration
try:
    import gspread
    from oauth2client.service_account import ServiceAccountCredentials
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå credentials.json ‡∏´‡∏£‡∏∑‡∏≠ Streamlit secrets
    credentials_file = 'credentials.json'
    scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
    
    creds = None
    
    # 1Ô∏è‚É£ ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ Streamlit Secrets ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Streamlit Cloud)
    try:
        if hasattr(st, 'secrets') and 'gcp_service_account' in st.secrets:
            creds = ServiceAccountCredentials.from_json_keyfile_dict(
                dict(st.secrets['gcp_service_account']), 
                scope
            )
            print("‚úÖ ‡πÉ‡∏ä‡πâ credentials ‡∏à‡∏≤‡∏Å Streamlit Secrets")
    except Exception as e:
        print(f"‚ö†Ô∏è Streamlit Secrets ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: {e}")
    
    # 2Ô∏è‚É£ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ secrets ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå local
    if creds is None:
        if os.path.exists(credentials_file):
            try:
                creds = ServiceAccountCredentials.from_json_keyfile_name(credentials_file, scope)
                print(f"‚úÖ ‡πÉ‡∏ä‡πâ credentials ‡∏à‡∏≤‡∏Å {credentials_file}")
            except Exception as e:
                print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå {credentials_file}: {e}")
        else:
            print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö {credentials_file} ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ Streamlit Secrets")
            print(f"üí° ‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà: CREDENTIALS_SETUP.md")
    
    # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
    if creds:
        try:
            gc = gspread.authorize(creds)
            SPREADSHEET_ID = '12DmIfECwVpsWfl8rl2r1A_LB4_5XMrmnmwlPUHKNU-o'
            sh = gc.open_by_key(SPREADSHEET_ID)
            SHEETS_AVAILABLE = True
            print("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        except Exception as e:
            print(f"‚ö†Ô∏è Google Sheets Error: {e}")
            print(f"üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö credentials ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏π‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà CREDENTIALS_SETUP.md")
            SHEETS_AVAILABLE = False
            gc = None
            sh = None
    else:
        SHEETS_AVAILABLE = False
        gc = None
        sh = None
        
except ImportError:
    print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö gspread library - ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢: pip install gspread oauth2client")
    SHEETS_AVAILABLE = False
    gc = None
    sh = None

# Auto-refresh component
try:
    from streamlit_autorefresh import st_autorefresh
    AUTOREFRESH_AVAILABLE = True
except ImportError:
    AUTOREFRESH_AVAILABLE = False
    # ‡πÅ‡∏™‡∏î‡∏á warning ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô local dev (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô deployment)
    if os.environ.get('ENVIRONMENT') != 'production':
        pass  # ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á warning - ‡πÉ‡∏ä‡πâ manual refresh ‡πÅ‡∏ó‡∏ô

# ==========================================
# GOOGLE SHEETS SYNC FUNCTION
# ==========================================
def sync_branch_data_from_sheets():
    """
    ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡∏∞ sync ‡∏Å‡∏±‡∏ö JSON file
    ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (Code/Plan Code) ‡πÄ‡∏õ‡πá‡∏ô key ‡∏´‡∏•‡∏±‡∏Å
    
    Returns:
        DataFrame ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
    """
    global SHEETS_AVAILABLE, sh
    
    json_file = 'branch_data.json'
    
    # ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å JSON
    existing_data = {}
    if os.path.exists(json_file):
        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                existing_data = json.load(f)
        except Exception as e:
            print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô JSON: {e}")
    
    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Google Sheets ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
    if not SHEETS_AVAILABLE or sh is None:
        if existing_data:
            print(f"‚ö†Ô∏è Google Sheets ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å JSON ({len(existing_data)} ‡∏™‡∏≤‡∏Ç‡∏≤)")
            df = pd.DataFrame.from_dict(existing_data, orient='index')
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Plan Code ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if 'Plan Code' not in df.columns:
                df.reset_index(inplace=True)
                df.rename(columns={'index': 'Plan Code'}, inplace=True)
            else:
                df.reset_index(drop=True, inplace=True)
            return df
        else:
            print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÑ‡∏°‡πà‡∏°‡∏µ Google Sheets ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ JSON cache")
            return pd.DataFrame()  # Return empty DataFrame ‡πÅ‡∏ó‡∏ô None
    
    try:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheets (GID: 876257177)
        worksheet = None
        for ws in sh.worksheets():
            if ws.id == 876257177:
                worksheet = ws
                break
        
        if worksheet is None:
            worksheet = sh.get_worksheet(0)
        
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        data = worksheet.get_all_values()
        if not data or len(data) < 2:
            return None
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame
        headers = data[0]
        df_new = pd.DataFrame(data[1:], columns=headers)
        
        # ‡∏´‡∏≤ column ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤
        code_col = None
        for col in ['Code', 'Plan Code', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏™‡∏≤‡∏Ç‡∏≤']:
            if col in df_new.columns:
                code_col = col
                break
        
        if not code_col:
            print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤")
            return None
        
        # ‡∏ô‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        new_count = 0
        updated_count = 0
        
        # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets (‡∏£‡∏ß‡∏° DC ‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Sheets)
        for idx, row in df_new.iterrows():
            code = str(row[code_col]).strip().upper()
            if not code or code == '':
                continue
            
            # ‡πÅ‡∏õ‡∏•‡∏á row ‡πÄ‡∏õ‡πá‡∏ô dict
            row_dict = row.to_dict()
            
            if code in existing_data:
                # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if existing_data[code] != row_dict:
                    existing_data[code] = row_dict
                    updated_count += 1
                # ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô update
            else:
                # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà - ‡πÄ‡∏û‡∏¥‡πà‡∏°
                existing_data[code] = row_dict
                new_count += 1
        
        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON
        with open(json_file, 'w', encoding='utf-8') as f:
            json.dump(existing_data, f, ensure_ascii=False, indent=2)
        
        print(f"‚úÖ Sync ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: {new_count} ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà, {updated_count} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï, ‡∏£‡∏ß‡∏° {len(existing_data)} ‡∏™‡∏≤‡∏Ç‡∏≤")
        
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô DataFrame (‡πÉ‡∏ä‡πâ index ‡πÄ‡∏õ‡πá‡∏ô Plan Code)
        df = pd.DataFrame.from_dict(existing_data, orient='index')
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Plan Code ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å index
        if 'Plan Code' not in df.columns and code_col in df.columns:
            df['Plan Code'] = df[code_col]
        elif 'Plan Code' not in df.columns:
            # ‡πÉ‡∏ä‡πâ index ‡πÄ‡∏õ‡πá‡∏ô Plan Code
            df.reset_index(inplace=True)
            df.rename(columns={'index': 'Plan Code'}, inplace=True)
        else:
            df.reset_index(drop=True, inplace=True)
        
        return df
        
    except Exception as e:
        print(f"‚ùå Error: {e}")
        # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
        if existing_data:
            print(f"üì¶ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å JSON")
            df = pd.DataFrame.from_dict(existing_data, orient='index')
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Plan Code ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if 'Plan Code' not in df.columns:
                df.reset_index(inplace=True)
                df.rename(columns={'index': 'Plan Code'}, inplace=True)
            else:
                df.reset_index(drop=True, inplace=True)
            return df
        return None

# ==========================================
# CONFIG
# ==========================================
MODEL_PATH = 'models/decision_tree_model.pkl'

# ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
LIMITS = {
    '4W': {'max_w': 2500, 'max_c': 5.0, 'max_drops': 12},   # ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 12 ‡∏à‡∏∏‡∏î, Cube ‚â§ 5
    'JB': {'max_w': 3500, 'max_c': 7.0, 'max_drops': 12},   # ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 12 ‡∏à‡∏∏‡∏î, Cube ‚â§ 7
    '6W': {'max_w': 6000, 'max_c': 20.0, 'max_drops': 999}  # ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î, Cube ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°, Weight ‚â§ 6000
}

# üîí ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Punthai ‡∏•‡πâ‡∏ß‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 100%)
PUNTHAI_LIMITS = {
    '4W': {'max_w': 2500, 'max_c': 5.0, 'max_drops': 5},   # Punthai ‡∏•‡πâ‡∏ß‡∏ô 4W: ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏™‡∏≤‡∏Ç‡∏≤
    'JB': {'max_w': 3500, 'max_c': 7.0, 'max_drops': 7},  # Punthai ‡∏•‡πâ‡∏ß‡∏ô JB: ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 7 ‡∏™‡∏≤‡∏Ç‡∏≤
    '6W': {'max_w': 6000, 'max_c': 20.0, 'max_drops': 999}
}

#  Geographic Clustering Config
MAX_DISTRICT_DISTANCE_KM = 30  # ‡∏Ñ‡∏ô‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 30km ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ 80km)

# ==========================================
# REGION ORDER CONFIG (Far-to-Near Sorting)
# ==========================================
# ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î: ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‚Üí ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô ‚Üí ‡πÉ‡∏ï‡πâ ‚Üí ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‚Üí ‡∏Å‡∏•‡∏≤‡∏á
REGION_ORDER = {
    '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': 1, 'NORTH': 1,
    '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô': 2, 'NE': 2,
    '‡πÉ‡∏ï‡πâ': 3, 'SOUTH': 3,
    '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': 4, 'EAST': 4,
    '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å': 5, 'WEST': 5,
    '‡∏Å‡∏•‡∏≤‡∏á': 6, 'CENTRAL': 6,
    '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏': 99
}

# ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å)
EXCLUDE_BRANCHES = ['DC011', 'PTDC', 'PTG DISTRIBUTION CENTER']

# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å (‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠)
EXCLUDE_NAMES = ['Distribution Center', 'PTG Distribution', '‡∏ö.‡∏û‡∏µ‡∏ó‡∏µ‡∏à‡∏µ ‡πÄ‡∏≠‡πá‡∏ô‡πÄ‡∏ô‡∏≠‡∏¢‡∏µ']

# ‡∏û‡∏¥‡∏Å‡∏±‡∏î DC ‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á)
DC_WANG_NOI_LAT = 14.179394
DC_WANG_NOI_LON = 100.648149

# ==========================================
# üöõ HIGHWAY-BASED LOGISTICS ROUTES & ZONES
# ==========================================
# ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏ï‡∏≤‡∏°‡∏ñ‡∏ô‡∏ô"
# ‡∏¢‡∏∂‡∏î‡πÄ‡∏•‡∏Ç‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏Ç‡∏ï‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î

HIGHWAY_ROUTES = {
    # ‡∏™‡∏≤‡∏¢ 1 (‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô): ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô
    'ROUTE_1_‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô': {
        'highway': '1',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå ‚Üí ‡∏ï‡∏≤‡∏Å ‚Üí ‡∏•‡∏≥‡∏õ‡∏≤‡∏á ‚Üí ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‚Üí ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢',
        'provinces': ['‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', '‡∏ï‡∏≤‡∏Å', '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', '‡∏•‡∏≥‡∏û‡∏π‡∏ô', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢'],
        'branches': ['‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô', '‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢'],
    },
    # ‡∏™‡∏≤‡∏¢ 11 (‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡πà‡∏≤): ‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å-‡πÅ‡∏û‡∏£‡πà-‡∏ô‡πà‡∏≤‡∏ô
    'ROUTE_11_‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡πà‡∏≤': {
        'highway': '11',
        'description': '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå ‚Üí ‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£ ‚Üí ‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å ‚Üí ‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå ‚Üí ‡πÅ‡∏û‡∏£‡πà',
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡πÅ‡∏û‡∏£‡πà'],
    },
    # ‡∏™‡∏≤‡∏¢ 101: ‡πÅ‡∏û‡∏£‡πà-‡∏ô‡πà‡∏≤‡∏ô
    'ROUTE_101_‡πÅ‡∏û‡∏£‡πà‡∏ô‡πà‡∏≤‡∏ô': {
        'highway': '101',
        'description': '‡πÅ‡∏û‡∏£‡πà ‚Üí ‡∏ô‡πà‡∏≤‡∏ô (‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤)',
        'provinces': ['‡πÅ‡∏û‡∏£‡πà', '‡∏ô‡πà‡∏≤‡∏ô'],
    },
    # ‡∏™‡∏≤‡∏¢ 32 (‡∏™‡∏≤‡∏¢‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢): ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á
    'ROUTE_32_‡∏™‡∏≤‡∏¢‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢': {
        'highway': '32',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ ‚Üí ‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á ‚Üí ‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå',
        'provinces': ['‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå'],
    },
    # ‡∏™‡∏≤‡∏¢ 2 (‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û): ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠
    'ROUTE_2_‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û': {
        'highway': '2',
        'description': '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤ ‚Üí ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‚Üí ‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ ‚Üí ‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢',
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡πÄ‡∏•‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'],
    },
    # ‡∏™‡∏≤‡∏¢ 24 (‡πÄ‡∏î‡∏ä‡∏≠‡∏∏‡∏î‡∏°): ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÉ‡∏ï‡πâ
    'ROUTE_24_‡πÄ‡∏î‡∏ä‡∏≠‡∏∏‡∏î‡∏°': {
        'highway': '24',
        'description': '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤ ‚Üí ‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå ‚Üí ‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‚Üí ‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ',
        'provinces': ['‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç'],
    },
    # ‡∏™‡∏≤‡∏¢ 304: ‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ-‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä
    'ROUTE_304_‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä': {
        'highway': '304',
        'description': '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',
        'provinces': ['‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
    },
    # ‡∏™‡∏≤‡∏¢ 4 (‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°): ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ
    'ROUTE_4_‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°': {
        'highway': '4',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ø ‚Üí ‡∏ä‡∏∏‡∏°‡∏û‡∏£ ‚Üí ‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏Ø ‚Üí ‡∏™‡∏á‡∏Ç‡∏•‡∏≤',
        'provinces': ['‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏ä‡∏∏‡∏°‡∏û‡∏£', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™'],
    },
    # ‡∏™‡∏≤‡∏¢ 401/402: ‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô
    'ROUTE_401_‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô': {
        'highway': '401/402',
        'description': '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå ‚Üí ‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà ‚Üí ‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï',
        'provinces': ['‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏û‡∏±‡∏á‡∏á‡∏≤', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏ï‡∏£‡∏±‡∏á', '‡∏™‡∏ï‡∏π‡∏•'],
    },
    # ‡∏™‡∏≤‡∏¢ 3 (‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó): ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å
    'ROUTE_3_‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó': {
        'highway': '3',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏£‡∏∞‡∏¢‡∏≠‡∏á ‚Üí ‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ï‡∏£‡∏≤‡∏î',
        'provinces': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ï‡∏£‡∏≤‡∏î'],
    },
    # ‡∏™‡∏≤‡∏¢ 331/344: EEC
    'ROUTE_331_EEC': {
        'highway': '331/344',
        'description': '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ-‡∏£‡∏∞‡∏¢‡∏≠‡∏á (‡πÄ‡∏Ç‡∏ï‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©)',
        'provinces': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á'],
    },
    # ‡∏™‡∏≤‡∏¢ 9 (‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å): ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠
    'ROUTE_9_‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å': {
        'highway': '9',
        'description': '‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ-‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ-‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£',
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£'],
    },
    # ‡∏™‡∏≤‡∏¢ 35 (‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ): ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å
    'ROUTE_35_‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ': {
        'highway': '35',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏° ‚Üí ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£',
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£'],
    },
    # ‡∏™‡∏≤‡∏¢ 305: ‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ-‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤
    'ROUTE_305_‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤': {
        'highway': '305',
        'description': '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å ‚Üí ‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤',
        'provinces': ['‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å', '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤', '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'],
    },
    # ‡∏™‡∏≤‡∏¢ 340: ‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ-‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó
    'ROUTE_340_‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì': {
        'highway': '340',
        'description': '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó ‚Üí ‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ',
        'provinces': ['‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ'],
    },
    # ‡∏™‡∏≤‡∏¢ 321: ‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ-‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ
    'ROUTE_321_‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ‡∏Å‡∏≤‡∏ç‡∏à‡∏ô': {
        'highway': '321',
        'description': '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏™‡∏±‡∏á‡∏Ç‡∏•‡∏∞‡∏ö‡∏∏‡∏£‡∏µ',
        'provinces': ['‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'],
    },
}

# ===== NO CROSS-ZONE RULES (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏ã‡∏ô) =====
NO_CROSS_ZONE_PAIRS = [
    ('‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥'),
    ('‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', '‡πÄ‡∏•‡∏¢'),
    ('‡∏ô‡πà‡∏≤‡∏ô', '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤'),
    ('‡∏ï‡∏≤‡∏Å', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢'),
    ('‡πÅ‡∏û‡∏£‡πà', '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå'),
    ('‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô', '‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢'),
    ('‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ'),
]

LOGISTICS_ZONES = {
    # ============ ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ - ‡∏™‡∏≤‡∏¢ 1/11/101 ============
    'ZONE_A_‡∏û‡∏∞‡πÄ‡∏¢‡∏≤': {
        'provinces': ['‡∏û‡∏∞‡πÄ‡∏¢‡∏≤'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', '‡πÅ‡∏°‡πà‡πÉ‡∏à', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏°‡πà‡∏ß‡∏ô', '‡∏î‡∏≠‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏ï‡πâ', '‡∏õ‡∏á', '‡∏à‡∏∏‡∏ô', '‡∏†‡∏π‡∏ã‡∏≤‡∏á', '‡∏†‡∏π‡∏Å‡∏≤‡∏°‡∏¢‡∏≤‡∏ß'],
        'highway': '1',
        'priority': 1,
        'distance_from_dc_km': 680,
        'description': '‡πÇ‡∏ã‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏™‡∏∏‡∏î ‡∏™‡∏≤‡∏¢ 1 ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
    },
    'ZONE_B_‡∏ô‡πà‡∏≤‡∏ô': {
        'provinces': ['‡∏ô‡πà‡∏≤‡∏ô'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏ô', '‡∏ó‡πà‡∏≤‡∏ß‡∏±‡∏á‡∏ú‡∏≤', '‡∏õ‡∏±‡∏ß', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡∏≤‡∏á', '‡∏ó‡∏∏‡πà‡∏á‡∏ä‡πâ‡∏≤‡∏á', '‡∏ö‡πà‡∏≠‡πÄ‡∏Å‡∏•‡∏∑‡∏≠', '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏™‡∏≤', '‡∏ô‡∏≤‡∏ô‡πâ‡∏≠‡∏¢', '‡∏ô‡∏≤‡∏´‡∏°‡∏∑‡πà‡∏ô', '‡πÅ‡∏°‡πà‡∏à‡∏£‡∏¥‡∏°', '‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á', '‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç', '‡∏†‡∏π‡πÄ‡∏û‡∏µ‡∏¢‡∏á', '‡∏™‡∏≠‡∏á‡πÅ‡∏Ñ‡∏ß', '‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥'],
        'highway': '101',
        'priority': 2,
        'distance_from_dc_km': 620,
        'description': '‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏û‡∏£‡πà (‡∏™‡∏≤‡∏¢ 101)'
    },
    'ZONE_C_‡πÅ‡∏û‡∏£‡πà': {
        'provinces': ['‡πÅ‡∏û‡∏£‡πà'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏û‡∏£‡πà', '‡∏™‡∏π‡∏á‡πÄ‡∏°‡πà‡∏ô', '‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏¢', '‡∏£‡πâ‡∏≠‡∏á‡∏Å‡∏ß‡∏≤‡∏á', '‡∏™‡∏≠‡∏á', '‡∏•‡∏≠‡∏á', '‡∏ß‡∏±‡∏á‡∏ä‡∏¥‡πâ‡∏ô', '‡∏´‡∏ô‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á‡πÑ‡∏Ç‡πà'],
        'highway': '11',
        'priority': 3,
        'distance_from_dc_km': 540,
        'description': 'Gateway ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô ‡∏™‡∏≤‡∏¢ 11 ‚Üí ‡∏ô‡πà‡∏≤‡∏ô/‡∏û‡∏∞‡πÄ‡∏¢‡∏≤'
    },
    'ZONE_D_‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå': {
        'provinces': ['‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡∏ï‡∏£‡∏≠‡∏ô', '‡∏ó‡πà‡∏≤‡∏õ‡∏•‡∏≤', '‡∏ô‡πâ‡∏≥‡∏õ‡∏≤‡∏î', '‡∏ü‡∏≤‡∏Å‡∏ó‡πà‡∏≤', '‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏Å', '‡∏û‡∏¥‡∏ä‡∏±‡∏¢', '‡∏•‡∏±‡∏ö‡πÅ‡∏•', '‡∏ó‡∏≠‡∏á‡πÅ‡∏™‡∏ô‡∏Ç‡∏±‡∏ô',
                      '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', '‡∏Å‡∏á‡πÑ‡∏Å‡∏£‡∏•‡∏≤‡∏®', '‡∏Ñ‡∏µ‡∏£‡∏µ‡∏°‡∏≤‡∏®', '‡∏®‡∏£‡∏µ‡∏™‡∏≥‡πÇ‡∏£‡∏á', '‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πÇ‡∏•‡∏Å', '‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£', '‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏•‡∏≤‡∏ô‡∏´‡∏≠‡∏¢', '‡∏ó‡∏∏‡πà‡∏á‡πÄ‡∏™‡∏•‡∏µ‡πà‡∏¢‡∏°', '‡∏®‡∏£‡∏µ‡∏™‡∏±‡∏ä‡∏ô‡∏≤‡∏•‡∏±‡∏¢'],
        'highway': '11',
        'priority': 4,
        'distance_from_dc_km': 450,
        'description': '‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏û‡∏£‡πà ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_E1_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å_‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á': {
        'provinces': ['‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'subdistricts': ['‡∏ß‡∏±‡∏î‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏•‡∏≠‡∏á', '‡∏´‡∏±‡∏ß‡∏£‡∏≠', '‡∏ö‡∏∂‡∏á‡∏û‡∏£‡∏∞', '‡∏ó‡πà‡∏≤‡∏ó‡∏≠‡∏á', '‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏£‡πà‡∏≤‡∏á'],
        'highway': '11',
        'priority': 5,
        'distance_from_dc_km': 380,
        'description': 'Hub ‡πÉ‡∏´‡∏ç‡πà ‡πÇ‡∏ã‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á+‡∏ï‡∏•‡∏≤‡∏î'
    },
    'ZONE_E2_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å_‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢': {
        'provinces': ['‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'subdistricts': ['‡∏ó‡πà‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå', '‡∏≠‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å', '‡πÅ‡∏°‡πà‡∏Å‡∏≤', '‡∏™‡∏°‡∏≠‡πÅ‡∏Ç', '‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡πà‡∏≤'],
        'highway': '11',
        'priority': 6,
        'distance_from_dc_km': 385,
        'description': '‡πÇ‡∏ã‡∏ô ‡∏°.‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£'
    },
    'ZONE_E3_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå'],
        'districts': ['‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á', '‡∏û‡∏£‡∏´‡∏°‡∏û‡∏¥‡∏£‡∏≤‡∏°', '‡πÄ‡∏ô‡∏¥‡∏ô‡∏°‡∏∞‡∏õ‡∏£‡∏≤‡∏á', '‡∏ö‡∏≤‡∏á‡∏£‡∏∞‡∏Å‡∏≥', '‡∏ä‡∏≤‡∏ï‡∏¥‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏£', '‡∏ô‡∏Ñ‡∏£‡πÑ‡∏ó‡∏¢',
                      '‡∏´‡∏•‡πà‡∏°‡∏™‡∏±‡∏Å', '‡∏´‡∏•‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤', '‡πÄ‡∏Ç‡∏≤‡∏Ñ‡πâ‡∏≠'],
        'highway': '12',
        'priority': 7,
        'distance_from_dc_km': 400,
        'description': '‡πÇ‡∏ã‡∏ô‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‡∏™‡∏≤‡∏¢ 12 ‡πÑ‡∏õ‡πÄ‡∏Ç‡∏≤‡∏Ñ‡πâ‡∏≠'
    },
    'ZONE_F1_‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£_‡∏™‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å': {
        'provinces': ['‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡∏™‡∏≤‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡∏™‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏°', '‡∏ß‡∏±‡∏á‡∏ó‡∏£‡∏≤‡∏¢‡∏û‡∏π‡∏ô'],
        'highway': '11',
        'priority': 8,
        'distance_from_dc_km': 330,
        'description': '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£‡∏™‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_F2_‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£'],
        'districts': ['‡∏ï‡∏∞‡∏û‡∏≤‡∏ô‡∏´‡∏¥‡∏ô', '‡∏ó‡∏±‡∏ö‡∏Ñ‡∏•‡πâ‡∏≠', '‡∏î‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏ö‡∏≤‡∏á‡∏°‡∏π‡∏•‡∏ô‡∏≤‡∏Å'],
        'highway': '113',
        'priority': 9,
        'distance_from_dc_km': 340,
        'description': '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‡∏™‡∏≤‡∏¢ 113'
    },
    'ZONE_F3_‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£_‡∏™‡∏≤‡∏¢117': {
        'provinces': ['‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£'],
        'districts': ['‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏ä‡πâ‡∏≤‡∏á', '‡∏ö‡∏∂‡∏á‡∏ô‡∏≤‡∏£‡∏≤‡∏á', '‡∏ß‡∏ä‡∏¥‡∏£‡∏ö‡∏≤‡∏£‡∏°‡∏µ', '‡πÇ‡∏û‡∏ó‡∏∞‡πÄ‡∏•'],
        'highway': '117',
        'priority': 10,
        'distance_from_dc_km': 320,
        'description': '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£‡∏™‡∏≤‡∏¢ 117'
    },
    'ZONE_G_‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß', '‡∏ó‡πà‡∏≤‡∏ï‡∏∞‡πÇ‡∏Å', '‡πÑ‡∏û‡∏®‡∏≤‡∏•‡∏µ', '‡∏ï‡∏≤‡∏Ñ‡∏•‡∏µ', '‡∏ö‡∏£‡∏£‡∏û‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢', '‡∏ä‡∏∏‡∏°‡∏ï‡∏≤‡∏ö‡∏á', '‡∏•‡∏≤‡∏î‡∏¢‡∏≤‡∏ß', '‡∏ï‡∏≤‡∏Å‡∏ü‡πâ‡∏≤', '‡∏û‡∏¢‡∏∏‡∏´‡∏∞‡∏Ñ‡∏µ‡∏£‡∏µ', '‡πÇ‡∏Å‡∏£‡∏Å‡∏û‡∏£‡∏∞', '‡πÄ‡∏Å‡πâ‡∏≤‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß', '‡∏ä‡∏∏‡∏°‡πÅ‡∏™‡∏á', '‡πÅ‡∏°‡πà‡∏ß‡∏á‡∏Å‡πå', '‡πÅ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏ô'],
        'highway': '1/32',
        'priority': 11,
        'distance_from_dc_km': 240,
        'description': '‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡∏™‡∏≤‡∏¢ 1/32'
    },
    # ============ ‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô - ‡∏™‡∏≤‡∏¢ 2/24 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢) ============
    'ZONE_H1_‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä_‡πÄ‡∏°‡∏∑‡∏≠‡∏á': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏õ‡∏±‡∏Å‡∏ò‡∏á‡∏ä‡∏±‡∏¢'],
        'highway': '2',
        'priority': 12,
        'distance_from_dc_km': 260,
        'description': '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'
    },
    'ZONE_H2_‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'districts': ['‡∏ö‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà', '‡∏Ñ‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏µ‡∏Ñ‡∏¥‡πâ‡∏ß', '‡∏™‡∏π‡∏á‡πÄ‡∏ô‡∏¥‡∏ô', '‡πÇ‡∏ô‡∏ô‡∏™‡∏π‡∏á', '‡πÇ‡∏ô‡∏ô‡πÅ‡∏î‡∏á', '‡∏î‡πà‡∏≤‡∏ô‡∏Ç‡∏∏‡∏ô‡∏ó‡∏î'],
        'highway': '2/304',
        'priority': 12,
        'distance_from_dc_km': 280,
        'description': '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å-‡πÄ‡∏Ç‡∏≤‡πÉ‡∏´‡∏ç‡πà'
    },
    'ZONE_H3_‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä_‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'districts': ['‡∏û‡∏¥‡∏°‡∏≤‡∏¢', '‡∏´‡πâ‡∏ß‡∏¢‡πÅ‡∏ñ‡∏•‡∏á', '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡πà‡∏≠‡∏°', '‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏±‡∏¢', '‡πÅ‡∏Å‡πâ‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ô‡∏≤‡∏á', '‡πÄ‡∏ó‡∏û‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå'],
        'highway': '2',
        'priority': 12,
        'distance_from_dc_km': 270,
        'description': '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä‡πÄ‡∏´‡∏ô‡∏∑‡∏≠-‡πÄ‡∏™‡πâ‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û'
    },
    'ZONE_H4_‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä_‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'districts': ['‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á', '‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥', '‡∏Ñ‡∏á', '‡∏ä‡∏∏‡∏°‡∏û‡∏ß‡∏á'],
        'highway': '2/304',
        'priority': 12,
        'distance_from_dc_km': 290,
        'description': '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä‡πÉ‡∏ï‡πâ-‡πÄ‡∏™‡πâ‡∏ô304'
    },
    'ZONE_I1_‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô_‡πÄ‡∏°‡∏∑‡∏≠‡∏á': {
        'provinces': ['‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏ô‡πâ‡∏≥‡∏û‡∏≠‡∏á', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏±‡∏ï‡∏ô‡πå', '‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà'],
        'highway': '2',
        'priority': 13,
        'distance_from_dc_km': 450,
        'description': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á Hub ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á'
    },
    'ZONE_I2_‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô_‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'],
        'districts': ['‡∏ö‡πâ‡∏≤‡∏ô‡∏ù‡∏≤‡∏á', '‡∏ä‡∏ô‡∏ö‡∏ó', '‡∏û‡∏•', '‡πÅ‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà', '‡πÅ‡∏ß‡∏á‡∏ô‡πâ‡∏≠‡∏¢', '‡∏°‡∏±‡∏ç‡∏à‡∏≤‡∏Ñ‡∏µ‡∏£‡∏µ'],
        'highway': '2',
        'priority': 13,
        'distance_from_dc_km': 470,
        'description': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡πÉ‡∏ï‡πâ'
    },
    'ZONE_I3_‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô_‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'],
        'districts': ['‡∏Å‡∏£‡∏∞‡∏ô‡∏ß‡∏ô', '‡∏ã‡∏≥‡∏™‡∏π‡∏á', '‡πÄ‡∏õ‡∏∑‡∏≠‡∏¢‡∏ô‡πâ‡∏≠‡∏¢', '‡∏û‡∏£‡∏∞‡∏¢‡∏∑‡∏ô', '‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô', '‡∏´‡∏ô‡∏≠‡∏á‡∏™‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á', '‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡∏≠'],
        'highway': '2',
        'priority': 13,
        'distance_from_dc_km': 460,
        'description': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'
    },
    'ZONE_I4_‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°': {
        'provinces': ['‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡∏ä‡∏±‡∏¢', '‡πÅ‡∏Å‡∏î‡∏≥', '‡πÇ‡∏Å‡∏™‡∏∏‡∏°‡∏û‡∏¥‡∏™‡∏±‡∏¢', '‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°', '‡∏ô‡∏≤‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å', '‡∏ô‡∏≤‡∏î‡∏π‡∏ô', '‡∏ö‡∏£‡∏ö‡∏∑‡∏≠', '‡∏û‡∏¢‡∏±‡∏Ñ‡∏Ü‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏¥‡∏™‡∏±‡∏¢', '‡∏ß‡∏≤‡∏õ‡∏µ‡∏õ‡∏ó‡∏∏‡∏°', '‡∏¢‡∏≤‡∏á‡∏™‡∏µ‡∏™‡∏∏‡∏£‡∏≤‡∏ä'],
        'highway': '2',
        'priority': 13,
        'distance_from_dc_km': 480,
        'description': '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°'
    },
    'ZONE_I5_‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î': {
        'provinces': ['‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ß‡∏¥‡∏™‡∏±‡∏¢', '‡∏õ‡∏ó‡∏∏‡∏°‡∏£‡∏±‡∏ï‡∏ï‡πå', '‡∏ò‡∏ß‡∏±‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡∏û‡∏ô‡∏°‡πÑ‡∏û‡∏£', '‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏£‡∏ß‡∏á', '‡πÄ‡∏™‡∏•‡∏†‡∏π‡∏°‡∏¥', '‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥', '‡∏≠‡∏≤‡∏à‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ'],
        'highway': '2/214',
        'priority': 13,
        'distance_from_dc_km': 510,
        'description': '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'
    },
    'ZONE_I6_‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå': {
        'provinces': ['‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', '‡∏Å‡∏°‡∏•‡∏≤‡πÑ‡∏™‡∏¢', '‡∏Å‡∏∏‡∏â‡∏¥‡∏ô‡∏≤‡∏£‡∏≤‡∏¢‡∏ì‡πå', '‡πÄ‡∏Ç‡∏≤‡∏ß‡∏á', '‡∏Ñ‡∏≥‡∏°‡πà‡∏ß‡∏á', '‡∏î‡∏≠‡∏ô‡∏à‡∏≤‡∏ô', '‡∏ó‡πà‡∏≤‡∏Ñ‡∏±‡∏ô‡πÇ‡∏ó', '‡∏ô‡∏≤‡∏Ñ‡∏π', '‡∏ô‡∏≤‡∏°‡∏ô', '‡∏¢‡∏≤‡∏á‡∏ï‡∏•‡∏≤‡∏î', '‡∏Ü‡πâ‡∏≠‡∏á‡∏ä‡∏±‡∏¢', '‡∏£‡πà‡∏≠‡∏á‡∏Ñ‡∏≥', '‡∏™‡∏´‡∏±‡∏™‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à', '‡∏™‡∏≤‡∏°‡∏ä‡∏±‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏Å‡∏∏‡∏á‡∏®‡∏£‡∏µ', '‡∏´‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡πá‡∏Å', '‡∏´‡πâ‡∏ß‡∏¢‡∏ú‡∏∂‡πâ‡∏á'],
        'highway': '213',
        'priority': 13,
        'distance_from_dc_km': 520,
        'description': '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå'
    },
    'ZONE_J_‡∏≠‡∏∏‡∏î‡∏£': {
        'provinces': ['‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡πÄ‡∏•‡∏¢', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨'],
        'highway': '2',
        'priority': 14,
        'distance_from_dc_km': 560,
        'description': '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡∏™‡∏≤‡∏¢ 2 ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
    },
    'ZONE_K_‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£'],
        'highway': '24',
        'priority': 15,
        'distance_from_dc_km': 500,
        'description': '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÉ‡∏ï‡πâ ‡∏™‡∏≤‡∏¢ 24'
    },
    # ============ ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å - ‡∏™‡∏≤‡∏¢ 3 ============
    'ZONE_L_‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏∞‡∏¢‡∏≠‡∏á': {
        'provinces': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á'],
        'highway': '3/331',
        'priority': 16,
        'distance_from_dc_km': 120,
        'description': 'EEC ‡∏™‡∏≤‡∏¢ 3/331'
    },
    'ZONE_M_‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ‡∏ï‡∏£‡∏≤‡∏î': {
        'provinces': ['‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ï‡∏£‡∏≤‡∏î'],
        'highway': '3',
        'priority': 17,
        'distance_from_dc_km': 300,
        'description': '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏Å‡∏• ‡∏™‡∏≤‡∏¢ 3 ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
    },
    # ============ ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ - ‡∏™‡∏≤‡∏¢ 4 ============
    'ZONE_N_‡πÉ‡∏ï‡πâ‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô': {
        'provinces': ['‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á'],
        'highway': '4',
        'priority': 18,
        'distance_from_dc_km': 400,
        'description': '‡πÉ‡∏ï‡πâ‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô ‡∏™‡∏≤‡∏¢ 4 (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ä‡∏∏‡∏°‡∏û‡∏£)'
    },
    # ‡∏ä‡∏∏‡∏°‡∏û‡∏£ - ‡πÅ‡∏¢‡∏Å‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢
    'ZONE_N1_‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'districts': ['‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß', '‡∏™‡∏ß‡∏µ', '‡∏•‡∏∞‡πÅ‡∏°', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'highway': '4',
        'priority': 18.1,
        'distance_from_dc_km': 420,
        'description': '‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß-‡∏™‡∏ß‡∏µ-‡πÄ‡∏°‡∏∑‡∏≠‡∏á)'
    },
    'ZONE_N2_‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'districts': ['‡∏ó‡∏∏‡πà‡∏á‡∏ï‡∏∞‡πÇ‡∏Å', '‡∏û‡∏∞‡πÇ‡∏ï‡πä‡∏∞', '‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏ô', '‡∏ó‡πà‡∏≤‡πÅ‡∏ã‡∏∞'],
        'highway': '4',
        'priority': 18.2,
        'distance_from_dc_km': 450,
        'description': '‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÉ‡∏ï‡πâ (‡∏ó‡∏∏‡πà‡∏á‡∏ï‡∏∞‡πÇ‡∏Å-‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏ô)'
    },
    'ZONE_N3_‡∏ä‡∏∏‡∏°‡∏û‡∏£‡∏Å‡∏•‡∏≤‡∏á': {
        'provinces': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢', '‡∏ó‡∏±‡∏ö‡∏™‡∏∞‡πÅ‡∏Å', '‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô'],
        'highway': '4',
        'priority': 18.3,
        'distance_from_dc_km': 440,
        'description': '‡∏ä‡∏∏‡∏°‡∏û‡∏£‡∏Å‡∏•‡∏≤‡∏á (‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢-‡∏ó‡∏±‡∏ö‡∏™‡∏∞‡πÅ‡∏Å-‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô)'
    },
    'ZONE_O_‡πÉ‡∏ï‡πâ‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢': {
        'provinces': ['‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™'],
        'highway': '4',
        'priority': 19,
        'distance_from_dc_km': 700,
        'description': '‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢ ‡∏™‡∏≤‡∏¢ 4'
    },
    'ZONE_P_‡πÉ‡∏ï‡πâ‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô': {
        'provinces': ['‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏û‡∏±‡∏á‡∏á‡∏≤', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏ï‡∏£‡∏±‡∏á', '‡∏™‡∏ï‡∏π‡∏•'],
        'highway': '401/402',
        'priority': 20,
        'distance_from_dc_km': 850,
        'description': '‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô ‡∏™‡∏≤‡∏¢ 401/402'
    },
    # ============ ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏• (‡πÅ‡∏ö‡πà‡∏á‡πÇ‡∏ã‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) ============
    'ZONE_BKK_‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà', '‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°', '‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£', '‡∏û‡∏ç‡∏≤‡πÑ‡∏ó', '‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', '‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á'],
        'highway': '1/9',
        'priority': 95,
        'distance_from_dc_km': 50,
        'description': '‡∏Å‡∏ó‡∏°.‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô-‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á'
    },
    'ZONE_BKK_‡∏Å‡∏•‡∏≤‡∏á': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô', '‡∏ß‡∏±‡∏í‡∏ô‡∏≤', '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', '‡∏™‡∏≤‡∏ó‡∏£', '‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤'],
        'highway': 'CBD',
        'priority': 96,
        'distance_from_dc_km': 55,
        'description': '‡∏Å‡∏ó‡∏°.‡∏Å‡∏•‡∏≤‡∏á CBD-‡∏™‡∏µ‡∏•‡∏°-‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó'
    },
    'ZONE_BKK_‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ', '‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞', '‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏', '‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á', '‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô', '‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô', '‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®', '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å'],
        'highway': '35',
        'priority': 97,
        'distance_from_dc_km': 60,
        'description': '‡∏Å‡∏ó‡∏°.‡πÉ‡∏ï‡πâ ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 2-‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô'
    },
    'ZONE_BKK_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥', '‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°', '‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á', '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', '‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤', '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å'],
        'highway': '3/9',
        'priority': 98,
        'distance_from_dc_km': 45,
        'description': '‡∏Å‡∏ó‡∏°.‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤-‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á'
    },
    'ZONE_NEARBY_‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ß‡∏¢', '‡∏ö‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà', '‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á', '‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢', '‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î'],
        'highway': '9/35',
        'priority': 99,
        'distance_from_dc_km': 35,
        'description': '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏ó‡∏°'
    },
    'ZONE_NEARBY_‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ': {
        'provinces': ['‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á', '‡∏ò‡∏±‡∏ç‡∏ö‡∏∏‡∏£‡∏µ', '‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡∏≠', '‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏Å‡πâ‡∏ß', '‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤', '‡∏™‡∏≤‡∏°‡πÇ‡∏Ñ‡∏Å'],
        'highway': '1/9/305',
        'priority': 99,
        'distance_from_dc_km': 25,
        'description': '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ ‡πÉ‡∏Å‡∏•‡πâ DC ‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢'
    },
    'ZONE_NEARBY_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£': {
        'provinces': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', '‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠', '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ', '‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á', '‡∏û‡∏£‡∏∞‡∏™‡∏°‡∏∏‡∏ó‡∏£‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå', '‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á'],
        'highway': '3/9/34',
        'priority': 99,
        'distance_from_dc_km': 40,
        'description': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ ‡∏ö‡∏≤‡∏á‡∏ô‡∏≤-‡πÅ‡∏ö‡∏£‡∏¥‡πà‡∏á-‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥'
    },
    'ZONE_NEARBY_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£': {
        'provinces': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∞‡∏ó‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ô', '‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏û‡πâ‡∏ß'],
        'highway': '35',
        'priority': 99,
        'distance_from_dc_km': 50,
        'description': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ‡∏°‡∏´‡∏≤‡∏ä‡∏±‡∏¢'
    },
    'ZONE_NEARBY_‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÅ‡∏™‡∏ô', '‡∏ô‡∏Ñ‡∏£‡∏ä‡∏±‡∏¢‡∏®‡∏£‡∏µ', '‡∏î‡∏≠‡∏ô‡∏ï‡∏π‡∏°', '‡∏ö‡∏≤‡∏á‡πÄ‡∏•‡∏ô', '‡∏™‡∏≤‡∏°‡∏û‡∏£‡∏≤‡∏ô', '‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ì‡∏ë‡∏•'],
        'highway': '35/4',
        'priority': 99,
        'distance_from_dc_km': 55,
        'description': '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏° ‡∏°.‡πÄ‡∏Å‡∏©‡∏ï‡∏£-‡∏™‡∏≤‡∏°‡∏û‡∏£‡∏≤‡∏ô'
    },
    'ZONE_NEARBY_‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': {
        'provinces': ['‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠', '‡∏ô‡∏Ñ‡∏£‡∏´‡∏•‡∏ß‡∏á', '‡∏ö‡∏≤‡∏á‡πÑ‡∏ó‡∏£', '‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏´‡∏±‡∏ô', '‡∏ö‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢', '‡∏ú‡∏±‡∏Å‡πÑ‡∏´‡πà', '‡∏†‡∏≤‡∏ä‡∏µ', '‡∏•‡∏≤‡∏î‡∏ö‡∏±‡∏ß‡∏´‡∏•‡∏ß‡∏á', '‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢', '‡πÄ‡∏™‡∏ô‡∏≤', '‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏≠‡∏¥‡∏ô', '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢'],
        'highway': '1/32',
        'priority': 99,
        'distance_from_dc_km': 20,
        'description': '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤-‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (DC ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà!)'
    },
}

# ==========================================
# ZONE/REGION CONFIG - ‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏Ñ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
# ==========================================
# ‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏Ñ: 1=‡∏Å‡∏•‡∏≤‡∏á, 2=‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å, 3=‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å, 4=‡πÄ‡∏´‡∏ô‡∏∑‡∏≠, 5=‡∏≠‡∏µ‡∏™‡∏≤‡∏ô, 6=‡πÉ‡∏ï‡πâ
REGION_CODE = {
    # ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á (‡∏£‡∏´‡∏±‡∏™ 1)
    '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£': '10', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø': '10',
    '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': '11',
    '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ': '12',
    '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': '13', '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': '13',
    '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ': '14',
    '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ': '15',
    '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ': '16',
    '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á': '17',
    '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó': '18',
    '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°': '19',
    '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£': '1A',
    '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£': '1B',
    '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°': '1C',
    
    # ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å (‡∏£‡∏´‡∏±‡∏™ 2)
    '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ': '20',
    '‡∏£‡∏∞‡∏¢‡∏≠‡∏á': '21',
    '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': '22',
    '‡∏ï‡∏£‡∏≤‡∏î': '23',
    '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤': '24',
    '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': '25',
    '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß': '26',
    '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å': '27',
    
    # ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å (‡∏£‡∏´‡∏±‡∏™ 3)
    '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ': '30',
    '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': '31',
    '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ': '32',
    '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ': '33',
    '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå': '34',
    
    # ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (‡∏£‡∏´‡∏±‡∏™ 4)
    '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå': '40',
    '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ': '41',
    '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£': '42',
    '‡∏ï‡∏≤‡∏Å': '43',
    '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢': '44',
    '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å': '45',
    '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£': '46',
    '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå': '47',
    '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå': '48',
    '‡πÅ‡∏û‡∏£‡πà': '49',
    '‡∏ô‡πà‡∏≤‡∏ô': '4A',
    '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤': '4B',
    '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢': '4C',
    '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà': '4D',
    '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô': '4E',
    '‡∏•‡∏≥‡∏û‡∏π‡∏ô': '4F',
    '‡∏•‡∏≥‡∏õ‡∏≤‡∏á': '4G',
    
    # ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠/‡∏≠‡∏µ‡∏™‡∏≤‡∏ô (‡∏£‡∏´‡∏±‡∏™ 5)
    '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤': '50', '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä': '50',
    '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå': '51',
    '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå': '52',
    '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©': '53',
    '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ': '54',
    '‡∏¢‡πÇ‡∏™‡∏ò‡∏£': '55',
    '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥': '56',
    '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç': '57',
    '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π': '58',
    '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô': '59',
    '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ': '5A',
    '‡πÄ‡∏•‡∏¢': '5B',
    '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢': '5C',
    '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°': '5D',
    '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î': '5E',
    '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå': '5F',
    '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£': '5G',
    '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°': '5H',
    '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£': '5I',
    '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨': '5J',
    
    # ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ (‡∏£‡∏´‡∏±‡∏™ 6)
    '‡∏ä‡∏∏‡∏°‡∏û‡∏£': '60',
    '‡∏£‡∏∞‡∏ô‡∏≠‡∏á': '61',
    '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ': '62',
    '‡∏û‡∏±‡∏á‡∏á‡∏≤': '63',
    '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà': '64',
    '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï': '65',
    '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä': '66',
    '‡∏ï‡∏£‡∏±‡∏á': '67',
    '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á': '68',
    '‡∏™‡∏á‡∏Ç‡∏•‡∏≤': '69',
    '‡∏™‡∏ï‡∏π‡∏•': '6A',
    '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ': '6B',
    '‡∏¢‡∏∞‡∏•‡∏≤': '6C',
    '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™': '6D',
}

# ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ
REGION_NAMES = {
    '1': '‡∏Å‡∏•‡∏≤‡∏á',
    '2': '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å',
    '3': '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å',
    '4': '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠',
    '5': '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô',
    '6': '‡πÉ‡∏ï‡πâ',
    '9': '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
}

# ==========================================
# HELPER: ZONE/REGION FUNCTIONS
# ==========================================
def get_region_code(province):
    """‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏Ñ/‡πÇ‡∏ã‡∏ô‡∏à‡∏≤‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"""
    if not province or str(province).strip() == '' or str(province) == 'nan':
        return '99'  # ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏
    province = str(province).strip()
    return REGION_CODE.get(province, '99')

def get_region_name(province):
    """‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ‡∏à‡∏≤‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"""
    code = get_region_code(province)
    if code == '99':
        return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    region_prefix = code[0]
    return REGION_NAMES.get(region_prefix, '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')

# ==========================================
# LOGISTICS ZONE FUNCTIONS
# ==========================================
def get_logistics_zone(province, district='', subdistrict=''):
    """
    ‡∏´‡∏≤‡πÇ‡∏ã‡∏ô‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå‡∏à‡∏≤‡∏Å ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•
    
    ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î) ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•)
    
    Returns:
        zone_name (str): ‡πÄ‡∏ä‡πà‡∏ô 'ZONE_A_‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', 'ZONE_NEARBY_‡∏Å‡∏ó‡∏°', None ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    """
    if not province or str(province).strip() == '':
        return None
    
    province = str(province).strip()
    district = str(district).strip() if district else ''
    subdistrict = str(subdistrict).strip() if subdistrict else ''
    
    # üéØ ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ districts/subdistricts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
    # ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏•‡πà‡∏•‡∏á‡πÑ‡∏õ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (‡∏°‡∏µ districts/subdistricts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
    
    main_zones = []  # ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
    sub_zones = []   # ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•)
    
    # ‡πÅ‡∏¢‡∏Å‡πÇ‡∏ã‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å/‡∏¢‡πà‡∏≠‡∏¢
    for zone_name, zone_info in LOGISTICS_ZONES.items():
        if province in zone_info['provinces']:
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ districts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î = ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å
            if 'districts' not in zone_info or not zone_info['districts']:
                main_zones.append((zone_name, zone_info))
            else:
                # ‡∏°‡∏µ districts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î = ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢
                sub_zones.append((zone_name, zone_info))
    
    # 1Ô∏è‚É£ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏°‡∏≤)
    if district:
        for zone_name, zone_info in sub_zones:
            if district in zone_info['districts']:
                # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ subdistricts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏ß‡∏¢ ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
                if 'subdistricts' in zone_info and zone_info['subdistricts']:
                    if subdistrict and subdistrict in zone_info['subdistricts']:
                        return zone_name
                else:
                    # ‡πÑ‡∏°‡πà‡∏°‡∏µ subdistricts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‚Üí return ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ
                    return zone_name
    
    # 2Ô∏è‚É£ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢ ‚Üí ‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å
    if main_zones:
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° priority)
        main_zones_sorted = sorted(main_zones, key=lambda x: x[1].get('priority', 999))
        return main_zones_sorted[0][0]
    
    return None

def get_zone_priority(zone_name):
    """
    ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Priority ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LIFO: ‡πÑ‡∏Å‡∏•‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
    
    Returns:
        int: 1-99 (1 = ‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î, 99 = ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î)
    """
    if not zone_name or zone_name not in LOGISTICS_ZONES:
        return 999  # ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÇ‡∏ã‡∏ô ‚Üí ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î
    
    return LOGISTICS_ZONES[zone_name]['priority']

def get_zone_highway(zone_name):
    """
    ‡∏î‡∏∂‡∏á‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô
    
    Returns:
        str: ‡πÄ‡∏ä‡πà‡∏ô '‡∏™‡∏≤‡∏¢ 1 (‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô)', '‡∏™‡∏≤‡∏¢ 2 (‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û)'
    """
    if not zone_name or zone_name not in LOGISTICS_ZONES:
        return ''
    
    return LOGISTICS_ZONES[zone_name].get('highway', '')

def can_combine_zones_by_highway(zone1, zone2):
    """
    ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ 2 ‡πÇ‡∏ã‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà ‚Üí ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏î‡πâ)
    
    Returns:
        bool: True ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    """
    if not zone1 or not zone2:
        return False
    
    highway1 = get_zone_highway(zone1)
    highway2 = get_zone_highway(zone2)
    
    if not highway1 or not highway2:
        return False
    
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    return highway1 == highway2

def is_cross_zone_violation(province1, province2):
    """
    ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á 2 ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô NO_CROSS_ZONE_PAIRS ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    (‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥/‡∏†‡∏π‡πÄ‡∏Ç‡∏≤)
    
    Returns:
        bool: True ‡∏ñ‡πâ‡∏≤‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏ã‡∏ô
    """
    if not province1 or not province2:
        return False
    
    prov1 = str(province1).strip()
    prov2 = str(province2).strip()
    
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ó‡∏≤‡∏á
    return (prov1, prov2) in NO_CROSS_ZONE_PAIRS or (prov2, prov1) in NO_CROSS_ZONE_PAIRS

def calculate_district_centroid(district_df):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤"""
    valid_coords = district_df[district_df['_lat'] > 0]
    if valid_coords.empty:
        return None, None
    return valid_coords['_lat'].mean(), valid_coords['_lon'].mean()

def check_geographic_proximity(district1_df, district2_df, max_distance_km=MAX_DISTRICT_DISTANCE_KM):
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ 2 ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡∏û‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    prov1 = district1_df['_province'].iloc[0] if not district1_df.empty else ''
    prov2 = district2_df['_province'].iloc[0] if not district2_df.empty else ''
    
    # üö® ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ Logistics Zone ‡∏Å‡πà‡∏≠‡∏ô
    if prov1 and prov2 and prov1 != prov2:
        # ‡πÅ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà Logistics Zone ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        zone1 = get_logistics_zone(prov1, '', '')
        zone2 = get_logistics_zone(prov2, '', '')
        
        if zone1 and zone2:
            if zone1 == zone2:
                # ‚úÖ Zone ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô)
                return True
            else:
                # ‡∏Ñ‡∏ô‡∏•‡∏∞ Zone ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if not can_combine_zones_by_highway(zone1, zone2):
                    return False  # ‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á centroids
    lat1, lon1 = calculate_district_centroid(district1_df)
    lat2, lon2 = calculate_district_centroid(district2_df)
    
    if lat1 is None or lat2 is None:
        return True  # ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô
    
    distance = haversine_distance(lat1, lon1, lat2, lon2)
    
    if prov1 and prov2 and prov1 == prov2:
        # ‚úÖ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡πÉ‡∏ä‡πâ threshold ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤ (60km)
        return distance <= (max_distance_km * 2.0)  # 30km * 2.0 = 60km
    else:
        # ‚ö†Ô∏è ‡∏Ñ‡∏ô‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î + ‡∏Ñ‡∏ô‡∏•‡∏∞ Zone ‚Üí ‡πÉ‡∏ä‡πâ threshold ‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î (30km)
        return distance <= max_distance_km

def sort_branches_by_region_route(branches_df, master_data=None):
    """
    ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí Route
    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î
    """
    if branches_df.empty:
        return branches_df
    
    df = branches_df.copy()
    
    # ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Province ‡πÅ‡∏•‡∏∞ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
    province_col = 'Province' if 'Province' in df.columns else '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' if '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in df.columns else None
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sort
    df['_region_code'] = df[province_col].apply(get_region_code) if province_col else '99'
    df['_province'] = df[province_col].fillna('') if province_col else ''
    df['_district'] = df['District'].fillna('') if 'District' in df.columns else ''
    df['_subdistrict'] = df['Subdistrict'].fillna('') if 'Subdistrict' in df.columns else ''
    
    # ‡πÅ‡∏¢‡∏Å Route number
    if 'Route' in df.columns:
        df['_route_num'] = df['Route'].apply(lambda x: int(str(x).replace('CD', '')) if pd.notna(x) and str(x).startswith('CD') else 99999)
    else:
        df['_route_num'] = 99999
    
    # Sort
    df = df.sort_values(by=['_region_code', '_province', '_district', '_subdistrict', '_route_num'])
    
    # ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    df = df.drop(columns=['_region_code', '_province', '_district', '_subdistrict', '_route_num'])
    
    return df.reset_index(drop=True)

def check_trip_route_spread(trip_df):
    """
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡∏°‡∏µ Route ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πÑ‡∏´‡∏°
    ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤: (route_range, is_spread, provinces)
    """
    if trip_df.empty or 'Route' not in trip_df.columns:
        return 0, False, []
    
    routes = trip_df['Route'].dropna().unique()
    route_nums = []
    for r in routes:
        if pd.notna(r) and str(r).startswith('CD'):
            try:
                route_nums.append(int(str(r).replace('CD', '')))
            except:
                pass
    
    if len(route_nums) < 2:
        return 0, False, trip_df['Province'].dropna().unique().tolist() if 'Province' in trip_df.columns else []
    
    route_range = max(route_nums) - min(route_nums)
    is_spread = route_range > 4000  # ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 4000 ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
    
    provinces = trip_df['Province'].dropna().unique().tolist() if 'Province' in trip_df.columns else []
    
    return route_range, is_spread, provinces

# ==========================================
# LOAD MASTER DATA
# ==========================================
@st.cache_data(ttl=300)  # Cache 5 ‡∏ô‡∏≤‡∏ó‡∏µ (auto-sync ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ)
def load_master_data():
    """‡πÇ‡∏´‡∏•‡∏î Master Data ‡∏à‡∏≤‡∏Å Google Sheets ‡∏´‡∏£‡∏∑‡∏≠ JSON (auto-sync)"""
    try:
        # ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏ó‡∏µ‡πà sync ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        df_from_sheets = sync_branch_data_from_sheets()
        
        if df_from_sheets is None or df_from_sheets.empty:
            print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Sheets ‡∏´‡∏£‡∏∑‡∏≠ branch_data.json")
            return pd.DataFrame()
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        required_cols = ['Plan Code']
        missing = [c for c in required_cols if c not in df_from_sheets.columns]
        if missing:
            print(f"‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: {missing}")
        
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
        col_mapping = {
            '‡∏•‡∏∞': '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î',
            '‡∏•‡∏≠‡∏á': '‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î'
        }
        df_from_sheets = df_from_sheets.rename(columns=col_mapping)
        
        # ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Plan Code
        if 'Plan Code' in df_from_sheets.columns:
            df_from_sheets['Plan Code'] = df_from_sheets['Plan Code'].astype(str).str.strip().str.upper()
            df_from_sheets = df_from_sheets[df_from_sheets['Plan Code'] != '']
        
        print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î MASTER_DATA: {len(df_from_sheets)} ‡∏™‡∏≤‡∏Ç‡∏≤")
        return df_from_sheets
        
    except Exception as e:
        print(f"‚ùå Error loading MASTER_DATA: {e}")
        return pd.DataFrame()

# ‡πÇ‡∏´‡∏•‡∏î Master Data ‡∏à‡∏≤‡∏Å Google Sheets
MASTER_DATA = load_master_data()

# ==========================================
# CLEAN NAME FUNCTION (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Join_Key)
# ==========================================
def clean_name(text):
    """
    ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠: ‡∏•‡∏ö prefix ‡∏à./‡∏≠./‡∏ï. ‡πÅ‡∏•‡∏∞ trim whitespace
    ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Join_Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Master Data
    """
    if pd.isna(text) or text is None:
        return ''
    text = str(text)
    # ‡∏•‡∏ö prefix ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    text = text.replace('‡∏à. ', '').replace('‡∏à.', '')
    text = text.replace('‡∏≠. ', '').replace('‡∏≠.', '')
    text = text.replace('‡∏ï. ', '').replace('‡∏ï.', '')
    # ‡∏•‡∏ö prefix ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    text = text.replace('Tambon ', '').replace('Amphoe ', '').replace('Changwat ', '')
    return text.strip()

def normalize_province_name(province):
    """
    ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô)
    """
    if pd.isna(province) or province is None:
        return ''
    province = clean_name(province)
    # Mapping ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢
    province_mapping = {
        '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',
        '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡∏Å‡∏ó‡∏°': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡∏Å‡∏ó‡∏°.': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä': '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',
    }
    return province_mapping.get(province, province)

def normalize(val):
    """‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"""
    return str(val).strip().upper().replace(" ", "").replace(".0", "")

def load_master_dist_data():
    """
    ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Master Dist.xlsx ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:
    1. ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•
    2. Sum_Code (Sort_Code) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
    
    ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Sum_Code ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sort
    """
    try:
        file_path = 'Dc/Master Dist.xlsx'
        df = pd.read_excel(file_path)
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á lookup dict - ‡∏™‡∏≠‡∏á key: Sum_Code ‡πÅ‡∏•‡∏∞ Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•)
        dist_lookup = {}   # key = Sum_Code
        name_lookup = {}   # key = Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•)
        
        for _, row in df.iterrows():
            sum_code = str(row.get('Sum_Code', '')).strip()
            
            # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° sum_code (Sort_Code) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢!
            data = {
                'sum_code': sum_code,  # üîë ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sort!
                'region': row.get('Region', ''),
                'region_code': row.get('Region_Code', ''),
                'province': row.get('Province', ''),
                'prov_code': row.get('Prov_Code', ''),
                'district': row.get('District', ''),
                'dist_code': row.get('Dist_Code', ''),
                'subdistrict': row.get('Subdistrict', ''),
                'subdist_code': row.get('Subdist_Code', ''),
                'dist_from_dc_km': float(row.get('Dist_from_DC_km', 9999)) if pd.notna(row.get('Dist_from_DC_km')) else 9999,
                'prov_dist_km': float(row.get('Prov_Dist_km', 0)) if pd.notna(row.get('Prov_Dist_km')) else 0,
                'dist_subdist_km': float(row.get('Dist_Subdist_km', 0)) if pd.notna(row.get('Dist_Subdist_km')) else 0,
            }
            
            # Key 1: Sum_Code (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö lookup ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
            if sum_code:
                dist_lookup[sum_code] = data
            
            # Key 2: Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•) - ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á Lookup!
            prov_raw = str(row.get('Province', ''))
            dist_raw = str(row.get('District', ''))
            subdist_raw = str(row.get('Subdistrict', ''))
            
            # Clean name ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Join
            prov_clean = clean_name(prov_raw)
            dist_clean = clean_name(dist_raw)
            subdist_clean = clean_name(subdist_raw)
            
            # Join_Key ‡πÅ‡∏ö‡∏ö clean (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
            join_key = f"{prov_clean}_{dist_clean}_{subdist_clean}"
            if join_key and join_key != '__':
                name_lookup[join_key] = data
            
            # Join_Key ‡πÅ‡∏ö‡∏ö normalized province (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô)
            prov_normalized = normalize_province_name(prov_raw)
            if prov_normalized != prov_clean:
                alt_key = f"{prov_normalized}_{dist_clean}_{subdist_clean}"
                if alt_key and alt_key != '__':
                    name_lookup[alt_key] = data
            
            # Join_Key ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ prefix (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ prefix)
            raw_key = f"{prov_raw.strip()}_{dist_raw.strip()}_{subdist_raw.strip()}"
            if raw_key and raw_key != '__' and raw_key not in name_lookup:
                name_lookup[raw_key] = data
        
        return {'by_code': dist_lookup, 'by_name': name_lookup}
    except Exception as e:
        return {'by_code': {}, 'by_name': {}}

# ‡πÇ‡∏´‡∏•‡∏î Master Dist Data
MASTER_DIST_DATA = load_master_dist_data()

# ==========================================
# PUNTHAI/MAXMART BUFFER FUNCTIONS (REMOVED - ‡πÉ‡∏ä‡πâ‡πÇ‡∏•‡∏à‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß)
# ==========================================
# HELPER FUNCTIONS
# ==========================================

def get_max_vehicle_for_branch(branch_code, test_df=None):
    """‡∏î‡∏∂‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö - ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Master Data (Google Sheets) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å"""
    branch_code_str = str(branch_code).strip().upper()
    
    # üéØ ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å MASTER_DATA (Google Sheets) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
        branch_row = MASTER_DATA[MASTER_DATA['Plan Code'].str.strip().str.upper() == branch_code_str]
        if not branch_row.empty:
            # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            possible_cols = ['MaxTruckType', 'Max Truck Type', 'MaxVehicle', 'Max Vehicle', '‡∏£‡∏ñ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', 'Max_Truck_Type']
            for col in possible_cols:
                if col in branch_row.columns and pd.notna(branch_row.iloc[0][col]):
                    max_truck = str(branch_row.iloc[0][col]).strip().upper()
                    if max_truck in ['4W', 'JB', '6W']:
                        return max_truck
    
    # üîÑ Fallback: ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å test_df (Excel upload) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô Master
    if test_df is not None and not test_df.empty:
        branch_row = test_df[test_df['Code'].str.strip().str.upper() == branch_code_str]
        if not branch_row.empty:
            # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            possible_cols = ['MaxTruckType', 'Max Truck Type', 'MaxVehicle', 'Max Vehicle', '‡∏£‡∏ñ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', 'Max_Truck_Type']
            for col in possible_cols:
                if col in branch_row.columns and pd.notna(branch_row.iloc[0][col]):
                    max_truck = str(branch_row.iloc[0][col]).strip().upper()
                    if max_truck in ['4W', 'JB', '6W']:
                        return max_truck
    
    # Default: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î = ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏î‡πâ
    return '6W'

def get_max_vehicle_for_trip(trip_codes):
    """
    ‡∏´‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ)
    
    Args:
        trip_codes: set ‡∏Ç‡∏≠‡∏á branch codes ‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
    
    Returns:
        str: '4W', 'JB', ‡∏´‡∏£‡∏∑‡∏≠ '6W'
    """
    vehicle_priority = {'4W': 1, 'JB': 2, '6W': 3}
    max_allowed = '6W'  # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤
    min_priority = 3  # ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
    
    for code in trip_codes:
        branch_max = get_max_vehicle_for_branch(code)
        priority = vehicle_priority.get(branch_max, 3)
        
        # üîí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
        if priority < min_priority:
            min_priority = priority
            max_allowed = branch_max
    
    return max_allowed

def haversine_distance(lat1, lon1, lat2, lon2):
    """
    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏™‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡πÇ‡∏•‡∏Å (km)
    ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£ Haversine
    """
    from math import radians, sin, cos, sqrt, atan2
    
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏õ‡πá‡∏ô radians
    lat1_rad = radians(lat1)
    lon1_rad = radians(lon1)
    lat2_rad = radians(lat2)
    lon2_rad = radians(lon2)
    
    # ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
    dlat = lat2_rad - lat1_rad
    dlon = lon2_rad - lon1_rad
    
    # ‡∏™‡∏π‡∏ï‡∏£ Haversine
    a = sin(dlat/2)**2 + cos(lat1_rad) * cos(lat2_rad) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))
    
    # ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å (km)
    R = 6371.0
    distance = R * c
    
    return distance

def load_model():
    """‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏ô‡πÑ‡∏ß‡πâ"""
    if not os.path.exists(MODEL_PATH):
        return None
    
    try:
        with open(MODEL_PATH, 'rb') as f:
            model_data = pickle.load(f)
        return model_data
    except Exception as e:
        st.error(f"‚ùå Error loading model: {e}")
        return None

def load_excel(file_content, sheet_name=None):
    """‡πÇ‡∏´‡∏•‡∏î Excel"""
    try:
        xls = pd.ExcelFile(io.BytesIO(file_content))
        
        target_sheet = None
        if sheet_name and sheet_name in xls.sheet_names:
            target_sheet = sheet_name
        else:
            for s in xls.sheet_names:
                if 'punthai' in s.lower() or '2.' in s.lower():
                    target_sheet = s
                    break
        
        if not target_sheet:
            target_sheet = xls.sheet_names[0]
        
        # ‡∏´‡∏≤ header row
        df_temp = pd.read_excel(xls, sheet_name=target_sheet, header=None)
        header_row = 0
        
        for i in range(min(10, len(df_temp))):
            row_values = df_temp.iloc[i].astype(str).str.upper()
            match_count = sum([
                'BRANCH' in ' '.join(row_values),
                'TRIP' in ' '.join(row_values),
                '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤' in ' '.join(df_temp.iloc[i].astype(str))
            ])
            if match_count >= 2:
                header_row = i
                break
        
        df = pd.read_excel(xls, sheet_name=target_sheet, header=header_row)
        df = df.loc[:, ~df.columns.duplicated()]
        
        return df
    except Exception as e:
        st.error(f"‚ùå Error: {e}")
        return None

def process_dataframe(df):
    """‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"""
    if df is None:
        return None
    
    rename_map = {}
    
    # ‡πÉ‡∏ä‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå test.xlsx sheet 2.Punthai
    # 0:Sep, 1:BU, 2:BranchCode, 3:‡∏£‡∏´‡∏±‡∏™WMS, 4:Branch, 5:TOTALCUBE, 6:TOTALWGT, 7:OriginalQTY, ...
    col_list = list(df.columns)
    
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 1 = BU
    if len(col_list) > 1:
        rename_map[col_list[1]] = 'BU'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 2 = ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (BranchCode)
    if len(col_list) > 2:
        rename_map[col_list[2]] = 'Code'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 4 = ‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡∏∑‡πà‡∏≠ (Branch)
    if len(col_list) > 4:
        rename_map[col_list[4]] = 'Name'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 5 = TOTALCUBE
    if len(col_list) > 5:
        rename_map[col_list[5]] = 'Cube'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 6 = TOTALWGT
    if len(col_list) > 6:
        rename_map[col_list[6]] = 'Weight'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 15 = latitude
    if len(col_list) > 15:
        rename_map[col_list[15]] = 'Latitude'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 16 = longitude
    if len(col_list) > 16:
        rename_map[col_list[16]] = 'Longitude'
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πà‡∏≤‡∏á)
    for col in df.columns:
        if col in rename_map.values():  # ‡∏ñ‡πâ‡∏≤ map ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°
            continue
        if col in rename_map:  # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô key ‡πÉ‡∏ô map ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°
            continue
        col_clean = str(col).strip()
        col_upper = col_clean.upper().replace(' ', '').replace('_', '')
        
        # BU
        if col_upper == 'BU' or col_clean == 'BU':
            rename_map[col] = 'BU'
        # Code
        elif col_clean == 'BranchCode' or '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤' in col_clean or col_clean ==  'BRANCH_CODE' in col_upper or 'CODE' in col_upper:
            if 'Weight' not in col_upper and 'Cube' not in col_upper:  # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö WeightCode
                rename_map[col] = 'Code'
        # Name
        elif col_clean == 'Branch' or '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤' in col_clean or col_clean == '‡∏™‡∏≤‡∏Ç‡∏≤' or ('BRANCH' in col_upper and 'CODE' not in col_upper):
            rename_map[col] = 'Name'
        # ‡∏ï‡∏≥‡∏ö‡∏•
        elif '‡∏ï‡∏≥‡∏ö‡∏•' in col_clean or 'SUBDISTRICT' in col_upper or 'TAMBON' in col_upper:
            rename_map[col] = 'Subdistrict'
        # ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
        elif '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠' in col_clean or ('DISTRICT' in col_upper and 'SUB' not in col_upper) or 'AMPHOE' in col_upper or 'AMPHUR' in col_upper:
            rename_map[col] = 'District'
        # ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
        elif '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in col_clean or 'PROVINCE' in col_upper or 'CHANGWAT' in col_upper:
            rename_map[col] = 'Province'
        # Weight - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
        elif ('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å' in col_clean or 
              'WEIGHT' in col_upper or 
              'WGT' in col_upper or 
              'TOTALWGT' in col_upper or
              '‡∏ô‡πâ‡πç‡∏≤‡∏´‡∏ô‡∏±‡∏Å' in col_clean or  # ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏≥ ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î
              col_upper in ['WEIGHT', 'WGT', 'TOTALWEIGHT']):
            rename_map[col] = 'Weight'
        # Cube - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
        elif ('‡∏Ñ‡∏¥‡∏ß' in col_clean or 
              'CUBE' in col_upper or 
              'TOTALCUBE' in col_upper or
              'CBM' in col_upper or
              col_upper in ['CUBE', 'CBM', 'TOTALCUBE']):
            rename_map[col] = 'Cube'
        # Latitude
        elif 'latitude' in col_clean.lower() or col_clean == '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î' or 'LAT' == col_upper or col_upper == 'LATITUDE':
            rename_map[col] = 'Latitude'
        # Longitude
        elif 'longitude' in col_clean.lower() or col_clean == '‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î' or col_upper in ['LONG', 'LNG', 'LON', 'LONGITUDE']:
            rename_map[col] = 'Longitude'
        # Trip
        elif col_upper in ['TRIPNO', 'TRIP_NO', 'TRIPNUMBER'] or col_clean == 'Trip no':
            rename_map[col] = 'TripNo'
        elif col_upper == 'TRIP' or '‡∏ó‡∏£‡∏¥‡∏õ' in col_clean or '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß' in col_clean:
            rename_map[col] = 'Trip'
        # Booking
        elif 'BOOKING' in col_upper:
            rename_map[col] = 'Booking'
    
    df = df.rename(columns=rename_map)
    
    # ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≥
    df = df.loc[:, ~df.columns.duplicated()]
    
    if 'Code' in df.columns:
        df['Code'] = df['Code'].apply(normalize)
        
        # ‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å (‡∏£‡∏´‡∏±‡∏™)
        df = df[~df['Code'].isin(EXCLUDE_BRANCHES)]
        
        # ‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏µ keyword ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        if 'Name' in df.columns:
            exclude_pattern = '|'.join(EXCLUDE_NAMES)
            df = df[~df['Name'].str.contains(exclude_pattern, case=False, na=False)]
    
    for col in ['Weight', 'Cube']:
        if col not in df.columns:
            df[col] = 0.0
        else:
            df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0.0)
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å Master ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Province ‡πÅ‡∏•‡∏∞ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
    province_col = 'Province' if 'Province' in df.columns else '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' if '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in df.columns else None
    
    if not province_col or df[province_col].isna().all():
        if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns and 'Code' in df.columns:
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping ‡∏à‡∏≤‡∏Å Master
            province_map = {}
            for _, row in MASTER_DATA.iterrows():
                code = row.get('Plan Code', '')
                province = row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '')
                if code and province:
                    province_map[code] = province
            
            # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
            def find_province_by_name(code, name):
                # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å code ‡∏Å‡πà‡∏≠‡∏ô
                if code in province_map:
                    return province_map[code]
                
                # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
                if not name or pd.isna(name):
                    return None
                
                # ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà prefix)
                keywords = str(name).replace('MAX MART-', '').replace('PUNTHAI-', '').replace('LUBE', '').strip()
                if not keywords:
                    return None
                
                # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á Master
                for _, master_row in MASTER_DATA.iterrows():
                    master_name = str(master_row.get('‡∏™‡∏≤‡∏Ç‡∏≤', ''))
                    # ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô (‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
                    if keywords[:10] in master_name or master_name[:10] in keywords:
                        province = master_row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '')
                        if province:
                            return province
                
                return None
            
            # ‡πÉ‡∏™‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Province ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
            target_col = 'Province' if 'Province' in df.columns else '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
            if 'Name' in df.columns:
                df[target_col] = df.apply(lambda row: find_province_by_name(row['Code'], row.get('Name', '')), axis=1)
            else:
                df[target_col] = df['Code'].map(province_map)
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á Province ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠ backward compatibility)
            if 'Province' not in df.columns and '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in df.columns:
                df['Province'] = df['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î']
    
    return df.reset_index(drop=True)

def predict_trips(test_df, model_data, punthai_buffer=1.0, maxmart_buffer=1.10):
    """
    ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà - ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
    
    ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:
    1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°: ‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí Route (‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å Master Dist.xlsx ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
    2. ‡∏à‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° Route ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
    3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ (‡∏à‡∏≤‡∏Å DC)
    4. ‡∏ï‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    5. ‡πÉ‡∏ä‡πâ BUFFER ‡∏ï‡∏≤‡∏° BU (‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö - ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    
    Args:
        test_df: DataFrame ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
        model_data: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏•
        punthai_buffer: Buffer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Punthai (‡πÄ‡∏ä‡πà‡∏ô 1.0 = 100%, ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
        maxmart_buffer: Buffer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Maxmart/‡∏ú‡∏™‡∏° (‡πÄ‡∏ä‡πà‡∏ô 1.10 = 110%, ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
    """
    branch_vehicles = model_data.get('branch_vehicles', {})
    
    # ==========================================
    # Step 1: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Master Dist Lookup (Join_Key ‚Üí Sort_Code)
    # ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
    # ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Sum_Code (Sort_Code) ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
    # ==========================================
    subdistrict_dist_lookup = {}  # {Join_Key: {sum_code, dist_from_dc, ...}}
    if MASTER_DIST_DATA and 'by_name' in MASTER_DIST_DATA:
        subdistrict_dist_lookup = MASTER_DIST_DATA['by_name']
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á location_map ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• test_df (‡∏à‡∏≤‡∏Å Google Sheets) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    location_map = {}  # {code: {province, district, subdistrict, route, sum_code, ...}}
    
    # üöÄ OPTIMIZED: ‡πÉ‡∏ä‡πâ vectorized operations ‡πÅ‡∏ó‡∏ô iterrows ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 10-50 ‡πÄ‡∏ó‡πà‡∏≤
    # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° lookup dictionary ‡∏à‡∏≤‡∏Å MASTER_DATA ‡∏Å‡πà‡∏≠‡∏ô
    master_lookup = {}
    if isinstance(model_data, pd.DataFrame) and not model_data.empty and 'Plan Code' in model_data.columns:
        for _, row in model_data.iterrows():
            code = str(row.get('Plan Code', '')).strip().upper()
            if code:
                master_lookup[code] = {
                    'province': str(row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '')).strip() if pd.notna(row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î')) else '',
                    'district': str(row.get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '')).strip() if pd.notna(row.get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠')) else '',
                    'subdistrict': str(row.get('‡∏ï‡∏≥‡∏ö‡∏•', '')).strip() if pd.notna(row.get('‡∏ï‡∏≥‡∏ö‡∏•')) else '',
                    'route': str(row.get('Route', '')).strip() if pd.notna(row.get('Route')) else '',
                    'lat': float(row.get('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0)) if pd.notna(row.get('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î')) else 0,
                    'lon': float(row.get('‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0)) if pd.notna(row.get('‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î')) else 0
                }
    
    # üéØ Process each branch - optimized version
    for _, row in test_df.iterrows():
        code = str(row.get('Code', '')).strip().upper()
        if not code:
            continue
        
        # üåü ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å master_lookup (pre-built dictionary) ‡πÅ‡∏ó‡∏ô loop
        master_info = master_lookup.get(code, {})
        province = master_info.get('province', '')
        district = master_info.get('district', '')
        subdistrict = master_info.get('subdistrict', '')
        route = master_info.get('route', '')
        lat = master_info.get('lat', 0)
        lon = master_info.get('lon', 0)
        
        # üîÑ Fallback: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô MASTER_DATA ‚Üí ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Excel upload (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)
        if not province:
            province = str(row.get('Province', '')).strip() if pd.notna(row.get('Province')) else ''
        if not district:
            district = str(row.get('District', '')).strip() if pd.notna(row.get('District')) else ''
        if not subdistrict:
            subdistrict = str(row.get('Subdistrict', '')).strip() if pd.notna(row.get('Subdistrict')) else ''
        if not route:
            route = str(row.get('Route', '')).strip() if pd.notna(row.get('Route')) else ''
        
        # üåç ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å master_lookup (‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö)
        if lat == 0 or lon == 0:
            # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå upload
            lat_cols = ['Latitude', 'latitude', '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î', 'lat','‡∏•‡∏∞']
            lon_cols = ['Longitude', 'longitude', '‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î', '‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î', 'lon', 'long','‡∏•‡∏≠‡∏á']
            
            for lat_col in lat_cols:
                if lat_col in row and pd.notna(row[lat_col]):
                    try:
                        lat = float(row[lat_col])
                        break
                    except:
                        pass
            
            for lon_col in lon_cols:
                if lon_col in row and pd.notna(row[lon_col]):
                    try:
                        lon = float(row[lon_col])
                        break
                    except:
                        pass
        
        # üîë ‡∏™‡∏£‡πâ‡∏≤‡∏á Join_Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Master Dist (VLOOKUP)
        prov_clean = clean_name(province)
        dist_clean = clean_name(district)
        subdist_clean = clean_name(subdistrict)
        join_key = f"{prov_clean}_{dist_clean}_{subdist_clean}"
        
        # ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ key ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
        dist_data = subdistrict_dist_lookup.get(join_key, {})
        if not dist_data:
            # ‡∏•‡∏≠‡∏á normalize ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            prov_normalized = normalize_province_name(province)
            alt_key = f"{prov_normalized}_{dist_clean}_{subdist_clean}"
            dist_data = subdistrict_dist_lookup.get(alt_key, {})
        
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Master Dist (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if dist_data:
            sum_code = dist_data.get('sum_code', '')  # üéØ Sort_Code ‡∏´‡∏•‡∏±‡∏Å!
            dist_from_dc = dist_data.get('dist_from_dc_km', 9999)
            region_code = dist_data.get('region_code', '')
            prov_code = dist_data.get('prov_code', '')
            dist_code_val = dist_data.get('dist_code', '')
            subdist_code = dist_data.get('subdist_code', '')
        else:
            # Fallback: ‡∏™‡∏£‡πâ‡∏≤‡∏á sort_code ‡∏à‡∏≤‡∏Å region code ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å lat/lon
            region_code = get_region_code(province)
            sum_code = f"R99P999D9999S99999"  # Default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö
            dist_from_dc = 9999
            if lat and lon:
                dist_from_dc = haversine_distance(DC_WANG_NOI_LAT, DC_WANG_NOI_LON, lat, lon)
            prov_code = 'P999'
            dist_code_val = 'D9999'
            subdist_code = 'S99999'
        
        region_name = get_region_name(province)
        
        location_map[code] = {
            'province': province,
            'district': district,
            'subdistrict': subdistrict,
            'route': route,
            'lat': lat,
            'lon': lon,
            'join_key': join_key,  # üîë Join_Key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ lookup
            'sum_code': sum_code,  # üéØ Sort_Code ‡∏´‡∏•‡∏±‡∏Å (‡∏à‡∏≤‡∏Å Master Dist)
            'distance_from_dc': dist_from_dc,
            'region_code': region_code,
            'prov_code': prov_code,
            'dist_code': dist_code_val,
            'subdist_code': subdist_code,
            'region_name': region_name
        }
    
    # ==========================================
    # Step 2: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (pd.merge ‡πÅ‡∏ö‡∏ö manual)
    # ==========================================
    df = test_df.copy()
    
    def get_location_info(code):
        code_upper = str(code).strip().upper()
        return location_map.get(code_upper, {
            'province': '', 'district': '', 'subdistrict': '', 'route': '',
            'lat': 0, 'lon': 0, 'join_key': '', 
            'sum_code': 'R99P999D9999S99999',  # Default sort_code
            'distance_from_dc': 9999,
            'region_code': 'R99', 'prov_code': 'P999', 'dist_code': 'D9999', 'subdist_code': 'S99999',
            'region_name': '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
        })
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏£‡∏ß‡∏° sum_code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sort)
    df['_sum_code'] = df['Code'].apply(lambda c: get_location_info(c)['sum_code'])  # üéØ Sort_Code!
    df['_join_key'] = df['Code'].apply(lambda c: get_location_info(c)['join_key'])
    df['_region_code'] = df['Code'].apply(lambda c: get_location_info(c)['region_code'])
    df['_region_name'] = df['Code'].apply(lambda c: get_location_info(c)['region_name'])
    df['_prov_code'] = df['Code'].apply(lambda c: get_location_info(c)['prov_code'])
    df['_dist_code'] = df['Code'].apply(lambda c: get_location_info(c)['dist_code'])
    df['_subdist_code'] = df['Code'].apply(lambda c: get_location_info(c)['subdist_code'])
    df['_province'] = df['Code'].apply(lambda c: get_location_info(c)['province'])
    df['_district'] = df['Code'].apply(lambda c: get_location_info(c)['district'])
    df['_subdistrict'] = df['Code'].apply(lambda c: get_location_info(c)['subdistrict'])
    df['_route'] = df['Code'].apply(lambda c: get_location_info(c)['route'])
    df['_distance_from_dc'] = df['Code'].apply(lambda c: get_location_info(c)['distance_from_dc'])
    df['_lat'] = df['Code'].apply(lambda c: get_location_info(c)['lat'])
    df['_lon'] = df['Code'].apply(lambda c: get_location_info(c)['lon'])
    
    # üö® ‡πÄ‡∏û‡∏¥‡πà‡∏° Logistics Zone ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö routing ‡∏ï‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á
    df['_logistics_zone'] = df.apply(
        lambda row: get_logistics_zone(row['_province'], row['_district'], row['_subdistrict']),
        axis=1
    )
    df['_zone_priority'] = df['_logistics_zone'].apply(get_zone_priority)
    df['_zone_highway'] = df['_logistics_zone'].apply(get_zone_highway)
    
    # ==========================================
    # Step 3: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö Hierarchical (Zone Priority > Region > Province Max Dist > District Max Dist > Distance)
    # üéØ ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Region Order ‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ)
    # ==========================================
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏° Region Order ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sorting
    df['_region_order'] = df['_region_name'].map(REGION_ORDER).fillna(99)
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Province Max Distance (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏´‡∏ô‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
    prov_max_dist = df.groupby('_province')['_distance_from_dc'].max().reset_index()
    prov_max_dist.columns = ['_province', '_prov_max_dist']
    df = df.merge(prov_max_dist, on='_province', how='left')
    df['_prov_max_dist'] = df['_prov_max_dist'].fillna(9999)
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì District Max Distance (‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÑ‡∏´‡∏ô‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
    dist_max_dist = df.groupby(['_province', '_district'])['_distance_from_dc'].max().reset_index()
    dist_max_dist.columns = ['_province', '_district', '_dist_max_dist']
    df = df.merge(dist_max_dist, on=['_province', '_district'], how='left')
    df['_dist_max_dist'] = df['_dist_max_dist'].fillna(9999)
    
    # üéØ Sort: LIFO (Last In First Out) - ‡πÑ‡∏Å‡∏•‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô, ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
    # Zone Priority (Asc - 1=‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î, 99=‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î) ‚Üí Region Order ‚Üí Province Max Dist ‚Üí District Max Dist ‚Üí 
    # Sum_Code ‚Üí Route ‚Üí Distance (Desc - ‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
    df = df.sort_values(
        ['_zone_priority', '_region_order', '_prov_max_dist', '_dist_max_dist', '_sum_code', '_route', '_distance_from_dc'],
        ascending=[True, True, False, False, True, True, False]  # Zone Priority + ‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ
    ).reset_index(drop=True)
    
    # ==========================================
    # Step 4: ‡∏à‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° Route ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
    # ==========================================
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á grouping key ‡∏à‡∏≤‡∏Å route (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≥‡∏ö‡∏•+‡∏≠‡∏≥‡πÄ‡∏†‡∏≠+‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    def get_group_key(row):
        route = row['_route']
        if route and route.strip():
            return f"R_{route}"
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ route ‡πÉ‡∏ä‡πâ ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡∏ö‡∏• (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)
        return f"L_{row['_subdist_code']}_{row['_dist_code']}_{row['_prov_code']}"
    
    df['_group_key'] = df.apply(get_group_key, axis=1)
    
    # ==========================================
    # Step 5: ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤ + Central Region Rule
    # ==========================================
    def get_max_vehicle_for_code(code):
        """‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ - ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Sheets"""
        max_vehicle = get_max_vehicle_for_branch(code, test_df=test_df)
        return max_vehicle
    
    df['_max_vehicle'] = df['Code'].apply(get_max_vehicle_for_code)
    # ‚úÖ ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° Master Data ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    df['_region_allowed_vehicles'] = [['4W', 'JB', '6W']] * len(df)
    
    # üéØ ‡∏™‡∏£‡πâ‡∏≤‡∏á Vehicle Priority: ‡∏™‡∏≤‡∏Ç‡∏≤ 4W = 1 (‡∏à‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô), JB = 2, 6W = 3 (‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
    vehicle_priority_map = {'4W': 1, 'JB': 2, '6W': 3}
    df['_vehicle_priority'] = df['_max_vehicle'].map(vehicle_priority_map).fillna(3)
    
    # üéØ Sort: Vehicle Priority (4W ‡∏Å‡πà‡∏≠‡∏ô) + LIFO Zone Routing (‡πÑ‡∏Å‡∏•‚Üí‡πÉ‡∏Å‡∏•‡πâ) + ‡∏£‡∏ß‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    # 1. ‡∏™‡∏≤‡∏Ç‡∏≤ 4W ‡∏Å‡πà‡∏≠‡∏ô (Priority 1)
    # 2. ‡πÇ‡∏ã‡∏ô‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô (Zone Priority 1-99)
    # 3. ‡∏†‡∏≤‡∏Ñ‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô (Region Order)
    # 4. ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô (Prov Max Dist Desc)
    # 5. ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô (District ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
    # 6. ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô (Subdistrict ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
    # 7. ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô (Distance Desc)
    df = df.sort_values(
        ['_vehicle_priority', '_zone_priority', '_region_order', '_prov_max_dist', '_district', '_subdistrict', '_sum_code', '_route', '_distance_from_dc'],
        ascending=[True, True, True, False, True, True, True, True, False]  # 4W + Zone + ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô + ‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ
    ).reset_index(drop=True)
    
    # ==========================================
    # Step 6: DISTRICT CLUSTERING ALLOCATION (OPTIMIZED)
    # ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏≤‡∏° District Buckets ‡∏û‡∏£‡πâ‡∏≠‡∏° Split ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô
    # ==========================================
    trip_counter = 1
    df['Trip'] = 0
    
    vehicle_priority = {'4W': 1, 'JB': 2, '6W': 3}
    
    # üöÄ CACHE: Pre-compute branch constraints ‡πÅ‡∏•‡∏∞ BU type ‡∏à‡∏≤‡∏Å Excel upload
    branch_max_vehicle_cache = {}
    branch_bu_cache = {}
    for _, row in df.iterrows():
        code = row['Code']
        branch_max_vehicle_cache[code] = row['_max_vehicle']
        
        # üìä ‡∏î‡∏∂‡∏á BU ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà upload ‡∏°‡∏≤ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå BU)
        bu = row.get('BU', None)  # ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Excel
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Punthai ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        is_punthai = False
        if bu is not None:
            bu_str = str(bu).strip().upper()
            # ‡πÄ‡∏ä‡πá‡∏Ñ BU = 211 ‡∏´‡∏£‡∏∑‡∏≠ 'PUNTHAI'
            is_punthai = bu_str in ['211', 'PUNTHAI']
        else:
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå BU ‚Üí ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ (fallback)
            name = str(row.get('Name', '')).upper()
            is_punthai = 'PUNTHAI' in name or 'PUN-' in name
        
        branch_bu_cache[code] = is_punthai
    
    # üöÄ Pre-compute limits with buffer
    def get_max_limits(allowed_vehicles, is_punthai):
        """‡∏´‡∏≤ capacity ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ"""
        buffer_mult = punthai_buffer if is_punthai else maxmart_buffer
        max_vehicle = '6W' if '6W' in allowed_vehicles else ('JB' if 'JB' in allowed_vehicles else '4W')
        limits_to_use = PUNTHAI_LIMITS if is_punthai else LIMITS
        lim = limits_to_use.get(max_vehicle, LIMITS['6W'])
        return {
            'max_w': lim.get('max_w', 6000) * buffer_mult,
            'max_c': lim.get('max_c', 20.0) * buffer_mult,
            'max_d': lim.get('max_drops', 12)
        }
    
    # Helper function: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (Optimized)
    def select_vehicle_for_load(weight, cube, drops, is_punthai, allowed_vehicles, debug=False):
        """
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
        
        Logic:
        1. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 4W ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 4W ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°)
        2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ JB (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ 4W) ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å JB ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏° ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 4W ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 4W
        3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á 4W ‡πÅ‡∏•‡∏∞ JB (‡∏°‡∏µ‡πÅ‡∏ï‡πà 6W) ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà‡∏Å‡πà‡∏≠‡∏ô (6W ‚Üí JB ‚Üí 4W) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ buffer ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà
        """
        buffer_mult = punthai_buffer if is_punthai else maxmart_buffer
        limits_to_use = PUNTHAI_LIMITS if is_punthai else LIMITS
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ 4W ‡∏´‡∏£‡∏∑‡∏≠ JB ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        has_4w_restriction = ('4W' in allowed_vehicles)
        has_jb_restriction = ('JB' in allowed_vehicles)
        
        if has_4w_restriction:
            # ‡∏°‡∏µ 4W ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 4W ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô JB ‡∏´‡∏£‡∏∑‡∏≠ 6W)
            vehicle_order = ['4W']
        elif has_jb_restriction:
            # ‡∏°‡∏µ JB (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ 4W) ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å JB ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏° ‡πÅ‡∏ï‡πà‡∏•‡∏î 4W ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß
            vehicle_order = ['JB', '4W']
        else:
            # ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á 4W ‡πÅ‡∏•‡∏∞ JB (‡∏°‡∏µ‡πÅ‡∏ï‡πà 6W) ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà‡∏Å‡πà‡∏≠‡∏ô: 6W ‚Üí JB ‚Üí 4W
            vehicle_order = ['6W', 'JB', '4W']
        
        reasons = []  # ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏±‡∏ô
        
        for v in vehicle_order:
            if v not in allowed_vehicles:
                reasons.append(f"{v}: ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô allowed_vehicles")
                continue
            lim = limits_to_use[v]
            
            # üéØ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà):
            # 1. Cube ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô buffer (100% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Punthai, 110% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Maxmart)
            # 2. Weight ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100% ‡πÄ‡∏™‡∏°‡∏≠ (hard limit ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤ buffer ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£)
            # 3. Drops:
            #    - Punthai ‡∏•‡πâ‡∏ß‡∏ô: ‡πÉ‡∏ä‡πâ PUNTHAI_LIMITS (4W:5, JB:7, 6W:999)
            #    - Maxmart/‡∏ú‡∏™‡∏°: 4W ‡πÅ‡∏•‡∏∞ JB ‚â§ 12, 6W ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
            
            cube_ok = cube <= lim['max_c'] * buffer_mult
            weight_ok = weight <= lim['max_w']  # Weight ‚â§ 100% ‡πÄ‡∏™‡∏°‡∏≠
            
            # ‡πÄ‡∏ä‡πá‡∏Ñ Drops
            if v in ['4W', 'JB']:
                if is_punthai:
                    # Punthai ‡∏•‡πâ‡∏ß‡∏ô: ‡πÉ‡∏ä‡πâ max_drops ‡∏à‡∏≤‡∏Å PUNTHAI_LIMITS
                    drops_ok = drops <= lim.get('max_drops', 12)
                else:
                    # Maxmart/‡∏ú‡∏™‡∏°: 4W ‡πÅ‡∏•‡∏∞ JB ‡∏à‡∏≥‡∏Å‡∏±‡∏î 12 drops
                    drops_ok = drops <= 12
            else:
                # 6W: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î drops
                drops_ok = True
            
            if cube_ok and weight_ok and drops_ok:
                return v
            else:
                # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
                fails = []
                if not weight_ok:
                    fails.append(f"‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å {weight:.1f} > {lim['max_w']:.1f}")
                if not cube_ok:
                    fails.append(f"‡∏Ñ‡∏¥‡∏ß {cube:.2f} > {lim['max_c']:.2f}*{buffer_mult:.0%}")
                if not drops_ok:
                    fails.append(f"drops {drops} > 12")
                reasons.append(f"{v}: {', '.join(fails)}")
        
        # üö® FALLBACK: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏û‡∏≠‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‚Üí ‡πÉ‡∏ä‡πâ fallback logic
        if debug:
            print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: w={weight:.1f}, c={cube:.2f}, drops={drops}")
            print(f"  allowed_vehicles: {allowed_vehicles}")
            print(f"  ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ Fallback Logic...")
            for r in reasons:
                print(f"  - {r}")
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ allowed_vehicles ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if not allowed_vehicles:
            if debug:
                print(f"  ‚ö†Ô∏è allowed_vehicles ‡∏ß‡πà‡∏≤‡∏á ‚Üí Fallback: ‡πÉ‡∏ä‡πâ 6W")
            return '6W'  # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡πÉ‡∏ä‡πâ 6W
        
        # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° override MaxVehicle ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏¥‡∏ô buffer
        limits_to_check = PUNTHAI_LIMITS if is_punthai else LIMITS
        
        # ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô allowed_vehicles ‚Üí ‡∏•‡∏≠‡∏á override ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤
        if '6W' not in allowed_vehicles and (weight > 3500 or cube > 7.0 * buffer_mult):
            if debug:
                print(f"  ‚Üí Override MaxVehicle: ‡πÉ‡∏ä‡πâ 6W (‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏¥‡∏ô JB: {weight}kg/{cube}m¬≥)")
            return '6W'
        elif 'JB' not in allowed_vehicles and (weight > 2500 or cube > 5.0 * buffer_mult):
            if debug:
                print(f"  ‚Üí Override MaxVehicle: ‡πÉ‡∏ä‡πâ JB (‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏¥‡∏ô 4W: {weight}kg/{cube}m¬≥)")
            return 'JB'
        
        # Fallback: ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô allowed_vehicles
        if '6W' in allowed_vehicles:
            if debug:
                print(f"  ‚Üí Fallback: ‡πÉ‡∏ä‡πâ 6W")
            return '6W'
        elif 'JB' in allowed_vehicles:
            if debug:
                print(f"  ‚Üí Fallback: ‡πÉ‡∏ä‡πâ JB")
            return 'JB'
        elif '4W' in allowed_vehicles:
            if debug:
                print(f"  ‚Üí Fallback: ‡πÉ‡∏ä‡πâ 4W")
            return '4W'
        
        # Fallback ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡πÄ‡∏•‡∏¢ ‡πÉ‡∏ä‡πâ 6W
        if debug:
            print(f"  ‚Üí Fallback ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡πÉ‡∏ä‡πâ 6W")
        return '6W'
    
    # Helper function: ‡πÄ‡∏ä‡πá‡∏Ñ Geographic Spread ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ (OPTIMIZED)
    def check_intra_trip_spread(trip_codes_list):
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏¥‡∏®)"""
        if len(trip_codes_list) < 2:
            return True  # 1 ‡∏™‡∏≤‡∏Ç‡∏≤ = OK
        
        trip_df = df[df['Code'].isin(trip_codes_list)]
        if trip_df.empty or len(trip_df) < 2:
            return True
        
        # ‡∏Å‡∏£‡∏≠‡∏á branch ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î (vectorized)
        valid_coords = trip_df[(trip_df['_lat'] > 0) & (trip_df['_lon'] > 0)]
        if len(valid_coords) < 2:
            return True
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì centroid
        center_lat = valid_coords['_lat'].mean()
        center_lon = valid_coords['_lon'].mean()
        
        # Vectorized distance calculation (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ iterrows)
        distances = valid_coords.apply(
            lambda row: haversine_distance(center_lat, center_lon, row['_lat'], row['_lon']),
            axis=1
        )
        
        # ‡∏ñ‡πâ‡∏≤ spread ‡πÄ‡∏Å‡∏¥‡∏ô 80km ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
        return distances.max() <= 80
    
    # Helper function: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Punthai ‡∏•‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Optimized - ‡πÉ‡∏ä‡πâ cache)
    def is_all_punthai_codes(codes):
        if not codes:
            return False
        return all(branch_bu_cache.get(c, False) for c in codes)
    
    # Helper function: ‡∏´‡∏≤ allowed vehicles ‡∏à‡∏≤‡∏Å codes (Optimized)
    def get_allowed_from_codes(codes, base_allowed):
        """‡∏´‡∏≤ allowed vehicles ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° branch constraints"""
        result = set(base_allowed)
        for code in codes:
            branch_max = branch_max_vehicle_cache.get(code, '6W')
            if branch_max == 'JB':
                result.discard('6W')
            elif branch_max == '4W':
                result.discard('6W')
                result.discard('JB')
        return list(result)
    
    # üöÄ CACHE: Trip metadata cache (‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ã‡πâ‡∏≥)
    trip_metadata_cache = {}
    
    def get_trip_metadata_cached(codes_list, base_allowed):
        """Get trip metadata with caching"""
        codes_key = tuple(sorted(codes_list))
        if codes_key not in trip_metadata_cache:
            trip_metadata_cache[codes_key] = {
                'is_punthai': is_all_punthai_codes(codes_list),
                'allowed': get_allowed_from_codes(codes_list, base_allowed)
            }
        return trip_metadata_cache[codes_key]
    
    # Current trip state
    current_trip = {
        'codes': [], 'weight': 0, 'cube': 0, 'drops': 0,
        'region': None, 'allowed_vehicles': ['4W', 'JB', '6W'],
        'district': None, 'is_punthai': False
    }
    
    overflow_queue = []  # Queue ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö stores ‡∏ó‡∏µ‡πà overflow
    
    def finalize_current_trip(force=False, near_buffer=False):
        """
        ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        
        Args:
            force (bool): ‡∏ñ‡πâ‡∏≤ True ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤ utilization ‡∏à‡∏∞‡∏ï‡πà‡∏≥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
            near_buffer (bool): ‡∏ñ‡πâ‡∏≤ True ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ñ‡∏∂‡∏á buffer (‚â•85%)
        
        Returns:
            bool: True ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, False ‡∏ñ‡πâ‡∏≤ utilization ‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á buffer ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà force
        """
        nonlocal trip_counter
        if current_trip['codes']:
            # üìä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì utilization ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏¥‡∏î
            limits = get_max_limits(current_trip['allowed_vehicles'], current_trip['is_punthai'])
            weight_util = (current_trip['weight'] / limits['max_w']) * 100 if limits['max_w'] > 0 else 0
            cube_util = (current_trip['cube'] / limits['max_c']) * 100 if limits['max_c'] > 0 else 0
            
            # üéØ ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ max(‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å, ‡∏Ñ‡∏¥‡∏ß) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô CONSISTENT ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö
            # - ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô limiting factor (‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤) ‚Üí ‡∏ó‡∏∏‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
            # - ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏õ‡πá‡∏ô limiting factor (‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤) ‚Üí ‡∏ó‡∏∏‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏ß
            max_util = max(weight_util, cube_util)
            limiting_factor = '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å' if weight_util > cube_util else '‡∏Ñ‡∏¥‡∏ß'
            
            # üéØ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì buffer threshold (100% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Punthai, 110% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Maxmart)
            buffer_mult = punthai_buffer if current_trip['is_punthai'] else maxmart_buffer
            buffer_threshold = buffer_mult * 100  # 100% ‡∏´‡∏£‡∏∑‡∏≠ 110%
            near_buffer_threshold = buffer_threshold * 0.90  # 90% ‡∏Ç‡∏≠‡∏á buffer (‡πÄ‡∏ä‡πà‡∏ô 90% ‡∏´‡∏£‡∏∑‡∏´ 99%)
            
            # üö´ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100% (Hard Limit)
            if weight_util > 100.0:
                print(f"üö® Trip {trip_counter}: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô 100% ({weight_util:.1f}%) - ‡∏ï‡πâ‡∏≠‡∏á split")
                return False
            
            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if not force:
                if max_util >= buffer_threshold:
                    # ‚úÖ ‡∏ñ‡∏∂‡∏á buffer ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏î‡πâ
                    pass
                elif near_buffer and max_util >= near_buffer_threshold:
                    # ‚úÖ ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ñ‡∏∂‡∏á buffer (‚â•85%) ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ
                    print(f"‚úÖ ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}: {limiting_factor} {max_util:.1f}% ‡πÉ‡∏Å‡∏•‡πâ Buffer {buffer_threshold:.0f}% (‡∏™‡∏≤‡∏Ç‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô)")
                else:
                    print(f"üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}: {limiting_factor} {max_util:.1f}% < Buffer {buffer_threshold:.0f}%")
                    return False
            
            # ‚úÖ ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ
            if max_util < buffer_threshold:
                if near_buffer:
                    print(f"‚ö†Ô∏è Trip {trip_counter}: {limiting_factor} {max_util:.1f}% (‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô)")
                else:
                    print(f"‚ö†Ô∏è Trip {trip_counter}: {limiting_factor} {max_util:.1f}% (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ force)")
            
            for c in current_trip['codes']:
                df.loc[df['Code'] == c, 'Trip'] = trip_counter
            return True
        return False
    
    def split_until_fits(allowed_vehicles, region):
        """‡πÅ‡∏¢‡∏Å stores ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å current_trip ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏û‡∏≠‡∏î‡∏µ‡∏£‡∏ñ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô buffer) - OPTIMIZED"""
        nonlocal trip_counter, overflow_queue
        
        max_iterations = 20  # ‡∏•‡∏î‡∏à‡∏≤‡∏Å 100 ‚Üí 20 (‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡πÅ‡∏•‡πâ‡∏ß)
        iteration = 0
        prev_codes_count = len(current_trip['codes'])
        
        while iteration < max_iterations:
            iteration += 1
            # ‡πÉ‡∏ä‡πâ cached is_punthai
            is_punthai = current_trip['is_punthai']
            limits = get_max_limits(current_trip['allowed_vehicles'], is_punthai)
            buffer_mult = punthai_buffer if is_punthai else maxmart_buffer
            
            # üéØ ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡πÉ‡∏ä‡πâ max(weight, cube) utilization
            weight_util_check = (current_trip['weight'] / limits['max_w']) * 100 if limits['max_w'] > 0 else 0
            cube_util_check = (current_trip['cube'] / limits['max_c']) * 100 if limits['max_c'] > 0 else 0
            max_util_check = max(weight_util_check, cube_util_check)
            
            # üö´ STRICT: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô buffer ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            weight_ok = weight_util_check <= 100.0
            util_ok = max_util_check <= (buffer_mult * 100)
            drops_ok = current_trip['drops'] <= limits['max_d']
            
            # Early exit ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
            if weight_ok and util_ok and drops_ok:
                break
            
            # Early exit ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏™‡∏≤‡∏Ç‡∏≤
            if len(current_trip['codes']) <= 1:
                break
            
            # ‡∏ï‡∏±‡∏î store ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
            overflow_code = current_trip['codes'].pop()
            branch_data = df[df['Code'] == overflow_code]
            if branch_data.empty:
                continue  # Skip if not found
            
            overflow_weight = branch_data['Weight'].iloc[0]
            overflow_cube = branch_data['Cube'].iloc[0]
            current_trip['weight'] -= overflow_weight
            current_trip['cube'] -= overflow_cube
            current_trip['drops'] -= 1
            
            # Update metadata ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ codes ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            if len(current_trip['codes']) != prev_codes_count:
                current_trip['is_punthai'] = is_all_punthai_codes(current_trip['codes'])
                current_trip['allowed_vehicles'] = get_allowed_from_codes(current_trip['codes'], allowed_vehicles)
                prev_codes_count = len(current_trip['codes'])
            
            overflow_queue.append({
                'code': overflow_code,
                'weight': overflow_weight,
                'cube': overflow_cube,
                'region': region,
                'allowed_vehicles': allowed_vehicles
            })
    
    def process_overflow_queue():
        """‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• overflow queue - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö stores ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏ô - OPTIMIZED"""
        nonlocal trip_counter, current_trip, overflow_queue
        
        while overflow_queue:
            item = overflow_queue.pop(0)
            code = item['code']
            weight = item['weight']
            cube = item['cube']
            region = item['region']
            allowed_vehicles = item['allowed_vehicles']
            
            # ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ current_trip
            if current_trip['codes']:
                # üö® ‡πÄ‡∏ä‡πá‡∏Ñ Logistics Zone ‡πÅ‡∏•‡∏∞ Cross-Zone Violation ‡∏Å‡πà‡∏≠‡∏ô
                current_trip_df_check = df[df['Code'].isin(current_trip['codes'])]
                new_code_df_check = df[df['Code'] == code]
                
                can_add = True
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ NO_CROSS_ZONE_PAIRS
                if not current_trip_df_check.empty and not new_code_df_check.empty:
                    current_provinces = current_trip_df_check['_province'].unique()
                    new_province = new_code_df_check['_province'].iloc[0]
                    
                    for curr_prov in current_provinces:
                        if is_cross_zone_violation(curr_prov, new_province):
                            can_add = False
                            break
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ Logistics Zone
                if can_add and not current_trip_df_check.empty and not new_code_df_check.empty:
                    current_zones = current_trip_df_check['_logistics_zone'].dropna().unique()
                    new_zone = new_code_df_check['_logistics_zone'].iloc[0] if pd.notna(new_code_df_check['_logistics_zone'].iloc[0]) else None
                    
                    if len(current_zones) > 0 and new_zone:
                        current_zone = current_zones[0]
                        if current_zone != new_zone:
                            # ‡∏Ñ‡∏ô‡∏•‡∏∞‡πÇ‡∏ã‡∏ô ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                            if not can_combine_zones_by_highway(current_zone, new_zone):
                                can_add = False
                
                if can_add:
                    test_codes = current_trip['codes'] + [code]
                    test_weight = current_trip['weight'] + weight
                    test_cube = current_trip['cube'] + cube
                    test_drops = current_trip['drops'] + 1
                    test_punthai = is_all_punthai_codes(test_codes)
                    test_allowed = get_allowed_from_codes(test_codes, allowed_vehicles)
                    
                    # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                    vehicle = select_vehicle_for_load(test_weight, test_cube, test_drops, test_punthai, test_allowed, debug=False)
                    
                    if vehicle:
                        # ‡∏û‡∏≠‡∏î‡∏µ! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤
                        current_trip['codes'].append(code)
                        current_trip['weight'] = test_weight
                        current_trip['cube'] = test_cube
                        current_trip['drops'] = test_drops
                        current_trip['is_punthai'] = test_punthai
                        current_trip['allowed_vehicles'] = test_allowed
                        
                        # Double check
                        split_until_fits(allowed_vehicles, region)
                    else:
                        # ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏î‡∏µ ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏Å‡πà‡∏≤, ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                        finalize_current_trip()
                        trip_counter += 1
                        new_allowed = get_allowed_from_codes([code], allowed_vehicles)
                        current_trip = {
                            'codes': [code],
                            'weight': weight,
                            'cube': cube,
                            'drops': 1,
                            'region': region,
                            'allowed_vehicles': new_allowed,
                            'district': None,
                            'is_punthai': branch_bu_cache.get(code, False)
                        }
                else:
                    # ‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô Zone/Cross-Zone Check ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏Å‡πà‡∏≤, ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                    finalize_current_trip()
                    trip_counter += 1
                    new_allowed = get_allowed_from_codes([code], allowed_vehicles)
                    current_trip = {
                        'codes': [code],
                        'weight': weight,
                        'cube': cube,
                        'drops': 1,
                        'region': region,
                        'allowed_vehicles': new_allowed,
                        'district': None,
                        'is_punthai': branch_bu_cache.get(code, False)
                    }
            else:
                # ‡∏ó‡∏£‡∏¥‡∏õ‡∏ß‡πà‡∏≤‡∏á
                new_allowed = get_allowed_from_codes([code], allowed_vehicles)
                current_trip = {
                    'codes': [code],
                    'weight': weight,
                    'cube': cube,
                    'drops': 1,
                    'region': region,
                    'allowed_vehicles': new_allowed,
                    'district': None,
                    'is_punthai': branch_bu_cache.get(code, False)
                }
    
    # ==========================================
    # üèõÔ∏è PROVINCE-FIRST ‚Üí DISTRICT-FIRST ‚Üí SUBDISTRICT-FIRST GROUPING
    # ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    # ==========================================
    # Group by Province ‚Üí District ‚Üí Subdistrict
    province_groups = df.groupby(['_region_name', '_province'], sort=False)
    
    # Flatten to subdistrict groups but maintain province/district grouping context
    subdistrict_groups = []  # list of ((region, province, district, subdistrict), subdistrict_df)
    branches_without_subdistrict = []  # ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡∏ö‡∏•
    
    for (region, province), province_df in province_groups:
        # Sub-group by district within this province
        for district, district_df in province_df.groupby('_district', sort=False):
            # Sub-group by subdistrict within this district
            for subdistrict, subdistrict_df in district_df.groupby('_subdistrict', sort=False):
                # üö´ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏¢‡∏Å
                if not subdistrict or str(subdistrict).strip() == '' or pd.isna(subdistrict):
                    # ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö district
                    branches_without_subdistrict.append(((region, province, district, None), subdistrict_df))
                    continue
                
                # üéØ Micro-clustering: ‡πÅ‡∏¢‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 3 km
                if len(subdistrict_df) > 1:
                    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì centroid ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≥‡∏ö‡∏•
                    center_lat = subdistrict_df['_lat'].mean()
                    center_lon = subdistrict_df['_lon'].mean()
                    
                    # ‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å centroid
                    subdistrict_df = subdistrict_df.copy()
                    subdistrict_df['_dist_from_center'] = subdistrict_df.apply(
                        lambda row: haversine_distance(center_lat, center_lon, row['_lat'], row['_lon']) 
                        if row['_lat'] > 0 and row['_lon'] > 0 else 0,
                        axis=1
                    )
                    
                    # ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏Å‡∏•‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏Å‡∏• (threshold 2 km ‡∏à‡∏≤‡∏Å centroid)
                    near_branches = subdistrict_df[subdistrict_df['_dist_from_center'] <= 2.0]
                    far_branches = subdistrict_df[subdistrict_df['_dist_from_center'] > 2.0]
                    
                    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏Å‡∏•‡πâ
                    if not near_branches.empty:
                        near_branches_sorted = near_branches.sort_values(
                            ['_vehicle_priority', '_distance_from_dc'],
                            ascending=[True, False]
                        ).reset_index(drop=True)
                        subdistrict_groups.append(((region, province, district, subdistrict), near_branches_sorted))
                    
                    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏Å‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) - ‡∏ï‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢
                    if not far_branches.empty:
                        far_branches_sorted = far_branches.sort_values(
                            ['_vehicle_priority', '_distance_from_dc'],
                            ascending=[True, False]
                        ).reset_index(drop=True)
                        # ‡πÉ‡∏ä‡πâ subdistrict_far ‡πÄ‡∏õ‡πá‡∏ô key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å
                        subdistrict_groups.append(((region, province, district, f"{subdistrict}_far"), far_branches_sorted))
                else:
                    # ‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å
                    subdistrict_df_sorted = subdistrict_df.sort_values(
                        ['_vehicle_priority', '_distance_from_dc'],
                        ascending=[True, False]
                    ).reset_index(drop=True)
                    subdistrict_groups.append(((region, province, district, subdistrict), subdistrict_df_sorted))
    
    # ‡∏£‡∏ß‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡πâ‡∏≤‡∏¢ subdistrict_groups ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
    subdistrict_groups.extend(branches_without_subdistrict)
    
    # üö® IMPORTANT: Track remaining branches per province/district/subdistrict
    province_remaining = {}
    district_remaining = {}
    subdistrict_remaining = {}
    
    for (region, province), province_df in province_groups:
        province_remaining[(region, province)] = len(province_df)
        
        for district, district_df in province_df.groupby('_district', sort=False):
            district_remaining[(region, province, district)] = len(district_df)
            
            for subdistrict, subdistrict_df in district_df.groupby('_subdistrict', sort=False):
                # ‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if not subdistrict or str(subdistrict).strip() == '' or pd.isna(subdistrict):
                    continue
                subdistrict_remaining[(region, province, district, subdistrict)] = len(subdistrict_df)
    
    # üéØ Process subdistrict groups dynamically - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    processed_subdistricts = set()
    
    while len(processed_subdistricts) < len(subdistrict_groups):
        # ‡∏´‡∏≤‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ process
        remaining_groups = [g for i, g in enumerate(subdistrict_groups) if i not in processed_subdistricts]
        
        if not remaining_groups:
            break
        
        # üåç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏´‡∏£‡∏∑‡∏≠ DC ‡∏ñ‡πâ‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡∏ß‡πà‡∏≤‡∏á)
        best_idx = None
        best_distance = float('inf')
        current_zone = None
        
        if current_trip['codes']:
            # ‡∏°‡∏µ‡∏ó‡∏£‡∏¥‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏´‡∏≤‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            current_trip_df = df[df['Code'].isin(current_trip['codes'])]
            current_lat = current_trip_df['_lat'].mean()
            current_lon = current_trip_df['_lon'].mean()
            
            # ‡∏´‡∏≤ Logistics Zone ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            current_zones = current_trip_df['_logistics_zone'].dropna().unique()
            if len(current_zones) > 0:
                current_zone = current_zones[0]
            
            # üéØ ‡∏´‡∏≤‡∏ï‡∏≥‡∏ö‡∏•‡πÉ‡∏ô Zone ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
            for i, ((region, province, district, subdistrict), subdistrict_df) in enumerate(subdistrict_groups):
                if i in processed_subdistricts:
                    continue
                
                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                sub_lat = subdistrict_df['_lat'].mean()
                sub_lon = subdistrict_df['_lon'].mean()
                
                if current_lat > 0 and current_lon > 0 and sub_lat > 0 and sub_lon > 0:
                    distance = haversine_distance(current_lat, current_lon, sub_lat, sub_lon)
                    
                    # ‡πÄ‡∏ä‡πá‡∏Ñ Zone
                    sub_zones = subdistrict_df['_logistics_zone'].dropna().unique()
                    sub_zone = sub_zones[0] if len(sub_zones) > 0 else None
                    
                    # ‚≠ê ‡∏ñ‡πâ‡∏≤ Zone ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô Zone (‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)
                    if current_zone and sub_zone and current_zone == sub_zone:
                        if distance < best_distance:
                            best_distance = distance
                            best_idx = i
            
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô Zone ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏Ñ‡∏ô‡∏•‡∏∞ Zone ‡∏Å‡πá‡πÑ‡∏î‡πâ)
            if best_idx is None:
                for i, ((region, province, district, subdistrict), subdistrict_df) in enumerate(subdistrict_groups):
                    if i in processed_subdistricts:
                        continue
                    
                    sub_lat = subdistrict_df['_lat'].mean()
                    sub_lon = subdistrict_df['_lon'].mean()
                    
                    if current_lat > 0 and current_lon > 0 and sub_lat > 0 and sub_lon > 0:
                        distance = haversine_distance(current_lat, current_lon, sub_lat, sub_lon)
                        if distance < best_distance:
                            best_distance = distance
                            best_idx = i
            
            # ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î) ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ process
            if best_idx is None:
                for i in range(len(subdistrict_groups)):
                    if i not in processed_subdistricts:
                        best_idx = i
                        break
        else:
            # ‡∏ó‡∏£‡∏¥‡∏õ‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ process (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° vehicle priority ‡πÅ‡∏•‡πâ‡∏ß)
            for i in range(len(subdistrict_groups)):
                if i not in processed_subdistricts:
                    best_idx = i
                    break
        
        if best_idx is None:
            break
        
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        (region, province, district, subdistrict), subdistrict_df = subdistrict_groups[best_idx]
        processed_subdistricts.add(best_idx)
        # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Subdistrict (vectorized) - ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÑ‡∏Å‡∏• ‚Üí ‡πÉ‡∏Å‡∏•‡πâ)
        subdistrict_df = subdistrict_df.sort_values('_distance_from_dc', ascending=False).reset_index(drop=True)
        subdistrict_codes = subdistrict_df['Code'].tolist()
        subdistrict_weight = subdistrict_df['Weight'].sum()
        subdistrict_cube = subdistrict_df['Cube'].sum()
        subdistrict_drops = len(subdistrict_codes)
        
        # ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ
        # ‚úÖ ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° Master Data ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        allowed_vehicles = ['4W', 'JB', '6W']
        
        # ==========================================
        # Rule 0: Region Change ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏Å‡πà‡∏≤ + process overflow
        # ==========================================
        if current_trip['region'] and current_trip['region'] != region:
            process_overflow_queue()
            finalize_current_trip()
            trip_counter += 1
            current_trip = {
                'codes': [], 'weight': 0, 'cube': 0, 'drops': 0,
                'region': None, 'allowed_vehicles': allowed_vehicles,
                'district': None, 'is_punthai': False
            }
        
        # ==========================================
        # Rule 1: ‡∏•‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ó‡∏±‡πâ‡∏á Subdistrict - STRICT SUBDISTRICT GROUPING
        # üéØ ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏≥‡∏ö‡∏•
        # ==========================================
        if current_trip['codes']:
            current_trip_df = df[df['Code'].isin(current_trip['codes'])]
            allow_merge = True
            force_finalize = False
            
            # üèõÔ∏è Hierarchical: ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            current_province = current_trip_df['_province'].iloc[0] if not current_trip_df.empty else None
            current_district = current_trip_df['_district'].iloc[0] if not current_trip_df.empty else None
            current_subdistrict = current_trip_df['_subdistrict'].iloc[0] if not current_trip_df.empty else None
            
            # 1Ô∏è‚É£ ‡∏ï‡∏≥‡∏ö‡∏•: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ï‡∏≥‡∏ö‡∏•‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Üí ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ
            if current_subdistrict and current_subdistrict != subdistrict:
                subdistrict_key = (region, current_province, current_district, current_subdistrict)
                if subdistrict_remaining.get(subdistrict_key, 0) > 0:
                    force_finalize = True
                    allow_merge = False
            
            # 2Ô∏è‚É£ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏•‡∏∞‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°
            if allow_merge and current_district and current_district != district:
                district_key = (region, current_province, current_district)
                if district_remaining.get(district_key, 0) > 0:
                    allow_merge = False
            
            # 3Ô∏è‚É£ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°
            if allow_merge and current_province and current_province != province:
                province_key = (region, current_province)
                if province_remaining.get(province_key, 0) > 0:
                    allow_merge = False
                elif is_cross_zone_violation(current_province, province):
                    allow_merge = False
                else:
                    # ‡πÄ‡∏ä‡πá‡∏Ñ Logistics Zone ‡∏Å‡πà‡∏≠‡∏ô
                    current_zone = get_logistics_zone(current_province, '', '')
                    new_zone = get_logistics_zone(province, '', '')
                    if current_zone and new_zone and current_zone != new_zone:
                        if not can_combine_zones_by_highway(current_zone, new_zone):
                            allow_merge = False
                        else:
                            # ‡πÄ‡∏ä‡πá‡∏Ñ proximity
                            if not check_geographic_proximity(current_trip_df, subdistrict_df):
                                allow_merge = False
                    else:
                        # Zone ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ proximity
                        if not check_geographic_proximity(current_trip_df, subdistrict_df):
                            allow_merge = False
            
            # 4Ô∏è‚É£ Logistics Zone: ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏ã‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á
            if allow_merge:
                current_zones = df[df['Code'].isin(current_trip['codes'])]['_logistics_zone'].dropna().unique()
                new_zones = subdistrict_df['_logistics_zone'].dropna().unique()
                if len(current_zones) > 0 and len(new_zones) > 0:
                    if current_zones[0] != new_zones[0] and not can_combine_zones_by_highway(current_zones[0], new_zones[0]):
                        allow_merge = False
            
            if allow_merge:
                test_codes = current_trip['codes'] + subdistrict_codes
                test_weight = current_trip['weight'] + subdistrict_weight
                test_cube = current_trip['cube'] + subdistrict_cube
                test_drops = current_trip['drops'] + subdistrict_drops
                test_punthai = is_all_punthai_codes(test_codes)
                test_allowed = get_allowed_from_codes(test_codes, allowed_vehicles)
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏û‡∏≠‡∏î‡∏µ‡∏ó‡∏±‡πâ‡∏á spread ‡πÅ‡∏•‡∏∞ load
                vehicle = select_vehicle_for_load(test_weight, test_cube, test_drops, test_punthai, test_allowed, debug=False) if check_intra_trip_spread(test_codes) else None
            else:
                vehicle = None
            
            # üî• ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á force_finalize (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠) ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
            if force_finalize:
                finalize_current_trip()
                trip_counter += 1
                
                # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ subdistrict ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                new_allowed = get_allowed_from_codes(subdistrict_codes, allowed_vehicles)
                new_punthai = is_all_punthai_codes(subdistrict_codes)
                
                current_trip = {
                    'codes': subdistrict_codes.copy(),
                    'weight': subdistrict_weight,
                    'cube': subdistrict_cube,
                    'drops': subdistrict_drops,
                    'region': region,
                    'allowed_vehicles': new_allowed,
                    'district': district,
                    'is_punthai': new_punthai
                }
                
                # üìä Update remaining counters
                province_key = (region, province)
                district_key = (region, province, district)
                subdistrict_key = (region, province, district, subdistrict)
                if subdistrict_key in subdistrict_remaining:
                    subdistrict_remaining[subdistrict_key] -= subdistrict_drops
                if district_key in district_remaining:
                    district_remaining[district_key] -= subdistrict_drops
                if province_key in province_remaining:
                    province_remaining[province_key] -= subdistrict_drops
                
                split_until_fits(allowed_vehicles, region)
            elif vehicle and allow_merge:
                # Subdistrict ‡∏û‡∏≠‡∏î‡∏µ!
                current_trip['codes'].extend(subdistrict_codes)
                current_trip['weight'] = test_weight
                current_trip['cube'] = test_cube
                current_trip['drops'] = test_drops
                current_trip['allowed_vehicles'] = test_allowed
                current_trip['region'] = region
                current_trip['is_punthai'] = test_punthai
                
                # üìä Update remaining counters (subdistrict ‚Üí district ‚Üí province)
                province_key = (region, province)
                district_key = (region, province, district)
                subdistrict_key = (region, province, district, subdistrict)
                if subdistrict_key in subdistrict_remaining:
                    subdistrict_remaining[subdistrict_key] -= subdistrict_drops
                if district_key in district_remaining:
                    district_remaining[district_key] -= subdistrict_drops
                if province_key in province_remaining:
                    province_remaining[province_key] -= subdistrict_drops
                
                # üö´ CRITICAL: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô buffer ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°
                split_until_fits(test_allowed, region)
            else:
                # Subdistrict ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏î‡∏µ ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô, ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                finalize_current_trip()
                trip_counter += 1
                
                new_allowed = get_allowed_from_codes(subdistrict_codes, allowed_vehicles)
                new_punthai = is_all_punthai_codes(subdistrict_codes)
                
                current_trip = {
                    'codes': subdistrict_codes.copy(),
                    'weight': subdistrict_weight,
                    'cube': subdistrict_cube,
                    'drops': subdistrict_drops,
                    'region': region,
                    'allowed_vehicles': new_allowed,
                    'district': district,
                    'is_punthai': new_punthai
                }
                
                # üìä Update remaining counters
                province_key = (region, province)
                district_key = (region, province, district)
                subdistrict_key = (region, province, district, subdistrict)
                if subdistrict_key in subdistrict_remaining:
                    subdistrict_remaining[subdistrict_key] -= subdistrict_drops
                if district_key in district_remaining:
                    district_remaining[district_key] -= subdistrict_drops
                if province_key in province_remaining:
                    province_remaining[province_key] -= subdistrict_drops
                
                # ==========================================
                # Rule 2: ‡∏ñ‡πâ‡∏≤ Subdistrict ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡∏ñ ‚Üí Split ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
                # ==========================================
                split_until_fits(allowed_vehicles, region)
        else:
            # ‡∏ó‡∏£‡∏¥‡∏õ‡∏ß‡πà‡∏≤‡∏á - ‡∏´‡∏≤ allowed_vehicles ‡∏£‡∏ß‡∏° branch constraints (‡πÉ‡∏ä‡πâ cache)
            new_allowed = get_allowed_from_codes(subdistrict_codes, allowed_vehicles)
            new_punthai = is_all_punthai_codes(subdistrict_codes)
            
            current_trip = {
                'codes': subdistrict_codes.copy(),
                'weight': subdistrict_weight,
                'cube': subdistrict_cube,
                'drops': subdistrict_drops,
                'region': region,
                'allowed_vehicles': new_allowed,
                'district': district,
                'is_punthai': new_punthai
            }
            
            # üìä Update remaining counters
            province_key = (region, province)
            district_key = (region, province, district)
            subdistrict_key = (region, province, district, subdistrict)
            if subdistrict_key in subdistrict_remaining:
                subdistrict_remaining[subdistrict_key] -= subdistrict_drops
            if district_key in district_remaining:
                district_remaining[district_key] -= subdistrict_drops
            if province_key in province_remaining:
                province_remaining[province_key] -= subdistrict_drops
            
            # ==========================================
            # Rule 2: ‡∏ñ‡πâ‡∏≤ District ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡∏ñ ‚Üí Split ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
            # ==========================================
            split_until_fits(new_allowed, region)
    
    # ==========================================
    # Final: Process remaining overflow ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
    # ==========================================
    process_overflow_queue()
    finalize_current_trip(force=True)  # ‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î
    
    # üö® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ
    unassigned_branches = df[df['Trip'] == 0]
    if len(unassigned_branches) > 0:
        print(f"\n‚ö†Ô∏è ‡∏û‡∏ö {len(unassigned_branches)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ:")
        print(unassigned_branches[['Code', 'Name', 'Weight', 'Cube', '_province', '_district', '_max_vehicle']].head(20))
        print("\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:")
        print("1. ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ (MaxVehicle) ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ")
        print("2. Zone conflict ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ")
        print("3. ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏Ñ‡∏¥‡∏ß ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î")
        print("4. Overflow queue ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å process ‡∏´‡∏°‡∏î")
    else:
        print(f"\n‚úÖ ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤!")

    # ==========================================
    # Step 6.5: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÑ‡∏Å‡∏• ‚Üí ‡πÉ‡∏Å‡∏•‡πâ)
    # ==========================================
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ
    trip_avg_distances = {}
    for trip_num in df[df['Trip'] > 0]['Trip'].unique():
        trip_data = df[df['Trip'] == trip_num]
        avg_dist = trip_data['_distance_from_dc'].mean()
        trip_avg_distances[trip_num] = avg_dist
    
    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÑ‡∏Å‡∏• ‚Üí ‡πÉ‡∏Å‡∏•‡πâ)
    sorted_trips = sorted(trip_avg_distances.items(), key=lambda x: x[1], reverse=True)
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping ‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà
    trip_mapping = {old_num: new_num for new_num, (old_num, _) in enumerate(sorted_trips, start=1)}
    
    # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà
    df['Trip'] = df['Trip'].map(lambda x: trip_mapping.get(x, x) if x > 0 else x)

    # ==========================================
    # Step 7: ‡∏™‡∏£‡πâ‡∏≤‡∏á Summary + Central Rule + Punthai Drop Limits
    # ==========================================
    summary_data = []
    
    for trip_num in sorted(df['Trip'].unique()):
        if trip_num == 0:
            continue
        
        trip_data = df[df['Trip'] == trip_num]
        total_w = trip_data['Weight'].sum()
        total_c = trip_data['Cube'].sum()
        trip_codes = trip_data['Code'].unique()
        trip_drops = len(trip_codes)
        
        # ‡∏´‡∏≤‡∏†‡∏≤‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ (‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏Ñ‡πÅ‡∏£‡∏Å)
        trip_region = trip_data['_region_name'].iloc[0] if '_region_name' in trip_data.columns else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
        
        # ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° Master Data ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        max_vehicles = [get_max_vehicle_for_branch(c) for c in trip_codes]
        min_max_size = min(vehicle_priority.get(v, 3) for v in max_vehicles)
        max_allowed_vehicle = {1: '4W', 2: 'JB', 3: '6W'}.get(min_max_size, '6W')
        
        # ‡∏ï‡∏£‡∏ß‡∏à BU ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ
        is_punthai_only_trip = True
        for _, r in trip_data.iterrows():
            bu = str(r.get('BU', '')).upper()
            if bu not in ['211', 'PUNTHAI']:
                is_punthai_only_trip = False
                break
        
        buffer = punthai_buffer if is_punthai_only_trip else maxmart_buffer
        buffer_pct = int(buffer * 100)
        buffer_label = f"üÖøÔ∏è {buffer_pct}%" if is_punthai_only_trip else f"üÖº {buffer_pct}%"
        trip_type = 'punthai' if is_punthai_only_trip else 'maxmart'
        
        # üöõ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà:
        # 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å MaxVehicle ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
        # 2. ‡πÄ‡∏ä‡πá‡∏Ñ Cube ‚â• Buffer (100%/110%) ‡∏´‡∏£‡∏∑‡∏≠ Weight ‚â• 100%
        # 3. ‡πÄ‡∏ä‡πá‡∏Ñ Weight ‚â§ 100% (hard limit)
        # 4. ‡πÄ‡∏ä‡πá‡∏Ñ Drops ‚â§ 12 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4W/JB ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Punthai ‡∏•‡πâ‡∏ß‡∏ô)
        # 5. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡∏Ç‡∏∂‡πâ‡∏ô
        
        suggested = max_allowed_vehicle
        source = "üìã MaxVehicle" if min_max_size < 3 else "ü§ñ Auto"
        
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å LIMITS ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó BU
        limits_to_use = PUNTHAI_LIMITS if is_punthai_only_trip else LIMITS
        
        # ===============================================
        # ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏±‡∏ô ‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡πá‡∏Å‡πÑ‡∏õ‡πÉ‡∏´‡∏ç‡πà
        # ===============================================
        attempts = 0
        max_attempts = 3  # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô infinite loop
        
        while attempts < max_attempts:
            attempts += 1
            
            if suggested not in LIMITS:
                break
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            w_pct = (total_w / LIMITS[suggested]['max_w']) * 100
            c_pct = (total_c / LIMITS[suggested]['max_c']) * 100
            
            # ‡πÄ‡∏ä‡πá‡∏Ñ Drops limit
            if is_punthai_only_trip:
                # Punthai ‡∏•‡πâ‡∏ß‡∏ô: ‡πÉ‡∏ä‡πâ PUNTHAI_LIMITS (4W:5, JB:7, 6W:999)
                max_drops_allowed = limits_to_use[suggested]['max_drops']
            else:
                # Maxmart/‡∏ú‡∏™‡∏°: 4W ‡πÅ‡∏•‡∏∞ JB ‚â§ 12, 6W ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
                if suggested in ['4W', 'JB']:
                    max_drops_allowed = 12
                else:
                    max_drops_allowed = 999
            
            drops_ok = trip_drops <= max_drops_allowed
            
            # ===== ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç =====
            # 1. Cube ‚â§ Buffer (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô)
            cube_buffer_ok = c_pct <= (buffer * 100)
            
            # 2. Weight ‚â§ 100% (hard limit ‡πÄ‡∏™‡∏°‡∏≠)
            weight_hard_ok = w_pct <= 100
            
            # 3. Drops OK
            # 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ)
            #    - Cube ‚â• Buffer ‡∏´‡∏£‡∏∑‡∏≠
            #    - Weight ‚â• 100%
            # (‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô finalize_current_trip ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            
            # ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‚Üí ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ô‡∏µ‡πâ
            if cube_buffer_ok and weight_hard_ok and drops_ok:
                # ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà optimize ‡∏ï‡∏≤‡∏° MIN_UTIL - ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏° Master Data ‡πÅ‡∏•‡∏∞ Buffer ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                break
            
            # ===== ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ =====
            if not cube_buffer_ok:
                # Cube ‡πÄ‡∏Å‡∏¥‡∏ô buffer
                if suggested == '4W' and min_max_size >= 2:
                    suggested = 'JB'
                    source = "‚¨ÜÔ∏è Cube Buffer"
                    continue
                elif suggested == 'JB' and min_max_size >= 3:
                    suggested = '6W'
                    source = "‚¨ÜÔ∏è Cube Buffer"
                    continue
                else:
                    # ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
                    break
            
            elif not weight_hard_ok:
                # Weight ‡πÄ‡∏Å‡∏¥‡∏ô 100%
                if suggested == '4W' and min_max_size >= 2:
                    suggested = 'JB'
                    source = "üö® Weight 100%"
                    continue
                elif suggested == 'JB' and min_max_size >= 3:
                    suggested = '6W'
                    source = "üö® Weight 100%"
                    continue
                else:
                    # ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
                    break
            
            elif not drops_ok:
                # Drops ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î
                if suggested == '4W' and min_max_size >= 2:
                    suggested = 'JB'
                    source = "üîí Drops Limit"
                    continue
                elif suggested == 'JB' and min_max_size >= 3:
                    suggested = '6W'
                    source = "üîí Drops Limit"
                    continue
                else:
                    # ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
                    break
            
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏î‡πÜ ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏´‡∏¢‡∏∏‡∏î
            break
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì utilization ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        if suggested in LIMITS:
            w_util = (total_w / LIMITS[suggested]['max_w']) * 100
            c_util = (total_c / LIMITS[suggested]['max_c']) * 100
        else:
            w_util = c_util = 0
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°
        total_distance = 0
        branch_coords = []
        for code in trip_codes:
            loc = location_map.get(str(code).upper(), {})
            if loc.get('lat') and loc.get('lon'):
                branch_coords.append((loc['lat'], loc['lon']))
        
        if branch_coords:
            # DC ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å
            total_distance += haversine_distance(DC_WANG_NOI_LAT, DC_WANG_NOI_LON, branch_coords[0][0], branch_coords[0][1])
            # ‡∏™‡∏≤‡∏Ç‡∏≤ ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤
            for i in range(len(branch_coords) - 1):
                total_distance += haversine_distance(branch_coords[i][0], branch_coords[i][1], branch_coords[i+1][0], branch_coords[i+1][1])
            # ‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‚Üí DC
            total_distance += haversine_distance(branch_coords[-1][0], branch_coords[-1][1], DC_WANG_NOI_LAT, DC_WANG_NOI_LON)
        
        summary_data.append({
            'Trip': trip_num,
            'Branches': len(trip_codes),
            'Weight': total_w,
            'Cube': total_c,
            'Truck': f"{suggested} {source}",
            'BU_Type': trip_type,
            'Buffer': buffer_label,
            'Weight_Use%': w_util,
            'Cube_Use%': c_util,
            'Total_Distance': round(total_distance, 1)
        })
    
    summary_df = pd.DataFrame(summary_data)
    
    # ==========================================
    # Step 8: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°
    # ==========================================
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏ñ
    trip_truck_map = {}
    for _, row in summary_df.iterrows():
        trip_truck_map[row['Trip']] = row['Truck']
    df['Truck'] = df['Trip'].map(trip_truck_map)
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Region
    df['Region'] = df['_region_name']
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Province/District/Subdistrict (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
    if 'Province' not in df.columns:
        df['Province'] = df['_province']
    if 'District' not in df.columns:
        df['District'] = df['_district']
    if 'Subdistrict' not in df.columns:
        df['Subdistrict'] = df['_subdistrict']
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å DC
    df['Distance_from_DC'] = df['_distance_from_dc'].round(1)
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå MaxVehicle constraint
    df['MaxVehicle'] = df['_max_vehicle']
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏ñ
    df['VehicleCheck'] = '‚úÖ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'
    
    # ==========================================
    # Step 9: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö export)
    # ==========================================
    df = df.sort_values(['Trip', '_distance_from_dc'], ascending=[True, False]).reset_index(drop=True)
    
    # ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÄ‡∏Å‡πá‡∏ö _province, _district, _subdistrict, _max_vehicle ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)
    cols_to_drop = ['_region_code', '_region_name', '_prov_code', '_dist_code', '_subdist_code', '_route', '_distance_from_dc', '_group_key', '_region_order', '_prov_max_dist', '_dist_max_dist', '_region_allowed_vehicles', '_vehicle_priority', '_lat', '_lon']
    df = df.drop(columns=[c for c in cols_to_drop if c in df.columns], errors='ignore')
    
    return df, summary_df
def main():
    st.set_page_config(
        page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß",
        page_icon="üöö",
        layout="wide",
        initial_sidebar_state="collapsed"
    )
    
 
    if AUTOREFRESH_AVAILABLE:
        now = datetime.now()
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (00:00:00)
        midnight = datetime.combine(now.date(), datetime_time(0, 0, 0))
        
        # ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô ‡πÄ‡∏≠‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        if now < midnight:
            next_midnight = midnight
        else:
            next_midnight = midnight + timedelta(days=1)
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
        seconds_until_midnight = int((next_midnight - now).total_seconds())
        
        # Refresh ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ autorefresh)
        if AUTOREFRESH_AVAILABLE and seconds_until_midnight > 0:
            # ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (‡∏´‡∏•‡∏±‡∏á 23:55)
            if seconds_until_midnight <= 300:  # 5 minutes
                st.info(f"üîÑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ Refresh ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô {seconds_until_midnight // 60} ‡∏ô‡∏≤‡∏ó‡∏µ")
                st_autorefresh(interval=seconds_until_midnight * 1000, key="midnight_refresh")
            else:
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                st_autorefresh(interval=3600000, limit=24, key="hourly_check")
    
    # Header
    col1, col2 = st.columns([3, 1])
    with col1:
        st.title("üöö ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß - Route Optimizer")
    with col2:
        st.image("https://raw.githubusercontent.com/twitter/twemoji/master/assets/svg/1f69a.svg", width=100)
    
    # üìä Status Bar - ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
    status_cols = st.columns([2, 2, 1])
    with status_cols[0]:
        if SHEETS_AVAILABLE:
            st.info("üìä **Google Sheets:** ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à | Auto-sync ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ", icon="‚úÖ")
        else:
            st.warning("üìä **Data Source:** branch_data.json (cache)", icon="‚ö†Ô∏è")
    with status_cols[1]:
        st.metric("üìç Master Data", f"{len(MASTER_DATA):,} ‡∏™‡∏≤‡∏Ç‡∏≤", delta="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß", delta_color="off")
    with status_cols[2]:
        st.metric("üîÑ Buffer", "100%/110%", delta="Pun/Max", delta_color="off")
    
    st.markdown("---")
    
    # ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
    model_data = load_model()
    
    if not model_data:
        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
        st.info("üí° ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: `python test_model.py`")
        st.stop()
    
    # ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    st.markdown("### üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå")
    uploaded_file = st.file_uploader(
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)", 
        type=['xlsx'],
        help="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"
    )
    
    if uploaded_file:
        # ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô session_state ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô export
        uploaded_file_content = uploaded_file.read()
        st.session_state['original_file_content'] = uploaded_file_content
        
        with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."):
            df = load_excel(uploaded_file_content)
            df = process_dataframe(df)
            
            if df is not None and 'Code' in df.columns:
                st.success(f"‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: **{len(df):,}** ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                col1, col2, col3, col4 = st.columns(4)
                with col1:
                    st.metric("üìç ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤", f"{df['Code'].nunique():,}")
                with col2:
                    st.metric("‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°", f"{df['Weight'].sum():,.0f} kg")
                with col3:
                    st.metric("üì¶ ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°", f"{df['Cube'].sum():.1f} m¬≥")
                with col4:
                    provinces = df['Province'].nunique() if 'Province' in df.columns else 0
                    st.metric("üó∫Ô∏è ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", f"{provinces}")
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                with st.expander("üîç ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á"):
                    st.dataframe(df.head(10), use_container_width=True)
                
                # ==========================================
                # ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Master (‡∏ó‡∏≥‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
                # ==========================================
                if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
                    # ‡∏™‡∏£‡πâ‡∏≤‡∏á dict ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡πá‡∏ß
                    master_lookup = {}
                    for _, row in MASTER_DATA.iterrows():
                        code = str(row['Plan Code']).strip().upper()
                        master_lookup[code] = {
                            'province': row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', ''),
                            'district': row.get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', ''),
                            'subdistrict': row.get('‡∏ï‡∏≥‡∏ö‡∏•', ''),
                            'lat': row.get('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0),
                            'lon': row.get('‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0)
                        }
                    
                    # ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
                    filled_count = 0
                    for idx, row in df.iterrows():
                        code = str(row['Code']).strip().upper()
                        if code in master_lookup:
                            master_info = master_lookup[code]
                            # ‡πÄ‡∏ï‡∏¥‡∏° Province ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
                            if 'Province' not in df.columns or pd.isna(df.loc[idx, 'Province']) or df.loc[idx, 'Province'] == '' or df.loc[idx, 'Province'] == 'UNKNOWN':
                                if master_info['province']:
                                    df.loc[idx, 'Province'] = master_info['province']
                                    filled_count += 1
                            # ‡πÄ‡∏ï‡∏¥‡∏° District ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
                            if 'District' not in df.columns:
                                df['District'] = ''
                            if pd.isna(df.loc[idx, 'District']) or df.loc[idx, 'District'] == '':
                                if master_info['district']:
                                    df.loc[idx, 'District'] = master_info['district']
                            # ‡πÄ‡∏ï‡∏¥‡∏° Subdistrict ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
                            if 'Subdistrict' not in df.columns:
                                df['Subdistrict'] = ''
                            if pd.isna(df.loc[idx, 'Subdistrict']) or df.loc[idx, 'Subdistrict'] == '':
                                if master_info['subdistrict']:
                                    df.loc[idx, 'Subdistrict'] = master_info['subdistrict']
                    
                    if filled_count > 0:
                        st.info(f"üìç ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Master ‡πÅ‡∏•‡πâ‡∏ß {filled_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
                
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
                if 'Province' in df.columns:
                    missing_df = df[(df['Province'].isna()) | (df['Province'] == '') | (df['Province'] == 'UNKNOWN')]
                    if len(missing_df) > 0:
                        st.warning(f"‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏°‡∏µ {len(missing_df)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô Master")
                        with st.expander("üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
                            missing_codes = missing_df['Code'].tolist()
                            st.write(f"**‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤:** {', '.join(map(str, missing_codes))}")
                            if 'Name' in missing_df.columns:
                                for idx, row in missing_df.iterrows():
                                    st.write(f"- {row['Code']}: {row.get('Name', 'N/A')}")
                
                st.markdown("---")
                
                # ‡πÅ‡∏ó‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å
                tab1, tab2 = st.tabs([
                    "üì¶ ‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß (‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)", 
                    "üó∫Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ"
                ])
                    
                # ==========================================
                # ‡πÅ‡∏ó‡πá‡∏ö 1: ‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß (‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)
                # ==========================================
                with tab1:
                    # ‡πÄ‡∏û‡∏¥‡πà‡∏° Region ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                    if 'Region' not in df.columns and 'Province' in df.columns:
                        df['Region'] = df['Province'].apply(get_region_name)
                    
                    # ==========================================
                    # ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    # ==========================================
                    st.markdown("#### ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ")
                    
                    # ‡∏Å‡∏£‡∏≠‡∏Å Buffer ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                    col_buf1, col_buf2 = st.columns(2)
                    
                    with col_buf1:
                        punthai_buffer = st.number_input(
                            "üÖøÔ∏è Punthai Buffer %",
                            min_value=80,
                            max_value=120,
                            value=100,
                            step=5
                        )
                    
                    with col_buf2:
                        maxmart_buffer = st.number_input(
                            "üÖº Maxmart/‡∏ú‡∏™‡∏° Buffer %",
                            min_value=80,
                            max_value=150,
                            value=110,
                            step=5
                        )
                    
                    # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô buffer value
                    punthai_buffer_value = punthai_buffer / 100.0
                    maxmart_buffer_value = maxmart_buffer / 100.0
                    
                    st.markdown("---")
                    
                    # ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ
                    if st.button("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", type="primary", use_container_width=True):
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á status container ‡πÅ‡∏ö‡∏ö popup
                        with st.status("üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...", expanded=True) as status:
                            # Progress bar
                            progress_bar = st.progress(0)
                            status_text = st.empty()
                            
                            status_text.write("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
                            progress_bar.progress(10)
                            
                            # ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•/Route (‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô predict_trips)
                            df_to_process = df.copy()
                            
                            status_text.write("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°... (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 10-30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")
                            progress_bar.progress(20)
                            
                            import time as time_module
                            start_time = time_module.time()
                            
                            # ‡∏™‡πà‡∏á buffer ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° BU
                            result_df, summary = predict_trips(
                                df_to_process, 
                                model_data, 
                                punthai_buffer=punthai_buffer_value,
                                maxmart_buffer=maxmart_buffer_value
                            )
                            
                            elapsed_time = time_module.time() - start_time
                            progress_bar.progress(90)
                            
                            # üíæ ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô session_state ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô export
                            st.session_state['trip_result'] = result_df
                            st.session_state['trip_summary'] = summary
                            st.session_state['trip_buffers'] = {
                                'punthai': punthai_buffer_value,
                                'maxmart': maxmart_buffer_value
                            }
                            
                            progress_bar.progress(100)
                            status_text.write(f"‚úÖ ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ {elapsed_time:.1f} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")
                            status.update(label=f"‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! ({elapsed_time:.1f}s)", state="complete", expanded=False)
                    
                    # üìä ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô session_state
                    if 'trip_result' in st.session_state and 'trip_summary' in st.session_state:
                        result_df = st.session_state['trip_result']
                        summary = st.session_state['trip_summary']
                        
                        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ (Trip = 0)
                        unassigned_count = len(result_df[result_df['Trip'] == 0])
                        if unassigned_count > 0:
                            st.warning(f"‚ö†Ô∏è ‡∏°‡∏µ {unassigned_count} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ (Trip = 0)")
                        
                        # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                        assigned_df = result_df[result_df['Trip'] > 0].copy()
                        
                        st.balloons()
                        st.success(f"‚úÖ **‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!** ‡∏£‡∏ß‡∏° **{len(summary)}** ‡∏ó‡∏£‡∏¥‡∏õ ({len(assigned_df)} ‡∏™‡∏≤‡∏Ç‡∏≤)")
                        
                        st.markdown("---")
                        
                        # ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
                        st.markdown("### üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ")
                        
                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric("üöö ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ", len(summary))
                        with col2:
                            st.metric("üìç ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤", len(assigned_df))
                        with col3:
                            avg_branches = len(assigned_df) / max(1, assigned_df['Trip'].nunique())
                            st.metric("üìä ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ó‡∏£‡∏¥‡∏õ", f"{avg_branches:.1f}")
                        with col4:
                            avg_util = summary['Cube_Use%'].mean() if len(summary) > 0 else 0
                            st.metric("üìà ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", f"{avg_util:.0f}%")
                        
                        buffers = st.session_state.get('trip_buffers', {'punthai': 1.0, 'maxmart': 1.1})
                        st.info(f"üí° ‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏° Buffer ({int(buffers['punthai']*100)}% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Punthai, {int(buffers['maxmart']*100)}% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Maxmart)")
                        
                        st.markdown("---")
                        
                        # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ
                        st.markdown("### üöõ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ")
                        
                        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ summary ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        format_dict = {}
                        gradient_cols = []
                        
                        if 'Weight' in summary.columns:
                            format_dict['Weight'] = '{:.2f}'
                        if 'Cube' in summary.columns:
                            format_dict['Cube'] = '{:.2f}'
                        if 'Weight_Use%' in summary.columns:
                            format_dict['Weight_Use%'] = '{:.1f}%'
                            gradient_cols.append('Weight_Use%')
                        if 'Cube_Use%' in summary.columns:
                            format_dict['Cube_Use%'] = '{:.1f}%'
                            gradient_cols.append('Cube_Use%')
                        if 'Total_Distance' in summary.columns:
                            format_dict['Total_Distance'] = '{:.1f} km'
                        
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á styled dataframe
                        if format_dict:
                            styled_df = summary.style.format(format_dict)
                            if gradient_cols:
                                styled_df = styled_df.background_gradient(
                                    subset=gradient_cols,
                                    cmap='RdYlGn',
                                    vmin=0,
                                    vmax=100
                                )
                            st.dataframe(styled_df, use_container_width=True, height=400)
                        else:
                            st.dataframe(summary, use_container_width=True, height=400)
                        
                        # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)
                        with st.expander("üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)"):
                            # ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                            display_cols = ['Trip', 'Code', 'Name']
                            if 'Province' in result_df.columns:
                                display_cols.append('Province')
                            if 'Region' in result_df.columns:
                                display_cols.append('Region')
                            display_cols.extend(['Max_Distance_in_Trip', 'Weight', 'Cube', 'Truck', 'VehicleCheck'])
                            
                            # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
                            display_cols = [col for col in display_cols if col in result_df.columns]
                            display_df = result_df[display_cols].copy()
                            
                            # ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
                            col_names = {'Trip': '‡∏ó‡∏£‡∏¥‡∏õ', 'Code': '‡∏£‡∏´‡∏±‡∏™', 'Name': '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤', 'Province': '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', 
                                       'Region': '‡∏†‡∏≤‡∏Ñ', 'Max_Distance_in_Trip': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á Max(km)', 
                                       'Weight': '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å(kg)', 'Cube': '‡∏Ñ‡∏¥‡∏ß(m¬≥)', 'Truck': '‡∏£‡∏ñ', 'VehicleCheck': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏ñ'}
                            display_df.columns = [col_names.get(c, c) for c in display_cols]
                            
                            # ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
                            st.dataframe(
                                display_df.style.format({
                                    '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(km)': '{:.1f}',
                                    '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å(kg)': '{:.2f}',
                                    '‡∏Ñ‡∏¥‡∏ß(m¬≥)': '{:.2f}'
                                }),
                                use_container_width=True, 
                                height=400
                            )
                        
                        # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                        warning_branches = result_df[result_df['VehicleCheck'].str.contains('‚ö†Ô∏è', na=False)]
                        if len(warning_branches) > 0:
                            with st.expander(f"‚ö†Ô∏è ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥ ({len(warning_branches)} ‡∏™‡∏≤‡∏Ç‡∏≤)"):
                                st.warning("‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∑‡πà‡∏ô ‡πÅ‡∏ï‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ")
                                display_cols_warn = ['Trip', 'Code', 'Name', 'Truck', 'VehicleCheck']
                                display_warn_df = warning_branches[display_cols_warn].copy()
                                display_warn_df.columns = ['‡∏ó‡∏£‡∏¥‡∏õ', '‡∏£‡∏´‡∏±‡∏™', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î', '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ']
                                st.dataframe(display_warn_df, use_container_width=True)
                        
                        st.markdown("---")
                        
                        # ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏ä‡∏µ‡∏ï 2.Punthai ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÇ‡∏ó‡∏ô‡∏™‡πâ‡∏°-‡∏Ç‡∏≤‡∏ß
                        from openpyxl import load_workbook
                        from openpyxl.styles import PatternFill, Font, Border, Side
                        
                        output = io.BytesIO()
                        
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á location_map ‡∏à‡∏≤‡∏Å MASTER_DATA
                        location_map = {}
                        if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
                            for _, row in MASTER_DATA.iterrows():
                                code = str(row.get('Plan Code', '')).strip().upper()
                                if code:
                                    location_map[code] = {
                                        '‡∏ï‡∏≥‡∏ö‡∏•': row.get('‡∏ï‡∏≥‡∏ö‡∏•', ''),
                                        '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠': row.get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', ''),
                                        '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î': row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', ''),
                                        'Route': row.get('Reference', '')
                                    }
                        
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á Trip_No map
                        trip_no_map = {}
                        vehicle_counts = {'4W': 0, '4WJ': 0, '6W': 0}
                        
                        # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á trip ‡∏ï‡∏≤‡∏° Zone Order + Province Max Dist + District Max Dist (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ)
                        ZONE_ORDER_EXPORT = {'NORTH': 1, 'NE': 2, 'SOUTH': 3, 'EAST': 4, 'WEST': 5, 'CENTRAL': 6}
                        trip_sort_keys = {}
                        
                        for trip_num in result_df['Trip'].unique():
                            if trip_num == 0:
                                continue
                            trip_data = result_df[result_df['Trip'] == trip_num]
                            
                            # ‡∏´‡∏≤ Region Order
                            region = trip_data['Region'].iloc[0] if 'Region' in trip_data.columns else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                            region_order = ZONE_ORDER_EXPORT.get(region, 99)
                            
                            # ‡∏´‡∏≤ Province Max Distance ‡πÅ‡∏•‡∏∞ District Max Distance
                            prov_max_dist = 0
                            dist_max_dist = 0
                            
                            for code in trip_data['Code'].unique():
                                loc = location_map.get(str(code).upper(), {})
                                # ‡∏î‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å MASTER_DATA
                                if not MASTER_DATA.empty:
                                    master_row = MASTER_DATA[MASTER_DATA['Plan Code'].astype(str).str.upper() == str(code).upper()]
                                    if len(master_row) > 0:
                                        dist_km = master_row.iloc[0].get('Distance from DC (km)', 0)
                                        if pd.notna(dist_km):
                                            prov_max_dist = max(prov_max_dist, float(dist_km))
                                            dist_max_dist = max(dist_max_dist, float(dist_km))
                            
                            # Sort key: Region Order (Asc), Prov Max Dist (Desc), Dist Max Dist (Desc)
                            # ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ sort Desc
                            trip_sort_keys[trip_num] = (region_order, -prov_max_dist, -dist_max_dist)
                        
                        # Sort: Zone Order ‚Üí Province Max Dist (‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô) ‚Üí District Max Dist (‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô)
                        sorted_trips = sorted(
                            [t for t in result_df['Trip'].unique() if t != 0],
                            key=lambda t: trip_sort_keys.get(t, (99, 0, 0))
                        )
                        
                        for trip_num in sorted_trips:
                            trip_summary = summary[summary['Trip'] == trip_num]
                            if len(trip_summary) > 0:
                                truck_info = trip_summary.iloc[0]['Truck']
                                vehicle_type = truck_info.split()[0] if truck_info else '6W'
                                # JB ‡πÉ‡∏ä‡πâ prefix 4WJ
                                if vehicle_type == 'JB':
                                    vehicle_type = '4WJ'
                                vehicle_counts[vehicle_type] = vehicle_counts.get(vehicle_type, 0) + 1
                                trip_no = f"{vehicle_type}{vehicle_counts[vehicle_type]:03d}"
                                trip_no_map[trip_num] = trip_no
                        
                        try:
                            # ‡πÇ‡∏´‡∏•‡∏î workbook ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
                            wb = load_workbook(io.BytesIO(st.session_state.get('original_file_content', b'')))
                            
                            # ‡∏´‡∏≤‡∏ä‡∏µ‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (2.Punthai)
                            target_sheet = None
                            for sheet_name in wb.sheetnames:
                                if 'punthai' in sheet_name.lower() or '2.' in sheet_name.lower():
                                    target_sheet = sheet_name
                                    break
                            
                            if not target_sheet:
                                target_sheet = '2.Punthai'
                                if target_sheet not in wb.sheetnames:
                                    wb.create_sheet(target_sheet)
                            
                            ws = wb[target_sheet]
                            
                            # ‡∏´‡∏≤ header row
                            header_row = 1
                            for row_idx in range(1, min(5, ws.max_row + 1)):
                                for col_idx in range(1, min(15, ws.max_column + 1)):
                                    cell_val = str(ws.cell(row=row_idx, column=col_idx).value or '')
                                    if '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤' in cell_val or 'Trip' in cell_val.upper():
                                        header_row = row_idx
                                        break
                            
                            # ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
                            if ws.max_row > header_row:
                                ws.delete_rows(header_row + 1, ws.max_row - header_row)
                            
                            # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô header ‡πÉ‡∏´‡∏°‡πà
                            new_headers = ['Sep.', 'BU', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏£‡∏´‡∏±‡∏™ WMS', '‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏ï‡∏≥‡∏ö‡∏•', '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', 'Route',
                                          'Total Cube', 'Total Wgt', 'Original QTY', 'Trip', 'Trip no']
                            for col_idx, header_val in enumerate(new_headers, 1):
                                ws.cell(row=header_row, column=col_idx, value=header_val)
                            
                            # ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÇ‡∏ó‡∏ô‡∏™‡πâ‡∏°-‡∏Ç‡∏≤‡∏ß (‡∏™‡∏•‡∏±‡∏ö 2 ‡∏™‡∏µ)
                            yellow_orange = PatternFill(start_color='FFE699', end_color='FFE699', fill_type='solid')
                            white_fill = PatternFill(start_color='FFFFFF', end_color='FFFFFF', fill_type='solid')
                            thin_border = Border(
                                left=Side(style='thin'), right=Side(style='thin'),
                                top=Side(style='thin'), bottom=Side(style='thin')
                            )
                            red_font = Font(color='FF0000', bold=True)
                            
                            # ‡∏´‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå
                            failed_trips = set()
                            vehicle_limits = {'4W': {'max_w': 2500, 'max_c': 5.0}, 'JB': {'max_w': 3500, 'max_c': 7.0}, '6W': {'max_w': 6000, 'max_c': 20.0}}
                            for t in result_df['Trip'].unique():
                                if t == 0:
                                    continue
                                trip_data = result_df[result_df['Trip'] == t]
                                trip_cube = trip_data['Cube'].sum()
                                trip_weight = trip_data['Weight'].sum()
                                trip_no = trip_no_map.get(t, '6W001')
                                veh_type = 'JB' if trip_no.startswith('4WJ') else ('4W' if trip_no.startswith('4W') else '6W')
                                limits = vehicle_limits.get(veh_type, vehicle_limits['6W'])
                                max_util = max((trip_cube / limits['max_c']) * 100, (trip_weight / limits['max_w']) * 100)
                                if max_util > 105 or max_util < 50:
                                    failed_trips.add(t)
                            
                            # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            current_trip = None
                            use_yellow = True
                            row_num = header_row + 1
                            sep_num = 1
                            
                            for trip_num in sorted_trips:
                                trip_data = result_df[result_df['Trip'] == trip_num].copy()
                                
                                # Sort ‡∏ï‡∏≤‡∏° ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                                trip_data['_sort_sub'] = trip_data['Code'].apply(lambda c: location_map.get(str(c).upper(), {}).get('‡∏ï‡∏≥‡∏ö‡∏•', ''))
                                trip_data['_sort_dist'] = trip_data['Code'].apply(lambda c: location_map.get(str(c).upper(), {}).get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', ''))
                                trip_data['_sort_prov'] = trip_data['Code'].apply(lambda c: location_map.get(str(c).upper(), {}).get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', ''))
                                trip_data = trip_data.sort_values(['_sort_prov', '_sort_dist', '_sort_sub', 'Code'])
                                
                                trip_no = trip_no_map.get(trip_num, '')
                                
                                # ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
                                if current_trip != trip_num:
                                    current_trip = trip_num
                                    use_yellow = not use_yellow
                                
                                fill = yellow_orange if use_yellow else white_fill
                                
                                for _, row in trip_data.iterrows():
                                    branch_code = row.get('Code', '')
                                    loc = location_map.get(str(branch_code).upper(), {})
                                    
                                    data = [
                                        sep_num,
                                        row.get('BU', 211),
                                        branch_code,
                                        branch_code,
                                        row.get('Name', ''),
                                        loc.get('‡∏ï‡∏≥‡∏ö‡∏•', ''),
                                        loc.get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', ''),
                                        loc.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', ''),
                                        loc.get('Route', ''),
                                        round(row.get('Cube', 0), 2) if pd.notna(row.get('Cube')) else 0,
                                        round(row.get('Weight', 0), 2) if pd.notna(row.get('Weight')) else 0,
                                        row.get('OriginalQty', 0) if pd.notna(row.get('OriginalQty')) else 0,
                                        int(trip_num),
                                        trip_no,
                                    ]
                                    
                                    for col_idx, value in enumerate(data, 1):
                                        cell = ws.cell(row=row_num, column=col_idx, value=value)
                                        cell.fill = fill
                                        cell.border = thin_border
                                        if trip_num in failed_trips:
                                            cell.font = red_font
                                    
                                    row_num += 1
                                    sep_num += 1
                            
                            wb.save(output)
                            output.seek(0)
                            
                        except Exception as e:
                            st.warning(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏î‡πâ: {e} - ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏ó‡∏ô")
                            # Fallback: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ xlsxwriter
                            output = io.BytesIO()
                            with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
                                export_df = result_df.copy()
                                export_df['Trip_No'] = export_df['Trip'].map(lambda x: trip_no_map.get(x, ''))
                                export_df.to_excel(writer, sheet_name='‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏£‡∏¥‡∏õ', index=False)
                                summary.to_excel(writer, sheet_name='‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ', index=False)
                        
                        col1, col2, col3 = st.columns([1, 2, 1])
                        with col2:
                            st.download_button(
                                label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Excel)",
                                data=output.getvalue(),
                                file_name=f"‡∏ú‡∏•‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
                                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                                use_container_width=True
                            )
                # ==========================================
                # ‡πÅ‡∏ó‡πá‡∏ö 2: ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)
                # ==========================================
                with tab2:
                    df_region = df.copy()
                    
                    # ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ
                    branch_info = model_data.get('branch_info', {})
                    trip_pairs = model_data.get('trip_pairs', set())
                    
                    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏Ñ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
                    region_groups = {
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ô': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≠‡∏Å': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•': ['‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô': ['‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ'],
                        '‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å': ['‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ'],
                        '‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': ['‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ï‡∏£‡∏≤‡∏î', '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å', '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß', '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤'],
                        '‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô-‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': ['‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡πÄ‡∏•‡∏¢'],
                        '‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô-‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': ['‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥', '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'],
                        '‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô-‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÉ‡∏ï‡πâ': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä', '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ'],
                        '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠-‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô': ['‡∏ô‡πà‡∏≤‡∏ô', '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', '‡∏•‡∏≥‡∏û‡∏π‡∏ô', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡πÅ‡∏û‡∏£‡πà', '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô'],
                        '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠-‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á': ['‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', '‡∏ï‡∏≤‡∏Å', '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå'],
                        '‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ-‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô': ['‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏ï‡∏£‡∏±‡∏á', '‡∏û‡∏±‡∏á‡∏á‡∏≤', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', '‡∏™‡∏ï‡∏π‡∏•'],
                        '‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ-‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™']
                    }
                    
                    def get_region(province):
                        if pd.isna(province) or not province or str(province).strip() in ['', 'nan', 'UNKNOWN']:
                            return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                        
                        # üö® Override: ‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤ ‚Üí ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•)
                        if '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤' in str(province):
                            return '‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'
                        
                        for region, provinces in region_groups.items():
                            if any(p in str(province) for p in provinces):
                                return region
                        return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
                    
                    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏†‡∏≤‡∏Ñ - ‡∏î‡∏∂‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å Master ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
                    # ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (Province) ‡πÅ‡∏•‡∏∞‡πÑ‡∏ó‡∏¢ (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                    province_col = None
                    if 'Province' in df_region.columns:
                        province_col = 'Province'
                    elif '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in df_region.columns:
                        province_col = '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
                    
                    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏•‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô NaN ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å MASTER_DATA
                    if not province_col or df_region[province_col].isna().all():
                        # ‡∏î‡∏∂‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å Master
                        if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns and 'Code' in df_region.columns:
                            province_map = {}
                            for _, row in MASTER_DATA.iterrows():
                                code = row.get('Plan Code', '')
                                province = row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '')
                                if code and province:
                                    province_map[code] = province
                            
                            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
                            df_region['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] = df_region['Code'].map(province_map).fillna('UNKNOWN')
                            province_col = '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
                    elif province_col and df_region[province_col].isna().any():
                        # ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô NaN ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°
                        if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns and 'Code' in df_region.columns:
                            province_map = {}
                            for _, row in MASTER_DATA.iterrows():
                                code = row.get('Plan Code', '')
                                province = row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '')
                                if code and province:
                                    province_map[code] = province
                            
                            # ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô NaN
                            df_region[province_col] = df_region.apply(
                                lambda row: province_map.get(row['Code'], row.get(province_col, 'UNKNOWN')) 
                                if pd.isna(row.get(province_col)) else row[province_col],
                                axis=1
                            )
                    
                    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß
                    if not province_col or province_col not in df_region.columns:
                        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
                        return
                    
                    df_region['Region'] = df_region[province_col].apply(get_region)
                    
                    # ‡∏´‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÉ‡∏ä‡πâ Booking No. ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å)
                    def find_paired_branches(code, code_province, df_data):
                        paired = set()
                        
                        # ‡∏´‡∏≤ Booking No. ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ
                        code_rows = df_data[df_data['Code'] == code]
                        if len(code_rows) == 0:
                            return paired
                        
                        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Booking ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        if 'Booking' not in df_data.columns and 'Trip' not in df_data.columns:
                            return paired
                        
                        booking_col = 'Booking' if 'Booking' in df_data.columns else 'Trip'
                        code_bookings = set(code_rows[booking_col].dropna().astype(str))
                        
                        if not code_bookings:
                            return paired
                        
                        # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà Booking ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                        for booking in code_bookings:
                            if booking == 'nan' or not booking.strip():
                                continue
                            
                            same_booking = df_data[df_data[booking_col].astype(str) == booking]
                            for _, other_row in same_booking.iterrows():
                                other_code = other_row['Code']
                                
                                # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: Booking ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô = ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                                if other_code != code:
                                    paired.add(other_code)
                        
                        return paired
                    
                    all_codes_set = set(df_region['Code'].unique())
                    
                    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏ö‡∏ö Union-Find (‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                    # Step 1: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÜ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Master
                    initial_groups = {}
                    for code in all_codes_set:
                        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Master
                        location = {}
                        if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
                            master_row = MASTER_DATA[MASTER_DATA['Plan Code'] == code]
                            if len(master_row) > 0:
                                master_row = master_row.iloc[0]
                                location = {
                                    'subdistrict': master_row.get('‡∏ï‡∏≥‡∏ö‡∏•', ''),
                                    'district': master_row.get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', ''),
                                    'province': master_row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', 'UNKNOWN'),
                                    'lat': master_row.get('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0),
                                    'lon': master_row.get('‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0)
                                }
                        
                        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Master ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                        if not location or location.get('province', 'UNKNOWN') == 'UNKNOWN':
                            c_row = df_region[df_region['Code'] == code].iloc[0] if len(df_region[df_region['Code'] == code]) > 0 else None
                            if c_row is not None:
                                location = {
                                    'subdistrict': '',
                                    'district': '',
                                    'province': c_row.get('Province', 'UNKNOWN'),
                                    'lat': 0,
                                    'lon': 0
                                }
                        
                        if location:
                            initial_groups[(code,)] = {code: location}
                    
                    # ‡πÉ‡∏ä‡πâ initial_groups ‡πÅ‡∏ó‡∏ô booking_groups
                    booking_groups = initial_groups
                    
                    # Step 2: ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                    def groups_can_merge(locs1, locs2):
                        """‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ 2 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏° (‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)"""
                        # 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•)
                        subdistricts1 = set(loc.get('subdistrict', '') for loc in locs1.values() if loc.get('subdistrict', ''))
                        subdistricts2 = set(loc.get('subdistrict', '') for loc in locs2.values() if loc.get('subdistrict', ''))
                        if subdistricts1 and subdistricts2 and (subdistricts1 & subdistricts2):
                            return True, '‡∏ï‡∏≥‡∏ö‡∏•'
                        
                        # 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
                        districts1 = {(loc.get('district', ''), loc.get('province', '')) for loc in locs1.values() if loc.get('district', '')}
                        districts2 = {(loc.get('district', ''), loc.get('province', '')) for loc in locs2.values() if loc.get('district', '')}
                        if districts1 and districts2:
                            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
                            for d1, p1 in districts1:
                                for d2, p2 in districts2:
                                    if d1 == d2 and p1 == p2 and p1:
                                        return True, '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠'
                        
                        # 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                        provinces1 = set(loc.get('province', '') for loc in locs1.values() if loc.get('province', ''))
                        provinces2 = set(loc.get('province', '') for loc in locs2.values() if loc.get('province', ''))
                        if provinces1 & provinces2:
                            return True, '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
                        
                        return False, None
                    
                    merged_groups = []
                    used_groups = set()
                    
                    for group1, locs1 in booking_groups.items():
                        if group1 in used_groups:
                            continue
                        
                        merged_codes = set(group1)
                        merged_locs = locs1.copy()
                        used_groups.add(group1)
                        
                        # ‡∏´‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
                        changed = True
                        while changed:
                            changed = False
                            for group2, locs2 in booking_groups.items():
                                if group2 in used_groups:
                                    continue
                                can_merge, level = groups_can_merge(merged_locs, locs2)
                                if can_merge:
                                    merged_codes |= set(group2)
                                    merged_locs.update(locs2)
                                    used_groups.add(group2)
                                    changed = True
                        
                        merged_groups.append({
                            'codes': merged_codes,
                            'locations': merged_locs
                        })
                    
                    # Step 3: ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô groups format
                    groups = []
                    for mg in merged_groups:
                        rep_code = list(mg['codes'])[0]
                        rep_row = df_region[df_region['Code'] == rep_code].iloc[0]
                        # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà UNKNOWN ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NaN
                        provinces = set(
                            str(loc.get('province', '')).strip() 
                            for loc in mg['locations'].values() 
                            if loc.get('province') and str(loc.get('province', '')).strip() not in ['UNKNOWN', 'nan', '']
                        )
                        
                        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏•‡∏¢ ‡πÉ‡∏™‡πà "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
                        province_str = ', '.join(sorted(provinces)) if provinces else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                        
                        groups.append({
                            'codes': mg['codes'],
                            'region': rep_row.get('Region', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'),
                            'province': province_str
                        })
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                    st.markdown("---")
                    st.markdown("### üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°")
                    
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        st.metric("üìç ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤", df_region['Code'].nunique())
                    with col2:
                        st.metric("üóÇÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°", len(groups))
                    with col3:
                        regions_count = df_region['Region'].nunique()
                        st.metric("üó∫Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏Ñ", regions_count)
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ
                    st.markdown("---")
                    st.markdown("### üó∫Ô∏è ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ")
                    
                    region_summary = df_region.groupby('Region').agg({
                        'Code': 'nunique',
                        'Weight': 'sum',
                        'Cube': 'sum'
                    }).reset_index()
                    region_summary.columns = ['‡∏†‡∏≤‡∏Ñ', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°', '‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°']
                    st.dataframe(region_summary, use_container_width=True)
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ
                    for region in sorted(df_region['Region'].unique()):
                        region_data = df_region[df_region['Region'] == region]
                        with st.expander(f"üìç {region} ({region_data['Code'].nunique()} ‡∏™‡∏≤‡∏Ç‡∏≤)"):
                            display_cols = ['Code', 'Name', 'Province', 'Weight', 'Cube']
                            display_cols = [c for c in display_cols if c in region_data.columns]
                            
                            region_display = region_data[display_cols].drop_duplicates('Code')
                            col_names = {'Code': '‡∏£‡∏´‡∏±‡∏™', 'Name': '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤', 'Province': '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', 'Weight': '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', 'Cube': '‡∏Ñ‡∏¥‡∏ß'}
                            region_display.columns = [col_names.get(c, c) for c in display_cols]
                            st.dataframe(region_display, use_container_width=True)
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
                    st.markdown("---")
                    st.markdown("### üîó ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)")
                    
                    paired_groups = [g for g in groups if len(g['codes']) > 1]
                    if paired_groups:
                        for i, group in enumerate(paired_groups, 1):
                            codes_list = list(group['codes'])
                            names = []
                            for c in codes_list:
                                name_row = df_region[df_region['Code'] == c]
                                if len(name_row) > 0 and 'Name' in name_row.columns:
                                    names.append(f"{c} ({name_row['Name'].iloc[0]})")
                                else:
                                    names.append(c)
                            
                            st.write(f"**‡∏Å‡∏•‡∏∏‡πà‡∏° {i}** - {group['region']}: {', '.join(names)}")
                    else:
                        st.info("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ")
                    
                    # ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    st.markdown("---")
                    output_region = io.BytesIO()
                    with pd.ExcelWriter(output_region, engine='xlsxwriter') as writer:
                        df_region.to_excel(writer, sheet_name='‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', index=False)
                        region_summary.to_excel(writer, sheet_name='‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ', index=False)
                    
                    col1, col2, col3 = st.columns([1, 2, 1])
                    with col2:
                        st.download_button(
                            label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° (Excel)",
                            data=output_region.getvalue(),
                            file_name=f"‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                            use_container_width=True
                        )

if __name__ == "__main__":
    main()
