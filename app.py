# Logistics Planner
# Version: 2025-12-26-v3.4

import streamlit as st
import pandas as pd
import numpy as np
import pickle
import os
import glob
from datetime import datetime, time as datetime_time, timedelta
import io
from math import radians, sin, cos, sqrt, atan2
import json
import time as time_module
import sys

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô safe print ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Windows console
def safe_print(*args, **kwargs):
    """Print with fallback encoding for Windows console"""
    text = ' '.join(str(arg) for arg in args)
    try:
        # ‡πÉ‡∏ä‡πâ buffer ‡πÅ‡∏ó‡∏ô stdout ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á Streamlit wrapper
        output = sys.stdout.buffer if hasattr(sys.stdout, 'buffer') else sys.stdout
        if hasattr(output, 'write'):
            if isinstance(output, (type(sys.stdout.buffer), type(sys.stderr.buffer))):
                output.write((text + '\n').encode('utf-8', errors='replace'))
            else:
                output.write(text + '\n')
            output.flush() if hasattr(output, 'flush') else None
    except Exception:
        try:
            # Fallback: ‡πÉ‡∏ä‡πâ ASCII
            sys.__stdout__.write(text.encode('ascii', 'replace').decode('ascii') + '\n')
            sys.__stdout__.flush()
        except Exception:
            pass

# Map visualization
try:
    import folium
    from folium import plugins
    from streamlit_folium import folium_static  # ‡πÉ‡∏ä‡πâ folium_static ‡πÅ‡∏ó‡∏ô st_folium ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
    import requests
    FOLIUM_AVAILABLE = True
except ImportError:
    FOLIUM_AVAILABLE = False

# Google Sheets Integration
try:
    import gspread
    from oauth2client.service_account import ServiceAccountCredentials
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå credentials.json ‡∏´‡∏£‡∏∑‡∏≠ Streamlit secrets
    credentials_file = 'credentials.json'
    scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
    
    creds = None
    
    # 1Ô∏è‚É£ ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ Streamlit Secrets ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Streamlit Cloud)
    try:
        if hasattr(st, 'secrets') and 'gcp_service_account' in st.secrets:
            creds = ServiceAccountCredentials.from_json_keyfile_dict(
                dict(st.secrets['gcp_service_account']), 
                scope
            )
            safe_print("‚úÖ ‡πÉ‡∏ä‡πâ credentials ‡∏à‡∏≤‡∏Å Streamlit Secrets")
    except Exception as e:
        safe_print(f"‚ö†Ô∏è Streamlit Secrets ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: {e}")
    
    # 2Ô∏è‚É£ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ secrets ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå local
    if creds is None:
        if os.path.exists(credentials_file):
            try:
                creds = ServiceAccountCredentials.from_json_keyfile_name(credentials_file, scope)
                safe_print(f"‚úÖ ‡πÉ‡∏ä‡πâ credentials ‡∏à‡∏≤‡∏Å {credentials_file}")
            except Exception as e:
                safe_print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå {credentials_file}: {e}")
        else:
            safe_print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö {credentials_file} ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ Streamlit Secrets")
            safe_print(f"üí° ‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà: CREDENTIALS_SETUP.md")
    
    # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
    if creds:
        try:
            gc = gspread.authorize(creds)
            SPREADSHEET_ID = '12DmIfECwVpsWfl8rl2r1A_LB4_5XMrmnmwlPUHKNU-o'
            sh = gc.open_by_key(SPREADSHEET_ID)
            SHEETS_AVAILABLE = True
            safe_print("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        except Exception as e:
            safe_print(f"‚ö†Ô∏è Google Sheets Error: {e}")
            safe_print(f"üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö credentials ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏π‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà CREDENTIALS_SETUP.md")
            SHEETS_AVAILABLE = False
            gc = None
            sh = None
    else:
        SHEETS_AVAILABLE = False
        gc = None
        sh = None
        
except ImportError:
    safe_print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö gspread library - ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢: pip install gspread oauth2client")
    SHEETS_AVAILABLE = False
    gc = None
    sh = None

# Auto-refresh component
try:
    from streamlit_autorefresh import st_autorefresh
    AUTOREFRESH_AVAILABLE = True
except ImportError:
    AUTOREFRESH_AVAILABLE = False
    # ‡πÅ‡∏™‡∏î‡∏á warning ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô local dev (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô deployment)
    if os.environ.get('ENVIRONMENT') != 'production':
        pass  # ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á warning - ‡πÉ‡∏ä‡πâ manual refresh ‡πÅ‡∏ó‡∏ô

# ==========================================
# CACHE SYSTEM - ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
# ==========================================
USE_CACHE = True  # ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô cache system
DISTANCE_CACHE_FILE = 'distance_cache.json'
ROUTE_CACHE_FILE = 'route_cache.json'

# ‡πÇ‡∏´‡∏•‡∏î cache ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
@st.cache_data(show_spinner=False)
def load_distance_cache():
    """‡πÇ‡∏´‡∏•‡∏î distance cache ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå"""
    if os.path.exists(DISTANCE_CACHE_FILE):
        try:
            with open(DISTANCE_CACHE_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_distance_cache(cache_dict):
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å distance cache ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå"""
    try:
        with open(DISTANCE_CACHE_FILE, 'w', encoding='utf-8') as f:
            json.dump(cache_dict, f, ensure_ascii=False, indent=2)
    except Exception as e:
        safe_print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å distance cache: {e}")

@st.cache_data(show_spinner=False)
def load_route_cache():
    """‡πÇ‡∏´‡∏•‡∏î route cache ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå"""
    if os.path.exists(ROUTE_CACHE_FILE):
        try:
            with open(ROUTE_CACHE_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_route_cache(cache_dict):
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å route cache ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå (compact JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)"""
    try:
        with open(ROUTE_CACHE_FILE, 'w', encoding='utf-8') as f:
            json.dump(cache_dict, f, ensure_ascii=False, separators=(',', ':'))
    except Exception as e:
        safe_print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å route cache: {e}")

# ‡πÇ‡∏´‡∏•‡∏î cache ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
if USE_CACHE:
    DISTANCE_CACHE = load_distance_cache()
    ROUTE_CACHE_DATA = load_route_cache()
    
    # ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó cache
    dc_distances = sum(1 for k in DISTANCE_CACHE.keys() if k.startswith('14.1') or k.startswith('14.2'))
    branch_distances = len(DISTANCE_CACHE) - dc_distances
    
    safe_print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î distance_cache.json: {len(DISTANCE_CACHE):,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
    if dc_distances > 0 or branch_distances > 0:
        safe_print(f"   - DC‚Üí‡∏™‡∏≤‡∏Ç‡∏≤: ~{dc_distances:,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        safe_print(f"   - ‡∏™‡∏≤‡∏Ç‡∏≤‚Üî‡∏™‡∏≤‡∏Ç‡∏≤: ~{branch_distances:,} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
    safe_print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î route_cache.json: {len(ROUTE_CACHE_DATA):,} ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á")
else:
    DISTANCE_CACHE = {}
    ROUTE_CACHE_DATA = {}

# ==========================================
# GOOGLE SHEETS SYNC FUNCTION
# ==========================================
def sync_branch_data_from_sheets():
    """
    ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡∏∞ sync ‡∏Å‡∏±‡∏ö JSON file
    ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (Code/Plan Code) ‡πÄ‡∏õ‡πá‡∏ô key ‡∏´‡∏•‡∏±‡∏Å
    
    Returns:
        DataFrame ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
    """
    global SHEETS_AVAILABLE, sh
    
    json_file = 'branch_data.json'
    
    # ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å JSON
    existing_data = {}
    if os.path.exists(json_file):
        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                existing_data = json.load(f)
        except Exception as e:
            safe_print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô JSON: {e}")
    
    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Google Sheets ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
    if not SHEETS_AVAILABLE or sh is None:
        if existing_data:
            safe_print(f"‚ö†Ô∏è Google Sheets ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å JSON ({len(existing_data)} ‡∏™‡∏≤‡∏Ç‡∏≤)")
            df = pd.DataFrame.from_dict(existing_data, orient='index')
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Plan Code ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if 'Plan Code' not in df.columns:
                df.reset_index(inplace=True)
                df.rename(columns={'index': 'Plan Code'}, inplace=True)
            else:
                df.reset_index(drop=True, inplace=True)
            return df
        else:
            safe_print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÑ‡∏°‡πà‡∏°‡∏µ Google Sheets ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ JSON cache")
            return pd.DataFrame()  # Return empty DataFrame ‡πÅ‡∏ó‡∏ô None
    
    try:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheets (GID: 876257177)
        worksheet = None
        for ws in sh.worksheets():
            if ws.id == 876257177:
                worksheet = ws
                break
        
        if worksheet is None:
            worksheet = sh.get_worksheet(0)
        
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        data = worksheet.get_all_values()
        if not data or len(data) < 2:
            return None
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame
        headers = data[0]
        df_new = pd.DataFrame(data[1:], columns=headers)
        
        # ‡∏´‡∏≤ column ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤
        code_col = None
        for col in ['Code', 'Plan Code', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏™‡∏≤‡∏Ç‡∏≤']:
            if col in df_new.columns:
                code_col = col
                break
        
        if not code_col:
            safe_print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤")
            return None
        
        # ‡∏ô‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        new_count = 0
        updated_count = 0
        
        # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets (‡∏£‡∏ß‡∏° DC ‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Sheets)
        for idx, row in df_new.iterrows():
            code = str(row[code_col]).strip().upper()
            if not code or code == '':
                continue
            
            # ‡πÅ‡∏õ‡∏•‡∏á row ‡πÄ‡∏õ‡πá‡∏ô dict
            row_dict = row.to_dict()
            
            if code in existing_data:
                # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if existing_data[code] != row_dict:
                    existing_data[code] = row_dict
                    updated_count += 1
                # ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô update
            else:
                # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà - ‡πÄ‡∏û‡∏¥‡πà‡∏°
                existing_data[code] = row_dict
                new_count += 1
        
        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON
        with open(json_file, 'w', encoding='utf-8') as f:
            json.dump(existing_data, f, ensure_ascii=False, indent=2)
        
        safe_print(f"‚úÖ Sync ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: {new_count} ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà, {updated_count} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï, ‡∏£‡∏ß‡∏° {len(existing_data)} ‡∏™‡∏≤‡∏Ç‡∏≤")
        
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô DataFrame (‡πÉ‡∏ä‡πâ index ‡πÄ‡∏õ‡πá‡∏ô Plan Code)
        df = pd.DataFrame.from_dict(existing_data, orient='index')
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Plan Code ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å index
        if 'Plan Code' not in df.columns and code_col in df.columns:
            df['Plan Code'] = df[code_col]
        elif 'Plan Code' not in df.columns:
            # ‡πÉ‡∏ä‡πâ index ‡πÄ‡∏õ‡πá‡∏ô Plan Code
            df.reset_index(inplace=True)
            df.rename(columns={'index': 'Plan Code'}, inplace=True)
        else:
            df.reset_index(drop=True, inplace=True)
        
        return df
        
    except Exception as e:
        safe_print(f"‚ùå Error: {e}")
        # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
        if existing_data:
            safe_print(f"üì¶ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å JSON")
            df = pd.DataFrame.from_dict(existing_data, orient='index')
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Plan Code ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if 'Plan Code' not in df.columns:
                df.reset_index(inplace=True)
                df.rename(columns={'index': 'Plan Code'}, inplace=True)
            else:
                df.reset_index(drop=True, inplace=True)
            return df
        return None

# ==========================================
# CONFIG
# ==========================================
MODEL_PATH = 'models/decision_tree_model.pkl'

# ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
LIMITS = {
    '4W': {'max_w': 2500, 'max_c': 5.0, 'max_drops': 12},   # ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 12 ‡∏à‡∏∏‡∏î, Cube ‚â§ 5
    'JB': {'max_w': 3500, 'max_c': 7.0, 'max_drops': 12},   # ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 12 ‡∏à‡∏∏‡∏î, Cube ‚â§ 7
    '6W': {'max_w': 6000, 'max_c': 20.0, 'max_drops': 999}  # ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î, Cube ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°, Weight ‚â§ 6000
}

# üîí ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Punthai ‡∏•‡πâ‡∏ß‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 100%)
PUNTHAI_LIMITS = {
    '4W': {'max_w': 2500, 'max_c': 5.0, 'max_drops': 5},   # Punthai ‡∏•‡πâ‡∏ß‡∏ô 4W: ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏™‡∏≤‡∏Ç‡∏≤
    'JB': {'max_w': 3500, 'max_c': 7.0, 'max_drops': 7},  # Punthai ‡∏•‡πâ‡∏ß‡∏ô JB: ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 7 ‡∏™‡∏≤‡∏Ç‡∏≤
    '6W': {'max_w': 6000, 'max_c': 20.0, 'max_drops': 999}
}

#  Geographic Clustering Config
MAX_DISTRICT_DISTANCE_KM = 30  # ‡∏Ñ‡∏ô‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 30km ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ 80km)

# Utilization Config (‡πÉ‡∏ä‡πâ buffer ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà fix ‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)
MIN_VEHICLE_UTILIZATION = 0.80  # ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏£‡∏ñ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 80% (‡πÅ‡∏™‡∏î‡∏á warning ‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤)

# ==========================================
# REGION ORDER CONFIG (Far-to-Near Sorting)
# ==========================================
# ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î: ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‚Üí ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô ‚Üí ‡πÉ‡∏ï‡πâ ‚Üí ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‚Üí ‡∏Å‡∏•‡∏≤‡∏á
REGION_ORDER = {
    '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': 1, 'NORTH': 1,
    '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô': 2, 'NE': 2,
    '‡πÉ‡∏ï‡πâ': 3, 'SOUTH': 3,
    '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': 4, 'EAST': 4,
    '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å': 5, 'WEST': 5,
    '‡∏Å‡∏•‡∏≤‡∏á': 6, 'CENTRAL': 6,
    '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏': 99
}

# ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å)
EXCLUDE_BRANCHES = ['DC011', 'PTDC', 'PTG DISTRIBUTION CENTER']

# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å (‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠)
EXCLUDE_NAMES = ['Distribution Center', 'PTG Distribution', '‡∏ö.‡∏û‡∏µ‡∏ó‡∏µ‡∏à‡∏µ ‡πÄ‡∏≠‡πá‡∏ô‡πÄ‡∏ô‡∏≠‡∏¢‡∏µ']

# ‡∏û‡∏¥‡∏Å‡∏±‡∏î DC ‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á)
DC_WANG_NOI_LAT = 14.179394
DC_WANG_NOI_LON = 100.648149

# ==========================================
# üöõ HIGHWAY-BASED LOGISTICS ROUTES & ZONES
# ==========================================
# ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏ï‡∏≤‡∏°‡∏ñ‡∏ô‡∏ô"
# ‡∏¢‡∏∂‡∏î‡πÄ‡∏•‡∏Ç‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏Ç‡∏ï‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î

HIGHWAY_ROUTES = {
    # ‡∏™‡∏≤‡∏¢ 1 (‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô): ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô
    'ROUTE_1_‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô': {
        'highway': '1',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå ‚Üí ‡∏ï‡∏≤‡∏Å ‚Üí ‡∏•‡∏≥‡∏õ‡∏≤‡∏á ‚Üí ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‚Üí ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢',
        'provinces': ['‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', '‡∏ï‡∏≤‡∏Å', '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', '‡∏•‡∏≥‡∏û‡∏π‡∏ô', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢'],
        'branches': ['‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô', '‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢'],
    },
    # ‡∏™‡∏≤‡∏¢ 11 (‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡πà‡∏≤): ‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å-‡πÅ‡∏û‡∏£‡πà-‡∏ô‡πà‡∏≤‡∏ô
    'ROUTE_11_‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡πà‡∏≤': {
        'highway': '11',
        'description': '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå ‚Üí ‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£ ‚Üí ‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å ‚Üí ‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå ‚Üí ‡πÅ‡∏û‡∏£‡πà',
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡πÅ‡∏û‡∏£‡πà'],
    },
    # ‡∏™‡∏≤‡∏¢ 101: ‡πÅ‡∏û‡∏£‡πà-‡∏ô‡πà‡∏≤‡∏ô
    'ROUTE_101_‡πÅ‡∏û‡∏£‡πà‡∏ô‡πà‡∏≤‡∏ô': {
        'highway': '101',
        'description': '‡πÅ‡∏û‡∏£‡πà ‚Üí ‡∏ô‡πà‡∏≤‡∏ô (‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤)',
        'provinces': ['‡πÅ‡∏û‡∏£‡πà', '‡∏ô‡πà‡∏≤‡∏ô'],
    },
    # ‡∏™‡∏≤‡∏¢ 32 (‡∏™‡∏≤‡∏¢‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢): ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á
    'ROUTE_32_‡∏™‡∏≤‡∏¢‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢': {
        'highway': '32',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ ‚Üí ‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á ‚Üí ‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå',
        'provinces': ['‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå'],
    },
    # ‡∏™‡∏≤‡∏¢ 2 (‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û): ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠
    'ROUTE_2_‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û': {
        'highway': '2',
        'description': '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤ ‚Üí ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‚Üí ‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ ‚Üí ‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢',
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡πÄ‡∏•‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'],
    },
    # ‡∏™‡∏≤‡∏¢ 24 (‡πÄ‡∏î‡∏ä‡∏≠‡∏∏‡∏î‡∏°): ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÉ‡∏ï‡πâ
    'ROUTE_24_‡πÄ‡∏î‡∏ä‡∏≠‡∏∏‡∏î‡∏°': {
        'highway': '24',
        'description': '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤ ‚Üí ‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå ‚Üí ‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‚Üí ‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ',
        'provinces': ['‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç'],
    },
    # ‡∏™‡∏≤‡∏¢ 304: ‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ-‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä
    'ROUTE_304_‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä': {
        'highway': '304',
        'description': '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',
        'provinces': ['‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
    },
    # ‡∏™‡∏≤‡∏¢ 4 (‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°): ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ
    'ROUTE_4_‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°': {
        'highway': '4',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ø ‚Üí ‡∏ä‡∏∏‡∏°‡∏û‡∏£ ‚Üí ‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏Ø ‚Üí ‡∏™‡∏á‡∏Ç‡∏•‡∏≤',
        'provinces': ['‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏ä‡∏∏‡∏°‡∏û‡∏£', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™'],
    },
    # ‡∏™‡∏≤‡∏¢ 401/402: ‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô
    'ROUTE_401_‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô': {
        'highway': '401/402',
        'description': '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå ‚Üí ‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà ‚Üí ‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï',
        'provinces': ['‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏û‡∏±‡∏á‡∏á‡∏≤', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏ï‡∏£‡∏±‡∏á', '‡∏™‡∏ï‡∏π‡∏•'],
    },
    # ‡∏™‡∏≤‡∏¢ 3 (‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó): ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å
    'ROUTE_3_‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó': {
        'highway': '3',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏£‡∏∞‡∏¢‡∏≠‡∏á ‚Üí ‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ï‡∏£‡∏≤‡∏î',
        'provinces': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ï‡∏£‡∏≤‡∏î'],
    },
    # ‡∏™‡∏≤‡∏¢ 331/344: EEC
    'ROUTE_331_EEC': {
        'highway': '331/344',
        'description': '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ-‡∏£‡∏∞‡∏¢‡∏≠‡∏á (‡πÄ‡∏Ç‡∏ï‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©)',
        'provinces': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á'],
    },
    # ‡∏™‡∏≤‡∏¢ 9 (‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å): ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠
    'ROUTE_9_‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å': {
        'highway': '9',
        'description': '‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ-‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ-‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£',
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£'],
    },
    # ‡∏™‡∏≤‡∏¢ 35 (‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ): ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å
    'ROUTE_35_‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ': {
        'highway': '35',
        'description': '‡∏Å‡∏ó‡∏° ‚Üí ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏° ‚Üí ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£',
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£'],
    },
    # ‡∏™‡∏≤‡∏¢ 305: ‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ-‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤
    'ROUTE_305_‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤': {
        'highway': '305',
        'description': '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å ‚Üí ‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤',
        'provinces': ['‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å', '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤', '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'],
    },
    # ‡∏™‡∏≤‡∏¢ 340: ‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ-‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó
    'ROUTE_340_‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì': {
        'highway': '340',
        'description': '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó ‚Üí ‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ',
        'provinces': ['‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ'],
    },
    # ‡∏™‡∏≤‡∏¢ 321: ‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ-‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ
    'ROUTE_321_‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ‡∏Å‡∏≤‡∏ç‡∏à‡∏ô': {
        'highway': '321',
        'description': '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ ‚Üí ‡∏™‡∏±‡∏á‡∏Ç‡∏•‡∏∞‡∏ö‡∏∏‡∏£‡∏µ',
        'provinces': ['‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'],
    },
}

# ===== NO CROSS-ZONE RULES (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏ã‡∏ô) =====
# ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏≤‡∏á/‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏†‡∏π‡πÄ‡∏Ç‡∏≤
NO_CROSS_ZONE_PAIRS = [
    ('‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥'),
    ('‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', '‡πÄ‡∏•‡∏¢'),
    ('‡∏ï‡∏≤‡∏Å', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢'),
    ('‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô', '‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢'),
    ('‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ'),
    # ‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ (‡πÄ‡∏°‡∏∑‡∏≠‡∏á/‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á) ‚â† ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å (‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ/‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤)
    # ‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠/‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á ‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà ZONE_EAST_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
]
# ‚úÖ ‡∏ô‡πà‡∏≤‡∏ô-‡πÅ‡∏û‡∏£‡πà-‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ (‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: DC ‚Üí ‡πÅ‡∏û‡∏£‡πà (‡∏™‡∏≤‡∏¢ 11) ‚Üí ‡∏ô‡πà‡∏≤‡∏ô (‡∏™‡∏≤‡∏¢ 101) ‡∏´‡∏£‡∏∑‡∏≠ ‚Üí ‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ (‡∏™‡∏≤‡∏¢ 1))
# ‚úÖ ‡πÅ‡∏û‡∏£‡πà-‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå ‡∏£‡∏ß‡∏°‡πÑ‡∏î‡πâ (‡∏™‡∏≤‡∏¢ 11 ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)

# üéØ ROUTE GROUPS: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô (‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
ROUTE_GROUPS = {
    'ROUTE_‡∏™‡∏≤‡∏¢1_‡∏û‡∏∞‡πÄ‡∏¢‡∏≤': {
        'provinces': ['‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', '‡∏•‡∏≥‡∏õ‡∏≤‡∏á'],
        'description': '‡∏™‡∏≤‡∏¢ 1 ‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô ‡πÑ‡∏õ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢-‡∏û‡∏∞‡πÄ‡∏¢‡∏≤',
        'next_routes': [],  # ‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏™‡∏≤‡∏¢ 1
    },
    'ROUTE_‡∏™‡∏≤‡∏¢11_‡πÅ‡∏û‡∏£‡πà‡∏ô‡πà‡∏≤‡∏ô': {
        'provinces': ['‡πÅ‡∏û‡∏£‡πà', '‡∏ô‡πà‡∏≤‡∏ô'],
        'description': '‡∏™‡∏≤‡∏¢ 11/101 ‡πÅ‡∏û‡∏£‡πà-‡∏ô‡πà‡∏≤‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏û‡∏£‡πà)',
        'next_routes': ['ROUTE_‡∏™‡∏≤‡∏¢11_‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå'],  # ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå‡πÑ‡∏î‡πâ
    },
    'ROUTE_‡∏™‡∏≤‡∏¢11_‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå': {
        'provinces': ['‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢'],
        'description': '‡∏™‡∏≤‡∏¢ 11 ‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå-‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',
        'next_routes': ['ROUTE_‡∏™‡∏≤‡∏¢11_‡πÅ‡∏û‡∏£‡πà‡∏ô‡πà‡∏≤‡∏ô', 'ROUTE_‡∏™‡∏≤‡∏¢11_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
    },
    'ROUTE_‡∏™‡∏≤‡∏¢11_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å': {
        'provinces': ['‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£'],
        'description': '‡∏™‡∏≤‡∏¢ 11 ‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å-‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£',
        'next_routes': ['ROUTE_‡∏™‡∏≤‡∏¢11_‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', 'ROUTE_‡∏™‡∏≤‡∏¢32_‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå'],
    },
}

LOGISTICS_ZONES = {
    # ============ ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ - ‡∏™‡∏≤‡∏¢ 1/11/101 ============
    'ZONE_A_‡∏û‡∏∞‡πÄ‡∏¢‡∏≤': {
        'provinces': ['‡∏û‡∏∞‡πÄ‡∏¢‡∏≤'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', '‡πÅ‡∏°‡πà‡πÉ‡∏à', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏°‡πà‡∏ß‡∏ô', '‡∏î‡∏≠‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏ï‡πâ', '‡∏õ‡∏á', '‡∏à‡∏∏‡∏ô', '‡∏†‡∏π‡∏ã‡∏≤‡∏á', '‡∏†‡∏π‡∏Å‡∏≤‡∏°‡∏¢‡∏≤‡∏ß'],
        'highway': '1',
        'priority': 1,
        'distance_from_dc_km': 680,
        'description': '‡πÇ‡∏ã‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏™‡∏∏‡∏î ‡∏™‡∏≤‡∏¢ 1 ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
    },
    'ZONE_B_‡∏ô‡πà‡∏≤‡∏ô': {
        'provinces': ['‡∏ô‡πà‡∏≤‡∏ô'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏ô', '‡∏ó‡πà‡∏≤‡∏ß‡∏±‡∏á‡∏ú‡∏≤', '‡∏õ‡∏±‡∏ß', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡∏≤‡∏á', '‡∏ó‡∏∏‡πà‡∏á‡∏ä‡πâ‡∏≤‡∏á', '‡∏ö‡πà‡∏≠‡πÄ‡∏Å‡∏•‡∏∑‡∏≠', '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏™‡∏≤', '‡∏ô‡∏≤‡∏ô‡πâ‡∏≠‡∏¢', '‡∏ô‡∏≤‡∏´‡∏°‡∏∑‡πà‡∏ô', '‡πÅ‡∏°‡πà‡∏à‡∏£‡∏¥‡∏°', '‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á', '‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç', '‡∏†‡∏π‡πÄ‡∏û‡∏µ‡∏¢‡∏á', '‡∏™‡∏≠‡∏á‡πÅ‡∏Ñ‡∏ß', '‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥'],
        'highway': '101',
        'priority': 2,
        'distance_from_dc_km': 620,
        'description': '‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏û‡∏£‡πà (‡∏™‡∏≤‡∏¢ 101)'
    },
    'ZONE_C_‡πÅ‡∏û‡∏£‡πà': {
        'provinces': ['‡πÅ‡∏û‡∏£‡πà'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏û‡∏£‡πà', '‡∏™‡∏π‡∏á‡πÄ‡∏°‡πà‡∏ô', '‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏¢', '‡∏£‡πâ‡∏≠‡∏á‡∏Å‡∏ß‡∏≤‡∏á', '‡∏™‡∏≠‡∏á', '‡∏•‡∏≠‡∏á', '‡∏ß‡∏±‡∏á‡∏ä‡∏¥‡πâ‡∏ô', '‡∏´‡∏ô‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á‡πÑ‡∏Ç‡πà'],
        'highway': '11',
        'priority': 3,
        'distance_from_dc_km': 540,
        'description': 'Gateway ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô ‡∏™‡∏≤‡∏¢ 11 ‚Üí ‡∏ô‡πà‡∏≤‡∏ô/‡∏û‡∏∞‡πÄ‡∏¢‡∏≤'
    },
    'ZONE_D_‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå': {
        'provinces': ['‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡∏ï‡∏£‡∏≠‡∏ô', '‡∏ó‡πà‡∏≤‡∏õ‡∏•‡∏≤', '‡∏ô‡πâ‡∏≥‡∏õ‡∏≤‡∏î', '‡∏ü‡∏≤‡∏Å‡∏ó‡πà‡∏≤', '‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏Å', '‡∏û‡∏¥‡∏ä‡∏±‡∏¢', '‡∏•‡∏±‡∏ö‡πÅ‡∏•', '‡∏ó‡∏≠‡∏á‡πÅ‡∏™‡∏ô‡∏Ç‡∏±‡∏ô',
                      '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', '‡∏Å‡∏á‡πÑ‡∏Å‡∏£‡∏•‡∏≤‡∏®', '‡∏Ñ‡∏µ‡∏£‡∏µ‡∏°‡∏≤‡∏®', '‡∏®‡∏£‡∏µ‡∏™‡∏≥‡πÇ‡∏£‡∏á', '‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πÇ‡∏•‡∏Å', '‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£', '‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏•‡∏≤‡∏ô‡∏´‡∏≠‡∏¢', '‡∏ó‡∏∏‡πà‡∏á‡πÄ‡∏™‡∏•‡∏µ‡πà‡∏¢‡∏°', '‡∏®‡∏£‡∏µ‡∏™‡∏±‡∏ä‡∏ô‡∏≤‡∏•‡∏±‡∏¢'],
        'highway': '11',
        'priority': 4,
        'distance_from_dc_km': 450,
        'description': '‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏û‡∏£‡πà ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_E1_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å_‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á': {
        'provinces': ['‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'subdistricts': ['‡∏ß‡∏±‡∏î‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏•‡∏≠‡∏á', '‡∏´‡∏±‡∏ß‡∏£‡∏≠', '‡∏ö‡∏∂‡∏á‡∏û‡∏£‡∏∞', '‡∏ó‡πà‡∏≤‡∏ó‡∏≠‡∏á', '‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏£‡πà‡∏≤‡∏á'],
        'highway': '11',
        'priority': 5,
        'distance_from_dc_km': 380,
        'description': 'Hub ‡πÉ‡∏´‡∏ç‡πà ‡πÇ‡∏ã‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á+‡∏ï‡∏•‡∏≤‡∏î'
    },
    'ZONE_E2_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å_‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢': {
        'provinces': ['‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'subdistricts': ['‡∏ó‡πà‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå', '‡∏≠‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å', '‡πÅ‡∏°‡πà‡∏Å‡∏≤', '‡∏™‡∏°‡∏≠‡πÅ‡∏Ç', '‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡πà‡∏≤'],
        'highway': '11',
        'priority': 6,
        'distance_from_dc_km': 385,
        'description': '‡πÇ‡∏ã‡∏ô ‡∏°.‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£'
    },
    'ZONE_E3_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå'],
        'districts': ['‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á', '‡∏û‡∏£‡∏´‡∏°‡∏û‡∏¥‡∏£‡∏≤‡∏°', '‡πÄ‡∏ô‡∏¥‡∏ô‡∏°‡∏∞‡∏õ‡∏£‡∏≤‡∏á', '‡∏ö‡∏≤‡∏á‡∏£‡∏∞‡∏Å‡∏≥', '‡∏ä‡∏≤‡∏ï‡∏¥‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏£', '‡∏ô‡∏Ñ‡∏£‡πÑ‡∏ó‡∏¢',
                      '‡∏´‡∏•‡πà‡∏°‡∏™‡∏±‡∏Å', '‡∏´‡∏•‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤', '‡πÄ‡∏Ç‡∏≤‡∏Ñ‡πâ‡∏≠'],
        'highway': '12',
        'priority': 7,
        'distance_from_dc_km': 400,
        'description': '‡πÇ‡∏ã‡∏ô‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‡∏™‡∏≤‡∏¢ 12 ‡πÑ‡∏õ‡πÄ‡∏Ç‡∏≤‡∏Ñ‡πâ‡∏≠'
    },
    'ZONE_F1_‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£_‡∏™‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å': {
        'provinces': ['‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡∏™‡∏≤‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡∏™‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏°', '‡∏ß‡∏±‡∏á‡∏ó‡∏£‡∏≤‡∏¢‡∏û‡∏π‡∏ô'],
        'highway': '11',
        'priority': 8,
        'distance_from_dc_km': 330,
        'description': '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£‡∏™‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_F2_‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£'],
        'districts': ['‡∏ï‡∏∞‡∏û‡∏≤‡∏ô‡∏´‡∏¥‡∏ô', '‡∏ó‡∏±‡∏ö‡∏Ñ‡∏•‡πâ‡∏≠', '‡∏î‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏ö‡∏≤‡∏á‡∏°‡∏π‡∏•‡∏ô‡∏≤‡∏Å'],
        'highway': '113',
        'priority': 9,
        'distance_from_dc_km': 340,
        'description': '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‡∏™‡∏≤‡∏¢ 113'
    },
    'ZONE_F3_‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£_‡∏™‡∏≤‡∏¢117': {
        'provinces': ['‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£'],
        'districts': ['‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏ä‡πâ‡∏≤‡∏á', '‡∏ö‡∏∂‡∏á‡∏ô‡∏≤‡∏£‡∏≤‡∏á', '‡∏ß‡∏ä‡∏¥‡∏£‡∏ö‡∏≤‡∏£‡∏°‡∏µ', '‡πÇ‡∏û‡∏ó‡∏∞‡πÄ‡∏•'],
        'highway': '117',
        'priority': 10,
        'distance_from_dc_km': 320,
        'description': '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£‡∏™‡∏≤‡∏¢ 117'
    },
    'ZONE_G_‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß', '‡∏ó‡πà‡∏≤‡∏ï‡∏∞‡πÇ‡∏Å', '‡πÑ‡∏û‡∏®‡∏≤‡∏•‡∏µ', '‡∏ï‡∏≤‡∏Ñ‡∏•‡∏µ', '‡∏ö‡∏£‡∏£‡∏û‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢', '‡∏ä‡∏∏‡∏°‡∏ï‡∏≤‡∏ö‡∏á', '‡∏•‡∏≤‡∏î‡∏¢‡∏≤‡∏ß', '‡∏ï‡∏≤‡∏Å‡∏ü‡πâ‡∏≤', '‡∏û‡∏¢‡∏∏‡∏´‡∏∞‡∏Ñ‡∏µ‡∏£‡∏µ', '‡πÇ‡∏Å‡∏£‡∏Å‡∏û‡∏£‡∏∞', '‡πÄ‡∏Å‡πâ‡∏≤‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß', '‡∏ä‡∏∏‡∏°‡πÅ‡∏™‡∏á', '‡πÅ‡∏°‡πà‡∏ß‡∏á‡∏Å‡πå', '‡πÅ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏ô'],
        'highway': '1/32',
        'priority': 11,
        'distance_from_dc_km': 240,
        'description': '‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡∏™‡∏≤‡∏¢ 1/32'
    },
    # ============ ‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô - ‡∏™‡∏≤‡∏¢ 2/24 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢) ============
    'ZONE_H1_‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä_‡πÄ‡∏°‡∏∑‡∏≠‡∏á': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏õ‡∏±‡∏Å‡∏ò‡∏á‡∏ä‡∏±‡∏¢'],
        'highway': '2',
        'priority': 12,
        'distance_from_dc_km': 260,
        'description': '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'
    },
    'ZONE_H2_‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'districts': ['‡∏ö‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà', '‡∏Ñ‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏µ‡∏Ñ‡∏¥‡πâ‡∏ß', '‡∏™‡∏π‡∏á‡πÄ‡∏ô‡∏¥‡∏ô', '‡πÇ‡∏ô‡∏ô‡∏™‡∏π‡∏á', '‡πÇ‡∏ô‡∏ô‡πÅ‡∏î‡∏á', '‡∏î‡πà‡∏≤‡∏ô‡∏Ç‡∏∏‡∏ô‡∏ó‡∏î'],
        'highway': '2/304',
        'priority': 12,
        'distance_from_dc_km': 280,
        'description': '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å-‡πÄ‡∏Ç‡∏≤‡πÉ‡∏´‡∏ç‡πà'
    },
    'ZONE_H3_‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä_‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'districts': ['‡∏û‡∏¥‡∏°‡∏≤‡∏¢', '‡∏´‡πâ‡∏ß‡∏¢‡πÅ‡∏ñ‡∏•‡∏á', '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡πà‡∏≠‡∏°', '‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏±‡∏¢', '‡πÅ‡∏Å‡πâ‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ô‡∏≤‡∏á', '‡πÄ‡∏ó‡∏û‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå'],
        'highway': '2',
        'priority': 12,
        'distance_from_dc_km': 270,
        'description': '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä‡πÄ‡∏´‡∏ô‡∏∑‡∏≠-‡πÄ‡∏™‡πâ‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û'
    },
    'ZONE_H4_‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä_‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'districts': ['‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á', '‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥', '‡∏Ñ‡∏á', '‡∏ä‡∏∏‡∏°‡∏û‡∏ß‡∏á'],
        'highway': '2/304',
        'priority': 12,
        'distance_from_dc_km': 290,
        'description': '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä‡πÉ‡∏ï‡πâ-‡πÄ‡∏™‡πâ‡∏ô304'
    },
    'ZONE_I1_‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô_‡πÄ‡∏°‡∏∑‡∏≠‡∏á': {
        'provinces': ['‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏ô‡πâ‡∏≥‡∏û‡∏≠‡∏á', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏±‡∏ï‡∏ô‡πå', '‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà'],
        'highway': '2',
        'priority': 13,
        'distance_from_dc_km': 450,
        'description': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á Hub ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á'
    },
    'ZONE_I2_‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô_‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'],
        'districts': ['‡∏ö‡πâ‡∏≤‡∏ô‡∏ù‡∏≤‡∏á', '‡∏ä‡∏ô‡∏ö‡∏ó', '‡∏û‡∏•', '‡πÅ‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà', '‡πÅ‡∏ß‡∏á‡∏ô‡πâ‡∏≠‡∏¢', '‡∏°‡∏±‡∏ç‡∏à‡∏≤‡∏Ñ‡∏µ‡∏£‡∏µ'],
        'highway': '2',
        'priority': 13,
        'distance_from_dc_km': 470,
        'description': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡πÉ‡∏ï‡πâ'
    },
    'ZONE_I3_‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô_‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'],
        'districts': ['‡∏Å‡∏£‡∏∞‡∏ô‡∏ß‡∏ô', '‡∏ã‡∏≥‡∏™‡∏π‡∏á', '‡πÄ‡∏õ‡∏∑‡∏≠‡∏¢‡∏ô‡πâ‡∏≠‡∏¢', '‡∏û‡∏£‡∏∞‡∏¢‡∏∑‡∏ô', '‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô', '‡∏´‡∏ô‡∏≠‡∏á‡∏™‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á', '‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡∏≠'],
        'highway': '2',
        'priority': 13,
        'distance_from_dc_km': 460,
        'description': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'
    },
    'ZONE_I4_‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°': {
        'provinces': ['‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡∏ä‡∏±‡∏¢', '‡πÅ‡∏Å‡∏î‡∏≥', '‡πÇ‡∏Å‡∏™‡∏∏‡∏°‡∏û‡∏¥‡∏™‡∏±‡∏¢', '‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°', '‡∏ô‡∏≤‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å', '‡∏ô‡∏≤‡∏î‡∏π‡∏ô', '‡∏ö‡∏£‡∏ö‡∏∑‡∏≠', '‡∏û‡∏¢‡∏±‡∏Ñ‡∏Ü‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏¥‡∏™‡∏±‡∏¢', '‡∏ß‡∏≤‡∏õ‡∏µ‡∏õ‡∏ó‡∏∏‡∏°', '‡∏¢‡∏≤‡∏á‡∏™‡∏µ‡∏™‡∏∏‡∏£‡∏≤‡∏ä'],
        'highway': '2',
        'priority': 13,
        'distance_from_dc_km': 480,
        'description': '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°'
    },
    'ZONE_I5_‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î': {
        'provinces': ['‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ß‡∏¥‡∏™‡∏±‡∏¢', '‡∏õ‡∏ó‡∏∏‡∏°‡∏£‡∏±‡∏ï‡∏ï‡πå', '‡∏ò‡∏ß‡∏±‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡∏û‡∏ô‡∏°‡πÑ‡∏û‡∏£', '‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏£‡∏ß‡∏á', '‡πÄ‡∏™‡∏•‡∏†‡∏π‡∏°‡∏¥', '‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥', '‡∏≠‡∏≤‡∏à‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ'],
        'highway': '2/214',
        'priority': 13,
        'distance_from_dc_km': 510,
        'description': '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'
    },
    'ZONE_I6_‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå': {
        'provinces': ['‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', '‡∏Å‡∏°‡∏•‡∏≤‡πÑ‡∏™‡∏¢', '‡∏Å‡∏∏‡∏â‡∏¥‡∏ô‡∏≤‡∏£‡∏≤‡∏¢‡∏ì‡πå', '‡πÄ‡∏Ç‡∏≤‡∏ß‡∏á', '‡∏Ñ‡∏≥‡∏°‡πà‡∏ß‡∏á', '‡∏î‡∏≠‡∏ô‡∏à‡∏≤‡∏ô', '‡∏ó‡πà‡∏≤‡∏Ñ‡∏±‡∏ô‡πÇ‡∏ó', '‡∏ô‡∏≤‡∏Ñ‡∏π', '‡∏ô‡∏≤‡∏°‡∏ô', '‡∏¢‡∏≤‡∏á‡∏ï‡∏•‡∏≤‡∏î', '‡∏Ü‡πâ‡∏≠‡∏á‡∏ä‡∏±‡∏¢', '‡∏£‡πà‡∏≠‡∏á‡∏Ñ‡∏≥', '‡∏™‡∏´‡∏±‡∏™‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à', '‡∏™‡∏≤‡∏°‡∏ä‡∏±‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏Å‡∏∏‡∏á‡∏®‡∏£‡∏µ', '‡∏´‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡πá‡∏Å', '‡∏´‡πâ‡∏ß‡∏¢‡∏ú‡∏∂‡πâ‡∏á'],
        'highway': '213',
        'priority': 13,
        'distance_from_dc_km': 520,
        'description': '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå'
    },
    'ZONE_J_‡∏≠‡∏∏‡∏î‡∏£': {
        'provinces': ['‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡πÄ‡∏•‡∏¢', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨'],
        'highway': '2',
        'priority': 14,
        'distance_from_dc_km': 560,
        'description': '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡∏™‡∏≤‡∏¢ 2 ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
    },
    'ZONE_K_‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£'],
        'highway': '24',
        'priority': 15,
        'distance_from_dc_km': 500,
        'description': '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÉ‡∏ï‡πâ ‡∏™‡∏≤‡∏¢ 24'
    },
    # ============ ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å - ‡∏™‡∏≤‡∏¢ 3 ============
    'ZONE_L_‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏∞‡∏¢‡∏≠‡∏á': {
        'provinces': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á'],
        # ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á (‡πÄ‡∏°‡∏∑‡∏≠‡∏á/‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤/‡∏ö‡πâ‡∏≤‡∏ô‡∏ö‡∏∂‡∏á/‡∏û‡∏±‡∏ó‡∏¢‡∏≤/‡∏™‡∏±‡∏ï‡∏´‡∏µ‡∏ö) + ‡∏£‡∏∞‡∏¢‡∏≠‡∏á ‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏¢ 3 (Bang Na-Trat)
        'highway': '3',
        'priority': 16,
        'distance_from_dc_km': 120,
        'description': '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á+‡∏£‡∏∞‡∏¢‡∏≠‡∏á ‡∏™‡∏≤‡∏¢ 3 (Bang Na‚ÜíTrat) EEC'
    },
    # ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠/‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô: ‡∏û‡∏ô‡∏±‡∏™‡∏ô‡∏¥‡∏Ñ‡∏°/‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á/‡∏´‡∏ô‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏¢ 304‚Üí31 ‡∏à‡∏≤‡∏Å‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤
    'ZONE_L1_‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ'],
        'districts': ['‡∏û‡∏ô‡∏±‡∏™‡∏ô‡∏¥‡∏Ñ‡∏°', '‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á', '‡∏´‡∏ô‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà', '‡πÄ‡∏Å‡∏≤‡∏∞‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå'],
        'highway': '304/331',
        'priority': 16.5,
        'distance_from_dc_km': 90,
        'description': '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô ‡∏™‡∏≤‡∏¢ 304‚Üí331 ‡∏ú‡πà‡∏≤‡∏ô‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤'
    },
    # ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ ‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å: ‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠-‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏≤‡∏¢ 3 ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ
    'ZONE_EAST_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£': {
        'provinces': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠', '‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á'],
        'highway': '3/331',
        'priority': 28,
        'distance_from_dc_km': 55,
        'description': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠-‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á ‡∏™‡∏≤‡∏¢ 3 ‡∏ï‡πà‡∏≠‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ'
    },
    'ZONE_M_‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ‡∏ï‡∏£‡∏≤‡∏î': {
        'provinces': ['‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ï‡∏£‡∏≤‡∏î'],
        'highway': '3',
        'priority': 17,
        'distance_from_dc_km': 300,
        'description': '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏Å‡∏• ‡∏™‡∏≤‡∏¢ 3 ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
    },
    # ============ ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ - ‡∏™‡∏≤‡∏¢ 4 ============
    'ZONE_N_‡πÉ‡∏ï‡πâ‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô': {
        'provinces': ['‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á'],
        'highway': '4',
        'priority': 18,
        'distance_from_dc_km': 400,
        'description': '‡πÉ‡∏ï‡πâ‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô ‡∏™‡∏≤‡∏¢ 4 (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ä‡∏∏‡∏°‡∏û‡∏£)'
    },
    # ‡∏ä‡∏∏‡∏°‡∏û‡∏£ - ‡πÅ‡∏¢‡∏Å‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢
    'ZONE_N1_‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'districts': ['‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß', '‡∏™‡∏ß‡∏µ', '‡∏•‡∏∞‡πÅ‡∏°', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'highway': '4',
        'priority': 18.1,
        'distance_from_dc_km': 420,
        'description': '‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß-‡∏™‡∏ß‡∏µ-‡πÄ‡∏°‡∏∑‡∏≠‡∏á)'
    },
    'ZONE_N2_‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'districts': ['‡∏ó‡∏∏‡πà‡∏á‡∏ï‡∏∞‡πÇ‡∏Å', '‡∏û‡∏∞‡πÇ‡∏ï‡πä‡∏∞', '‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏ô', '‡∏ó‡πà‡∏≤‡πÅ‡∏ã‡∏∞'],
        'highway': '4',
        'priority': 18.2,
        'distance_from_dc_km': 450,
        'description': '‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÉ‡∏ï‡πâ (‡∏ó‡∏∏‡πà‡∏á‡∏ï‡∏∞‡πÇ‡∏Å-‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏ô)'
    },
    'ZONE_N3_‡∏ä‡∏∏‡∏°‡∏û‡∏£‡∏Å‡∏•‡∏≤‡∏á': {
        'provinces': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢', '‡∏ó‡∏±‡∏ö‡∏™‡∏∞‡πÅ‡∏Å', '‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô'],
        'highway': '4',
        'priority': 18.3,
        'distance_from_dc_km': 440,
        'description': '‡∏ä‡∏∏‡∏°‡∏û‡∏£‡∏Å‡∏•‡∏≤‡∏á (‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢-‡∏ó‡∏±‡∏ö‡∏™‡∏∞‡πÅ‡∏Å-‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô)'
    },
    'ZONE_O_‡πÉ‡∏ï‡πâ‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢': {
        'provinces': ['‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™'],
        'highway': '4',
        'priority': 19,
        'distance_from_dc_km': 700,
        'description': '‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢ ‡∏™‡∏≤‡∏¢ 4'
    },
    'ZONE_P_‡πÉ‡∏ï‡πâ‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô': {
        'provinces': ['‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏û‡∏±‡∏á‡∏á‡∏≤', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏ï‡∏£‡∏±‡∏á', '‡∏™‡∏ï‡∏π‡∏•'],
        'highway': '401/402',
        'priority': 20,
        'distance_from_dc_km': 850,
        'description': '‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô ‡∏™‡∏≤‡∏¢ 401/402'
    },
    # ============ ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏• (‡πÅ‡∏ö‡πà‡∏á‡πÇ‡∏ã‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) ============
    'ZONE_BKK_‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà', '‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°', '‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£', '‡∏û‡∏ç‡∏≤‡πÑ‡∏ó', '‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', '‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á'],
        'highway': '1/9',
        'priority': 95,
        'distance_from_dc_km': 50,
        'description': '‡∏Å‡∏ó‡∏°.‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô-‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á'
    },
    'ZONE_BKK_‡∏Å‡∏•‡∏≤‡∏á': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô', '‡∏ß‡∏±‡∏í‡∏ô‡∏≤', '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', '‡∏™‡∏≤‡∏ó‡∏£', '‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤'],
        'highway': 'CBD',
        'priority': 96,
        'distance_from_dc_km': 55,
        'description': '‡∏Å‡∏ó‡∏°.‡∏Å‡∏•‡∏≤‡∏á CBD-‡∏™‡∏µ‡∏•‡∏°-‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó'
    },
    'ZONE_BKK_‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ', '‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞', '‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏', '‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á', '‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô', '‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô', '‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®', '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å'],
        'highway': '35',
        'priority': 97,
        'distance_from_dc_km': 60,
        'description': '‡∏Å‡∏ó‡∏°.‡πÉ‡∏ï‡πâ ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 2-‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô'
    },
    'ZONE_BKK_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥', '‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°', '‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á', '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', '‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤', '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å'],
        'highway': '3/9',
        'priority': 98,
        'distance_from_dc_km': 45,
        'description': '‡∏Å‡∏ó‡∏°.‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ‡∏£‡∏≤‡∏°‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤-‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á'
    },
    'ZONE_NEARBY_‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ß‡∏¢', '‡∏ö‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà', '‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á', '‡πÑ‡∏ó‡∏£‡∏ô‡πâ‡∏≠‡∏¢', '‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î'],
        'highway': '9/35',
        'priority': 99,
        'distance_from_dc_km': 35,
        'description': '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏ó‡∏°'
    },
    'ZONE_NEARBY_‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ': {
        'provinces': ['‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á', '‡∏ò‡∏±‡∏ç‡∏ö‡∏∏‡∏£‡∏µ', '‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡∏≠', '‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏Å‡πâ‡∏ß', '‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤', '‡∏™‡∏≤‡∏°‡πÇ‡∏Ñ‡∏Å'],
        'highway': '1/9/305',
        'priority': 99,
        'distance_from_dc_km': 25,
        'description': '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ ‡πÉ‡∏Å‡∏•‡πâ DC ‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢'
    },
    'ZONE_NEARBY_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£': {
        'provinces': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ', '‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á', '‡∏û‡∏£‡∏∞‡∏™‡∏°‡∏∏‡∏ó‡∏£‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå'],
        'highway': '3/9/34',
        'priority': 99,
        'distance_from_dc_km': 40,
        'description': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å ‡πÄ‡∏°‡∏∑‡∏≠‡∏á-‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á-‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ (‡∏ù‡∏±‡πà‡∏á‡∏Å‡∏ó‡∏°)'
    },
    'ZONE_NEARBY_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£': {
        'provinces': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∞‡∏ó‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ô', '‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏û‡πâ‡∏ß'],
        'highway': '35',
        'priority': 99,
        'distance_from_dc_km': 50,
        'description': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ‡∏°‡∏´‡∏≤‡∏ä‡∏±‡∏¢'
    },
    'ZONE_NEARBY_‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÅ‡∏™‡∏ô', '‡∏ô‡∏Ñ‡∏£‡∏ä‡∏±‡∏¢‡∏®‡∏£‡∏µ', '‡∏î‡∏≠‡∏ô‡∏ï‡∏π‡∏°', '‡∏ö‡∏≤‡∏á‡πÄ‡∏•‡∏ô', '‡∏™‡∏≤‡∏°‡∏û‡∏£‡∏≤‡∏ô', '‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ì‡∏ë‡∏•'],
        'highway': '35/4',
        'priority': 99,
        'distance_from_dc_km': 55,
        'description': '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏° ‡∏°.‡πÄ‡∏Å‡∏©‡∏ï‡∏£-‡∏™‡∏≤‡∏°‡∏û‡∏£‡∏≤‡∏ô'
    },
    'ZONE_NEARBY_‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': {
        'provinces': ['‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤'],
        'districts': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠', '‡∏ô‡∏Ñ‡∏£‡∏´‡∏•‡∏ß‡∏á', '‡∏ö‡∏≤‡∏á‡πÑ‡∏ó‡∏£', '‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏´‡∏±‡∏ô', '‡∏ö‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢', '‡∏ú‡∏±‡∏Å‡πÑ‡∏´‡πà', '‡∏†‡∏≤‡∏ä‡∏µ', '‡∏•‡∏≤‡∏î‡∏ö‡∏±‡∏ß‡∏´‡∏•‡∏ß‡∏á', '‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢', '‡πÄ‡∏™‡∏ô‡∏≤', '‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏≠‡∏¥‡∏ô', '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢'],
        'highway': '1/32',
        'priority': 99,
        'distance_from_dc_km': 20,
        'description': '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤-‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (DC ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà!)'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° - ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á DC ============
    'ZONE_F4_‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£': {
        'provinces': ['‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£'],
        'highway': '1',
        'priority': 10.5,
        'distance_from_dc_km': 340,
        'description': '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£ ‡∏™‡∏≤‡∏¢ 1 ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á'
    },
    'ZONE_F4_‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢': {
        'provinces': ['‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢'],
        'highway': '1',
        'priority': 11,
        'distance_from_dc_km': 400,
        'description': '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢ ‡∏™‡∏≤‡∏¢ 1 ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á'
    },
    'ZONE_NEARBY_‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ'],
        'highway': '1/32',
        'priority': 99,
        'distance_from_dc_km': 100,
        'description': '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ ‡∏™‡∏≤‡∏¢ 1/32 ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô'
    },
    'ZONE_NEARBY_‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á': {
        'provinces': ['‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á'],
        'highway': '1/32',
        'priority': 99,
        'distance_from_dc_km': 80,
        'description': '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á ‡∏™‡∏≤‡∏¢ 1/32 ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô'
    },
    'ZONE_NEARBY_‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó': {
        'provinces': ['‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó'],
        'highway': '1/32',
        'priority': 99,
        'distance_from_dc_km': 150,
        'description': '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó ‡∏™‡∏≤‡∏¢ 1/32 ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô'
    },
    'ZONE_NEARBY_‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ'],
        'highway': '1/21',
        'priority': 99,
        'distance_from_dc_km': 140,
        'description': '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ ‡∏™‡∏≤‡∏¢ 1/21 ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô'
    },
    'ZONE_NEARBY_‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ'],
        'highway': '1/2',
        'priority': 99,
        'distance_from_dc_km': 80,
        'description': '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ ‡∏™‡∏≤‡∏¢ 1/2 ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏≠‡∏µ‡∏™‡∏≤‡∏ô-‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° - ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡πÅ‡∏¢‡∏Å‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ============
    'ZONE_BKK_‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà', '‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°', '‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô', '‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß', '‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°', '‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥', '‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á', '‡∏Ñ‡∏±‡∏ô‡∏ô‡∏≤‡∏¢‡∏≤‡∏ß'],
        'highway': '‡∏Å‡∏ó‡∏°-‡πÄ‡∏´‡∏ô‡∏∑‡∏≠',
        'priority': 99,
        'distance_from_dc_km': 30,
        'description': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (‡πÉ‡∏Å‡∏•‡πâ DC ‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢)'
    },
    'ZONE_BKK_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤', '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å', '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', '‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á', '‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®', '‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á', '‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á', '‡∏ö‡∏≤‡∏á‡∏ô‡∏≤', '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', '‡∏ß‡∏±‡∏í‡∏ô‡∏≤'],
        'highway': '‡∏Å‡∏ó‡∏°-‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å',
        'priority': 99,
        'distance_from_dc_km': 55,
        'description': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'
    },
    'ZONE_BKK_‡πÉ‡∏ï‡πâ': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô', '‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô', '‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á', '‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞', '‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏', '‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°', '‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤', '‡∏™‡∏≤‡∏ó‡∏£', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô'],
        'highway': '‡∏Å‡∏ó‡∏°-‡πÉ‡∏ï‡πâ',
        'priority': 99,
        'distance_from_dc_km': 70,
        'description': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÉ‡∏ï‡πâ'
    },
    'ZONE_BKK_‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î', '‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô', '‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤', '‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°', '‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ', '‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà', '‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢', '‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ', '‡∏û‡∏ç‡∏≤‡πÑ‡∏ó', '‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', '‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á'],
        'highway': '‡∏Å‡∏ó‡∏°-‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å',
        'priority': 99,
        'distance_from_dc_km': 60,
        'description': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å/‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'
    },
    'ZONE_BKK_‡∏Å‡∏•‡∏≤‡∏á': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'districts': ['‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢', '‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå', '‡∏î‡∏∏‡∏™‡∏¥‡∏ï', '‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠'],
        'highway': '‡∏Å‡∏ó‡∏°-‡∏Å‡∏•‡∏≤‡∏á',
        'priority': 99,
        'distance_from_dc_km': 50,
        'description': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Å‡∏•‡∏≤‡∏á/‡πÄ‡∏Å‡∏≤‡∏∞‡∏£‡∏±‡∏ï‡∏ô‡πÇ‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡πå'
    },
    # Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Ç‡∏ï
    'ZONE_BKK_‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': {
        'provinces': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
        'highway': '‡∏Å‡∏ó‡∏°',
        'priority': 99,
        'distance_from_dc_km': 50,
        'description': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (fallback)'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏• ============
    'ZONE_CENTRAL_‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ'],
        'highway': '‡∏Å‡∏ó‡∏°',
        'priority': 99,
        'distance_from_dc_km': 40,
        'description': '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•'
    },
    'ZONE_CENTRAL_‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ': {
        'provinces': ['‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ'],
        'highway': '‡∏Å‡∏ó‡∏°',
        'priority': 99,
        'distance_from_dc_km': 30,
        'description': '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ ‡πÉ‡∏Å‡∏•‡πâ DC'
    },
    'ZONE_CENTRAL_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£': {
        'provinces': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£'],
        'highway': '‡∏Å‡∏ó‡∏°',
        'priority': 99,
        'distance_from_dc_km': 60,
        'description': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•'
    },
    'ZONE_CENTRAL_‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°'],
        'highway': '35/4',
        'priority': 99,
        'distance_from_dc_km': 55,
        'description': '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏° ‡∏™‡∏≤‡∏¢ 35/4'
    },
    'ZONE_CENTRAL_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£': {
        'provinces': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£'],
        'highway': '35',
        'priority': 99,
        'distance_from_dc_km': 70,
        'description': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ‡∏™‡∏≤‡∏¢ 35'
    },
    'ZONE_CENTRAL_‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°': {
        'provinces': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°'],
        'highway': '35',
        'priority': 99,
        'distance_from_dc_km': 90,
        'description': '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏° ‡∏™‡∏≤‡∏¢ 35'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° - ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô ============
    'ZONE_F4_‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå'],
        'highway': '1',
        'priority': 10,
        'distance_from_dc_km': 240,
        'description': '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå ‡∏™‡∏≤‡∏¢ 1 ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô'
    },
    'ZONE_CENTRAL_‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': {
        'provinces': ['‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤'],
        'highway': '1/32',
        'priority': 99,
        'distance_from_dc_km': 25,
        'description': '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ ‡πÉ‡∏Å‡∏•‡πâ DC'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° - ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å ============
    'ZONE_EAST_‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å'],
        'highway': '305',
        'priority': 90,
        'distance_from_dc_km': 100,
        'description': '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å ‡∏™‡∏≤‡∏¢ 305'
    },
    'ZONE_EAST_‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤': {
        'provinces': ['‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤'],
        'highway': '304/331',  # ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠
        'priority': 17,  # ‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏±‡∏î‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô highway 304/331)
        'distance_from_dc_km': 80,
        'description': '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤ ‡∏™‡∏≤‡∏¢ 304/331 (‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡∏Å‡∏±‡∏ö‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÑ‡∏î‡πâ)'
    },
    'ZONE_EAST_‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'],
        'highway': '304',
        'priority': 85,
        'distance_from_dc_km': 130,
        'description': '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ ‡∏™‡∏≤‡∏¢ 304'
    },
    'ZONE_EAST_‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß': {
        'provinces': ['‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß'],
        'highway': '33',
        'priority': 80,
        'distance_from_dc_km': 220,
        'description': '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß ‡∏™‡∏≤‡∏¢ 33'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° - ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å ============
    'ZONE_WEST_‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ'],
        'highway': '4',
        'priority': 85,
        'distance_from_dc_km': 100,
        'description': '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ ‡∏™‡∏≤‡∏¢ 4'
    },
    'ZONE_WEST_‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'],
        'highway': '323',
        'priority': 80,
        'distance_from_dc_km': 150,
        'description': '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ ‡∏™‡∏≤‡∏¢ 323'
    },
    'ZONE_WEST_‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ': {
        'provinces': ['‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ'],
        'highway': '340',
        'priority': 85,
        'distance_from_dc_km': 110,
        'description': '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ ‡∏™‡∏≤‡∏¢ 340'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° - ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ============
    'ZONE_NORTH_‡∏û‡∏∞‡πÄ‡∏¢‡∏≤': {
        'provinces': ['‡∏û‡∏∞‡πÄ‡∏¢‡∏≤'],
        'highway': '1',
        'priority': 1,
        'distance_from_dc_km': 680,
        'description': '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ ‡∏™‡∏≤‡∏¢ 1'
    },
    'ZONE_NORTH_‡∏ô‡πà‡∏≤‡∏ô': {
        'provinces': ['‡∏ô‡πà‡∏≤‡∏ô'],
        'highway': '101',
        'priority': 2,
        'distance_from_dc_km': 620,
        'description': '‡∏ô‡πà‡∏≤‡∏ô ‡∏™‡∏≤‡∏¢ 101'
    },
    'ZONE_NORTH_‡πÅ‡∏û‡∏£‡πà': {
        'provinces': ['‡πÅ‡∏û‡∏£‡πà'],
        'highway': '11',
        'priority': 3,
        'distance_from_dc_km': 540,
        'description': '‡πÅ‡∏û‡∏£‡πà ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_NORTH_‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå': {
        'provinces': ['‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå'],
        'highway': '11',
        'priority': 4,
        'distance_from_dc_km': 450,
        'description': '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_F4_‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å': {
        'provinces': ['‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å'],
        'highway': '12',
        'priority': 12,
        'distance_from_dc_km': 380,
        'description': '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å ‡∏™‡∏≤‡∏¢ 12'
    },
    'ZONE_F4_‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£': {
        'provinces': ['‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£'],
        'highway': '1',
        'priority': 11,
        'distance_from_dc_km': 330,
        'description': '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£ ‡∏™‡∏≤‡∏¢ 1'
    },
    'ZONE_F4_‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå': {
        'provinces': ['‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå'],
        'highway': '21',
        'priority': 15,
        'distance_from_dc_km': 350,
        'description': '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏™‡∏≤‡∏¢ 21'
    },
    'ZONE_F4_‡∏ï‡∏≤‡∏Å': {
        'provinces': ['‡∏ï‡∏≤‡∏Å'],
        'highway': '1',
        'priority': 13,
        'distance_from_dc_km': 430,
        'description': '‡∏ï‡∏≤‡∏Å ‡∏™‡∏≤‡∏¢ 1'
    },
    'ZONE_F4_‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ': {
        'provinces': ['‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ'],
        'highway': '333',
        'priority': 14,
        'distance_from_dc_km': 230,
        'description': '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ ‡∏™‡∏≤‡∏¢ 333'
    },
    'ZONE_NORTH_‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà': {
        'provinces': ['‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà'],
        'highway': '11',
        'priority': 5,
        'distance_from_dc_km': 700,
        'description': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_NORTH_‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢': {
        'provinces': ['‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢'],
        'highway': '1',
        'priority': 3,
        'distance_from_dc_km': 780,
        'description': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢ ‡∏™‡∏≤‡∏¢ 1'
    },
    'ZONE_NORTH_‡∏•‡∏≥‡∏û‡∏π‡∏ô': {
        'provinces': ['‡∏•‡∏≥‡∏û‡∏π‡∏ô'],
        'highway': '11',
        'priority': 6,
        'distance_from_dc_km': 680,
        'description': '‡∏•‡∏≥‡∏û‡∏π‡∏ô ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_NORTH_‡∏•‡∏≥‡∏õ‡∏≤‡∏á': {
        'provinces': ['‡∏•‡∏≥‡∏õ‡∏≤‡∏á'],
        'highway': '11',
        'priority': 7,
        'distance_from_dc_km': 600,
        'description': '‡∏•‡∏≥‡∏õ‡∏≤‡∏á ‡∏™‡∏≤‡∏¢ 11'
    },
    'ZONE_NORTH_‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô': {
        'provinces': ['‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô'],
        'highway': '108',
        'priority': 2,
        'distance_from_dc_km': 850,
        'description': '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô ‡∏™‡∏≤‡∏¢ 108 (‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î)'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° - ‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô ============
    'ZONE_ISAN_‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤': {
        'provinces': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'],
        'highway': '2',
        'priority': 50,
        'distance_from_dc_km': 260,
        'description': '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤ ‡∏™‡∏≤‡∏¢ 2 (‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û)'
    },
    'ZONE_ISAN_‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô': {
        'provinces': ['‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'],
        'highway': '2',
        'priority': 45,
        'distance_from_dc_km': 450,
        'description': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‡∏™‡∏≤‡∏¢ 2 (‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û)'
    },
    'ZONE_ISAN_‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥': {
        'provinces': ['‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥'],
        'highway': '201',
        'priority': 48,
        'distance_from_dc_km': 340,
        'description': '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥ ‡∏™‡∏≤‡∏¢ 201'
    },
    'ZONE_ISAN_‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå': {
        'provinces': ['‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå'],
        'highway': '12',
        'priority': 40,
        'distance_from_dc_km': 500,
        'description': '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå ‡∏™‡∏≤‡∏¢ 12'
    },
    'ZONE_ISAN_‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°': {
        'provinces': ['‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°'],
        'highway': '2',
        'priority': 42,
        'distance_from_dc_km': 470,
        'description': '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏° ‡∏™‡∏≤‡∏¢ 2'
    },
    'ZONE_ISAN_‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î': {
        'provinces': ['‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'],
        'highway': '23',
        'priority': 38,
        'distance_from_dc_km': 520,
        'description': '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î ‡∏™‡∏≤‡∏¢ 23'
    },
    # ============ ‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° - ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô ============
    'ZONE_SOUTH_‡∏ä‡∏∏‡∏°‡∏û‡∏£': {
        'provinces': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£'],
        'highway': '4',
        'priority': 60,
        'distance_from_dc_km': 470,
        'description': '‡∏ä‡∏∏‡∏°‡∏û‡∏£ ‡∏™‡∏≤‡∏¢ 4 (‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÉ‡∏ï‡πâ)'
    },
}

# ==========================================
# ZONE/REGION CONFIG - ‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏Ñ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
# ==========================================
# ‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏Ñ: 1=‡∏Å‡∏•‡∏≤‡∏á, 2=‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å, 3=‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å, 4=‡πÄ‡∏´‡∏ô‡∏∑‡∏≠, 5=‡∏≠‡∏µ‡∏™‡∏≤‡∏ô, 6=‡πÉ‡∏ï‡πâ
REGION_CODE = {
    # ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á (‡∏£‡∏´‡∏±‡∏™ 1)
    '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£': '10', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø': '10',
    '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': '11',
    '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ': '12',
    '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': '13', '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': '13',
    '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ': '14',
    '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ': '15',
    '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ': '16',
    '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á': '17',
    '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó': '18',
    '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°': '19',
    '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£': '1A',
    '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£': '1B',
    '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°': '1C',
    
    # ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å (‡∏£‡∏´‡∏±‡∏™ 2)
    '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ': '20',
    '‡∏£‡∏∞‡∏¢‡∏≠‡∏á': '21',
    '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': '22',
    '‡∏ï‡∏£‡∏≤‡∏î': '23',
    '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤': '24',
    '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': '25',
    '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß': '26',
    '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å': '27',
    
    # ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å (‡∏£‡∏´‡∏±‡∏™ 3)
    '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ': '30',
    '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': '31',
    '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ': '32',
    '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ': '33',
    '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå': '34',
    
    # ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (‡∏£‡∏´‡∏±‡∏™ 4)
    '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå': '40',
    '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ': '41',
    '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£': '42',
    '‡∏ï‡∏≤‡∏Å': '43',
    '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢': '44',
    '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å': '45',
    '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£': '46',
    '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå': '47',
    '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå': '48',
    '‡πÅ‡∏û‡∏£‡πà': '49',
    '‡∏ô‡πà‡∏≤‡∏ô': '4A',
    '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤': '4B',
    '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢': '4C',
    '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà': '4D',
    '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô': '4E',
    '‡∏•‡∏≥‡∏û‡∏π‡∏ô': '4F',
    '‡∏•‡∏≥‡∏õ‡∏≤‡∏á': '4G',
    
    # ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠/‡∏≠‡∏µ‡∏™‡∏≤‡∏ô (‡∏£‡∏´‡∏±‡∏™ 5)
    '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤': '50', '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä': '50',
    '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå': '51',
    '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå': '52',
    '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©': '53',
    '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ': '54',
    '‡∏¢‡πÇ‡∏™‡∏ò‡∏£': '55',
    '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥': '56',
    '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç': '57',
    '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π': '58',
    '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô': '59',
    '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ': '5A',
    '‡πÄ‡∏•‡∏¢': '5B',
    '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢': '5C',
    '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°': '5D',
    '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î': '5E',
    '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå': '5F',
    '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£': '5G',
    '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°': '5H',
    '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£': '5I',
    '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨': '5J',
    
    # ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ (‡∏£‡∏´‡∏±‡∏™ 6)
    '‡∏ä‡∏∏‡∏°‡∏û‡∏£': '60',
    '‡∏£‡∏∞‡∏ô‡∏≠‡∏á': '61',
    '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ': '62',
    '‡∏û‡∏±‡∏á‡∏á‡∏≤': '63',
    '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà': '64',
    '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï': '65',
    '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä': '66',
    '‡∏ï‡∏£‡∏±‡∏á': '67',
    '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á': '68',
    '‡∏™‡∏á‡∏Ç‡∏•‡∏≤': '69',
    '‡∏™‡∏ï‡∏π‡∏•': '6A',
    '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ': '6B',
    '‡∏¢‡∏∞‡∏•‡∏≤': '6C',
    '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™': '6D',
}

# ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ
REGION_NAMES = {
    '1': '‡∏Å‡∏•‡∏≤‡∏á',
    '2': '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å',
    '3': '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å',
    '4': '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠',
    '5': '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô',
    '6': '‡πÉ‡∏ï‡πâ',
    '9': '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
}

# ==========================================
# HELPER: ZONE/REGION FUNCTIONS
# ==========================================
def get_region_code(province):
    """‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏†‡∏≤‡∏Ñ/‡πÇ‡∏ã‡∏ô‡∏à‡∏≤‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"""
    if not province or str(province).strip() == '' or str(province) == 'nan':
        return '99'  # ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏
    province = clean_name(str(province).strip())  # ‡∏•‡∏ö ‡∏à./‡∏≠./‡∏ï. prefix
    # normalize aliases (‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ ‚Üí ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ ‡∏Ø‡∏•‡∏Ø)
    _alias = {
        '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',
        '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡∏Å‡∏ó‡∏°': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡∏Å‡∏ó‡∏°.': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä': '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',
    }
    province = _alias.get(province, province)
    return REGION_CODE.get(province, '99')

def get_region_name(province):
    """‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ‡∏à‡∏≤‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"""
    code = get_region_code(province)
    if code == '99':
        return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    region_prefix = code[0]
    return REGION_NAMES.get(region_prefix, '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')

# ==========================================
# LOGISTICS ZONE FUNCTIONS
# ==========================================
def get_logistics_zone(province, district='', subdistrict=''):
    """
    ‡∏´‡∏≤‡πÇ‡∏ã‡∏ô‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå‡∏à‡∏≤‡∏Å ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•
    
    ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î) ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•)
    
    Returns:
        zone_name (str): ‡πÄ‡∏ä‡πà‡∏ô 'ZONE_A_‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', 'ZONE_NEARBY_‡∏Å‡∏ó‡∏°', None ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    """
    if not province or str(province).strip() == '':
        return None
    
    province = str(province).strip()
    district = str(district).strip() if district else ''
    subdistrict = str(subdistrict).strip() if subdistrict else ''
    
    # üéØ ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ districts/subdistricts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
    # ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏•‡πà‡∏•‡∏á‡πÑ‡∏õ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (‡∏°‡∏µ districts/subdistricts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
    
    main_zones = []  # ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
    sub_zones = []   # ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•)
    
    # ‡πÅ‡∏¢‡∏Å‡πÇ‡∏ã‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å/‡∏¢‡πà‡∏≠‡∏¢
    for zone_name, zone_info in LOGISTICS_ZONES.items():
        if province in zone_info['provinces']:
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ districts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î = ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å
            if 'districts' not in zone_info or not zone_info['districts']:
                main_zones.append((zone_name, zone_info))
            else:
                # ‡∏°‡∏µ districts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î = ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢
                sub_zones.append((zone_name, zone_info))
    
    # 1Ô∏è‚É£ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏°‡∏≤)
    if district:
        for zone_name, zone_info in sub_zones:
            if district in zone_info['districts']:
                # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ subdistricts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏ß‡∏¢ ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
                if 'subdistricts' in zone_info and zone_info['subdistricts']:
                    if subdistrict and subdistrict in zone_info['subdistricts']:
                        return zone_name
                else:
                    # ‡πÑ‡∏°‡πà‡∏°‡∏µ subdistricts ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‚Üí return ‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ
                    return zone_name
    
    # 2Ô∏è‚É£ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÇ‡∏ã‡∏ô‡∏¢‡πà‡∏≠‡∏¢ ‚Üí ‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡∏´‡∏•‡∏±‡∏Å
    if main_zones:
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° priority)
        main_zones_sorted = sorted(main_zones, key=lambda x: x[1].get('priority', 999))
        return main_zones_sorted[0][0]
    
    return None

def get_zone_priority(zone_name):
    """
    ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Priority ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LIFO: ‡πÑ‡∏Å‡∏•‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
    
    Returns:
        int: 1-99 (1 = ‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î, 99 = ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î)
    """
    if not zone_name or zone_name not in LOGISTICS_ZONES:
        return 999  # ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÇ‡∏ã‡∏ô ‚Üí ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î
    
    return LOGISTICS_ZONES[zone_name]['priority']

def get_zone_highway(zone_name):
    """
    ‡∏î‡∏∂‡∏á‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô
    
    Returns:
        str: ‡πÄ‡∏ä‡πà‡∏ô '‡∏™‡∏≤‡∏¢ 1 (‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô)', '‡∏™‡∏≤‡∏¢ 2 (‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û)'
    """
    if not zone_name or zone_name not in LOGISTICS_ZONES:
        return ''
    
    return LOGISTICS_ZONES[zone_name].get('highway', '')

def can_combine_zones_by_highway(zone1, zone2):
    """
    ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ 2 ‡πÇ‡∏ã‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà ‚Üí ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏î‡πâ)
    
    Returns:
        bool: True ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    """
    if not zone1 or not zone2:
        return False
    
    highway1 = get_zone_highway(zone1)
    highway2 = get_zone_highway(zone2)
    
    if not highway1 or not highway2:
        return False
    
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô (set intersection) ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö '304' == '304/331'
    return bool(set(highway1.split('/')) & set(highway2.split('/')))

def is_cross_zone_violation(province1, province2):
    """
    ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á 2 ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô NO_CROSS_ZONE_PAIRS ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á - Soft Rule)
    
    Returns:
        bool: True ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏£‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÇ‡∏ã‡∏ô
    """
    if not province1 or not province2:
        return False
    
    prov1 = str(province1).strip()
    prov2 = str(province2).strip()
    
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ó‡∏≤‡∏á
    return (prov1, prov2) in NO_CROSS_ZONE_PAIRS or (prov2, prov1) in NO_CROSS_ZONE_PAIRS

def are_provinces_on_same_route(province1, province2):
    """
    ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á 2 ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô ROUTE ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    
    Returns:
        bool: True ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà route ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô)
    """
    if not province1 or not province2:
        return False
    
    prov1 = str(province1).strip()
    prov2 = str(province2).strip()
    
    # ‡∏´‡∏≤ route ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    route1 = None
    route2 = None
    
    for route_name, route_info in ROUTE_GROUPS.items():
        if prov1 in route_info['provinces']:
            route1 = route_name
        if prov2 in route_info['provinces']:
            route2 = route_name
    
    # ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà route ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    if route1 and route2:
        if route1 == route2:
            return True
        # ‡πÄ‡∏ä‡πá‡∏Ñ next_routes
        if route2 in ROUTE_GROUPS.get(route1, {}).get('next_routes', []):
            return True
        if route1 in ROUTE_GROUPS.get(route2, {}).get('next_routes', []):
            return True
    
    return False

def calculate_district_centroid(district_df):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤"""
    valid_coords = district_df[district_df['_lat'] > 0]
    if valid_coords.empty:
        return None, None
    return valid_coords['_lat'].mean(), valid_coords['_lon'].mean()

def check_geographic_proximity(district1_df, district2_df, max_distance_km=MAX_DISTRICT_DISTANCE_KM):
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ 2 ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡∏û‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    prov1 = district1_df['_province'].iloc[0] if not district1_df.empty else ''
    prov2 = district2_df['_province'].iloc[0] if not district2_df.empty else ''
    
    # üö® ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ Logistics Zone ‡∏Å‡πà‡∏≠‡∏ô
    if prov1 and prov2 and prov1 != prov2:
        # ‡πÅ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà Logistics Zone ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        zone1 = get_logistics_zone(prov1, '', '')
        zone2 = get_logistics_zone(prov2, '', '')
        
        if zone1 and zone2:
            if zone1 == zone2:
                # ‚úÖ Zone ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô)
                return True
            else:
                # ‡∏Ñ‡∏ô‡∏•‡∏∞ Zone ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if not can_combine_zones_by_highway(zone1, zone2):
                    return False  # ‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á centroids
    lat1, lon1 = calculate_district_centroid(district1_df)
    lat2, lon2 = calculate_district_centroid(district2_df)
    
    if lat1 is None or lat2 is None:
        return True  # ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô
    
    distance = haversine_distance(lat1, lon1, lat2, lon2)
    
    if prov1 and prov2 and prov1 == prov2:
        # ‚úÖ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡πÉ‡∏ä‡πâ threshold ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤ (60km)
        return distance <= (max_distance_km * 2.0)  # 30km * 2.0 = 60km
    else:
        # ‚ö†Ô∏è ‡∏Ñ‡∏ô‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î + ‡∏Ñ‡∏ô‡∏•‡∏∞ Zone ‚Üí ‡πÉ‡∏ä‡πâ threshold ‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î (30km)
        return distance <= max_distance_km

def sort_branches_by_region_route(branches_df, master_data=None):
    """
    ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí Route
    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î
    """
    if branches_df.empty:
        return branches_df
    
    df = branches_df.copy()
    
    # ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Province ‡πÅ‡∏•‡∏∞ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
    province_col = 'Province' if 'Province' in df.columns else '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' if '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in df.columns else None
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sort
    df['_region_code'] = df[province_col].apply(get_region_code) if province_col else '99'
    df['_province'] = df[province_col].fillna('') if province_col else ''
    df['_district'] = df['District'].fillna('') if 'District' in df.columns else ''
    df['_subdistrict'] = df['Subdistrict'].fillna('') if 'Subdistrict' in df.columns else ''
    
    # ‡πÅ‡∏¢‡∏Å Route number
    if 'Route' in df.columns:
        df['_route_num'] = df['Route'].apply(lambda x: int(str(x).replace('CD', '')) if pd.notna(x) and str(x).startswith('CD') else 99999)
    else:
        df['_route_num'] = 99999
    
    # Sort
    df = df.sort_values(by=['_region_code', '_province', '_district', '_subdistrict', '_route_num'])
    
    # ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    df = df.drop(columns=['_region_code', '_province', '_district', '_subdistrict', '_route_num'])
    
    return df.reset_index(drop=True)

def check_trip_route_spread(trip_df):
    """
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡∏°‡∏µ Route ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πÑ‡∏´‡∏°
    ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤: (route_range, is_spread, provinces)
    """
    if trip_df.empty or 'Route' not in trip_df.columns:
        return 0, False, []
    
    routes = trip_df['Route'].dropna().unique()
    route_nums = []
    for r in routes:
        if pd.notna(r) and str(r).startswith('CD'):
            try:
                route_nums.append(int(str(r).replace('CD', '')))
            except:
                pass
    
    if len(route_nums) < 2:
        return 0, False, trip_df['Province'].dropna().unique().tolist() if 'Province' in trip_df.columns else []
    
    route_range = max(route_nums) - min(route_nums)
    is_spread = route_range > 4000  # ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 4000 ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
    
    provinces = trip_df['Province'].dropna().unique().tolist() if 'Province' in trip_df.columns else []
    
    return route_range, is_spread, provinces

# ==========================================
# LOAD MASTER DATA
# ==========================================
@st.cache_data(ttl=3600, show_spinner=False)  # Cache 1 ‡∏ä‡∏°. (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
def load_master_data():
    """‡πÇ‡∏´‡∏•‡∏î Master Data ‡∏à‡∏≤‡∏Å Google Sheets ‡∏´‡∏£‡∏∑‡∏≠ JSON (auto-sync)"""
    try:
        # ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏ó‡∏µ‡πà sync ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        df_from_sheets = sync_branch_data_from_sheets()
        
        if df_from_sheets is None or df_from_sheets.empty:
            safe_print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Sheets ‡∏´‡∏£‡∏∑‡∏≠ branch_data.json")
            return pd.DataFrame()
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        required_cols = ['Plan Code']
        missing = [c for c in required_cols if c not in df_from_sheets.columns]
        if missing:
            safe_print(f"‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: {missing}")
        
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
        col_mapping = {
            '‡∏•‡∏∞': '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î',
            '‡∏•‡∏≠‡∏á': '‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î'
        }
        df_from_sheets = df_from_sheets.rename(columns=col_mapping)
        
        # ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Plan Code
        if 'Plan Code' in df_from_sheets.columns:
            df_from_sheets['Plan Code'] = df_from_sheets['Plan Code'].astype(str).str.strip().str.upper()
            df_from_sheets = df_from_sheets[df_from_sheets['Plan Code'] != '']
        
        safe_print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î MASTER_DATA: {len(df_from_sheets)} ‡∏™‡∏≤‡∏Ç‡∏≤")
        
        # üîç Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ
        safe_print(f"üìã ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({len(df_from_sheets.columns)}): {', '.join(df_from_sheets.columns.tolist())}")
        
        # üîç Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏ñ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô)
        vehicle_cols = [
            'MaxTruckType', 'Max Truck Type', 'MaxVehicle', 'Max Vehicle', 
            '‡∏£‡∏ñ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', 'Max_Truck_Type', 'max_truck', 'MaxTruck',
            '‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ', 'Truck', 'truck_type', 'TruckType',
            '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ', 'Vehicle', 'vehicle_type', 'VehicleType'
        ]
        found_vehicle_cols = [col for col in vehicle_cols if col in df_from_sheets.columns]
        if found_vehicle_cols:
            safe_print(f"‚úÖ ‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ: {', '.join(found_vehicle_cols)}")
            # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ
            for col in found_vehicle_cols:
                vehicle_counts = df_from_sheets[col].value_counts(dropna=False)
                safe_print(f"   - {col}: {dict(vehicle_counts)}")
        else:
            safe_print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ!")
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            for col in df_from_sheets.columns:
                if 'truck' in col.lower() or 'vehicle' in col.lower() or '‡∏£‡∏ñ' in col:
                    safe_print(f"   üí° ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á: '{col}'")
        
        return df_from_sheets
        
    except Exception as e:
        safe_print(f"‚ùå Error loading MASTER_DATA: {e}")
        return pd.DataFrame()

# ‡πÇ‡∏´‡∏•‡∏î Master Data ‡∏à‡∏≤‡∏Å Google Sheets
MASTER_DATA = load_master_data()

# ==========================================
# üîÑ BRANCH GROUPING (‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚â§200 ‡πÄ‡∏°‡∏ï‡∏£)
# ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å branch_groups.json (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ test_groups.py ‡∏î‡πâ‡∏ß‡∏¢ haversine 200m)
# ==========================================
@st.cache_data(show_spinner=False)
def load_branch_groups():
    """
    ‡πÇ‡∏´‡∏•‡∏î branch_groups.json ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ haversine 200m
    Return: (groups_dict, branch_to_group_dict)
    """
    try:
        with open('branch_groups.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        groups = data.get('groups', {})  # {group_id: [codes]}
        branch_to_group = data.get('branch_to_group', {})  # {code: group_id}
        
        safe_print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î branch_groups.json: {len(groups)} ‡∏Å‡∏•‡∏∏‡πà‡∏°, {len(branch_to_group)} ‡∏™‡∏≤‡∏Ç‡∏≤")
        return groups, branch_to_group
    except FileNotFoundError:
        safe_print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö branch_groups.json - ‡∏£‡∏±‡∏ô python test_groups.py ‡∏Å‡πà‡∏≠‡∏ô")
        return {}, {}
    except Exception as e:
        safe_print(f"‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î branch_groups.json ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
        return {}, {}

# ‡πÇ‡∏´‡∏•‡∏î branch groups
BRANCH_GROUPS, BRANCH_TO_GROUP = load_branch_groups()

def get_group_branches(code: str) -> list:
    """
    ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚â§200 ‡πÄ‡∏°‡∏ï‡∏£)
    ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏° return [code] (‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    """
    code_upper = str(code).strip().upper()
    group_id = BRANCH_TO_GROUP.get(code_upper)
    if group_id:
        return BRANCH_GROUPS.get(group_id, [code_upper])
    return [code_upper]

def is_same_group(code1: str, code2: str) -> bool:
    """‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ 2 ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    c1 = str(code1).strip().upper()
    c2 = str(code2).strip().upper()
    g1 = BRANCH_TO_GROUP.get(c1)
    g2 = BRANCH_TO_GROUP.get(c2)
    return g1 and g2 and g1 == g2

# ==========================================
# üöÄ BRANCH CLUSTERS & SPATIAL DATA (Pre-computed)
# ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å branch_clusters.json (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ precompute_branch_data.py)
# ==========================================
@st.cache_data(show_spinner=False)
def load_branch_clusters():
    """
    ‡πÇ‡∏´‡∏•‡∏î branch_clusters.json ‡∏ó‡∏µ‡πà‡∏°‡∏µ:
    - branch_info: ‡∏û‡∏¥‡∏Å‡∏±‡∏î, ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å DC, ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á, cluster
    - nearby_branches: ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (< 15km)
    - clusters: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á, ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
    """
    try:
        with open('branch_clusters.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        branch_info = {str(k).strip().upper(): v for k, v in data.get('branch_info', {}).items()}
        nearby_branches = {str(k).strip().upper(): v for k, v in data.get('nearby_branches', {}).items()}
        clusters = data.get('clusters', {})
        
        safe_print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î branch_clusters.json:")
        safe_print(f"   - {len(branch_info)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• spatial")
        safe_print(f"   - {len(nearby_branches)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏µ nearby branches")
        if clusters:
            safe_print(f"   - Distance clusters: {len(clusters.get('distance', {}))}")
            safe_print(f"   - Direction clusters: {len(clusters.get('direction', {}))}")
            safe_print(f"   - Province clusters: {len(clusters.get('province', {}))}")
            safe_print(f"   - District clusters: {len(clusters.get('district', {}))}")
        
        return branch_info, nearby_branches, clusters
    except FileNotFoundError:
        safe_print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö branch_clusters.json - ‡∏£‡∏±‡∏ô python precompute_branch_data.py ‡∏Å‡πà‡∏≠‡∏ô")
        return {}, {}, {}
    except Exception as e:
        safe_print(f"‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î branch_clusters.json ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
        return {}, {}, {}

# ‡πÇ‡∏´‡∏•‡∏î branch clusters
BRANCH_INFO, NEARBY_BRANCHES, BRANCH_CLUSTERS = load_branch_clusters()

# ==========================================
# üöÄ PRE-COMPUTE: Distance Matrix & Nearby Branches
# ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å branch_clusters.json ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
# ==========================================
@st.cache_data(ttl=3600)  # Cache 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
def precompute_branch_distances(master_df):
    """
    ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pre-computed ‡∏à‡∏≤‡∏Å branch_clusters.json
    ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå
    """
    # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pre-computed ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢
    if BRANCH_INFO and NEARBY_BRANCHES:
        safe_print("‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pre-computed ‡∏à‡∏≤‡∏Å branch_clusters.json")
        
        # ‡πÅ‡∏õ‡∏•‡∏á branch_info ‡πÄ‡∏õ‡πá‡∏ô branch_coords (‡πÉ‡∏ä‡πâ uppercase key ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
        branch_coords = {}
        for code, info in BRANCH_INFO.items():
            if 'lat' in info and 'lon' in info:
                branch_coords[str(code).strip().upper()] = (info['lat'], info['lon'])
        
        # ‡πÅ‡∏õ‡∏•‡∏á nearby_branches ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        nearby_dict = {}
        for code, nearby_list in NEARBY_BRANCHES.items():
            code_upper = str(code).strip().upper()
            # nearby_list ‡∏°‡∏µ‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
            #   - [code1, code2, ...]  (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤)
            #   - [{"code": code1, "distance": d1}, ...]  (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å precompute_branch_data.py)
            nearby_with_dist = []
            if code_upper in branch_coords:
                lat1, lon1 = branch_coords[code_upper]
                for item in nearby_list:
                    # ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
                    if isinstance(item, dict):
                        nearby_code = str(item.get('code', '')).strip().upper()
                        pre_dist = item.get('distance', None)
                    else:
                        nearby_code = str(item).strip().upper()
                        pre_dist = None

                    if not nearby_code or nearby_code not in branch_coords:
                        continue

                    lat2, lon2 = branch_coords[nearby_code]
                    if pre_dist is not None and pre_dist > 0:
                        # ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ pre-computed ‡∏à‡∏≤‡∏Å branch_clusters.json (OSRM road dist)
                        dist = pre_dist
                    else:
                        # Inline: ‡∏ï‡∏£‡∏ß‡∏à DISTANCE_CACHE ‡∏Å‡πà‡∏≠‡∏ô ‚Üí fallback haversine √ó 1.35
                        _ck  = f"{lat1:.4f},{lon1:.4f}_{lat2:.4f},{lon2:.4f}"
                        _ckr = f"{lat2:.4f},{lon2:.4f}_{lat1:.4f},{lon1:.4f}"
                        if USE_CACHE and _ck in DISTANCE_CACHE:
                            dist = DISTANCE_CACHE[_ck]
                        elif USE_CACHE and _ckr in DISTANCE_CACHE:
                            dist = DISTANCE_CACHE[_ckr]
                        else:
                            from math import radians, sin, cos, sqrt, atan2
                            _phi1, _phi2 = radians(lat1), radians(lat2)
                            _a = sin((radians(lat2-lat1))/2)**2 + cos(_phi1)*cos(_phi2)*sin((radians(lon2-lon1))/2)**2
                            dist = round(6371.0 * 2 * atan2(sqrt(_a), sqrt(1-_a)) * 1.35, 2)
                    nearby_with_dist.append((nearby_code, round(dist, 2)))
            nearby_dict[code_upper] = sorted(nearby_with_dist, key=lambda x: x[1])
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á same_area_branches ‡∏à‡∏≤‡∏Å clusters (‡πÉ‡∏ä‡πâ uppercase key)
        same_area_branches = {}
        if BRANCH_CLUSTERS and 'district' in BRANCH_CLUSTERS:
            district_clusters = BRANCH_CLUSTERS['district']
            for code, info in BRANCH_INFO.items():
                code_up = str(code).strip().upper()
                district_id = info.get('district_cluster')
                if district_id and district_id in district_clusters:
                    same_area_branches[code_up] = [str(c).strip().upper() for c in district_clusters[district_id] if str(c).strip().upper() != code_up]
                else:
                    same_area_branches[code_up] = []
        
        safe_print(f"   ‚úÖ {len(branch_coords)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î, {len(nearby_dict)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏µ nearby")
        return branch_coords, nearby_dict, same_area_branches
    
    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ pre-computed ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
    safe_print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ pre-computed data - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà...")
    
    if master_df.empty:
        return {}, {}, {}
    
    # ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    branch_coords = {}
    for _, row in master_df.iterrows():
        code = str(row.get('Plan Code', '')).strip().upper()
        lat = row.get('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î') or row.get('Latitude') or row.get('‡∏•‡∏∞', 0)
        lon = row.get('‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î') or row.get('Longitude') or row.get('‡∏•‡∏≠‡∏á', 0)
        if code and lat and lon:
            try:
                lat_float = float(lat)
                lon_float = float(lon)
                if lat_float > 0 and lon_float > 0:
                    branch_coords[code] = (lat_float, lon_float)
            except (ValueError, TypeError):
                pass
    
    safe_print(f"   üìç ‡∏û‡∏ö {len(branch_coords)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î")
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á nearby_branches (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß)
    nearby_branches = {}
    same_area_branches = {}
    
    codes = list(branch_coords.keys())
    for code in codes:
        nearby_branches[code] = []
        same_area_branches[code] = []
    
    safe_print(f"   ‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô")
    
    return branch_coords, nearby_branches, same_area_branches

# Pre-compute distances
BRANCH_COORDS, NEARBY_BRANCHES, SAME_AREA_BRANCHES = precompute_branch_distances(MASTER_DATA)

# ==========================================
# CLEAN NAME FUNCTION (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Join_Key)
# ==========================================
def clean_name(text):
    """
    ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠: ‡∏•‡∏ö prefix ‡∏à./‡∏≠./‡∏ï. ‡πÅ‡∏•‡∏∞ trim whitespace
    ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Join_Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Master Data
    """
    if pd.isna(text) or text is None:
        return ''
    text = str(text)
    # ‡∏•‡∏ö prefix ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    text = text.replace('‡∏à. ', '').replace('‡∏à.', '')
    text = text.replace('‡∏≠. ', '').replace('‡∏≠.', '')
    text = text.replace('‡∏ï. ', '').replace('‡∏ï.', '')
    # ‡∏•‡∏ö prefix ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    text = text.replace('Tambon ', '').replace('Amphoe ', '').replace('Changwat ', '')
    return text.strip()

def normalize_province_name(province):
    """
    ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô)
    """
    if pd.isna(province) or province is None:
        return ''
    province = clean_name(province)
    # Mapping ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢
    province_mapping = {
        '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',
        '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡∏Å‡∏ó‡∏°': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡∏Å‡∏ó‡∏°.': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä': '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',
    }
    return province_mapping.get(province, province)

def normalize(val):
    """‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"""
    return str(val).strip().upper().replace(" ", "").replace(".0", "")

def load_master_dist_data():
    """
    ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Master Dist.xlsx ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:
    1. ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•
    2. Sum_Code (Sort_Code) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
    
    ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Sum_Code ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sort
    """
    try:
        file_path = 'Dc/Master Dist.xlsx'
        df = pd.read_excel(file_path)
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á lookup dict - ‡∏™‡∏≠‡∏á key: Sum_Code ‡πÅ‡∏•‡∏∞ Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•)
        dist_lookup = {}   # key = Sum_Code
        name_lookup = {}   # key = Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•)
        
        for _, row in df.iterrows():
            sum_code = str(row.get('Sum_Code', '')).strip()
            
            # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° sum_code (Sort_Code) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢!
            data = {
                'sum_code': sum_code,  # üîë ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sort!
                'region': row.get('Region', ''),
                'region_code': row.get('Region_Code', ''),
                'province': row.get('Province', ''),
                'prov_code': row.get('Prov_Code', ''),
                'district': row.get('District', ''),
                'dist_code': row.get('Dist_Code', ''),
                'subdistrict': row.get('Subdistrict', ''),
                'subdist_code': row.get('Subdist_Code', ''),
                'dist_from_dc_km': float(row.get('Dist_from_DC_km', 9999)) if pd.notna(row.get('Dist_from_DC_km')) else 9999,
                'prov_dist_km': float(row.get('Prov_Dist_km', 0)) if pd.notna(row.get('Prov_Dist_km')) else 0,
                'dist_subdist_km': float(row.get('Dist_Subdist_km', 0)) if pd.notna(row.get('Dist_Subdist_km')) else 0,
            }
            
            # Key 1: Sum_Code (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö lookup ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
            if sum_code:
                dist_lookup[sum_code] = data
            
            # Key 2: Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•) - ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á Lookup!
            prov_raw = str(row.get('Province', ''))
            dist_raw = str(row.get('District', ''))
            subdist_raw = str(row.get('Subdistrict', ''))
            
            # Clean name ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Join
            prov_clean = clean_name(prov_raw)
            dist_clean = clean_name(dist_raw)
            subdist_clean = clean_name(subdist_raw)
            
            # Join_Key ‡πÅ‡∏ö‡∏ö clean (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
            join_key = f"{prov_clean}_{dist_clean}_{subdist_clean}"
            if join_key and join_key != '__':
                name_lookup[join_key] = data
            
            # Join_Key ‡πÅ‡∏ö‡∏ö normalized province (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô)
            prov_normalized = normalize_province_name(prov_raw)
            if prov_normalized != prov_clean:
                alt_key = f"{prov_normalized}_{dist_clean}_{subdist_clean}"
                if alt_key and alt_key != '__':
                    name_lookup[alt_key] = data
            
            # Join_Key ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ prefix (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ prefix)
            raw_key = f"{prov_raw.strip()}_{dist_raw.strip()}_{subdist_raw.strip()}"
            if raw_key and raw_key != '__' and raw_key not in name_lookup:
                name_lookup[raw_key] = data
        
        return {'by_code': dist_lookup, 'by_name': name_lookup}
    except Exception as e:
        return {'by_code': {}, 'by_name': {}}

# ‡πÇ‡∏´‡∏•‡∏î Master Dist Data
MASTER_DIST_DATA = load_master_dist_data()

# ==========================================
# PUNTHAI/MAXMART BUFFER FUNCTIONS (REMOVED - ‡πÉ‡∏ä‡πâ‡πÇ‡∏•‡∏à‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß)
# ==========================================
# HELPER FUNCTIONS
# ==========================================

def get_max_vehicle_for_branch(branch_code, test_df=None, debug=False):
    """‡∏î‡∏∂‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö - ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å MASTER_DATA (Google Sheets) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"""
    branch_code_str = str(branch_code).strip().upper()
    
    # üéØ ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å MASTER_DATA (Google Sheets) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô - ‡πÑ‡∏°‡πà‡∏°‡∏µ fallback
    if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
        # ‡∏•‡∏≠‡∏á match ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö
        master_codes = MASTER_DATA['Plan Code'].str.strip().str.upper()
        
        # 1. Match ‡πÅ‡∏ö‡∏ö exact
        branch_row = MASTER_DATA[master_codes == branch_code_str]
        
        # 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏•‡∏≠‡∏á match ‡πÅ‡∏ö‡∏ö partial (Code ‡∏≠‡∏≤‡∏à‡∏°‡∏µ prefix/suffix ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)
        if branch_row.empty:
            # ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏î prefix ‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢
            prefixes = ['PUN-', 'MAX-', 'MM-', 'PT-', 'N', 'S', 'E', 'W', 'C', 'PUN', 'MAX', 'MM', 'PT']
            
            # ‡∏Å‡∏£‡∏ì‡∏µ branch_code ‡∏°‡∏µ prefix
            code_clean = branch_code_str
            for p in prefixes:
                if code_clean.startswith(p):
                    code_clean = code_clean[len(p):]
                    break
            
            # ‡∏•‡∏≠‡∏á match ‡∏Å‡∏±‡∏ö master codes ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î prefix ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
            for idx, mc in enumerate(master_codes):
                mc_clean = mc
                for p in prefixes:
                    if mc_clean.startswith(p):
                        mc_clean = mc_clean[len(p):]
                        break
                
                if code_clean == mc_clean:
                    branch_row = MASTER_DATA.iloc[[idx]]
                    break
                    
        # 3. (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£ match ‡πÅ‡∏ö‡∏ö loose partial 'in' ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏ñ‡∏ú‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)
        
        if not branch_row.empty:
            # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
            possible_cols = [
                'MaxTruckType', 'Max Truck Type', 'MaxVehicle', 'Max Vehicle', 
                '‡∏£‡∏ñ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', 'Max_Truck_Type', 'max_truck', 'MaxTruck',
                '‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ', 'Truck', 'truck_type', 'TruckType',
                '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ', 'Vehicle', 'vehicle_type', 'VehicleType'
            ]
            for col in possible_cols:
                if col in branch_row.columns and pd.notna(branch_row.iloc[0][col]):
                    max_truck = str(branch_row.iloc[0][col]).strip().upper()
                    # ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö
                    if max_truck in ['4W', '4 W', '4-W']:
                        return '4W'
                    elif max_truck in ['JB', 'J B', 'J-B', '4WJ', '4WJ ']:
                        return 'JB'
                    elif max_truck in ['6W', '6 W', '6-W']:
                        return '6W'
                    elif max_truck and max_truck not in ['', 'NAN', 'NONE', '-']:
                        if debug:
                            safe_print(f"‚ö†Ô∏è Branch {branch_code_str}: ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å '{max_truck}' ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '{col}'")
    
    # Default: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î = ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏î‡πâ
    return '6W'

def get_max_vehicle_for_trip(trip_codes):
    """
    ‡∏´‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ)
    
    Args:
        trip_codes: set ‡∏Ç‡∏≠‡∏á branch codes ‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
    
    Returns:
        str: '4W', 'JB', ‡∏´‡∏£‡∏∑‡∏≠ '6W'
    """
    vehicle_priority = {'4W': 1, 'JB': 2, '6W': 3}
    max_allowed = '6W'  # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤
    min_priority = 3  # ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
    
    for code in trip_codes:
        branch_max = get_max_vehicle_for_branch(code)
        priority = vehicle_priority.get(branch_max, 3)
        
        # üîí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
        if priority < min_priority:
            min_priority = priority
            max_allowed = branch_max
    
    return max_allowed

def get_route_osrm(pickup_lat, pickup_lon, dropoff_lat, dropoff_lon, max_retries=1):
    """
    ‡∏Ç‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å OSRM API (‡∏ß‡∏¥‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏ñ‡∏ô‡∏ô)
    ‡∏ï‡∏£‡∏ß‡∏à ROUTE_CACHE_DATA ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‚Äî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢ cache ‡πÑ‡∏ß‡πâ
    """
    if not FOLIUM_AVAILABLE:
        return [[pickup_lat, pickup_lon], [dropoff_lat, dropoff_lon]]

    # ‡∏ï‡∏£‡∏ß‡∏à cache ‡∏Å‡πà‡∏≠‡∏ô
    cache_key = f"{pickup_lat:.4f},{pickup_lon:.4f}|{dropoff_lat:.4f},{dropoff_lon:.4f}"
    if USE_CACHE and cache_key in ROUTE_CACHE_DATA:
        cached = ROUTE_CACHE_DATA[cache_key]
        if isinstance(cached, dict):
            return cached.get('coords', [[pickup_lat, pickup_lon], [dropoff_lat, dropoff_lon]])
        return cached  # backward compat (list)

    # OSRM Public Server (lon, lat format!)
    loc = f"{pickup_lon},{pickup_lat};{dropoff_lon},{dropoff_lat}"
    url = f"http://router.project-osrm.org/route/v1/driving/{loc}?overview=full&geometries=geojson"

    for attempt in range(max_retries):
        try:
            r = requests.get(url, timeout=4)
            res = r.json()

            if "routes" in res and len(res["routes"]) > 0:
                coords = res["routes"][0]["geometry"]["coordinates"]
                route_coords = [[lat, lon] for lon, lat in coords]
                # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if USE_CACHE:
                    ROUTE_CACHE_DATA[cache_key] = {'coords': route_coords, 'distance': 0}
                    save_route_cache(ROUTE_CACHE_DATA)
                return route_coords
            else:
                return [[pickup_lat, pickup_lon], [dropoff_lat, dropoff_lon]]
        except Exception:
            return [[pickup_lat, pickup_lon], [dropoff_lat, dropoff_lon]]

    return [[pickup_lat, pickup_lon], [dropoff_lat, dropoff_lon]]


def get_multi_point_route_osrm(waypoints, max_retries=2):
    """
    ‡∏Ç‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å OSRM API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏° cache
    
    Args:
        waypoints: list ‡∏Ç‡∏≠‡∏á [lat, lon] ‡πÄ‡∏ä‡πà‡∏ô [[14.1, 100.6], [14.2, 100.7], ...]
        max_retries: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
    
    Returns:
        tuple: (route_coords, distance_km) - ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°
    """
    if not FOLIUM_AVAILABLE or len(waypoints) < 2:
        return waypoints, 0
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á cache key
    cache_key = "|".join([f"{lat:.4f},{lon:.4f}" for lat, lon in waypoints])
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö cache ‡∏Å‡πà‡∏≠‡∏ô
    if USE_CACHE and cache_key in ROUTE_CACHE_DATA:
        cached = ROUTE_CACHE_DATA[cache_key]
        return cached['coords'], cached['distance']
    
    # OSRM ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ö‡∏ö lon,lat (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà lat,lon!)
    coords_str = ";".join([f"{lon},{lat}" for lat, lon in waypoints])
    url = f"http://router.project-osrm.org/route/v1/driving/{coords_str}?overview=full&geometries=geojson"
    
    for attempt in range(max_retries):
        try:
            r = requests.get(url, timeout=10)
            res = r.json()
            
            if "routes" in res and len(res["routes"]) > 0:
                route = res["routes"][0]
                # ‡πÅ‡∏õ‡∏•‡∏á GeoJSON coordinates (lon, lat) ‡πÄ‡∏õ‡πá‡∏ô (lat, lon)
                coords = route["geometry"]["coordinates"]
                route_coords = [[lat, lon] for lon, lat in coords]
                # ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å OSRM ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£
                distance_km = route.get("distance", 0) / 1000
                
                # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                if USE_CACHE:
                    ROUTE_CACHE_DATA[cache_key] = {
                        'coords': route_coords,
                        'distance': distance_km
                    }
                    save_route_cache(ROUTE_CACHE_DATA)
                
                return route_coords, distance_km
            else:
                return waypoints, 0
        except Exception as e:
            if attempt < max_retries - 1:
                time_module.sleep(0.3)
                continue
            return waypoints, 0
    
    return waypoints, 0

def calculate_bearing(lat1, lon1, lat2, lon2):
    """
    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á (bearing) ‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î 1 ‡πÑ‡∏õ‡∏à‡∏∏‡∏î 2 ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤ (0-360)
    0 = ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠, 90 = ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å, 180 = ‡πÉ‡∏ï‡πâ, 270 = ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å
    """
    from math import radians, sin, cos, atan2, degrees
    
    lat1_rad = radians(lat1)
    lat2_rad = radians(lat2)
    dlon = radians(lon2 - lon1)
    
    x = sin(dlon) * cos(lat2_rad)
    y = cos(lat1_rad) * sin(lat2_rad) - sin(lat1_rad) * cos(lat2_rad) * cos(dlon)
    
    bearing = atan2(x, y)
    bearing = degrees(bearing)
    bearing = (bearing + 360) % 360  # Normalize to 0-360
    
    return bearing

def get_bearing_zone(bearing):
    """
    ‡πÅ‡∏ö‡πà‡∏á‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô 8 ‡πÇ‡∏ã‡∏ô (‡∏ó‡∏∏‡∏Å 45 ‡∏≠‡∏á‡∏®‡∏≤)
    0-1 = N, 2-3 = NE, 4-5 = E, 6-7 = SE, 8-9 = S, 10-11 = SW, 12-13 = W, 14-15 = NW
    """
    # ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 16 ‡πÇ‡∏ã‡∏ô (‡∏ó‡∏∏‡∏Å 22.5 ‡∏≠‡∏á‡∏®‡∏≤) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏¥‡∏®‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    zone = int((bearing + 11.25) / 22.5) % 16
    return zone

def get_osrm_distance_live(lat1, lon1, lat2, lon2):
    """
    ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OSRM Table API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≠‡∏á‡∏à‡∏∏‡∏î (km)
    ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ float km ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
    """
    try:
        url = (
            f"http://router.project-osrm.org/table/v1/driving/"
            f"{lon1},{lat1};{lon2},{lat2}?annotations=distance"
        )
        r = requests.get(url, timeout=6)
        data = r.json()
        if data.get("code") == "Ok":
            dist_m = data["distances"][0][1]  # ‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î 0 ‚Üí ‡∏à‡∏∏‡∏î 1
            if dist_m and dist_m > 0:
                return dist_m / 1000.0
    except Exception:
        pass
    return None


def haversine_distance(lat1, lon1, lat2, lon2, use_osrm_cache=True):
    """
    ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô‡∏à‡∏£‡∏¥‡∏á (km) ‡πÅ‡∏ö‡∏ö Cache-Only (‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å live API ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á runtime)
    ‡∏•‡∏≥‡∏î‡∏±‡∏ö:
      1. OSRM distance cache ‚Üí ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡πÅ‡∏°‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
      2. Cache miss ‚Üí haversine √ó ROAD_FACTOR (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ñ‡∏ô‡∏ô ~1.35√ó‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á)
    ‡πÉ‡∏ä‡πâ precompute_branch_data.py ‡πÄ‡∏û‡∏∑‡πà‡∏≠ build cache ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
    """
    # 1. ‡∏ï‡∏£‡∏ß‡∏à DISTANCE_CACHE (OSRM road distance) ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
    cache_key = f"{lat1:.4f},{lon1:.4f}_{lat2:.4f},{lon2:.4f}"
    cache_key_reverse = f"{lat2:.4f},{lon2:.4f}_{lat1:.4f},{lon1:.4f}"

    if USE_CACHE:
        if cache_key in DISTANCE_CACHE:
            return DISTANCE_CACHE[cache_key]
        if cache_key_reverse in DISTANCE_CACHE:
            return DISTANCE_CACHE[cache_key_reverse]

    # 2. ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô cache ‚Üí ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ñ‡∏ô‡∏ô‡∏î‡πâ‡∏ß‡∏¢ haversine √ó road factor
    # (‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OSRM live API ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á runtime ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
    R = 6371.0
    phi1, phi2 = radians(lat1), radians(lat2)
    dphi = radians(lat2 - lat1)
    dlambda = radians(lon2 - lon1)
    a = sin(dphi/2)**2 + cos(phi1)*cos(phi2)*sin(dlambda/2)**2
    straight_km = R * 2 * atan2(sqrt(a), sqrt(1 - a))

    # Road factor 1.35√ó ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏ñ‡∏ô‡∏ô‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≠‡∏° ~35% ‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á
    ROAD_FACTOR = 1.35
    return round(straight_km * ROAD_FACTOR, 2)

def load_model():
    """‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏ô‡πÑ‡∏ß‡πâ"""
    if not os.path.exists(MODEL_PATH):
        return None
    
    try:
        import warnings as _warnings
        with _warnings.catch_warnings(record=True) as _caught:
            _warnings.simplefilter("always")
            with open(MODEL_PATH, 'rb') as f:
                model_data = pickle.load(f)
        # ‡πÅ‡∏™‡∏î‡∏á version mismatch warning ‡πÉ‡∏ô UI (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô terminal)
        for w in _caught:
            if 'InconsistentVersionWarning' in str(w.category.__name__) or 'version' in str(w.message).lower():
                import sklearn as _sk
                st.warning(f"‚ö†Ô∏è **Model Version Warning:** ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ñ‡∏π‡∏Å train ‡∏î‡πâ‡∏ß‡∏¢ sklearn ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ‚Äî ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏≤‡∏à‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á sklearn ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß retrain model ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)")
                break
        return model_data
    except Exception as e:
        st.error(f"‚ùå Error loading model: {e}")
        return None

def load_excel(file_content, sheet_name=None):
    """‡πÇ‡∏´‡∏•‡∏î Excel"""
    try:
        xls = pd.ExcelFile(io.BytesIO(file_content))
        
        target_sheet = None
        if sheet_name and sheet_name in xls.sheet_names:
            target_sheet = sheet_name
        else:
            for s in xls.sheet_names:
                if 'punthai' in s.lower() or '2.' in s.lower():
                    target_sheet = s
                    break
        
        if not target_sheet:
            target_sheet = xls.sheet_names[0]
        
        # ‡∏´‡∏≤ header row
        df_temp = pd.read_excel(xls, sheet_name=target_sheet, header=None)
        header_row = 0
        
        for i in range(min(10, len(df_temp))):
            row_values = df_temp.iloc[i].astype(str).str.upper()
            match_count = sum([
                'BRANCH' in ' '.join(row_values),
                'TRIP' in ' '.join(row_values),
                '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤' in ' '.join(df_temp.iloc[i].astype(str))
            ])
            if match_count >= 2:
                header_row = i
                break
        
        df = pd.read_excel(xls, sheet_name=target_sheet, header=header_row)
        df = df.loc[:, ~df.columns.duplicated()]
        
        return df
    except Exception as e:
        st.error(f"‚ùå Error: {e}")
        return None

def process_dataframe(df):
    """‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"""
    if df is None:
        return None
    
    rename_map = {}
    
    # ‡πÉ‡∏ä‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå test.xlsx sheet 2.Punthai
    # 0:Sep, 1:BU, 2:BranchCode, 3:‡∏£‡∏´‡∏±‡∏™WMS, 4:Branch, 5:TOTALCUBE, 6:TOTALWGT, 7:OriginalQTY, ...
    col_list = list(df.columns)
    
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 1 = BU
    if len(col_list) > 1:
        rename_map[col_list[1]] = 'BU'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 2 = ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (BranchCode)
    if len(col_list) > 2:
        rename_map[col_list[2]] = 'Code'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 4 = ‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡∏∑‡πà‡∏≠ (Branch)
    if len(col_list) > 4:
        rename_map[col_list[4]] = 'Name'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 5 = TOTALCUBE
    if len(col_list) > 5:
        rename_map[col_list[5]] = 'Cube'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 6 = TOTALWGT
    if len(col_list) > 6:
        rename_map[col_list[6]] = 'Weight'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 15 = latitude
    if len(col_list) > 15:
        rename_map[col_list[15]] = 'Latitude'
    # ‡∏•‡∏≥‡∏î‡∏±‡∏ö 16 = longitude
    if len(col_list) > 16:
        rename_map[col_list[16]] = 'Longitude'
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πà‡∏≤‡∏á)
    for col in df.columns:
        if col in rename_map.values():  # ‡∏ñ‡πâ‡∏≤ map ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°
            continue
        if col in rename_map:  # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô key ‡πÉ‡∏ô map ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°
            continue
        col_clean = str(col).strip()
        col_upper = col_clean.upper().replace(' ', '').replace('_', '')
        
        # BU
        if col_upper == 'BU' or col_clean == 'BU':
            rename_map[col] = 'BU'
        # Code
        elif col_clean == 'BranchCode' or '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤' in col_clean or col_clean ==  'BRANCH_CODE' in col_upper or 'CODE' in col_upper:
            if 'Weight' not in col_upper and 'Cube' not in col_upper:  # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö WeightCode
                rename_map[col] = 'Code'
        # Name
        elif col_clean == 'Branch' or '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤' in col_clean or col_clean == '‡∏™‡∏≤‡∏Ç‡∏≤' or ('BRANCH' in col_upper and 'CODE' not in col_upper):
            rename_map[col] = 'Name'
        # ‡∏ï‡∏≥‡∏ö‡∏•
        elif '‡∏ï‡∏≥‡∏ö‡∏•' in col_clean or 'SUBDISTRICT' in col_upper or 'TAMBON' in col_upper:
            rename_map[col] = 'Subdistrict'
        # ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
        elif '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠' in col_clean or ('DISTRICT' in col_upper and 'SUB' not in col_upper) or 'AMPHOE' in col_upper or 'AMPHUR' in col_upper:
            rename_map[col] = 'District'
        # ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
        elif '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in col_clean or 'PROVINCE' in col_upper or 'CHANGWAT' in col_upper:
            rename_map[col] = 'Province'
        # Weight - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
        elif ('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å' in col_clean or 
              'WEIGHT' in col_upper or 
              'WGT' in col_upper or 
              'TOTALWGT' in col_upper or
              '‡∏ô‡πâ‡πç‡∏≤‡∏´‡∏ô‡∏±‡∏Å' in col_clean or  # ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏≥ ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î
              col_upper in ['WEIGHT', 'WGT', 'TOTALWEIGHT']):
            rename_map[col] = 'Weight'
        # Cube - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
        elif ('‡∏Ñ‡∏¥‡∏ß' in col_clean or 
              'CUBE' in col_upper or 
              'TOTALCUBE' in col_upper or
              'CBM' in col_upper or
              col_upper in ['CUBE', 'CBM', 'TOTALCUBE']):
            rename_map[col] = 'Cube'
        # Latitude
        elif 'latitude' in col_clean.lower() or col_clean == '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î' or 'LAT' == col_upper or col_upper == 'LATITUDE':
            rename_map[col] = 'Latitude'
        # Longitude
        elif 'longitude' in col_clean.lower() or col_clean == '‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î' or col_upper in ['LONG', 'LNG', 'LON', 'LONGITUDE']:
            rename_map[col] = 'Longitude'
        # Trip
        elif col_upper in ['TRIPNO', 'TRIP_NO', 'TRIPNUMBER'] or col_clean == 'Trip no':
            rename_map[col] = 'TripNo'
        elif col_upper == 'TRIP' or '‡∏ó‡∏£‡∏¥‡∏õ' in col_clean or '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß' in col_clean:
            rename_map[col] = 'Trip'
        # Booking
        elif 'BOOKING' in col_upper:
            rename_map[col] = 'Booking'
    
    df = df.rename(columns=rename_map)
    
    # ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≥
    df = df.loc[:, ~df.columns.duplicated()]
    
    if 'Code' in df.columns:
        df['Code'] = df['Code'].apply(normalize)
        
        # ‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å (‡∏£‡∏´‡∏±‡∏™)
        df = df[~df['Code'].isin(EXCLUDE_BRANCHES)]
        
        # ‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏µ keyword ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        if 'Name' in df.columns:
            exclude_pattern = '|'.join(EXCLUDE_NAMES)
            df = df[~df['Name'].str.contains(exclude_pattern, case=False, na=False)]
    
    for col in ['Weight', 'Cube']:
        if col not in df.columns:
            df[col] = 0.0
        else:
            df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0.0)
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å Master ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Province ‡πÅ‡∏•‡∏∞ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
    province_col = 'Province' if 'Province' in df.columns else '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' if '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in df.columns else None
    
    if not province_col or df[province_col].isna().all():
        if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns and 'Code' in df.columns:
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping ‡∏à‡∏≤‡∏Å Master
            province_map = {}
            for _, row in MASTER_DATA.iterrows():
                code = row.get('Plan Code', '')
                province = row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '')
                if code and province:
                    province_map[code] = province
            
            # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
            def find_province_by_name(code, name):
                # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å code ‡∏Å‡πà‡∏≠‡∏ô
                if code in province_map:
                    return province_map[code]
                
                # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
                if not name or pd.isna(name):
                    return ''
                
                # ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà prefix)
                keywords = str(name).replace('MAX MART-', '').replace('PUNTHAI-', '').replace('LUBE', '').strip()
                if not keywords:
                    return ''
                
                # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á Master (‡πÉ‡∏ä‡πâ vectorized ‡πÅ‡∏ó‡∏ô iterrows)
                name_lookup = {}
                if not MASTER_DATA.empty and '‡∏™‡∏≤‡∏Ç‡∏≤' in MASTER_DATA.columns and '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in MASTER_DATA.columns:
                    for rec in MASTER_DATA[['‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î']].dropna().to_dict('records'):
                        name_lookup[str(rec['‡∏™‡∏≤‡∏Ç‡∏≤'])[:10]] = str(rec.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', ''))
                for prefix, prov in name_lookup.items():
                    if keywords[:10] == prefix or prefix in keywords:
                        return prov if prov else ''
                return ''
            
            # ‡πÉ‡∏™‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Province ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
            target_col = 'Province' if 'Province' in df.columns else '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
            if 'Name' in df.columns:
                df[target_col] = df.apply(lambda row: find_province_by_name(row['Code'], row.get('Name', '')), axis=1).fillna('')
            else:
                df[target_col] = df['Code'].map(province_map).fillna('')
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á Province ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠ backward compatibility)
            if 'Province' not in df.columns and '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in df.columns:
                df['Province'] = df['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î']
    
    return df.reset_index(drop=True)

def predict_trips(test_df, model_data, punthai_buffer=1.0, maxmart_buffer=1.10):
    """
    ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà - ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
    
    ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:
    1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°: ‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí Route (‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å Master Dist.xlsx ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
    2. ‡∏à‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° Route ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
    3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ (‡∏à‡∏≤‡∏Å DC)
    4. ‡∏ï‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    5. ‡πÉ‡∏ä‡πâ BUFFER ‡∏ï‡∏≤‡∏° BU (‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤)
    
    Args:
        test_df: DataFrame ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ
        model_data: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏• (branch_vehicles, etc.)
        punthai_buffer: Buffer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Punthai (‡πÄ‡∏ä‡πà‡∏ô 1.0 = 100%)
        maxmart_buffer: Buffer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Maxmart/‡∏ú‡∏™‡∏° (‡πÄ‡∏ä‡πà‡∏ô 1.10 = 110%)
    """
    branch_vehicles = model_data.get('branch_vehicles', {})
    
    # ==========================================
    # Step 1: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Master Dist Lookup (Join_Key ‚Üí Sort_Code)
    # ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ Join_Key (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î_‡∏≠‡∏≥‡πÄ‡∏†‡∏≠_‡∏ï‡∏≥‡∏ö‡∏•) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
    # ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Sum_Code (Sort_Code) ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
    # ==========================================
    subdistrict_dist_lookup = {}  # {Join_Key: {sum_code, dist_from_dc, ...}}
    if MASTER_DIST_DATA and 'by_name' in MASTER_DIST_DATA:
        subdistrict_dist_lookup = MASTER_DIST_DATA['by_name']
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á location_map ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• test_df (‡∏à‡∏≤‡∏Å Google Sheets) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    location_map = {}  # {code: {province, district, subdistrict, route, sum_code, ...}}
    
    # üéØ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets (MASTER_DATA) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏à‡∏≤‡∏Å Excel upload
    for _, row in test_df.iterrows():
        code = str(row.get('Code', '')).strip().upper()
        if not code:
            continue
        
        # üåü ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MASTER_DATA (Google Sheets) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
        province = ''
        district = ''
        subdistrict = ''
        route = ''
        
        # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å MASTER_DATA ‡∏Å‡πà‡∏≠‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Sheets)
        if isinstance(model_data, pd.DataFrame) and not model_data.empty and 'Plan Code' in model_data.columns:
            master_row = model_data[model_data['Plan Code'] == code]
            if not master_row.empty:
                province = str(master_row.iloc[0].get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '')).strip() if pd.notna(master_row.iloc[0].get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î')) else ''
                district = str(master_row.iloc[0].get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '')).strip() if pd.notna(master_row.iloc[0].get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠')) else ''
                subdistrict = str(master_row.iloc[0].get('‡∏ï‡∏≥‡∏ö‡∏•', '')).strip() if pd.notna(master_row.iloc[0].get('‡∏ï‡∏≥‡∏ö‡∏•')) else ''
                route = str(master_row.iloc[0].get('Route', '')).strip() if pd.notna(master_row.iloc[0].get('Route')) else ''
        
        # üîÑ Fallback: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô MASTER_DATA ‚Üí ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Excel upload (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)
        if not province:
            province = str(row.get('Province', '')).strip() if pd.notna(row.get('Province')) else ''
        if not district:
            district = str(row.get('District', '')).strip() if pd.notna(row.get('District')) else ''
        if not subdistrict:
            subdistrict = str(row.get('Subdistrict', '')).strip() if pd.notna(row.get('Subdistrict')) else ''
        if not route:
            route = str(row.get('Route', '')).strip() if pd.notna(row.get('Route')) else ''
        
        # üîß normalize province: ‡∏•‡∏ö ‡∏à./‡∏≠./‡∏ï. prefix ‡πÅ‡∏•‡∏∞ alias
        province   = clean_name(province)
        _prov_alias = {'‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤':'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤','‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø':'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
                       '‡∏Å‡∏ó‡∏°':'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£','‡∏Å‡∏ó‡∏°.':'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£','‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä':'‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤'}
        province   = _prov_alias.get(province, province)
        district   = clean_name(district)
        subdistrict = clean_name(subdistrict)
        
        # üåç ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å Sheets ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
        lat = 0
        lon = 0
        
        # ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö
        lat_cols = ['Latitude', 'latitude', '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î', 'lat','‡∏•‡∏∞']
        lon_cols = ['Longitude', 'longitude', '‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î', '‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î', 'lon', 'long','‡∏•‡∏≠‡∏á']
        
        for lat_col in lat_cols:
            if lat_col in row and pd.notna(row[lat_col]):
                try:
                    lat = float(row[lat_col])
                    break
                except:
                    pass
        
        for lon_col in lon_cols:
            if lon_col in row and pd.notna(row[lon_col]):
                try:
                    lon = float(row[lon_col])
                    break
                except:
                    pass
        
        # üîÑ ‡∏ñ‡πâ‡∏≤ Sheets ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‚Üí Fallback ‡πÑ‡∏õ‡∏´‡∏≤‡πÉ‡∏ô MASTER_DATA
        if (lat == 0 or lon == 0) and not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
            master_row = MASTER_DATA[MASTER_DATA['Plan Code'] == code]
            if not master_row.empty:
                lat = float(master_row.iloc[0].get('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0)) if pd.notna(master_row.iloc[0].get('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î')) else 0
                lon = float(master_row.iloc[0].get('‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0)) if pd.notna(master_row.iloc[0].get('‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î')) else 0
        
        # üîë ‡∏™‡∏£‡πâ‡∏≤‡∏á Join_Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Master Dist (VLOOKUP)
        prov_clean = clean_name(province)
        dist_clean = clean_name(district)
        subdist_clean = clean_name(subdistrict)
        join_key = f"{prov_clean}_{dist_clean}_{subdist_clean}"
        
        # ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ key ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
        dist_data = subdistrict_dist_lookup.get(join_key, {})
        if not dist_data:
            # ‡∏•‡∏≠‡∏á normalize ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            prov_normalized = normalize_province_name(province)
            alt_key = f"{prov_normalized}_{dist_clean}_{subdist_clean}"
            dist_data = subdistrict_dist_lookup.get(alt_key, {})
        
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Master Dist (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if dist_data:
            sum_code = dist_data.get('sum_code', '')  # üéØ Sort_Code ‡∏´‡∏•‡∏±‡∏Å!
            dist_from_dc = dist_data.get('dist_from_dc_km', 9999)
            region_code = dist_data.get('region_code', '')
            prov_code = dist_data.get('prov_code', '')
            dist_code_val = dist_data.get('dist_code', '')
            subdist_code = dist_data.get('subdist_code', '')
        else:
            # Fallback: ‡∏™‡∏£‡πâ‡∏≤‡∏á sort_code ‡∏à‡∏≤‡∏Å region code ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å lat/lon
            region_code = get_region_code(province)
            sum_code = f"R99P999D9999S99999"  # Default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö
            dist_from_dc = 9999
            if lat and lon:
                dist_from_dc = haversine_distance(DC_WANG_NOI_LAT, DC_WANG_NOI_LON, lat, lon)
            prov_code = 'P999'
            dist_code_val = 'D9999'
            subdist_code = 'S99999'
        
        region_name = get_region_name(province)
        
        location_map[code] = {
            'province': province,
            'district': district,
            'subdistrict': subdistrict,
            'route': route,
            'lat': lat,
            'lon': lon,
            'join_key': join_key,  # üîë Join_Key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ lookup
            'sum_code': sum_code,  # üéØ Sort_Code ‡∏´‡∏•‡∏±‡∏Å (‡∏à‡∏≤‡∏Å Master Dist)
            'distance_from_dc': dist_from_dc,
            'region_code': region_code,
            'prov_code': prov_code,
            'dist_code': dist_code_val,
            'subdist_code': subdist_code,
            'region_name': region_name
        }
    
    # ==========================================
    # Step 2: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (pd.merge ‡πÅ‡∏ö‡∏ö manual)
    # ==========================================
    df = test_df.copy()
    
    def get_location_info(code):
        code_upper = str(code).strip().upper()
        return location_map.get(code_upper, {
            'province': '', 'district': '', 'subdistrict': '', 'route': '',
            'lat': 0, 'lon': 0, 'join_key': '', 
            'sum_code': 'R99P999D9999S99999',  # Default sort_code
            'distance_from_dc': 9999,
            'region_code': 'R99', 'prov_code': 'P999', 'dist_code': 'D9999', 'subdist_code': 'S99999',
            'region_name': '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
        })
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏£‡∏ß‡∏° sum_code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sort)
    df['_sum_code'] = df['Code'].apply(lambda c: get_location_info(c)['sum_code'])  # üéØ Sort_Code!
    df['_join_key'] = df['Code'].apply(lambda c: get_location_info(c)['join_key'])
    df['_region_code'] = df['Code'].apply(lambda c: get_location_info(c)['region_code'])
    df['_region_name'] = df['Code'].apply(lambda c: get_location_info(c)['region_name'])
    df['_prov_code'] = df['Code'].apply(lambda c: get_location_info(c)['prov_code'])
    df['_dist_code'] = df['Code'].apply(lambda c: get_location_info(c)['dist_code'])
    df['_subdist_code'] = df['Code'].apply(lambda c: get_location_info(c)['subdist_code'])
    df['_province'] = df['Code'].apply(lambda c: get_location_info(c)['province'])
    df['_district'] = df['Code'].apply(lambda c: get_location_info(c)['district'])
    df['_subdistrict'] = df['Code'].apply(lambda c: get_location_info(c)['subdistrict'])
    df['_route'] = df['Code'].apply(lambda c: get_location_info(c)['route'])
    df['_distance_from_dc'] = df['Code'].apply(lambda c: get_location_info(c)['distance_from_dc'])
    df['_lat'] = df['Code'].apply(lambda c: get_location_info(c)['lat'])
    df['_lon'] = df['Code'].apply(lambda c: get_location_info(c)['lon'])
    
    # üéØ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Bearing (‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á) ‡∏à‡∏≤‡∏Å DC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏¥‡∏®‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    DC_LAT = 14.117451
    DC_LON = 100.633408
    
    def calc_bearing(row):
        if row['_lat'] > 0 and row['_lon'] > 0:
            return calculate_bearing(DC_LAT, DC_LON, row['_lat'], row['_lon'])
        return 0
    
    df['_bearing_from_dc'] = df.apply(calc_bearing, axis=1)
    df['_bearing_zone'] = df['_bearing_from_dc'].apply(get_bearing_zone)
    
    # üö® ‡πÄ‡∏û‡∏¥‡πà‡∏° Logistics Zone ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö routing ‡∏ï‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á
    df['_logistics_zone'] = df.apply(
        lambda row: get_logistics_zone(row['_province'], row['_district'], row['_subdistrict']),
        axis=1
    )
    df['_zone_priority'] = df['_logistics_zone'].apply(get_zone_priority)
    df['_zone_highway'] = df['_logistics_zone'].apply(get_zone_highway)
    
    # ==========================================
    # Step 3: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö Hierarchical (Zone Priority > Region > Province Max Dist > District Max Dist > Distance)
    # üéØ ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Region Order ‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ)
    # ==========================================
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏° Region Order ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sorting
    df['_region_order'] = df['_region_name'].map(REGION_ORDER).fillna(99)
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Province Max Distance (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏´‡∏ô‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
    prov_max_dist = df.groupby('_province')['_distance_from_dc'].max().reset_index()
    prov_max_dist.columns = ['_province', '_prov_max_dist']
    df = df.merge(prov_max_dist, on='_province', how='left')
    df['_prov_max_dist'] = df['_prov_max_dist'].fillna(9999)
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì District Max Distance (‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÑ‡∏´‡∏ô‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
    dist_max_dist = df.groupby(['_province', '_district'])['_distance_from_dc'].max().reset_index()
    dist_max_dist.columns = ['_province', '_district', '_dist_max_dist']
    df = df.merge(dist_max_dist, on=['_province', '_district'], how='left')
    df['_dist_max_dist'] = df['_dist_max_dist'].fillna(9999)
    
    # üéØ Sort: LIFO (Last In First Out) - ‡πÑ‡∏Å‡∏•‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô, ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
    # Zone Priority (Asc - 1=‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î, 99=‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î) ‚Üí Region Order ‚Üí Province Max Dist ‚Üí District Max Dist ‚Üí 
    # Sum_Code ‚Üí Route ‚Üí Distance (Desc - ‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
    df = df.sort_values(
        ['_zone_priority', '_region_order', '_prov_max_dist', '_dist_max_dist', '_sum_code', '_route', '_distance_from_dc'],
        ascending=[True, True, False, False, True, True, False]  # Zone Priority + ‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ
    ).reset_index(drop=True)
    
    # ==========================================
    # Step 4: ‡∏à‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° Route ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
    # ==========================================
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á grouping key ‡∏à‡∏≤‡∏Å route (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≥‡∏ö‡∏•+‡∏≠‡∏≥‡πÄ‡∏†‡∏≠+‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    def get_group_key(row):
        route = row['_route']
        if route and route.strip():
            return f"R_{route}"
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ route ‡πÉ‡∏ä‡πâ ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡∏ö‡∏• (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)
        return f"L_{row['_subdist_code']}_{row['_dist_code']}_{row['_prov_code']}"
    
    df['_group_key'] = df.apply(get_group_key, axis=1)
    
    # ==========================================
    # Step 5: ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤ + Central Region Rule
    # ==========================================
    def get_max_vehicle_for_code(code):
        """‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ - ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Sheets"""
        max_vehicle = get_max_vehicle_for_branch(code, test_df=test_df)
        return max_vehicle
    
    def get_allowed_vehicles_for_region(region_name):
        """‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° Master data ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)"""
        return ['4W', 'JB', '6W']  # All vehicles - restrictions from Master data only
    
    df['_max_vehicle'] = df['Code'].apply(get_max_vehicle_for_code)
    df['_region_allowed_vehicles'] = df['_region_name'].apply(get_allowed_vehicles_for_region)
    
    # üéØ ‡∏™‡∏£‡πâ‡∏≤‡∏á Vehicle Priority: ‡∏™‡∏≤‡∏Ç‡∏≤ 4W = 1 (‡∏à‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô), JB = 2, 6W = 3 (‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
    vehicle_priority_map = {'4W': 1, 'JB': 2, '6W': 3}
    df['_vehicle_priority'] = df['_max_vehicle'].map(vehicle_priority_map).fillna(3)
    
    # üéØ Sort: ‡πÉ‡∏ä‡πâ BEARING ZONE ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏¥‡∏®‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô
    # ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏¥‡∏®‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å DC ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
    # 1. Bearing Zone (‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å DC) - ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏¥‡∏®‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô
    # 2. ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å DC (‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ) - LIFO
    # 3. ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏• - ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    df = df.sort_values(
        [
            '_bearing_zone',        # 1. üß≠ ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å DC - ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏¥‡∏®‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô!
            '_distance_from_dc',    # 2. ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô (LIFO)
            '_province',            # 3. ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            '_district',            # 4. ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            '_subdistrict',         # 5. ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            '_vehicle_priority'     # 6. ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ (secondary)
        ],
        ascending=[
            True,   # ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á 0-15 (‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‚Üí‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‚Üí‡πÉ‡∏ï‡πâ‚Üí‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å)
            False,  # ‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ (LIFO)
            True,   # ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á A-Z
            True,   # ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á A-Z
            True,   # ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏á A-Z
            True    # ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏°‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô
        ]
    ).reset_index(drop=True)
    
    safe_print(f"üìä DEBUG: Bearing zones = {df['_bearing_zone'].unique().tolist()}")
    
    # ==========================================
    # Step 6: DISTRICT CLUSTERING ALLOCATION (OPTIMIZED)
    # ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏≤‡∏° District Buckets ‡∏û‡∏£‡πâ‡∏≠‡∏° Split ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô
    # ==========================================
    trip_counter = 1
    df['Trip'] = 0
    
    vehicle_priority = {'4W': 1, 'JB': 2, '6W': 3}
    
    # üöÄ CACHE: Pre-compute branch constraints ‡πÅ‡∏•‡∏∞ BU type ‡∏à‡∏≤‡∏Å Excel upload
    branch_max_vehicle_cache = {}
    branch_bu_cache = {}
    for _, row in df.iterrows():
        code = row['Code']
        branch_max_vehicle_cache[code] = row['_max_vehicle']
        
        # üìä ‡∏î‡∏∂‡∏á BU ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà upload ‡∏°‡∏≤ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå BU)
        bu = row.get('BU', None)  # ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Excel
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Punthai ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        is_punthai = False
        if bu is not None:
            bu_str = str(bu).strip().upper()
            # ‡πÄ‡∏ä‡πá‡∏Ñ BU = 211 ‡∏´‡∏£‡∏∑‡∏≠ 'PUNTHAI'
            is_punthai = bu_str in ['211', 'PUNTHAI']
        else:
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå BU ‚Üí ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ (fallback)
            name = str(row.get('Name', '')).upper()
            is_punthai = 'PUNTHAI' in name or 'PUN-' in name
        
        branch_bu_cache[code] = is_punthai
    
    # üöÄ Pre-compute limits with buffer
    def get_max_limits(allowed_vehicles, is_punthai):
        """‡∏´‡∏≤ capacity ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ"""
        buffer_mult = punthai_buffer if is_punthai else maxmart_buffer
        max_vehicle = '6W' if '6W' in allowed_vehicles else ('JB' if 'JB' in allowed_vehicles else '4W')
        limits_to_use = PUNTHAI_LIMITS if is_punthai else LIMITS
        lim = limits_to_use.get(max_vehicle, LIMITS['6W'])
        return {
            'max_w': lim.get('max_w', 6000) * buffer_mult,
            'max_c': lim.get('max_c', 20.0) * buffer_mult,
            'max_d': lim.get('max_drops', 12)
        }
    
    # Helper function: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (STRICT - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î)
    def select_vehicle_for_load(weight, cube, drops, is_punthai, allowed_vehicles, strict_constraint=True):
        """
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
        
        Logic: ‡πÉ‡∏ä‡πâ buffer ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (punthai_buffer, maxmart_buffer)
        - Punthai: buffer = 100% (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô)
        - Maxmart: buffer = 110% (‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ 10%)
        - strict_constraint=True: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤ allowed_vehicles (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î)
        """
        buffer_mult = punthai_buffer if is_punthai else maxmart_buffer
        limits_to_use = PUNTHAI_LIMITS if is_punthai else LIMITS
        
        # üö® STRICT MODE: ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô
        vehicle_rank = {'4W': 1, 'JB': 2, '6W': 3}
        max_allowed_rank = max([vehicle_rank[v] for v in allowed_vehicles if v in vehicle_rank], default=3)
        
        # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡πá‡∏Å‡πÑ‡∏õ‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏ï‡πà‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô max_allowed
        vehicle_order = ['4W', 'JB', '6W']
        
        for v in vehicle_order:
            # ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
            if strict_constraint and vehicle_rank.get(v, 3) > max_allowed_rank:
                continue
            
            if v not in allowed_vehicles:
                continue
                
            lim = limits_to_use[v]
            
            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≤‡∏° buffer ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (weight <= lim['max_w'] * buffer_mult and 
                cube <= lim['max_c'] * buffer_mult and 
                drops <= lim.get('max_drops', 12)):
                return v
        
        return None
    
    # Helper function: ‡πÄ‡∏ä‡πá‡∏Ñ Geographic Spread ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
    def check_intra_trip_spread(trip_codes_list):
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏¥‡∏®)"""
        if len(trip_codes_list) < 2:
            return True  # 1 ‡∏™‡∏≤‡∏Ç‡∏≤ = OK
        
        trip_df = df[df['Code'].isin(trip_codes_list)]
        if trip_df.empty:
            return True
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì centroid ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ
        trip_lat_mean = trip_df['_lat'].mean()
        trip_lon_mean = trip_df['_lon'].mean()
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å centroid ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 80km
        max_dist_from_center = 0
        for _, row in trip_df.iterrows():
            if row['_lat'] > 0 and row['_lon'] > 0:
                dist = haversine_distance(trip_lat_mean, trip_lon_mean, row['_lat'], row['_lon'])
                max_dist_from_center = max(max_dist_from_center, dist)
        
        # ‡∏ñ‡πâ‡∏≤ spread ‡πÄ‡∏Å‡∏¥‡∏ô 80km ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏¥‡∏®)
        return max_dist_from_center <= 80
    
    # Helper function: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Punthai ‡∏•‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Optimized - ‡πÉ‡∏ä‡πâ cache)
    def is_all_punthai_codes(codes):
        if not codes:
            return False
        return all(branch_bu_cache.get(c, False) for c in codes)
    
    # Helper function: ‡∏´‡∏≤ allowed vehicles ‡∏à‡∏≤‡∏Å codes (Optimized)
    def get_allowed_from_codes(codes, base_allowed):
        """‡∏´‡∏≤ allowed vehicles ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° branch constraints"""
        result = set(base_allowed)
        for code in codes:
            branch_max = branch_max_vehicle_cache.get(code, '6W')
            if branch_max == 'JB':
                result.discard('6W')
            elif branch_max == '4W':
                result.discard('6W')
                result.discard('JB')
        return list(result)
    
    # Step 6.4: üéØ ZONE-STRICT GREEDY - ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡πÇ‡∏ã‡∏ô + ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏ã‡∏ô
    # ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ LOGISTICS_ZONES + NO_CROSS_ZONE_PAIRS
    # ==========================================
    safe_print("üéØ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö Zone-Strict (LOGISTICS_ZONES + NO_CROSS_ZONE_PAIRS)...")

    # _logistics_zone, _zone_priority, _zone_highway ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà Step 2

    # 2Ô∏è‚É£ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° zone priority (priority ‡∏ï‡πà‡∏≥ = ‡πÑ‡∏Å‡∏• DC = ‡∏à‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô)
    df = df.sort_values(['_zone_priority', '_distance_from_dc'], ascending=[True, False]).reset_index(drop=True)
    
    # üöó ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì MaxVehicle ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (4W=1, JB=2, 6W=3)
    vehicle_rank = {'4W': 1, 'JB': 2, '6W': 3}
    df['_max_vehicle'] = df['Code'].apply(lambda c: get_max_vehicle_for_branch(c))
    df['_vehicle_rank'] = df['_max_vehicle'].map(vehicle_rank).fillna(3).astype(int)
    
    # ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    df['Trip'] = 0
    trip_counter = 1
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á set ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î
    unassigned = set(df['Code'].tolist())
    
    # 3Ô∏è‚É£ ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô + ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ (4W ‡∏Å‡πà‡∏≠‡∏ô ‚Üí JB ‚Üí 6W)
    zones_processed = set()
    
    while unassigned:
        # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î
        unassigned_df = df[df['Code'].isin(unassigned)]
        if unassigned_df.empty:
            break
        
        # üöó ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°: 1) zone priority (‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô) 2) vehicle_rank (4W ‡∏Å‡πà‡∏≠‡∏ô) 3) ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô)
        unassigned_df = unassigned_df.sort_values(
            ['_zone_priority', '_vehicle_rank', '_distance_from_dc'], 
            ascending=[True, True, False]
        )
        
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å (‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î + ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î)
        farthest_row = unassigned_df.iloc[0]
        start_code = farthest_row['Code']
        start_lat = farthest_row['_lat']
        start_lon = farthest_row['_lon']
        start_max_vehicle = farthest_row['_max_vehicle']  # üöó ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
        
        # üéØ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏ã‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å
        trip_province = farthest_row.get('_province', '')
        trip_district = farthest_row.get('_district', '')  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
        trip_subdistrict = farthest_row.get('_subdistrict', '')  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡∏ö‡∏•
        trip_bearing_zone = farthest_row.get('_bearing_zone', 0)
        trip_region = farthest_row.get('_region_name', '')
        trip_logistics_zone = farthest_row.get('_logistics_zone', '')  # üéØ LOGISTICS_ZONE
        trip_max_vehicle = start_max_vehicle  # üöó ‡∏£‡∏ñ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ (‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å)

        # üîí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å province + highway + region ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‚Üí ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à zone-compat ‡∏ï‡∏•‡∏≠‡∏î (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô chain-hop)
        trip_original_province = trip_province
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì region ‡∏à‡∏≤‡∏Å province ‚Üí fallback ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô
        _derived_region = get_region_name(str(trip_original_province)) if trip_original_province else ''
        if not _derived_region or _derived_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏':
            _derived_region = farthest_row.get('_region_name', '')
        if not _derived_region or _derived_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏':
            # last resort: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å _region_code column (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Step 2)
            _rc = str(farthest_row.get('_region_code', '99'))
            _derived_region = REGION_NAMES.get(_rc[0] if len(_rc) > 0 else '9', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')
        trip_original_region = _derived_region
        _orig_hw_str = get_zone_highway(trip_logistics_zone)
        trip_original_hws: set = set(_orig_hw_str.split('/')) if _orig_hw_str else set()
        
        # üéØ ‡πÄ‡∏Å‡πá‡∏ö set ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ (‡πÉ‡∏ä‡πâ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
        trip_subdistricts = {trip_subdistrict} if trip_subdistrict else set()
        trip_districts = {trip_district} if trip_district else set()
        
        # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î
        # üéØ ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚â§200m) ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å
        start_group_codes = get_group_branches(start_code)
        start_group_unassigned = [c for c in start_group_codes if c in unassigned or c.upper() in [str(x).upper() for x in unassigned]]
        if not start_group_unassigned:
            start_group_unassigned = [start_code]
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì weight/cube ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
        trip_codes = []
        trip_weight = 0
        trip_cube = 0
        for gc in start_group_unassigned:
            gc_row = df[df['Code'].apply(lambda x: str(x).upper() == str(gc).upper())]
            if not gc_row.empty:
                actual_code = gc_row.iloc[0]['Code']
                # üîí FINAL REGION GUARD: ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° start ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ
                if trip_original_region and trip_original_region not in ('', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'):
                    _sg_prov = str(gc_row.iloc[0].get('_province', '') or '')
                    _sg_region = get_region_name(_sg_prov) if _sg_prov else ''
                    if _sg_region and _sg_region not in ('', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') and _sg_region != trip_original_region:
                        safe_print(f"      üõë START-GROUP GUARD: ‡∏ï‡∏±‡∏î {actual_code} ‡∏†‡∏≤‡∏Ñ {_sg_region} ‚â† {trip_original_region}")
                        continue  # ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äî ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
                    # ‚ö° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ province/region ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å farthest_row (‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
                    if (not _sg_region or _sg_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') and gc.upper() != str(start_code).upper():
                        _sg_lat = float(gc_row.iloc[0].get('_lat', 0) or 0)
                        _sg_lon = float(gc_row.iloc[0].get('_lon', 0) or 0)
                        if _sg_lat > 0 and _sg_lon > 0 and start_lat > 0 and start_lon > 0:
                            _sg_dist = haversine_distance(_sg_lat, _sg_lon, start_lat, start_lon)
                            if _sg_dist > 10.0:
                                safe_print(f"      üõë START-GROUP DIST GUARD: ‡∏ï‡∏±‡∏î {actual_code} ‡∏´‡πà‡∏≤‡∏á {_sg_dist:.1f}km (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)")
                                continue
                trip_codes.append(actual_code)
                trip_weight += gc_row.iloc[0]['Weight']
                trip_cube += gc_row.iloc[0]['Cube']
                # ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å unassigned
                if actual_code in unassigned:
                    unassigned.remove(actual_code)
                else:
                    for u in list(unassigned):
                        if str(u).upper() == str(actual_code).upper():
                            unassigned.remove(u)
                            break
        
        if len(trip_codes) > 1:
            safe_print(f"  üåè ‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà #{trip_counter} ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà {start_code} | ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î='{trip_original_province}' | ‡∏†‡∏≤‡∏Ñ='{trip_original_region}' | zone='{trip_logistics_zone}'")
            safe_print(f"      üîó ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°: {trip_codes}")
        else:
            safe_print(f"   üöÄ Trip {trip_counter}: {start_code} ({trip_province}) - {trip_logistics_zone} - {trip_max_vehicle} - {farthest_row['_distance_from_dc']:.0f}km")
        
        # ‡∏´‡∏≤ allowed vehicles ‡∏à‡∏≤‡∏Å constraints (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ï‡∏≤‡∏° trip_max_vehicle)
        trip_allowed = get_allowed_from_codes(trip_codes, ['4W', 'JB', '6W'])
        trip_is_punthai = all(branch_bu_cache.get(c, False) for c in trip_codes)
        
        # 2Ô∏è‚É£ Greedy: ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏ô‡πÄ‡∏ï‡πá‡∏° buffer
        while unassigned:
            remaining_df = df[df['Code'].isin(unassigned)].copy()
            if remaining_df.empty:
                break
            
            # ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï same_zone_df ‡∏ó‡∏∏‡∏Å iteration ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô stale value ‡∏à‡∏≤‡∏Å iteration ‡∏Å‡πà‡∏≠‡∏ô
            same_zone_df = None
            filter_level = ""

            # üéØ 0Ô∏è‚É£ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏°‡∏≤‡∏Å‡πÜ ‡∏Å‡πà‡∏≠‡∏ô (< 6km) - ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î!
            very_close_df = None
            last_code = trip_codes[-1]
            last_code_upper = str(last_code).strip().upper()
            
            if last_code_upper in NEARBY_BRANCHES:
                # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏°‡∏≤‡∏Å (< 6km) ‡∏à‡∏≤‡∏Å pre-computed data
                very_close_codes = []
                for nearby_code, dist in NEARBY_BRANCHES[last_code_upper]:
                    if dist < 6.0 and nearby_code in [str(c).strip().upper() for c in unassigned]:
                        very_close_codes.append(nearby_code)
                
                if very_close_codes:
                    very_close_df = remaining_df[remaining_df['Code'].apply(lambda x: str(x).strip().upper() in very_close_codes)].copy()
            
            # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏°‡∏≤‡∏Å ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà highway ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            # (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏ã‡∏ô highway ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)
            if very_close_df is not None and not very_close_df.empty:
                trip_hw = get_zone_highway(trip_logistics_zone) if trip_logistics_zone else ''
                # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà: ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ highway ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏´‡∏£‡∏∑‡∏≠ highway ‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)
                def _hw_compatible(row_hw):
                    if not trip_hw:
                        return True  # ‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏°‡∏µ zone ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏Å‡πà neighbor (region filter ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠)
                    if not row_hw:
                        return False  # candidate ‡πÑ‡∏°‡πà‡∏°‡∏µ zone/highway ‚Üí ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô)
                    # ‡πÄ‡∏ä‡πá‡∏Ñ primary highway (‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô '/')
                    trip_primaries = set(trip_hw.split('/'))
                    row_primaries = set(row_hw.split('/'))
                    return bool(trip_primaries & row_primaries)
                compatible_df = very_close_df[
                    (very_close_df['_province'] == trip_province) |
                    very_close_df['_zone_highway'].apply(_hw_compatible)
                ].copy()
                if not compatible_df.empty:
                    same_zone_df = compatible_df
                    filter_level = "‡πÉ‡∏Å‡∏•‡πâ‡∏°‡∏≤‡∏Å(<6km)"
                # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤ compatible ‚Üí ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ï‡πà‡∏≠ same_zone_df = None (‡πÉ‡∏ä‡πâ zone filter ‡∏õ‡∏Å‡∏ï‡∏¥)
            else:
                # üéØ ‡∏Å‡∏£‡∏≠‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡πÇ‡∏ã‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î!)
                same_zone_df = None
                filter_level = ""
                
                # üèôÔ∏è ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏© BKK: ‡πÉ‡∏ä‡πâ radius ‡πÅ‡∏ó‡∏ô zone (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô)
                is_bkk_trip = trip_logistics_zone and 'BKK' in trip_logistics_zone
                if is_bkk_trip and trip_codes:
                    # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô radius 15km ‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏î‡πÜ ‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
                    bkk_nearby = set()
                    unassigned_upper_set = {str(c).strip().upper() for c in unassigned}
                    for tc in trip_codes:
                        tc_upper = str(tc).strip().upper()
                        if tc_upper in NEARBY_BRANCHES:
                            for nearby_code, dist in NEARBY_BRANCHES[tc_upper]:
                                if dist <= 15.0 and nearby_code in unassigned_upper_set:
                                    bkk_nearby.add(nearby_code)
                    
                    if bkk_nearby:
                        bkk_nearby_df = remaining_df[remaining_df['Code'].apply(lambda x: str(x).strip().upper() in bkk_nearby)].copy()
                        if not bkk_nearby_df.empty:
                            same_zone_df = bkk_nearby_df
                            filter_level = "BKK radius 15km"
                
                # 1Ô∏è‚É£ ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô (priority ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
                if same_zone_df is None and trip_subdistricts and trip_districts:
                    subdistrict_df = remaining_df[
                        (remaining_df['_subdistrict'].isin(trip_subdistricts)) & 
                        (remaining_df['_district'].isin(trip_districts))
                    ].copy()
                    if not subdistrict_df.empty:
                        same_zone_df = subdistrict_df
                        filter_level = "‡∏ï‡∏≥‡∏ö‡∏•"
                
                # 2Ô∏è‚É£ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏ï‡∏≥‡∏ö‡∏•‡πÅ‡∏•‡πâ‡∏ß)
                if same_zone_df is None and trip_districts:
                    district_df = remaining_df[remaining_df['_district'].isin(trip_districts)].copy()
                    if not district_df.empty:
                        same_zone_df = district_df
                        filter_level = "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠"
            
            # 3Ô∏è‚É£ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏•‡πâ‡∏ß)
            # ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à trip_province ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á ‚Äî ‡∏°‡∏¥‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô '' == '' ‡∏Ñ‡∏∑‡∏ô ALL ‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏ï‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ‡∏õ‡∏ô‡∏Å‡∏±‡∏ô)
            if same_zone_df is None and trip_province:
                province_df = remaining_df[remaining_df['_province'] == trip_province].copy()
                if not province_df.empty:
                    same_zone_df = province_df
                    filter_level = "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"
            
            # 4Ô∏è‚É£ LOGISTICS_ZONE ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß)
            if same_zone_df is None and trip_logistics_zone:
                zone_df = remaining_df[remaining_df['_logistics_zone'] == trip_logistics_zone].copy()
                if not zone_df.empty:
                    same_zone_df = zone_df
                    filter_level = "‡πÇ‡∏ã‡∏ô"
                    # ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß
                    trip_subdistricts = set()
                    trip_districts = set()
            
            # 5Ô∏è‚É£ Highway ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÇ‡∏ã‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÇ‡∏ã‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô highway ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
            if same_zone_df is None:
                trip_highway = get_zone_highway(trip_logistics_zone)
                if trip_highway:
                    # ‡πÉ‡∏ä‡πâ set intersection ‡πÅ‡∏ó‡∏ô exact match ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö '304' ‡∏Å‡∏±‡∏ö '304/331' ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
                    trip_hw_set = set(trip_highway.split('/'))
                    def _hw_match(row_hw):
                        if not row_hw:
                            return False
                        return bool(trip_hw_set & set(str(row_hw).split('/')))
                    highway_df = remaining_df[remaining_df['_zone_highway'].apply(_hw_match)].copy()
                    if not highway_df.empty:
                        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                        last_code = trip_codes[-1]
                        last_row = df[df['Code'] == last_code].iloc[0]
                        last_lat, last_lon = last_row['_lat'], last_row['_lon']
                        
                        if last_lat > 0 and last_lon > 0:
                            highway_df['_dist_to_last'] = highway_df.apply(
                                lambda r: haversine_distance(r['_lat'], r['_lon'], last_lat, last_lon) 
                                if r['_lat'] > 0 and r['_lon'] > 0 else 999, axis=1
                            )
                            nearest_row = highway_df.loc[highway_df['_dist_to_last'].idxmin()]
                            nearest_zone = nearest_row['_logistics_zone']
                            nearest_prov = nearest_row['_province']
                            
                            # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÇ‡∏ã‡∏ô (BKK trips ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å BKK)
                            # BKK = ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ã‡∏ô BKK_* ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                            _orig_zone_name = str(farthest_row.get('_logistics_zone', ''))
                            _is_bkk_start = (trip_original_province == '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£' or
                                             'BKK' in _orig_zone_name)
                            _nearest_is_bkk = 'BKK' in str(nearest_zone)
                            trip_logistics_zone = nearest_zone
                            if _is_bkk_start and not _nearest_is_bkk:
                                # BKK trip ‡∏Ç‡∏¢‡∏≤‡∏¢ highway ‡πÑ‡∏õ‡πÇ‡∏ã‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏≠‡∏¢‡πà‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                                safe_print(f"      üèôÔ∏è BKK trip: ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï trip_province ({trip_province} ‚Üí {nearest_prov} ‡∏Ç‡πâ‡∏≤‡∏°)")
                            else:
                                trip_province = nearest_prov
                            trip_subdistricts = set()
                            trip_districts = set()
                            
                            same_zone_df = highway_df
                            filter_level = f"Highway {trip_highway}"
                            safe_print(f"      üõ£Ô∏è ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏õ‡πÇ‡∏ã‡∏ô {nearest_zone} ‡πÉ‡∏ô Highway {trip_highway}")
            
            # 6Ô∏è‚É£ ‡∏´‡∏°‡∏î Highway ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ! (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ Highway ‡∏≠‡∏∑‡πà‡∏ô)
            # ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å "‡∏´‡∏°‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ‡∏ñ‡∏∂‡∏á‡πÑ‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô"
            if same_zone_df is None:
                safe_print(f"      üõë ‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô Highway {get_zone_highway(trip_logistics_zone)} ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                break  # ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏õ Highway ‡∏≠‡∏∑‡πà‡∏ô

            # üîí ‡∏Å‡∏£‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á)
            if not trip_original_region or trip_original_region in ('‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', ''):
                # trip_original_region ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ ‚Üí ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å candidates ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πá‡∏≠‡∏Ñ
                _cand_region_counts: dict = {}
                for _, _cr in same_zone_df.iterrows():
                    _cp = _cr.get('_province', '')
                    _crn = get_region_name(str(_cp)) if _cp else ''
                    if _crn and _crn != '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏':
                        _cand_region_counts[_crn] = _cand_region_counts.get(_crn, 0) + 1
                if _cand_region_counts:
                    # ‡∏•‡πá‡∏≠‡∏Ñ‡∏†‡∏≤‡∏Ñ‡∏à‡∏≤‡∏Å candidate ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                    trip_original_region = max(_cand_region_counts, key=_cand_region_counts.get)
                    safe_print(f"      üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏†‡∏≤‡∏Ñ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ #{trip_counter}: '{trip_original_region}' (‡∏à‡∏≤‡∏Å candidates {_cand_region_counts})")
                    _region_filtered = same_zone_df[
                        same_zone_df['_province'].apply(lambda p: get_region_name(str(p)) if p else '') == trip_original_region
                    ]
                    if _region_filtered.empty:
                        safe_print(f"      üõë ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ {trip_original_region} ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                        break
                    same_zone_df = _region_filtered.copy()
                else:
                    # ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏•‡∏¢ ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
                    safe_print(f"      üõë ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏Ñ‡∏Ç‡∏≠‡∏á candidates ‡πÉ‡∏ô #{trip_counter} ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ (‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)")
                    break
            else:
                _region_filtered = same_zone_df[
                    same_zone_df['_province'].apply(lambda p: get_region_name(str(p)) if p else '') == trip_original_region
                ]
                _dropped = len(same_zone_df) - len(_region_filtered)
                if _dropped > 0:
                    _dropped_provs = same_zone_df[~same_zone_df.index.isin(_region_filtered.index)]['_province'].unique().tolist()
                    safe_print(f"      üîí ‡∏Å‡∏£‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ #{trip_counter}: ‡∏ï‡∏±‡∏î {_dropped} ‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏ï‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ: {_dropped_provs})")
                if _region_filtered.empty:
                    safe_print(f"      üõë ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ {trip_original_region} (‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ) ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                    break
                same_zone_df = _region_filtered.copy()

            # üéØ Priority: ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô > ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô > ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î > ‡πÇ‡∏ã‡∏ô
            same_zone_df['_priority'] = 4  # default = ‡πÇ‡∏ã‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            
            # ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí priority 1
            if trip_subdistricts and trip_districts:
                mask_subdistrict = same_zone_df['_subdistrict'].isin(trip_subdistricts) & same_zone_df['_district'].isin(trip_districts)
                same_zone_df.loc[mask_subdistrict, '_priority'] = 1
            
            # ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí priority 2
            if trip_districts:
                mask_district = same_zone_df['_district'].isin(trip_districts) & (same_zone_df['_priority'] > 2)
                same_zone_df.loc[mask_district, '_priority'] = 2
            
            # ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí priority 3
            mask_province = (same_zone_df['_province'] == trip_province) & (same_zone_df['_priority'] > 3)
            same_zone_df.loc[mask_province, '_priority'] = 3
            
            # üéØ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á - ‡πÉ‡∏ä‡πâ pre-computed ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            unassigned_upper = {str(c).strip().upper() for c in unassigned}
            
            candidate_distances = {}
            for tc in trip_codes:
                tc_upper = str(tc).strip().upper()
                if tc_upper in NEARBY_BRANCHES:
                    for nearby_code, dist in NEARBY_BRANCHES[tc_upper]:
                        if nearby_code in unassigned_upper:
                            if nearby_code not in candidate_distances or dist < candidate_distances[nearby_code]:
                                candidate_distances[nearby_code] = dist
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‚Äî ‡πÉ‡∏ä‡πâ NEARBY_BRANCHES cache ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ, fallback haversine ‡∏à‡∏≤‡∏Å branch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            _last_code_d = trip_codes[-1]
            _last_row_d = df[df['Code'] == _last_code_d].iloc[0]
            _last_lat_d, _last_lon_d = _last_row_d['_lat'], _last_row_d['_lon']

            def _dist_for_row(row):
                cu = str(row['Code']).strip().upper()
                if cu in candidate_distances:
                    return candidate_distances[cu]
                # fallback: haversine ‡∏à‡∏≤‡∏Å branch ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ
                if _last_lat_d > 0 and _last_lon_d > 0 and row['_lat'] > 0 and row['_lon'] > 0:
                    return haversine_distance(row['_lat'], row['_lon'], _last_lat_d, _last_lon_d)
                return 999

            same_zone_df['_dist_to_trip'] = same_zone_df.apply(_dist_for_row, axis=1)
            
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° priority + distance
            same_zone_df = same_zone_df.sort_values(['_priority', '_dist_to_trip'])
            
            found_candidate = False
            
            for _, candidate_row in same_zone_df.iterrows():
                candidate_code = candidate_row['Code']
                candidate_dist = candidate_row['_dist_to_trip']
                
                # üö´ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 80km ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏≠‡∏¢‡πà‡∏≤ break ‚Äî priority ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏≤‡∏à‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏ß‡πà‡∏≤)
                if candidate_dist > 80:
                    continue  # ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (priority ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ / ‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏ß‡πà‡∏≤)
                
                # üö´ Zone/province/region axis check (Step 6 greedy) ‚Äî ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏¥‡∏®/highway/‡∏†‡∏≤‡∏Ñ
                _c_prov   = candidate_row.get('_province', '')
                _c_zone   = candidate_row.get('_logistics_zone', '')
                _c_hw     = candidate_row.get('_zone_highway', '')
                _c_hws    = set(str(_c_hw).split('/')) if _c_hw else set()
                # ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏†‡∏≤‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô ‚Äî ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å province ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ _region_name ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ß‡πà‡∏≤‡∏á)
                _c_region_calc = get_region_name(str(_c_prov)) if _c_prov else ''
                _orig_region_calc = trip_original_region  # ‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡∏´‡∏£‡∏∑‡∏≠ chokepoint
                _region_compat = (
                    _c_region_calc in ('', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') or   # candidate ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
                    _orig_region_calc in ('', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') or  # ‡∏ó‡∏£‡∏¥‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡∏ó‡∏µ‡πà chokepoint ‡∏ï‡πà‡∏≠‡πÑ‡∏õ)
                    _c_region_calc == _orig_region_calc   # ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                )
                if not _region_compat:
                    safe_print(f"      üö´ step6 skip {candidate_code} ‡∏†‡∏≤‡∏Ñ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ({_c_region_calc}/{_c_prov} ‚â† {_orig_region_calc}/{trip_original_province})")
                    continue
                # ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à province/zone/highway
                _zone_compat = (
                    not _c_prov or not trip_original_province or   # ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
                    _c_prov == trip_original_province or           # ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                    _c_prov == trip_province or                    # ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    _c_zone == trip_logistics_zone or              # ‡πÇ‡∏ã‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                    bool(trip_original_hws & _c_hws)              # highway ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                )
                if not _zone_compat:
                    safe_print(f"      üö´ step6 skip {candidate_code} ({_c_prov}/{_c_zone}/{_c_hw}) ‚â† trip ({trip_original_province}/{trip_logistics_zone}/{trip_original_hws})")
                    continue   # ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏ô same_zone_df

                # üéØ ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚â§200m)
                group_codes = get_group_branches(candidate_code)
                # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÉ‡∏ô df
                group_codes_unassigned = [c for c in group_codes if c in unassigned or c.upper() in [str(x).upper() for x in unassigned]]
                if not group_codes_unassigned:
                    group_codes_unassigned = [candidate_code]
                
                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì weight/cube ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
                group_weight = 0
                group_cube = 0
                group_codes_valid = []
                for gc in group_codes_unassigned:
                    gc_row = df[df['Code'].apply(lambda x: str(x).upper() == str(gc).upper())]
                    if not gc_row.empty:
                        # üîí FINAL REGION GUARD: ‡∏ï‡∏£‡∏ß‡∏à‡∏†‡∏≤‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° candidate ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°
                        if trip_original_region and trip_original_region not in ('', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'):
                            _cg_prov = str(gc_row.iloc[0].get('_province', '') or '')
                            _cg_region = get_region_name(_cg_prov) if _cg_prov else ''
                            if _cg_region and _cg_region not in ('', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') and _cg_region != trip_original_region:
                                safe_print(f"      üõë CAND-GROUP GUARD: ‡∏ï‡∏±‡∏î {gc} ‡∏†‡∏≤‡∏Ñ {_cg_region} ‚â† {trip_original_region}")
                                continue  # ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Äî ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏Ñ‡∏¥‡∏ß‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö
                            # ‚ö° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ province/region ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å candidate
                            if (not _cg_region or _cg_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') and str(gc).upper() != str(candidate_code).upper():
                                _cg_lat = float(gc_row.iloc[0].get('_lat', 0) or 0)
                                _cg_lon = float(gc_row.iloc[0].get('_lon', 0) or 0)
                                _cd_lat = float(candidate_row.get('_lat', 0) or 0)
                                _cd_lon = float(candidate_row.get('_lon', 0) or 0)
                                if _cg_lat > 0 and _cg_lon > 0 and _cd_lat > 0 and _cd_lon > 0:
                                    _cg_dist = haversine_distance(_cg_lat, _cg_lon, _cd_lat, _cd_lon)
                                    if _cg_dist > 5.0:
                                        safe_print(f"      üõë CAND-GROUP DIST GUARD: ‡∏ï‡∏±‡∏î {gc} ‡∏´‡πà‡∏≤‡∏á {_cg_dist:.1f}km (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)")
                                        continue
                        group_weight += gc_row.iloc[0]['Weight']
                        group_cube += gc_row.iloc[0]['Cube']
                        group_codes_valid.append(gc_row.iloc[0]['Code'])
                
                if not group_codes_valid:
                    continue
                
                # üö´ ‡πÄ‡∏ä‡πá‡∏Ñ vehicle constraint ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
                vehicle_rank = {'4W': 1, 'JB': 2, '6W': 3}
                group_min_max_rank = 3
                for gc in group_codes_valid:
                    gc_max_vehicle = get_max_vehicle_for_branch(gc)
                    gc_max_rank = vehicle_rank.get(gc_max_vehicle, 3)
                    group_min_max_rank = min(group_min_max_rank, gc_max_rank)
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ allowed vehicles (‡∏£‡∏ß‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°)
                test_codes = trip_codes + group_codes_valid
                test_allowed = get_allowed_from_codes(test_codes, ['4W', 'JB', '6W'])
                if not test_allowed:
                    # ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ (‡πÑ‡∏°‡πà‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ß‡∏™‡∏≤‡∏Ç‡∏≤)
                    if len(group_codes_valid) > 1:
                        safe_print(f"      üõë ‡∏Å‡∏•‡∏∏‡πà‡∏° {group_codes_valid} (‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î) ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                    else:
                        safe_print(f"      üõë ‡∏™‡∏≤‡∏Ç‡∏≤ {candidate_code} (‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î) ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                    break
                
                # üéØ ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°)
                selected_vehicle = None
                for veh in ['4W', 'JB', '6W']:
                    if veh in test_allowed:
                        veh_rank = vehicle_rank.get(veh, 3)
                        if veh_rank <= group_min_max_rank:
                            selected_vehicle = veh
                            break
                
                if not selected_vehicle:
                    if len(group_codes_valid) > 1:
                        safe_print(f"      üõë ‡∏Å‡∏•‡∏∏‡πà‡∏° {group_codes_valid} (‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î) ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                    else:
                        safe_print(f"      üõë ‡∏™‡∏≤‡∏Ç‡∏≤ {candidate_code} (‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î) ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                    break
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£/drops ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
                test_weight = trip_weight + group_weight
                test_cube = trip_cube + group_cube
                test_drops = len(test_codes)
                
                # ‡∏´‡∏≤ buffer ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
                test_is_punthai = all(branch_bu_cache.get(c, False) for c in test_codes)
                buffer = punthai_buffer if test_is_punthai else maxmart_buffer
                
                # ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤)
                max_vehicle = selected_vehicle
                limits = PUNTHAI_LIMITS if test_is_punthai else LIMITS
                max_w = limits[max_vehicle]['max_w'] * buffer
                max_c = limits[max_vehicle]['max_c'] * buffer
                max_d = limits[max_vehicle]['max_drops']
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô buffer ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if test_weight > max_w or test_cube > max_c or test_drops > max_d:
                    # ‡πÄ‡∏Å‡∏¥‡∏ô buffer ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ (‡∏ï‡∏±‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏∑‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô)
                    if len(group_codes_valid) > 1:
                        safe_print(f"      üõë ‡∏Å‡∏•‡∏∏‡πà‡∏° {len(group_codes_valid)} ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î) ‡πÄ‡∏Å‡∏¥‡∏ô buffer ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                    else:
                        safe_print(f"      üõë ‡∏™‡∏≤‡∏Ç‡∏≤ {candidate_code} (‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î) ‡πÄ‡∏Å‡∏¥‡∏ô buffer ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ {trip_counter}")
                    break
                
                # ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏£‡∏¥‡∏õ (‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚â§200m)
                for gc in group_codes_valid:
                    if gc not in trip_codes:
                        trip_codes.append(gc)
                    # ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å unassigned
                    if gc in unassigned:
                        unassigned.remove(gc)
                    else:
                        # ‡∏Å‡∏£‡∏ì‡∏µ code ‡πÄ‡∏õ‡πá‡∏ô uppercase/lowercase ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
                        for u in list(unassigned):
                            if str(u).upper() == str(gc).upper():
                                unassigned.remove(u)
                                break
                
                trip_weight = test_weight
                trip_cube = test_cube
                trip_allowed = test_allowed
                trip_is_punthai = test_is_punthai
                found_candidate = True
                
                if len(group_codes_valid) > 1:
                    safe_print(f"      üîó ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° {len(group_codes_valid)} ‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô): {group_codes_valid}")
                
                # üéØ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà)
                cand_subdistrict = candidate_row.get('_subdistrict', '')
                cand_district = candidate_row.get('_district', '')
                if cand_subdistrict:
                    trip_subdistricts.add(cand_subdistrict)
                if cand_district:
                    trip_districts.add(cand_district)
                
                # üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏†‡∏≤‡∏Ñ: ‡∏ñ‡πâ‡∏≤ trip_original_region ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ ‚Üí ‡∏•‡πá‡∏≠‡∏Ñ‡∏à‡∏≤‡∏Å candidate ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏†‡∏≤‡∏Ñ
                if (not trip_original_region or trip_original_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'):
                    _cand_prov = candidate_row.get('_province', '')
                    if _cand_prov:
                        _new_region = get_region_name(str(_cand_prov))
                        if _new_region and _new_region != '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏':
                            trip_original_region = _new_region
                            safe_print(f"      üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏†‡∏≤‡∏Ñ #{trip_counter}: '{trip_original_region}' (‡∏à‡∏≤‡∏Å {_cand_prov})")
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (>= 90%)
                w_util = trip_weight / max_w
                c_util = trip_cube / max_c
                if max(w_util, c_util) >= 0.90:
                    safe_print(f"      ‚úÖ Trip {trip_counter} ‡πÄ‡∏ï‡πá‡∏° {max(w_util, c_util)*100:.1f}% ({len(trip_codes)} ‡∏™‡∏≤‡∏Ç‡∏≤)")
                    break  # ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß
                
                break  # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏™‡∏≤‡∏Ç‡∏≤ ‚Üí ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤ centroid ‡πÉ‡∏´‡∏°‡πà
            
            if not found_candidate:
                # ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 100km ‚Üí ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ
                break
        
        # 3Ô∏è‚É£ Assign ‡∏ó‡∏£‡∏¥‡∏õ
        for code in trip_codes:
            df.loc[df['Code'] == code, 'Trip'] = trip_counter
        
        safe_print(f"   üì¶ Trip {trip_counter}: {len(trip_codes)} ‡∏™‡∏≤‡∏Ç‡∏≤, {trip_weight:.0f} kg")
        trip_counter += 1
    
    safe_print(f"üéØ ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à: {trip_counter - 1} ‡∏ó‡∏£‡∏¥‡∏õ")

    # ==========================================
    # Step 6.5: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÑ‡∏Å‡∏• ‚Üí ‡πÉ‡∏Å‡∏•‡πâ)
    # ==========================================
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ
    trip_avg_distances = {}
    for trip_num in df[df['Trip'] > 0]['Trip'].unique():
        trip_data = df[df['Trip'] == trip_num]
        avg_dist = trip_data['_distance_from_dc'].mean()
        trip_avg_distances[trip_num] = avg_dist
    
    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÑ‡∏Å‡∏• ‚Üí ‡πÉ‡∏Å‡∏•‡πâ)
    sorted_trips = sorted(trip_avg_distances.items(), key=lambda x: x[1], reverse=True)
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping ‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà
    trip_mapping = {old_num: new_num for new_num, (old_num, _) in enumerate(sorted_trips, start=1)}
    
    # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà
    df['Trip'] = df['Trip'].map(lambda x: trip_mapping.get(x, x) if x > 0 else x)

    # ==========================================
    # Step 6.6: üîÑ BRANCH-LEVEL MERGE - ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    # ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏°‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤
    # ==========================================
    safe_print("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° buffer ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á...")
    
    def get_trip_capacity(trip_num):
        """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ"""
        trip_data = df[df['Trip'] == trip_num]
        if len(trip_data) == 0:
            return None
        
        total_w = trip_data['Weight'].sum()
        total_c = trip_data['Cube'].sum()
        codes = trip_data['Code'].tolist()
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ BU
        is_punthai = all(branch_bu_cache.get(c, False) for c in codes)
        buffer = punthai_buffer if is_punthai else maxmart_buffer
        
        # ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö constraint ‡πÑ‡∏î‡πâ
        max_vehicles = [branch_max_vehicle_cache.get(c, '6W') for c in codes]
        min_priority = min(vehicle_priority.get(v, 3) for v in max_vehicles)
        allowed_vehicle = {1: '4W', 2: 'JB', 3: '6W'}.get(min_priority, '6W')
        
        limits = PUNTHAI_LIMITS if is_punthai else LIMITS
        max_w = limits[allowed_vehicle]['max_w'] * buffer
        max_c = limits[allowed_vehicle]['max_c'] * buffer
        max_drops = limits[allowed_vehicle]['max_drops']
        
        # ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° zone/highway ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à compatibility ‡πÉ‡∏ô merge loop
        _provinces = set(trip_data['_province'].dropna().unique()) if '_province' in trip_data.columns else set()
        _zones     = set(trip_data['_logistics_zone'].dropna().unique()) if '_logistics_zone' in trip_data.columns else set()
        _hws: set  = set()
        if '_zone_highway' in trip_data.columns:
            for _hw in trip_data['_zone_highway'].dropna().unique():
                _hws.update(str(_hw).split('/'))
        # üîí ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° regions ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ (‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ)
        _regions: set = set()
        for _p in _provinces:
            _r = get_region_name(str(_p)) if _p else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
            if _r and _r != '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏':
                _regions.add(_r)
        # fallback: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å _region_name column
        if not _regions and '_region_name' in trip_data.columns:
            for _rn in trip_data['_region_name'].dropna().unique():
                if _rn and _rn != '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏':
                    _regions.add(_rn)
        return {
            'weight': total_w,
            'cube': total_c,
            'codes': codes,
            'drops': len(codes),
            'max_w': max_w,
            'max_c': max_c,
            'max_drops': max_drops,
            'is_punthai': is_punthai,
            'allowed_vehicle': allowed_vehicle,
            'min_priority': min_priority,
            'centroid_lat': trip_data['_lat'].mean(),
            'centroid_lon': trip_data['_lon'].mean(),
            'provinces': _provinces,
            'logistics_zones': _zones,
            'highways': _hws,
            'regions': _regions,
        }
    
    def can_add_branch_to_trip(branch_row, trip_capacity):
        """‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
        branch_code = branch_row['Code']
        branch_w = branch_row['Weight']
        branch_c = branch_row['Cube']
        branch_vehicle = branch_max_vehicle_cache.get(branch_code, '6W')
        branch_priority = vehicle_priority.get(branch_vehicle, 3)
    
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£
        new_w = trip_capacity['weight'] + branch_w
        new_c = trip_capacity['cube'] + branch_c
        new_drops = trip_capacity['drops'] + 1
        
        if new_w > trip_capacity['max_w']:
            return False, "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô"
        if new_c > trip_capacity['max_c']:
            return False, "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÄ‡∏Å‡∏¥‡∏ô"
        if new_drops > trip_capacity['max_drops']:
            return False, "Drop ‡πÄ‡∏Å‡∏¥‡∏ô"
        
        return True, "OK"
    
    def get_nearby_branches(branch_row, all_branches_df, max_dist_km=6.0):
        """‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô (‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô < 6 km)"""
        branch_lat = branch_row['_lat']
        branch_lon = branch_row['_lon']
        branch_subdistrict = branch_row.get('_subdistrict', '')
        branch_code = branch_row['Code']
        
        nearby_codes = []
        
        for _, other_row in all_branches_df.iterrows():
            other_code = other_row['Code']
            if other_code == branch_code:
                continue
            
            # 1. ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
            if other_row.get('_subdistrict', '') == branch_subdistrict and branch_subdistrict:
                nearby_codes.append(other_code)
                continue
            
            # 2. ‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô < 6 km ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
            other_lat = other_row['_lat']
            other_lon = other_row['_lon']
            if other_lat > 0 and other_lon > 0 and branch_lat > 0 and branch_lon > 0:
                dist = haversine_distance(branch_lat, branch_lon, other_lat, other_lon)
                if dist <= max_dist_km:
                    nearby_codes.append(other_code)
        
        return nearby_codes
    
    # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏£‡∏¥‡∏õ‡∏à‡∏≤‡∏Å‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î (1) ‡πÑ‡∏õ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î
    all_trips = sorted(df[df['Trip'] > 0]['Trip'].unique())
    moved_branches = 0
    
    for i, current_trip in enumerate(all_trips[:-1]):  # ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        trip_cap = get_trip_capacity(current_trip)
        if not trip_cap:
            continue
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏´‡∏°
        w_util = trip_cap['weight'] / trip_cap['max_w']
        c_util = trip_cap['cube'] / trip_cap['max_c']
        
        if max(w_util, c_util) >= 0.95:  # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°
            continue
        
        # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ
        for next_trip in all_trips[i+1:]:
            next_trip_data = df[df['Trip'] == next_trip].copy()
            if len(next_trip_data) == 0:
                continue
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô next_trip ‡∏à‡∏≤‡∏Å centroid ‡∏Ç‡∏≠‡∏á current_trip
            next_trip_data['_dist_to_current'] = next_trip_data.apply(
                lambda row: haversine_distance(
                    trip_cap['centroid_lat'], trip_cap['centroid_lon'],
                    row['_lat'], row['_lon']
                ) if row['_lat'] > 0 and row['_lon'] > 0 else 999,
                axis=1
            )
            
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
            next_trip_data = next_trip_data.sort_values('_dist_to_current')
            
            # ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥
            already_moved = set()
            
            # ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
            for _, branch_row in next_trip_data.iterrows():
                branch_code = branch_row['Code']
                
                # ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                if branch_code in already_moved:
                    continue
                
                dist_to_trip = branch_row['_dist_to_current']
                
                # ‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 80 km ‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á
                if dist_to_trip > 80:
                    continue
                
                # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï trip_cap ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                trip_cap = get_trip_capacity(current_trip)
                if not trip_cap:
                    break
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                w_util = trip_cap['weight'] / trip_cap['max_w']
                c_util = trip_cap['cube'] / trip_cap['max_c']
                if max(w_util, c_util) >= 0.95:
                    break  # ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏¢‡∏∏‡∏î
                
                # üö´ Zone + Region compatibility: ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ó‡∏¥‡∏®/highway/‡∏†‡∏≤‡∏Ñ
                _b_prov = branch_row.get('_province', '')
                _b_zone = branch_row.get('_logistics_zone', '')
                _b_hw   = branch_row.get('_zone_highway', '')
                _b_hws  = set(str(_b_hw).split('/')) if _b_hw else set()
                # üîí ‡∏ï‡∏£‡∏ß‡∏à‡∏†‡∏≤‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô ‚Äî ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å province ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                _b_region = get_region_name(str(_b_prov)) if _b_prov else ''
                _trip_regions = trip_cap.get('regions', set())
                _region_ok = (
                    not _b_region or _b_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' or   # candidate ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏Ñ
                    (not _trip_regions and (not _b_region or _b_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')) or  # ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö ‚Üí zone guard
                    (len(_trip_regions) == 1 and _b_region in _trip_regions) or  # ‡∏ó‡∏£‡∏¥‡∏õ‡∏°‡∏µ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
                    (len(_trip_regions) > 1 and _b_region in _trip_regions)   # ‡∏ó‡∏£‡∏¥‡∏õ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äî zone guard ‡∏î‡∏π‡πÅ‡∏•)
                )
                if not _region_ok:
                    safe_print(f"      üö´ merge skip {branch_code} ‡∏†‡∏≤‡∏Ñ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ({_b_region}/{_b_prov} ‚â† {_trip_regions})")
                    continue
                _zone_ok = (
                    _b_prov in trip_cap.get('provinces', set()) or
                    _b_zone in trip_cap.get('logistics_zones', set()) or
                    bool(trip_cap.get('highways', set()) & _b_hws)
                )
                if not _zone_ok:
                    safe_print(f"      üö´ merge skip {branch_code} ({_b_prov}/{_b_zone}) ‚â† trip zone {trip_cap.get('provinces')}")
                    continue

                # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
                can_add, reason = can_add_branch_to_trip(branch_row, trip_cap)
                
                if can_add:
                    # ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    df.loc[df['Code'] == branch_code, 'Trip'] = current_trip
                    already_moved.add(branch_code)
                    moved_branches += 1
                    safe_print(f"   ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢ {branch_code} ‡∏à‡∏≤‡∏Å Trip {next_trip} ‚Üí Trip {current_trip} (‡∏´‡πà‡∏≤‡∏á {dist_to_trip:.1f} km)")
                    
                    # üîó ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡πà‡∏≤‡∏á < 6 km) ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
                    nearby_codes = get_nearby_branches(branch_row, next_trip_data[~next_trip_data['Code'].isin(already_moved)])
                    
                    for nearby_code in nearby_codes:
                        if nearby_code in already_moved:
                            continue
                        
                        # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï trip_cap ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        trip_cap = get_trip_capacity(current_trip)
                        if not trip_cap:
                            break
                        
                        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                        w_util = trip_cap['weight'] / trip_cap['max_w']
                        c_util = trip_cap['cube'] / trip_cap['max_c']
                        if max(w_util, c_util) >= 0.95:
                            break
                        
                        nearby_row = next_trip_data[next_trip_data['Code'] == nearby_code]
                        if len(nearby_row) == 0:
                            continue
                        nearby_row = nearby_row.iloc[0]
                        
                        # zone + region check ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö nearby ‡∏™‡∏≤‡∏Ç‡∏≤‡∏î‡πâ‡∏ß‡∏¢
                        _nb_prov = nearby_row.get('_province', '')
                        _nb_zone = nearby_row.get('_logistics_zone', '')
                        _nb_hw   = nearby_row.get('_zone_highway', '')
                        _nb_hws  = set(str(_nb_hw).split('/')) if _nb_hw else set()
                        # üîí region check ‡∏Å‡πà‡∏≠‡∏ô
                        _nb_region = get_region_name(str(_nb_prov)) if _nb_prov else ''
                        _trip_regions_nb = trip_cap.get('regions', set())
                        _nb_region_ok = (
                            not _nb_region or _nb_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' or   # candidate ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏Ñ
                            (not _trip_regions_nb and (not _nb_region or _nb_region == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')) or  # ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö
                            (len(_trip_regions_nb) == 1 and _nb_region in _trip_regions_nb) or  # ‡∏ó‡∏£‡∏¥‡∏õ‡∏°‡∏µ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                            (len(_trip_regions_nb) > 1 and _nb_region in _trip_regions_nb)  # ‡∏ó‡∏£‡∏¥‡∏õ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ
                        )
                        if not _nb_region_ok:
                            continue
                        _nb_zone_ok = (
                            _nb_prov in trip_cap.get('provinces', set()) or
                            _nb_zone in trip_cap.get('logistics_zones', set()) or
                            bool(trip_cap.get('highways', set()) & _nb_hws)
                        )
                        if not _nb_zone_ok:
                            continue
                        can_add_nearby, _ = can_add_branch_to_trip(nearby_row, trip_cap)
                        if can_add_nearby:
                            df.loc[df['Code'] == nearby_code, 'Trip'] = current_trip
                            already_moved.add(nearby_code)
                            moved_branches += 1
                            safe_print(f"   üîó ‡∏¢‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ {nearby_code} (‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô/‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)")
        
        # ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        trip_cap = get_trip_capacity(current_trip)
        if trip_cap:
            w_util = trip_cap['weight'] / trip_cap['max_w']
            c_util = trip_cap['cube'] / trip_cap['max_c']
            safe_print(f"   üìä Trip {current_trip}: {max(w_util, c_util)*100:.1f}% ({len(trip_cap['codes'])} ‡∏™‡∏≤‡∏Ç‡∏≤)")
    
    if moved_branches > 0:
        safe_print(f"üîÑ ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à: ‡∏¢‡πâ‡∏≤‡∏¢ {moved_branches} ‡∏™‡∏≤‡∏Ç‡∏≤")
        
        # ‡∏•‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
        empty_trips = [t for t in df['Trip'].unique() if t > 0 and len(df[df['Trip'] == t]) == 0]
        
        # Renumber ‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≤‡∏¢
        remaining_trips = sorted(df[df['Trip'] > 0]['Trip'].unique())
        trip_renumber = {old: new for new, old in enumerate(remaining_trips, start=1)}
        df['Trip'] = df['Trip'].map(lambda x: trip_renumber.get(x, x) if x > 0 else x)

    # ==========================================
    # Step 6.7: üîç REGION AUDIT ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏ô‡∏†‡∏≤‡∏Ñ
    # ==========================================
    safe_print("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏ô‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ô trips...")
    _audit_fixed = 0
    _max_trip_now = df[df['Trip'] > 0]['Trip'].max() if len(df[df['Trip'] > 0]) > 0 else 0
    for _aud_trip in sorted(df[df['Trip'] > 0]['Trip'].unique()):
        _aud_data = df[df['Trip'] == _aud_trip]
        _aud_regions = {}
        for _, _aud_row in _aud_data.iterrows():
            _ap = str(_aud_row.get('_province', '') or '')
            _ar = get_region_name(_ap) if _ap else ''
            # fallback: ‡πÉ‡∏ä‡πâ _region_name column ‡∏ñ‡πâ‡∏≤ _province ‡∏ß‡πà‡∏≤‡∏á
            if (not _ar or _ar == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'):
                _ar = str(_aud_row.get('_region_name', '') or '')
            if _ar and _ar != '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏':
                _aud_regions[_ar] = _aud_regions.get(_ar, 0) + 1
        if len(_aud_regions) <= 1:
            continue  # ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏ô‡∏†‡∏≤‡∏Ñ
        # ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏ô‡∏†‡∏≤‡∏Ñ ‚Üí ‡πÅ‡∏¢‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ minority ‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà
        # ‡πÉ‡∏ä‡πâ region ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô dominant (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô sort)
        _dominant = max(_aud_regions, key=lambda k: (_aud_regions[k], ['‡πÄ‡∏´‡∏ô‡∏∑‡∏≠','‡∏≠‡∏µ‡∏™‡∏≤‡∏ô','‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å','‡∏Å‡∏•‡∏≤‡∏á','‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å','‡πÉ‡∏ï‡πâ'].index(k) if k in ['‡πÄ‡∏´‡∏ô‡∏∑‡∏≠','‡∏≠‡∏µ‡∏™‡∏≤‡∏ô','‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å','‡∏Å‡∏•‡∏≤‡∏á','‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å','‡πÉ‡∏ï‡πâ'] else 99))
        _minority_codes = []
        for _, _aud_row in _aud_data.iterrows():
            _ap2 = str(_aud_row.get('_province', '') or '')
            _ar2 = get_region_name(_ap2) if _ap2 else ''
            if (not _ar2 or _ar2 == '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'):
                _ar2 = str(_aud_row.get('_region_name', '') or '')
            if _ar2 and _ar2 != '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' and _ar2 != _dominant:
                _minority_codes.append(_aud_row['Code'])
        if _minority_codes:
            _max_trip_now += 1
            df.loc[df['Code'].isin(_minority_codes), 'Trip'] = _max_trip_now
            safe_print(f"   ‚ö†Ô∏è AUDIT: Trip {_aud_trip} ‡∏õ‡∏ô‡∏†‡∏≤‡∏Ñ {_aud_regions} ‚Üí ‡πÅ‡∏¢‡∏Å {_minority_codes} ‚Üí Trip ‡πÉ‡∏´‡∏°‡πà {_max_trip_now}")
            _audit_fixed += 1
    if _audit_fixed > 0:
        safe_print(f"   üîß AUDIT: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏ô‡∏†‡∏≤‡∏Ñ {_audit_fixed} ‡∏ó‡∏£‡∏¥‡∏õ")
        # Renumber ‡∏´‡∏•‡∏±‡∏á audit
        _aud_remaining = sorted(df[df['Trip'] > 0]['Trip'].unique())
        _aud_remap = {old: new for new, old in enumerate(_aud_remaining, start=1)}
        df['Trip'] = df['Trip'].map(lambda x: _aud_remap.get(x, x) if x > 0 else x)
    else:
        safe_print("   ‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏ô‡∏†‡∏≤‡∏Ñ")

    # ==========================================
    # Step 7: ‡∏™‡∏£‡πâ‡∏≤‡∏á Summary + Central Rule + Punthai Drop Limits
    # ==========================================
    summary_data = []
    
    for trip_num in sorted(df['Trip'].unique()):
        if trip_num == 0:
            continue
        
        trip_data = df[df['Trip'] == trip_num]
        total_w = trip_data['Weight'].sum()
        total_c = trip_data['Cube'].sum()
        trip_codes = trip_data['Code'].unique()
        trip_drops = len(trip_codes)
        
        # ‡∏´‡∏≤‡∏†‡∏≤‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ (‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏Ñ‡πÅ‡∏£‡∏Å)
        trip_region = trip_data['_region_name'].iloc[0] if '_region_name' in trip_data.columns else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
        
        # ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡∏£‡∏ß‡∏° Central Rule)
        max_vehicles = [get_max_vehicle_for_branch(c) for c in trip_codes]
        min_max_size = min(vehicle_priority.get(v, 3) for v in max_vehicles)
        max_allowed_vehicle = {1: '4W', 2: 'JB', 3: '6W'}.get(min_max_size, '6W')
        
        # ‡∏ï‡∏£‡∏ß‡∏à BU ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ
        is_punthai_only_trip = True
        for _, r in trip_data.iterrows():
            bu = str(r.get('BU', '')).upper()
            if bu not in ['211', 'PUNTHAI']:
                is_punthai_only_trip = False
                break
        
        buffer = punthai_buffer if is_punthai_only_trip else maxmart_buffer
        buffer_pct = int(buffer * 100)
        buffer_label = f"üÖøÔ∏è {buffer_pct}%" if is_punthai_only_trip else f"üÖº {buffer_pct}%"
        trip_type = 'punthai' if is_punthai_only_trip else 'maxmart'
        
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏û‡∏≠‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        suggested = max_allowed_vehicle
        source = "üìã ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤" if min_max_size < 3 else "ü§ñ ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"
        
        # ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Minimum Utilization (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
        if suggested in LIMITS:
            limits_to_check = PUNTHAI_LIMITS if is_punthai_only_trip else LIMITS
            max_w = limits_to_check[suggested]['max_w']
            max_c = limits_to_check[suggested]['max_c']
            w_util = (total_w / max_w) * 100
            c_util = (total_c / max_c) * 100
            current_util = max(w_util, c_util)
            
            # ‡∏ñ‡πâ‡∏≤ utilization ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ MIN_VEHICLE_UTILIZATION ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ
            min_util_threshold = MIN_VEHICLE_UTILIZATION * 100
            if current_util < min_util_threshold:
                # üîΩ ‡∏•‡∏≠‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Å‡∏£‡∏î: 6W ‚Üí JB ‚Üí 4W (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÜ)
                if suggested == '6W':
                    # ‡∏•‡∏≠‡∏á JB
                    if 'JB' in max_vehicles:
                        jb_lim = limits_to_check['JB']
                        if total_w <= jb_lim['max_w'] * buffer and total_c <= jb_lim['max_c'] * buffer:
                            suggested = 'JB'
                            source = "üîΩ Downgrade (‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏Ç‡∏≤)"
                        else:
                            # ‡∏•‡∏≠‡∏á 4W
                            if '4W' in max_vehicles:
                                fw_lim = limits_to_check['4W']
                                if total_w <= fw_lim['max_w'] * buffer and total_c <= fw_lim['max_c'] * buffer:
                                    suggested = '4W'
                                    source = "üîΩ Downgrade (‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏Ç‡∏≤)"
                    elif '4W' in max_vehicles:
                        # ‡πÑ‡∏°‡πà‡∏°‡∏µ JB ‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ 4W ‡πÄ‡∏•‡∏¢
                        fw_lim = limits_to_check['4W']
                        if total_w <= fw_lim['max_w'] * buffer and total_c <= fw_lim['max_c'] * buffer:
                            suggested = '4W'
                            source = "üîΩ Downgrade (‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏Ç‡∏≤)"
                elif suggested == 'JB':
                    # ‡∏•‡∏≠‡∏á 4W
                    if '4W' in max_vehicles:
                        fw_lim = limits_to_check['4W']
                        if total_w <= fw_lim['max_w'] * buffer and total_c <= fw_lim['max_c'] * buffer:
                            suggested = '4W'
                            source = "üîΩ Downgrade (‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏Ç‡∏≤)"
                if suggested == '6W' and 'JB' in max_vehicles:
                    jb_w_util = (total_w / limits_to_check['JB']['max_w']) * 100
                    jb_c_util = (total_c / limits_to_check['JB']['max_c']) * 100
                    if max(jb_w_util, jb_c_util) >= min_util_threshold:
                        suggested = 'JB'
                        source += " ‚Üí JB (Optimize)"
                elif suggested == 'JB' and '4W' in max_vehicles:
                    fw_w_util = (total_w / limits_to_check['4W']['max_w']) * 100
                    fw_c_util = (total_c / limits_to_check['4W']['max_c']) * 100
                    if max(fw_w_util, fw_c_util) >= min_util_threshold and trip_drops <= limits_to_check['4W']['max_drops']:
                        suggested = '4W'
                        source += " ‚Üí 4W (Optimize)"
        
        # üîí Punthai Drop Limit Check
        if is_punthai_only_trip:
            punthai_drop_limit = PUNTHAI_LIMITS.get(suggested, {}).get('max_drops', 999)
            if trip_drops > punthai_drop_limit:
                # ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö drops - ‡πÅ‡∏ï‡πà‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤!
                if suggested == '4W' and trip_drops <= PUNTHAI_LIMITS['JB']['max_drops']:
                    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï JB ‡πÑ‡∏´‡∏°
                    if min_max_size >= 2:  # JB ‡∏´‡∏£‡∏∑‡∏≠ 6W
                        suggested = 'JB'
                        source += " ‚Üí JB (Drop Limit)"
                    else:
                        # ‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏Ñ‡πà 4W - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ upgrade ‡πÑ‡∏î‡πâ!
                        source += " ‚ö†Ô∏è Drop ‡πÄ‡∏Å‡∏¥‡∏ô (‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î 4W)"
                elif suggested == 'JB' or trip_drops > PUNTHAI_LIMITS['JB']['max_drops']:
                    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï 6W ‡πÑ‡∏´‡∏°
                    if min_max_size >= 3:  # 6W
                        suggested = '6W'
                        source += " ‚Üí 6W (Drop Limit)"
                    else:
                        # üö´ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô JB - ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ 6W!
                        suggested = max_allowed_vehicle  # ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤ (JB ‡∏´‡∏£‡∏∑‡∏≠ 4W)
                        source += f" ‚ö†Ô∏è Drop ‡πÄ‡∏Å‡∏¥‡∏ô (‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î {max_allowed_vehicle})"
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì utilization - ‡πÉ‡∏ä‡πâ limits ‡∏ï‡∏≤‡∏° BU type
        max_util_threshold = buffer * 100  # 100% ‡∏´‡∏£‡∏∑‡∏≠ 110% ‡∏ï‡∏≤‡∏° BU
        limits_for_util = PUNTHAI_LIMITS if is_punthai_only_trip else LIMITS
        if suggested in limits_for_util:
            w_util = (total_w / limits_for_util[suggested]['max_w']) * 100
            c_util = (total_c / limits_for_util[suggested]['max_c']) * 100
            max_util = max(w_util, c_util)
            
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô threshold ‡∏ï‡∏≤‡∏° BU ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ñ
            if max_util > max_util_threshold:
                # üö´ ‡∏´‡πâ‡∏≤‡∏° upgrade ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤!
                if suggested == '4W' and min_max_size >= 2:
                    jb_util = max((total_w / limits_for_util['JB']['max_w']), (total_c / limits_for_util['JB']['max_c'])) * 100
                    if jb_util <= max_util_threshold:
                        suggested = 'JB'
                        source += " ‚Üí JB"
                        w_util = (total_w / limits_for_util['JB']['max_w']) * 100
                        c_util = (total_c / limits_for_util['JB']['max_c']) * 100
                    elif min_max_size >= 3:  # ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï 6W
                        suggested = '6W'
                        source += " ‚Üí 6W"
                        w_util = (total_w / limits_for_util['6W']['max_w']) * 100
                        c_util = (total_c / limits_for_util['6W']['max_c']) * 100
                    else:
                        # üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ upgrade ‡πÑ‡∏î‡πâ (‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î JB) ‚Üí ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ JB (‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô buffer)
                        suggested = 'JB'
                        source += " ‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î"
                        w_util = (total_w / limits_for_util['JB']['max_w']) * 100
                        c_util = (total_c / limits_for_util['JB']['max_c']) * 100
                elif suggested == 'JB' and min_max_size >= 3:  # ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï 6W
                    suggested = '6W'
                    source += " ‚Üí 6W"
                    w_util = (total_w / limits_for_util['6W']['max_w']) * 100
                    c_util = (total_c / limits_for_util['6W']['max_c']) * 100
                elif suggested == 'JB' and min_max_size < 3:
                    # üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ upgrade ‡πÄ‡∏õ‡πá‡∏ô 6W ‡πÑ‡∏î‡πâ (‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î JB)
                    source += " ‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î"
                elif suggested == '4W' and min_max_size < 2:
                    # üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ upgrade ‡πÑ‡∏î‡πâ (‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î 4W)
                    source += " ‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î"
        else:
            w_util = c_util = 0
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° - ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å DataFrame ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        total_distance = 0
        branch_coords = []
        for code in trip_codes:
            # ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å df (‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå _lat, _lon)
            branch_data = df[df['Code'] == code]
            if not branch_data.empty:
                lat = branch_data.iloc[0].get('_lat', 0)
                lon = branch_data.iloc[0].get('_lon', 0)
                if lat > 0 and lon > 0:
                    branch_coords.append((lat, lon))
        
        if branch_coords:
            # DC ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å
            total_distance += haversine_distance(DC_WANG_NOI_LAT, DC_WANG_NOI_LON, branch_coords[0][0], branch_coords[0][1])
            # ‡∏™‡∏≤‡∏Ç‡∏≤ ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤
            for i in range(len(branch_coords) - 1):
                total_distance += haversine_distance(branch_coords[i][0], branch_coords[i][1], branch_coords[i+1][0], branch_coords[i+1][1])
            # ‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‚Üí DC
            total_distance += haversine_distance(branch_coords[-1][0], branch_coords[-1][1], DC_WANG_NOI_LAT, DC_WANG_NOI_LON)
        
        summary_data.append({
            'Trip': trip_num,
            'Branches': len(trip_codes),
            'Weight': total_w,
            'Cube': total_c,
            'Truck': f"{suggested} {source}",
            'BU_Type': trip_type,
            'Buffer': buffer_label,
            'Weight_Use%': w_util,
            'Cube_Use%': c_util,
            'Total_Distance': round(total_distance, 1)
        })
    
    # ==========================================
    # üö® Step 7.5: ‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô buffer ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏ñ‡∏ú‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Strict Enforcement)
    # ==========================================
    safe_print("\nüìã Step 7.5: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô Buffer + ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ...")
    overflow_branches = []
    
    for i, trip_summary in enumerate(summary_data):
        trip_num = trip_summary['Trip']
        buffer_pct = float(trip_summary['Buffer'].replace('üÖøÔ∏è ', '').replace('üÖº ', '').replace('%', ''))
        
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏¥‡∏õ
        trip_data = df[df['Trip'] == trip_num].copy()
        if trip_data.empty:
            continue
            
        trip_codes = trip_data['Code'].tolist()
        
        # üöó ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
        max_vehicles = [get_max_vehicle_for_branch(c) for c in trip_codes]
        vehicle_priority_map = {'4W': 1, 'JB': 2, '6W': 3}
        min_max_size = min(vehicle_priority_map.get(v, 3) for v in max_vehicles)
        correct_vehicle = {1: '4W', 2: 'JB', 3: '6W'}.get(min_max_size, '6W')
        
        # ‡∏î‡∏∂‡∏á limits ‡∏ï‡∏≤‡∏° BU ‡πÅ‡∏•‡∏∞‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        bu_type = trip_summary['BU_Type']
        is_punthai = (bu_type == 'punthai')
        buffer = punthai_buffer if is_punthai else maxmart_buffer
        limits = PUNTHAI_LIMITS if is_punthai else LIMITS
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì utilization ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        total_w = trip_data['Weight'].sum()
        total_c = trip_data['Cube'].sum()
        max_w = limits[correct_vehicle]['max_w'] * buffer
        max_c = limits[correct_vehicle]['max_c'] * buffer
        max_drops = limits[correct_vehicle]['max_drops']
        
        w_util = (total_w / limits[correct_vehicle]['max_w']) * 100
        c_util = (total_c / limits[correct_vehicle]['max_c']) * 100
        max_util = max(w_util, c_util)
        
        # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï summary ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        truck_source = "üìã ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤" if min_max_size < 3 else "ü§ñ ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"
        summary_data[i]['Truck'] = f"{correct_vehicle} {truck_source}"
        summary_data[i]['Weight_Use%'] = w_util
        summary_data[i]['Cube_Use%'] = c_util
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô buffer ‡∏´‡∏£‡∏∑‡∏≠ drops ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        is_over_buffer = total_w > max_w or total_c > max_c
        is_over_drops = len(trip_codes) > max_drops
        
        if is_over_buffer or is_over_drops:
            reason = "‡πÄ‡∏Å‡∏¥‡∏ô buffer" if is_over_buffer else f"‡πÄ‡∏Å‡∏¥‡∏ô drops ({len(trip_codes)}>{max_drops})"
            safe_print(f"   ‚ö†Ô∏è Trip {trip_num} {reason}: {max_util:.1f}% (‡∏£‡∏ñ {correct_vehicle})")
            
            # üö® ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 1 ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏ô buffer ‚Üí ‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏õ overflow ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            if len(trip_data) <= 1:
                code = trip_data.iloc[0]['Code'] if len(trip_data) == 1 else None
                if code:
                    df.loc[df['Code'] == code, 'Trip'] = 0
                    overflow_branches.append(code)
                    safe_print(f"      üî™ ‡∏ï‡∏±‡∏î {code} ‡∏≠‡∏≠‡∏Å (1 ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏ô buffer ‚Üí overflow)")
                    # ‡∏•‡∏ö summary ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ
                    summary_data[i]['Branches'] = 0
                    summary_data[i]['Weight'] = 0
                    summary_data[i]['Cube'] = 0
                    summary_data[i]['Weight_Use%'] = 0
                    summary_data[i]['Cube_Use%'] = 0
                continue
            
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô (‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏Å‡∏•‡∏≠‡∏≠‡∏Å)
            trip_data = trip_data.sort_values('_distance_from_dc', ascending=False)
            
            # ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤ (correct_vehicle ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
            truck_str = correct_vehicle
            
            if truck_str not in limits:
                continue
            
            max_w = limits[truck_str]['max_w'] * buffer
            max_c = limits[truck_str]['max_c'] * buffer
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            current_w = trip_data['Weight'].sum()
            current_c = trip_data['Cube'].sum()
            current_drops = len(trip_data)
            
            # ‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô (weight, cube, ‡πÅ‡∏•‡∏∞ drops)
            codes_to_remove = []
            for _, row in trip_data.iterrows():
                # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á buffer ‡πÅ‡∏•‡∏∞ drops
                if current_w <= max_w and current_c <= max_c and current_drops <= max_drops:
                    break  # ‡∏û‡∏≠‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß
                
                code = row['Code']
                codes_to_remove.append(code)
                current_w -= row['Weight']
                current_c -= row['Cube']
                current_drops -= 1
                overflow_branches.append(code)
                safe_print(f"      üî™ ‡∏ï‡∏±‡∏î {code} ‡∏≠‡∏≠‡∏Å (‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î {row['_distance_from_dc']:.1f} km)")
            
            # ‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏¥‡∏õ (Trip = 0)
            for code in codes_to_remove:
                df.loc[df['Code'] == code, 'Trip'] = 0
            
            # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï summary
            if codes_to_remove:
                new_trip_data = df[df['Trip'] == trip_num]
                new_w = new_trip_data['Weight'].sum()
                new_c = new_trip_data['Cube'].sum()
                new_w_util = (new_w / (limits[truck_str]['max_w'])) * 100
                new_c_util = (new_c / (limits[truck_str]['max_c'])) * 100
                
                summary_data[i]['Branches'] = len(new_trip_data)
                summary_data[i]['Weight'] = new_w
                summary_data[i]['Cube'] = new_c
                summary_data[i]['Weight_Use%'] = new_w_util
                summary_data[i]['Cube_Use%'] = new_c_util
    
    # ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö overflow branches
    if overflow_branches:
        safe_print(f"\n   üì¶ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î: {len(overflow_branches)} ‡∏™‡∏≤‡∏Ç‡∏≤ ‚Üí ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà...")
        max_trip = df['Trip'].max()
        
        # üéØ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ JB/4W ‡πÑ‡∏õ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö 6W
        overflow_by_max_vehicle = {}
        for code in overflow_branches:
            max_veh = get_max_vehicle_for_branch(code)
            if max_veh not in overflow_by_max_vehicle:
                overflow_by_max_vehicle[max_veh] = []
            overflow_by_max_vehicle[max_veh].append(code)
        
        # ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î + ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏° buffer
        for max_veh in ['4W', 'JB', '6W']:
            if max_veh not in overflow_by_max_vehicle:
                continue
            
            codes_for_veh = overflow_by_max_vehicle[max_veh]
            if not codes_for_veh:
                continue
            
            # üéØ ‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ overflow ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡∏≤‡∏° buffer limit
            remaining_codes = list(codes_for_veh)
            
            while remaining_codes:
                new_trip = max_trip + 1
                max_trip = new_trip
                
                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì limits - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ BU ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô!
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Punthai ‡∏•‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                first_code = remaining_codes[0]
                first_row = df[df['Code'] == first_code]
                first_bu = str(first_row['BU'].values[0] if len(first_row) > 0 else '').upper()
                is_punthai_overflow = first_bu in ['211', 'PUNTHAI']
                
                overflow_buffer = punthai_buffer if is_punthai_overflow else maxmart_buffer
                overflow_limits = PUNTHAI_LIMITS if is_punthai_overflow else LIMITS
                max_w = overflow_limits[max_veh]['max_w'] * overflow_buffer
                max_c = overflow_limits[max_veh]['max_c'] * overflow_buffer
                max_drops = overflow_limits[max_veh]['max_drops']
                
                # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏ï‡πá‡∏° buffer
                trip_codes = []
                trip_weight = 0
                trip_cube = 0
                
                for code in list(remaining_codes):
                    code_row = df[df['Code'] == code]
                    if code_row.empty:
                        remaining_codes.remove(code)
                        continue
                    
                    code_w = code_row.iloc[0]['Weight']
                    code_c = code_row.iloc[0]['Cube']
                    
                    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    if (trip_weight + code_w <= max_w and 
                        trip_cube + code_c <= max_c and 
                        len(trip_codes) < max_drops):
                        trip_codes.append(code)
                        trip_weight += code_w
                        trip_cube += code_c
                        remaining_codes.remove(code)
                    elif len(trip_codes) == 0:
                        # ‡∏ñ‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô buffer ‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏î‡∏µ
                        trip_codes.append(code)
                        trip_weight += code_w
                        trip_cube += code_c
                        remaining_codes.remove(code)
                        break
                    else:
                        # ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ
                        break
                
                # Assign trip
                for code in trip_codes:
                    df.loc[df['Code'] == code, 'Trip'] = new_trip
                
                # ‡πÄ‡∏û‡∏¥‡πà‡∏° summary
                if trip_codes:
                    is_overflow_punthai = all(
                        str(df[df['Code'] == c]['BU'].values[0] if len(df[df['Code'] == c]) > 0 else '').upper() in ['211', 'PUNTHAI'] 
                        for c in trip_codes
                    )
                    overflow_limits_final = PUNTHAI_LIMITS if is_overflow_punthai else LIMITS
                    overflow_buffer_final = punthai_buffer if is_overflow_punthai else maxmart_buffer
                    buffer_label = f"üÖøÔ∏è {int(overflow_buffer_final*100)}%" if is_overflow_punthai else f"üÖº {int(overflow_buffer_final*100)}%"
                    
                    summary_data.append({
                        'Trip': new_trip,
                        'Branches': len(trip_codes),
                        'Weight': trip_weight,
                        'Cube': trip_cube,
                        'Truck': f'{max_veh} üî™ ‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å',
                        'BU_Type': 'punthai' if is_overflow_punthai else 'mixed',
                        'Buffer': buffer_label,
                        'Weight_Use%': (trip_weight / overflow_limits_final[max_veh]['max_w']) * 100,
                        'Cube_Use%': (trip_cube / overflow_limits_final[max_veh]['max_c']) * 100,
                        'Total_Distance': 0
                    })
                    safe_print(f"   ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Trip {new_trip} ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ {max_veh} ({len(trip_codes)} ‡∏™‡∏≤‡∏Ç‡∏≤, {trip_weight:.0f}kg)")
    
    summary_df = pd.DataFrame(summary_data)
    
    # ==========================================
    # Step 8: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°
    # ==========================================
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏ñ
    trip_truck_map = {}
    for _, row in summary_df.iterrows():
        trip_truck_map[row['Trip']] = row['Truck']
    df['Truck'] = df['Trip'].map(trip_truck_map)
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Region
    df['Region'] = df['_region_name']
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Province/District/Subdistrict (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
    if 'Province' not in df.columns:
        df['Province'] = df['_province']
    if 'District' not in df.columns:
        df['District'] = df['_district']
    if 'Subdistrict' not in df.columns:
        df['Subdistrict'] = df['_subdistrict']
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å DC
    df['Distance_from_DC'] = df['_distance_from_dc'].round(1)
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå MaxVehicle constraint
    df['MaxVehicle'] = df['_max_vehicle']
    
    # üö® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏ñ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    def check_vehicle_compliance(row):
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
        if row['Trip'] == 0:
            return '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î'
        
        max_allowed = row['_max_vehicle']
        truck_assigned = str(row.get('Truck', '')).split()[0] if pd.notna(row.get('Truck')) else ''
        
        # ‡πÅ‡∏õ‡∏•‡∏á JB ‡πÄ‡∏õ‡πá‡∏ô 4WJ ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        if truck_assigned == '4WJ':
            truck_assigned = 'JB'
        
        # Vehicle hierarchy: 4W < JB < 6W
        vehicle_rank = {'4W': 1, 'JB': 2, '6W': 3}
        
        if max_allowed not in vehicle_rank or truck_assigned not in vehicle_rank:
            return '‚úÖ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
        if vehicle_rank[truck_assigned] <= vehicle_rank[max_allowed]:
            return '‚úÖ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'
        else:
            return f'‚ùå ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î (Max: {max_allowed}, ‡πÉ‡∏ä‡πâ: {truck_assigned})'
    
    df['VehicleCheck'] = df.apply(check_vehicle_compliance, axis=1)
    
    # ==========================================
    # üö® Step 8.5: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ (Enforce Vehicle Constraints)
    # ==========================================
    safe_print("\nüìã Step 8.5: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ...")
    vehicle_violations = df[df['VehicleCheck'].str.contains('‚ùå', na=False)]
    
    if len(vehicle_violations) > 0:
        safe_print(f"   ‚ö†Ô∏è ‡∏û‡∏ö {len(vehicle_violations)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î")
        
        # ‡πÅ‡∏¢‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà
        for _, viol_row in vehicle_violations.iterrows():
            viol_code = viol_row['Code']
            viol_trip = viol_row['Trip']
            max_allowed = viol_row['_max_vehicle']
            
            # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤
            same_trip = df[df['Trip'] == viol_trip]
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
            vehicle_rank = {'4W': 1, 'JB': 2, '6W': 3}
            max_allowed_rank = vehicle_rank.get(max_allowed, 3)
            
            # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏Ñ‡∏¥‡∏ß‡∏°‡∏≤‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ max vehicle ‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤)
            other_branches = same_trip[same_trip['Code'] != viol_code]
            
            if len(other_branches) > 0:
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                other_max_vehicles = other_branches['_max_vehicle'].apply(lambda x: vehicle_rank.get(x, 3))
                min_other_rank = other_max_vehicles.min()
                
                if min_other_rank > max_allowed_rank:
                    # ‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤ ‚Üí ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å
                    df.loc[df['Code'] == viol_code, 'Trip'] = 0  # ‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏à‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
                    safe_print(f"      üîÑ ‡∏¢‡πâ‡∏≤‡∏¢ {viol_code} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Trip {viol_trip} (Max: {max_allowed})")
    
    # ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
    unassigned_violations = df[df['Trip'] == 0]
    if len(unassigned_violations) > 0:
        safe_print(f"   üì¶ ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {len(unassigned_violations)} ‡∏™‡∏≤‡∏Ç‡∏≤...")
        max_trip = df[df['Trip'] > 0]['Trip'].max() if len(df[df['Trip'] > 0]) > 0 else 0
        
        # ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° max_vehicle
        for max_veh in ['4W', 'JB', '6W']:
            veh_branches = unassigned_violations[unassigned_violations['_max_vehicle'] == max_veh]
            if len(veh_branches) == 0:
                continue
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ max_vehicle ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            new_trip = max_trip + 1
            
            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Punthai ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            is_punthai = False
            if 'BU' in veh_branches.columns and len(veh_branches) > 0:
                bu_val = str(veh_branches['BU'].iloc[0]).upper()
                is_punthai = bu_val in ['211', 'PUNTHAI']
            limits = PUNTHAI_LIMITS if is_punthai else LIMITS
            
            current_w = 0
            current_c = 0
            current_drops = 0
            max_w = limits[max_veh]['max_w']
            max_c = limits[max_veh]['max_c']
            max_d = limits[max_veh]['max_drops']
            
            for _, br in veh_branches.iterrows():
                br_w = br['Weight']
                br_c = br['Cube']
                
                if current_w + br_w > max_w or current_c + br_c > max_c or current_drops >= max_d:
                    # ‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà
                    new_trip += 1
                    current_w = 0
                    current_c = 0
                    current_drops = 0
                
                df.loc[df['Code'] == br['Code'], 'Trip'] = new_trip
                current_w += br_w
                current_c += br_c
                current_drops += 1
            
            max_trip = new_trip
            safe_print(f"      ‚úÖ ‡∏à‡∏±‡∏î {len(veh_branches)} ‡∏™‡∏≤‡∏Ç‡∏≤ {max_veh} ‡πÄ‡∏™‡∏£‡πá‡∏à")
        
        # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï Truck ‡πÅ‡∏•‡∏∞ VehicleCheck ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
        for trip_num in df[df['Trip'] > 0]['Trip'].unique():
            trip_codes = df[df['Trip'] == trip_num]['Code'].tolist()
            max_vehicles = [get_max_vehicle_for_branch(c) for c in trip_codes]
            vehicle_priority = {'4W': 1, 'JB': 2, '6W': 3}
            min_rank = min(vehicle_priority.get(v, 3) for v in max_vehicles)
            suggested = {1: '4W', 2: 'JB', 3: '6W'}.get(min_rank, '6W')
            df.loc[df['Trip'] == trip_num, 'Truck'] = f"{suggested} üìã ‡∏à‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà"
        
        df['VehicleCheck'] = df.apply(check_vehicle_compliance, axis=1)
    
    # ==========================================
    # Step 9: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
    # ==========================================
    safe_print("\nüìã Step 9: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á...")
    
    # ‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞ dominant province/region ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ
    trip_max_distances = {}
    trip_sort9_keys = {}
    for trip_num in df[df['Trip'] > 0]['Trip'].unique():
        trip_data = df[df['Trip'] == trip_num]
        max_dist = trip_data['_distance_from_dc'].max() if '_distance_from_dc' in trip_data.columns else 0
        trip_max_distances[trip_num] = max_dist if pd.notna(max_dist) else 0
        # dominant province (most frequent in trip)
        _prov_col9 = '_province' if '_province' in trip_data.columns else ('Province' if 'Province' in trip_data.columns else None)
        _dom_prov9 = ''
        _rorder9 = 99
        if _prov_col9:
            _vc9 = trip_data[_prov_col9].value_counts()
            if len(_vc9):
                _dom_prov9 = _vc9.index[0]
                _rorder9 = REGION_ORDER.get(get_region_name(str(_dom_prov9)), 99)
        _dist_col9 = '_district' if '_district' in trip_data.columns else ('District' if 'District' in trip_data.columns else None)
        _dom_dist9 = ''
        if _dist_col9:
            _vcd9 = trip_data[_dist_col9].value_counts()
            if len(_vcd9):
                _dom_dist9 = _vcd9.index[0]
        trip_sort9_keys[trip_num] = (_rorder9, _dom_prov9, _dom_dist9, -(trip_max_distances[trip_num]))
    
    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏≤‡∏° ‡∏†‡∏≤‡∏Ñ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡πÑ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô)
    sorted_trips = sorted(trip_max_distances.keys(), key=lambda x: trip_sort9_keys.get(x, (99, '‡πø', '‡πø', 0)))
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping ‡πÉ‡∏´‡∏°‡πà
    trip_renumber = {old_trip: new_trip for new_trip, old_trip in enumerate(sorted_trips, 1)}
    df['Trip'] = df['Trip'].map(lambda x: trip_renumber.get(x, 0) if x > 0 else 0)
    
    # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï summary_df ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á renumber (‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö df)
    summary_data_new = []
    for trip_num in sorted(df[df['Trip'] > 0]['Trip'].unique()):
        trip_data = df[df['Trip'] == trip_num]
        total_w = trip_data['Weight'].sum()
        total_c = trip_data['Cube'].sum()
        trip_codes_list = trip_data['Code'].tolist()
        max_dist = trip_data['_distance_from_dc'].max() if '_distance_from_dc' in trip_data.columns else 0
        
        # ‡∏´‡∏≤‡∏£‡∏ñ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Truck ‡πÉ‡∏ô df
        truck = trip_data['Truck'].iloc[0] if 'Truck' in trip_data.columns and len(trip_data) > 0 else '6W'
        truck_str = str(truck).split()[0] if pd.notna(truck) else '6W'
        
        # ‡∏´‡∏≤ BU type
        is_punthai = all(str(r.get('BU', '')).upper() in ['211', 'PUNTHAI'] for _, r in trip_data.iterrows())
        limits = PUNTHAI_LIMITS if is_punthai else LIMITS
        
        max_w = limits.get(truck_str, limits['6W'])['max_w']
        max_c = limits.get(truck_str, limits['6W'])['max_c']
        
        summary_data_new.append({
            'Trip': trip_num,
            'Branches': len(trip_codes_list),
            'Weight': total_w,
            'Cube': total_c,
            'Truck': truck,
            'BU_Type': 'punthai' if is_punthai else 'maxmart',
            'Buffer': f"üÖøÔ∏è {int(punthai_buffer*100)}%" if is_punthai else f"üÖº {int(maxmart_buffer*100)}%",
            'Weight_Use%': (total_w / max_w) * 100,
            'Cube_Use%': (total_c / max_c) * 100,
            'Total_Distance': max_dist if pd.notna(max_dist) else 0
        })
    
    summary_df = pd.DataFrame(summary_data_new)
    summary_df = summary_df.sort_values('Trip').reset_index(drop=True)
    
    safe_print(f"   ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà: {len(sorted_trips)} ‡∏ó‡∏£‡∏¥‡∏õ (Trip 1 = ‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î {trip_max_distances[sorted_trips[0]]:.0f} km)")
    
    df = df.sort_values(['Trip', '_distance_from_dc'], ascending=[True, False]).reset_index(drop=True)
    
    # ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÄ‡∏Å‡πá‡∏ö _province, _district, _subdistrict, _max_vehicle, _lat, _lon, _distance_from_dc ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)
    cols_to_drop = ['_region_code', '_region_name', '_prov_code', '_dist_code', '_subdist_code', '_route', '_group_key', '_region_order', '_prov_max_dist', '_dist_max_dist', '_region_allowed_vehicles', '_vehicle_priority']
    df = df.drop(columns=[c for c in cols_to_drop if c in df.columns], errors='ignore')
    
    return df, summary_df
def main():
    st.set_page_config(
        page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß",
        page_icon="üöö",
        layout="wide",
        initial_sidebar_state="collapsed"
    )
    
    # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ã‡∏ô‡∏ã‡πâ‡∏≥ - ‡πÉ‡∏ä‡πâ session state
    if 'zones_loaded' not in st.session_state:
        st.session_state.zones_loaded = False
    if 'cache_stats_shown' not in st.session_state:
        st.session_state.cache_stats_shown = False
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ cache (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    if USE_CACHE and not st.session_state.cache_stats_shown:
        st.session_state.cache_stats_shown = True
        if len(DISTANCE_CACHE) > 0 or len(ROUTE_CACHE_DATA) > 0:
            st.success(f"‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡∏ä: {len(DISTANCE_CACHE)} ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á, {len(ROUTE_CACHE_DATA)} ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á")
    
    # üîÑ Auto-refresh (Optional - ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)
    # ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö refresh cache ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ local dev)
    if AUTOREFRESH_AVAILABLE:
        try:
            now = datetime.now()
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (00:00:00)
            midnight = datetime.combine(now.date(), datetime_time(0, 0, 0))
            
            # ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô ‡πÄ‡∏≠‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            if now < midnight:
                next_midnight = midnight
            else:
                next_midnight = midnight + timedelta(days=1)
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            seconds_until_midnight = int((next_midnight - now).total_seconds())
            
            # Refresh ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ autorefresh)
            if seconds_until_midnight > 0:
                # ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (‡∏´‡∏•‡∏±‡∏á 23:55)
                if seconds_until_midnight <= 300:  # 5 minutes
                    st.info(f"üîÑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ Refresh ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô {seconds_until_midnight // 60} ‡∏ô‡∏≤‡∏ó‡∏µ")
                    st_autorefresh(interval=seconds_until_midnight * 1000, key="midnight_refresh")
                else:
                    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                    st_autorefresh(interval=3600000, limit=24, key="hourly_check")
        except Exception as e:
            # ‡∏ñ‡πâ‡∏≤ autorefresh ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‚Üí ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error (‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            pass
    
    # Header
    st.title("üöö ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß - Route Optimizer")
    
    # üìä Status Bar - ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
    status_cols = st.columns([3, 1])
    with status_cols[0]:
        if SHEETS_AVAILABLE:
            st.success("üìä **Google Sheets:** ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à | Auto-sync ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ")
        else:
            st.warning("üìä **Data Source:** branch_data.json (local cache)")
    with status_cols[1]:
        st.metric("üìç Master Data", f"{len(MASTER_DATA):,} ‡∏™‡∏≤‡∏Ç‡∏≤")
    
    st.markdown("---")
    
    # ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
    model_data = load_model()
    
    if not model_data:
        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
        st.info("üí° ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: `python test_model.py`")
        st.stop()
    
    # ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    st.markdown("### üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå")
    uploaded_file = st.file_uploader(
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)", 
        type=['xlsx'],
        help="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"
    )
    
    if uploaded_file:
        # ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô session_state ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô export
        uploaded_file_content = uploaded_file.read()
        st.session_state['original_file_content'] = uploaded_file_content
        
        with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."):
            df = load_excel(uploaded_file_content)
            df = process_dataframe(df)
            
            if df is not None and 'Code' in df.columns:
                total_rows = len(df)
                unique_codes = df['Code'].nunique()
                duplicate_count = total_rows - unique_codes
                
                st.success(f"‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: **{total_rows:,}** ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
                
                # ‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ duplicate
                if duplicate_count > 0:
                    st.warning(f"‚ö†Ô∏è ‡∏û‡∏ö **{duplicate_count}** ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥ (Code ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô) - ‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")
                    with st.expander("üîç ‡∏î‡∏π Code ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥"):
                        dup_codes = df[df.duplicated(subset=['Code'], keep=False)].groupby('Code').size().reset_index(name='‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡πâ‡∏≥')
                        st.dataframe(dup_codes[dup_codes['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡πâ‡∏≥'] > 1], width="stretch")
                    
                    # ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î duplicate codes
                    agg_cols = {'Weight': 'sum', 'Cube': 'sum'}
                    # ‡πÄ‡∏Å‡πá‡∏ö column ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏ß‡πâ (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏Å)
                    for col in df.columns:
                        if col not in ['Code', 'Weight', 'Cube']:
                            agg_cols[col] = 'first'
                    df = df.groupby('Code', as_index=False).agg(agg_cols)
                    st.info(f"üìä ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ã‡πâ‡∏≥: **{len(df):,}** ‡∏™‡∏≤‡∏Ç‡∏≤")
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                col1, col2, col3, col4 = st.columns(4)
                with col1:
                    st.metric("üìç ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤", f"{len(df):,}")
                with col2:
                    st.metric("‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°", f"{df['Weight'].sum():,.0f} kg")
                with col3:
                    st.metric("üì¶ ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°", f"{df['Cube'].sum():.1f} m¬≥")
                with col4:
                    provinces = df['Province'].nunique() if 'Province' in df.columns else 0
                    st.metric("üó∫Ô∏è ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", f"{provinces}")
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                with st.expander("üîç ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á"):
                    st.dataframe(df.head(10), width="stretch")
                
                # ==========================================
                # ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Master (vectorized - ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ iterrows)
                # ==========================================
                if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
                    _m = MASTER_DATA[['Plan Code', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '‡∏ï‡∏≥‡∏ö‡∏•']].copy()
                    _m['_code'] = _m['Plan Code'].astype(str).str.strip().str.upper()
                    # ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ column ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á collision ‡∏Å‡∏±‡∏ö column ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô df
                    _m = _m.rename(columns={'‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î': '_m_prov', '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠': '_m_dist', '‡∏ï‡∏≥‡∏ö‡∏•': '_m_subdist'})
                    df['_code'] = df['Code'].astype(str).str.strip().str.upper()
                    df = df.merge(_m[['_code', '_m_prov', '_m_dist', '_m_subdist']].drop_duplicates('_code'),
                                  on='_code', how='left')
                    
                    # ‡πÄ‡∏ï‡∏¥‡∏° Province ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
                    need_prov = df['Province'].isna() | (df['Province'] == '') | (df['Province'] == 'UNKNOWN') if 'Province' in df.columns else pd.Series([True]*len(df))
                    filled_count = int(need_prov.sum())
                    if 'Province' not in df.columns:
                        df['Province'] = df['_m_prov']
                    else:
                        df.loc[need_prov, 'Province'] = df.loc[need_prov, '_m_prov']
                    
                    # ‡πÄ‡∏ï‡∏¥‡∏° District/Subdistrict ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
                    for col_upload, col_master in [('District', '_m_dist'), ('Subdistrict', '_m_subdist')]:
                        if col_upload not in df.columns:
                            df[col_upload] = df[col_master].fillna('')
                        else:
                            need = df[col_upload].isna() | (df[col_upload] == '')
                            df.loc[need, col_upload] = df.loc[need, col_master]
                    
                    df = df.drop(columns=['_code', '_m_prov', '_m_dist', '_m_subdist'], errors='ignore')
                    
                    if filled_count > 0:
                        st.info(f"üìç ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Master ‡πÅ‡∏•‡πâ‡∏ß {filled_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
                
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
                if 'Province' in df.columns:
                    missing_df = df[(df['Province'].isna()) | (df['Province'] == '') | (df['Province'] == 'UNKNOWN')]
                    if len(missing_df) > 0:
                        st.warning(f"‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏°‡∏µ {len(missing_df)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô Master")
                        with st.expander("üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
                            _show_cols = [c for c in ['Code', 'Name', 'Province', 'District'] if c in missing_df.columns]
                            st.dataframe(missing_df[_show_cols].reset_index(drop=True), hide_index=True)
                
                st.markdown("---")
                
                # ‡πÅ‡∏ó‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å
                tab1, tab2 = st.tabs([
                    "üì¶ ‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß (‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)", 
                    "üó∫Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ"
                ])
                    
                # ==========================================
                # ‡πÅ‡∏ó‡πá‡∏ö 1: ‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß (‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)
                # ==========================================
                with tab1:
                    # ‡πÄ‡∏û‡∏¥‡πà‡∏° Region ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                    if 'Region' not in df.columns and 'Province' in df.columns:
                        df['Region'] = df['Province'].apply(get_region_name)
                    
                    # ==========================================
                    # ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    # ==========================================
                    st.markdown("#### ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ")
                    
                    # ‡∏Å‡∏£‡∏≠‡∏Å Buffer ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                    col_buf1, col_buf2 = st.columns(2)
                    
                    with col_buf1:
                        punthai_buffer = st.number_input(
                            "üÖøÔ∏è Punthai Buffer %",
                            min_value=80,
                            max_value=120,
                            value=100,
                            step=5
                        )
                    
                    with col_buf2:
                        maxmart_buffer = st.number_input(
                            "üÖº Maxmart/‡∏ú‡∏™‡∏° Buffer %",
                            min_value=80,
                            max_value=150,
                            value=110,
                            step=5
                        )
                    
                    # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô buffer value
                    punthai_buffer_value = punthai_buffer / 100.0
                    maxmart_buffer_value = maxmart_buffer / 100.0
                    
                    st.markdown("---")
                    st.markdown("### üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ñ‡∏à‡∏≤‡∏Å Master Data")
                    
                    # ‡∏ö‡∏∂‡∏á‡πÅ‡∏Ñ‡∏ä: vehicle_restrictions (‡πÄ‡∏£‡πá‡∏ß - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ iterrows)
                    vehicle_restrictions = {code: get_max_vehicle_for_branch(code) for code in df['Code']}
                    unmatched_codes = []
                    
                    if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
                        master_codes_set = set(MASTER_DATA['Plan Code'].str.strip().str.upper())
                        for code in df['Code']:
                            code_clean = str(code).strip().upper()
                            if code_clean not in master_codes_set:
                                found = any(code_clean in mc or mc in code_clean for mc in master_codes_set)
                                if not found:
                                    unmatched_codes.append(code_clean)
                    
                    restriction_counts = pd.Series(vehicle_restrictions).value_counts()
                    total_branches = len(df)
                    col1, col2, col3, col4 = st.columns(4)
                    with col1:
                        st.metric("üìç ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", f"{total_branches}")
                    with col2:
                        four_w_count = restriction_counts.get('4W', 0)
                        st.metric("üöó ‡∏à‡∏≥‡∏Å‡∏±‡∏î 4W", f"{four_w_count}", 
                                 delta=f"{(four_w_count/total_branches*100):.1f}%" if total_branches > 0 else "0%")
                    with col3:
                        jb_count = restriction_counts.get('JB', 0)
                        st.metric("üöö ‡∏à‡∏≥‡∏Å‡∏±‡∏î JB", f"{jb_count}",
                                 delta=f"{(jb_count/total_branches*100):.1f}%" if total_branches > 0 else "0%")
                    with col4:
                        six_w_count = restriction_counts.get('6W', 0)
                        st.metric("üöõ ‡πÉ‡∏ä‡πâ 6W ‡πÑ‡∏î‡πâ", f"{six_w_count}",
                                 delta=f"{(six_w_count/total_branches*100):.1f}%" if total_branches > 0 else "0%")
                    
                    # ‚ö†Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô Master Data
                    if unmatched_codes:
                        st.warning(f"‚ö†Ô∏è ‡∏°‡∏µ {len(unmatched_codes)} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô Master Data (‡πÉ‡∏ä‡πâ 6W ‡πÄ‡∏õ‡πá‡∏ô default)")
                        with st.expander(f"üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö ({len(unmatched_codes)} ‡∏™‡∏≤‡∏Ç‡∏≤)"):
                            # ‡πÅ‡∏™‡∏î‡∏á 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å
                            sample_codes = unmatched_codes[:20]
                            unmatched_df = df[df['Code'].isin(sample_codes)][['Code', 'Name']].copy()
                            unmatched_df.columns = ['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÑ‡∏ü‡∏•‡πå Upload)', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤']
                            st.dataframe(unmatched_df, width="stretch")
                            
                            if len(unmatched_codes) > 20:
                                st.caption(f"... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å {len(unmatched_codes) - 20} ‡∏™‡∏≤‡∏Ç‡∏≤")
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
                    if four_w_count > 0 or jb_count > 0:
                        with st.expander(f"üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î ({four_w_count + jb_count} ‡∏™‡∏≤‡∏Ç‡∏≤)"):
                            restricted_branches = df[df['Code'].isin([k for k, v in vehicle_restrictions.items() if v in ['4W', 'JB']])].copy()
                            restricted_branches['MaxVehicle'] = restricted_branches['Code'].map(vehicle_restrictions)
                            display_restricted = restricted_branches[['Code', 'Name', 'MaxVehicle']].copy()
                            display_restricted.columns = ['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏£‡∏ñ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î']
                            st.dataframe(display_restricted.sort_values('‡∏£‡∏ñ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î'), width="stretch", height=300)
                    
                    st.markdown("---")
                    
                    # ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ
                    if st.button("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", type="primary", width="stretch"):
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á status container ‡πÅ‡∏ö‡∏ö popup
                        with st.status("üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...", expanded=True) as status:
                            # Progress bar
                            progress_bar = st.progress(0)
                            status_text = st.empty()
                            
                            status_text.write("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
                            progress_bar.progress(10)
                            
                            # ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•/Route (‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô predict_trips)
                            df_to_process = df.copy()
                            
                            progress_bar.progress(20)
                            
                            import time as time_module
                            start_time = time_module.time()
                            
                            # ‡∏™‡πà‡∏á buffer ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° BU
                            result_df, summary = predict_trips(
                                df_to_process, 
                                model_data, 
                                punthai_buffer=punthai_buffer_value,
                                maxmart_buffer=maxmart_buffer_value
                            )
                            
                            elapsed_time = time_module.time() - start_time
                            progress_bar.progress(90)
                            
                            # üíæ ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô session_state ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô export
                            st.session_state['trip_result'] = result_df
                            st.session_state['trip_summary'] = summary
                            st.session_state['trip_buffers'] = {
                                'punthai': punthai_buffer_value,
                                'maxmart': maxmart_buffer_value
                            }
                            st.session_state['_trip_result_fresh'] = True  # ‡πÅ‡∏™‡∏î‡∏á balloons ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                            st.session_state['_trip_elapsed'] = elapsed_time  # ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ
                            
                            progress_bar.progress(100)
                            status_text.write(f"‚úÖ ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ {elapsed_time:.1f} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")
                            status.update(label=f"‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! ({elapsed_time:.1f}s)", state="complete", expanded=False)
                    
                    # üìä ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô session_state
                    if 'trip_result' in st.session_state and 'trip_summary' in st.session_state:
                        result_df = st.session_state['trip_result']
                        summary = st.session_state['trip_summary']
                        
                        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ (Trip = 0)
                        unassigned_count = len(result_df[result_df['Trip'] == 0])
                        if unassigned_count > 0:
                            st.warning(f"‚ö†Ô∏è ‡∏°‡∏µ {unassigned_count} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ (Trip = 0)")
                        
                        # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                        assigned_df = result_df[result_df['Trip'] > 0].copy()
                        
                        # ‡πÅ‡∏™‡∏î‡∏á balloons ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏∏‡∏Å rerender)
                        if st.session_state.get('_trip_result_fresh', False):
                            st.balloons()
                            st.session_state['_trip_result_fresh'] = False
                        st.success(f"‚úÖ **‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!** ‡∏£‡∏ß‡∏° **{len(summary)}** ‡∏ó‡∏£‡∏¥‡∏õ ({len(assigned_df)} ‡∏™‡∏≤‡∏Ç‡∏≤)")
                        
                        st.markdown("---")
                        
                        # ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
                        st.markdown("### üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ")
                        
                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric("üöö ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ", len(summary))
                        with col2:
                            st.metric("üìç ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤", len(assigned_df))
                        with col3:
                            avg_branches = len(assigned_df) / max(1, assigned_df['Trip'].nunique())
                            st.metric("üìä ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ó‡∏£‡∏¥‡∏õ", f"{avg_branches:.1f}")
                        with col4:
                            avg_util = summary['Cube_Use%'].mean() if len(summary) > 0 else 0
                            st.metric("üìà ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", f"{avg_util:.0f}%")
                        
                        # ‚è±Ô∏è ‡πÅ‡∏™‡∏î‡∏á timing dashboard
                        _trip_elapsed = st.session_state.get('_trip_elapsed', 0)
                        _map_elapsed  = st.session_state.get('_imap_build_time', None)
                        if _trip_elapsed or _map_elapsed is not None:
                            with st.expander("‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•", expanded=False):
                                _tc1, _tc2, _tc3 = st.columns(3)
                                if _trip_elapsed:
                                    _tc1.metric("üîÑ ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ", f"{_trip_elapsed:.1f}s")
                                if _map_elapsed is not None:
                                    _tc2.metric("üó∫Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", f"{_map_elapsed:.1f}s")
                                _tc3.metric("üíæ cache", f"{len(st.session_state.get('_imap_key',''))*0:.0f}+{len(summary)} trips")

                        st.markdown("### üöõ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ")
                        
                        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ summary ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        format_dict = {}
                        gradient_cols = []
                        
                        if 'Weight' in summary.columns:
                            format_dict['Weight'] = '{:.2f}'
                        if 'Cube' in summary.columns:
                            format_dict['Cube'] = '{:.2f}'
                        if 'Weight_Use%' in summary.columns:
                            format_dict['Weight_Use%'] = '{:.1f}%'
                            gradient_cols.append('Weight_Use%')
                        if 'Cube_Use%' in summary.columns:
                            format_dict['Cube_Use%'] = '{:.1f}%'
                            gradient_cols.append('Cube_Use%')
                        if 'Total_Distance' in summary.columns:
                            format_dict['Total_Distance'] = '{:.1f} km'
                        
                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á styled dataframe
                        if format_dict:
                            styled_df = summary.style.format(format_dict)
                            if gradient_cols:
                                styled_df = styled_df.background_gradient(
                                    subset=gradient_cols,
                                    cmap='RdYlGn',
                                    vmin=0,
                                    vmax=100
                                )
                            st.dataframe(styled_df, width="stretch", height=400)
                        else:
                            st.dataframe(summary, width="stretch", height=400)

                        with st.expander("üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)"):
                            # ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                            display_cols = ['Trip', 'Code', 'Name']
                            if 'Province' in result_df.columns:
                                display_cols.append('Province')
                            if 'Region' in result_df.columns:
                                display_cols.append('Region')
                            display_cols.extend(['Max_Distance_in_Trip', 'Weight', 'Cube', 'Truck', 'VehicleCheck'])
                            
                            # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
                            display_cols = [col for col in display_cols if col in result_df.columns]
                            display_df = result_df[display_cols].copy()
                            
                            # ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
                            col_names = {'Trip': '‡∏ó‡∏£‡∏¥‡∏õ', 'Code': '‡∏£‡∏´‡∏±‡∏™', 'Name': '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤', 'Province': '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', 
                                       'Region': '‡∏†‡∏≤‡∏Ñ', 'Max_Distance_in_Trip': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á Max(km)', 
                                       'Weight': '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å(kg)', 'Cube': '‡∏Ñ‡∏¥‡∏ß(m¬≥)', 'Truck': '‡∏£‡∏ñ', 'VehicleCheck': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏ñ'}
                            display_df.columns = [col_names.get(c, c) for c in display_cols]
                            
                            # ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
                            st.dataframe(
                                display_df.style.format({
                                    '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á Max(km)': '{:.1f}',
                                    '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å(kg)': '{:.2f}',
                                    '‡∏Ñ‡∏¥‡∏ß(m¬≥)': '{:.2f}'
                                }),
                                width="stretch", 
                                height=400
                            )
                        
                        # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô - ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á ‚ö†Ô∏è ‡πÅ‡∏•‡∏∞ ‚ùå
                        warning_branches = result_df[result_df['VehicleCheck'].str.contains('‚ö†Ô∏è|‚ùå', na=False, regex=True)]
                        if len(warning_branches) > 0:
                            # ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                            error_count = len(result_df[result_df['VehicleCheck'].str.contains('‚ùå', na=False)])
                            warning_count = len(result_df[result_df['VehicleCheck'].str.contains('‚ö†Ô∏è', na=False)])
                            
                            with st.expander(f"üö® ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ({len(warning_branches)} ‡∏™‡∏≤‡∏Ç‡∏≤: ‚ùå {error_count} ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î, ‚ö†Ô∏è {warning_count} ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)", expanded=(error_count > 0)):
                                if error_count > 0:
                                    st.error(f"‚ùå ‡∏°‡∏µ {error_count} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å Master Data!")
                                if warning_count > 0:
                                    st.warning(f"‚ö†Ô∏è ‡∏°‡∏µ {warning_count} ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ")
                                
                                display_cols_warn = ['Trip', 'Code', 'Name', 'MaxVehicle', 'Truck', 'VehicleCheck']
                                display_warn_df = warning_branches[display_cols_warn].copy()
                                display_warn_df.columns = ['‡∏ó‡∏£‡∏¥‡∏õ', '‡∏£‡∏´‡∏±‡∏™', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏£‡∏ñ Max', '‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']
                                st.dataframe(display_warn_df, width="stretch")
                        
                        # ‚îÄ‚îÄ üì• Excel build (cached) ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà rebuild ‡∏ñ‡πâ‡∏≤ result ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚îÄ‚îÄ
                        import hashlib as _hl_xl
                        _xl_sig = f"v6|{len(result_df)}|{int(result_df['Trip'].max())}|{sorted(result_df['Trip'].unique().tolist())}"
                        _xl_key = _hl_xl.md5(_xl_sig.encode()).hexdigest()[:12]

                        if st.session_state.get('_excel_key') != _xl_key:
                            with st.spinner("üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel..."):
                                import xlsxwriter as _xlw

                                # ‚îÄ‚îÄ 1. location_map ‚Üí vectorized dict map ‚îÄ‚îÄ
                                _loc_sp = {}; _loc_sd = {}; _loc_sv = {}; _loc_rt = {}
                                if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
                                    _lm_cols = [c for c in ['Plan Code','‡∏ï‡∏≥‡∏ö‡∏•','‡∏≠‡∏≥‡πÄ‡∏†‡∏≠','‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î','Reference'] if c in MASTER_DATA.columns]
                                    _lm = MASTER_DATA[_lm_cols].copy()
                                    _lm['_k'] = _lm['Plan Code'].astype(str).str.strip().str.upper()
                                    for _r in _lm.to_dict('records'):
                                        _k = _r['_k']
                                        if _k:
                                            _loc_sp[_k] = str(_r.get('‡∏ï‡∏≥‡∏ö‡∏•', '') or '')
                                            _loc_sd[_k] = str(_r.get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '') or '')
                                            _loc_sv[_k] = str(_r.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '') or '')
                                            _loc_rt[_k] = str(_r.get('Reference', '') or '')

                                # ‚îÄ‚îÄ 2. Pre-join ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö vectorized ‚îÄ‚îÄ
                                _rd = result_df[result_df['Trip'] != 0].copy()
                                _rd['_key_u'] = _rd['Code'].astype(str).str.strip().str.upper()
                                _rd['_sp'] = _rd['_key_u'].map(_loc_sp).fillna('')
                                _rd['_sd'] = _rd['_key_u'].map(_loc_sd).fillna('')
                                _rd['_sv'] = _rd['_key_u'].map(_loc_sv).fillna('')
                                _rd['_rt'] = _rd['_key_u'].map(_loc_rt).fillna('')

                                # fallback ‚Üí ‡πÉ‡∏ä‡πâ planning columns ‡∏ñ‡πâ‡∏≤ MASTER_DATA ‡∏ß‡πà‡∏≤‡∏á
                                _prov_col  = '_province'    if '_province'    in _rd.columns else ('Province'    if 'Province'    in _rd.columns else None)
                                _dist_col2 = '_district'    if '_district'    in _rd.columns else ('District'    if 'District'    in _rd.columns else None)
                                _subd_col2 = '_subdistrict' if '_subdistrict' in _rd.columns else ('Subdistrict' if 'Subdistrict' in _rd.columns else None)
                                _empty = ''
                                _rd['_sv_eff'] = _rd['_sv'].where(_rd['_sv'].str.strip() != '', _rd[_prov_col]  if _prov_col  else _empty)
                                _rd['_sd_eff'] = _rd['_sd'].where(_rd['_sd'].str.strip() != '', _rd[_dist_col2] if _dist_col2 else _empty)
                                _rd['_sp_eff'] = _rd['_sp'].where(_rd['_sp'].str.strip() != '', _rd[_subd_col2] if _subd_col2 else _empty)

                                # ‚îÄ‚îÄ 3. pre-build province‚Üírorder dict ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚îÄ‚îÄ
                                _prov_rorder: dict = {}
                                for _p in _rd['_sv_eff'].unique():
                                    _prov_rorder[_p] = REGION_ORDER.get(get_region_name(str(_p)), 99)
                                _rd['_rorder'] = _rd['_sv_eff'].map(_prov_rorder).fillna(99).astype(int)

                                # ‚îÄ‚îÄ 4. distance from result_df directly (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á MASTER_DATA loop) ‚îÄ‚îÄ
                                _dist_src_col = '_distance_from_dc' if '_distance_from_dc' in _rd.columns else None

                                # ‚îÄ‚îÄ 5. sort keys ‚îÄ‚îÄ
                                trip_no_map = {}
                                vehicle_counts = {'4W': 0, '4WJ': 0, '6W': 0}
                                trip_sort_keys = {}
                                for _tnum, _tg in _rd.groupby('Trip', sort=False):
                                    if _tnum == 0: continue
                                    _rorder = int(_tg['_rorder'].mode().iloc[0]) if len(_tg) else 99
                                    if _dist_src_col:
                                        _pmx = float(_tg[_dist_src_col].max() or 0)
                                    else:
                                        _pmx = 0.0
                                    _pvc = _tg['_sv_eff'].value_counts()
                                    _dvc = _tg['_sd_eff'].value_counts()
                                    trip_sort_keys[_tnum] = (
                                        _rorder,
                                        _pvc.index[0] if len(_pvc) else '',
                                        _dvc.index[0] if len(_dvc) else '',
                                        -_pmx
                                    )

                                sorted_trips = sorted(
                                    [t for t in result_df['Trip'].unique() if t != 0],
                                    key=lambda t: trip_sort_keys.get(t, (99, '‡πø', '‡πø', 0))
                                )

                                for _tnum in sorted_trips:
                                    _ts = summary[summary['Trip'] == _tnum]
                                    if len(_ts) > 0:
                                        _vi = _ts.iloc[0]['Truck']
                                        _vt = _vi.split()[0] if _vi else '6W'
                                        if _vt == 'JB': _vt = '4WJ'
                                        vehicle_counts[_vt] = vehicle_counts.get(_vt, 0) + 1
                                        trip_no_map[_tnum] = f"{_vt}{vehicle_counts[_vt]:03d}"

                                # ‚îÄ‚îÄ 6. sort rows ‚îÄ‚îÄ
                                _trip_order_map = {t: i for i, t in enumerate(sorted_trips)}
                                _rd['_trip_order'] = _rd['Trip'].map(_trip_order_map)
                                _rd = _rd.sort_values(['_trip_order', '_sv_eff', '_sd_eff', '_sp_eff', 'Code'])

                                # ‚îÄ‚îÄ 7. pre-group rows ‚îÄ‚îÄ
                                _trip_rows: dict = {}
                                for _rec in _rd.to_dict('records'):
                                    _trip_rows.setdefault(int(_rec['Trip']), []).append(_rec)

                                # ‚îÄ‚îÄ 8. failed_trips ‚îÄ‚îÄ
                                failed_trips = set()
                                for _t in sorted_trips:
                                    _rows_t = _trip_rows.get(_t, [])
                                    if not _rows_t: continue
                                    _is_pt = all(str(_r.get('BU', '')).upper() in ('211', 'PUNTHAI') for _r in _rows_t)
                                    _tno = trip_no_map.get(_t, '6W001')
                                    _vt2 = 'JB' if _tno.startswith('4WJ') else ('4W' if _tno.startswith('4W') else '6W')
                                    _lim = (PUNTHAI_LIMITS if _is_pt else LIMITS).get(_vt2, LIMITS['6W'])
                                    _tw  = sum(float(_r.get('Weight', 0) or 0) for _r in _rows_t)
                                    _tc  = sum(float(_r.get('Cube',   0) or 0) for _r in _rows_t)
                                    if (_tw / _lim['max_w'] * 100) < 90 and (_tc / _lim['max_c'] * 100) < 90:
                                        failed_trips.add(_t)

                                # ‚îÄ‚îÄ 9. xlsxwriter write ‚îÄ‚îÄ
                                _output = io.BytesIO()
                                try:
                                    _wb_xl = _xlw.Workbook(_output, {'in_memory': True, 'constant_memory': True})
                                    _ws_xl = _wb_xl.add_worksheet('2.Punthai')

                                    _hdr_fmt = _wb_xl.add_format({'bold':True,'border':1,'bg_color':'#D9D9D9','align':'center'})
                                    _yfmt    = _wb_xl.add_format({'bg_color':'#FFE699','border':1})
                                    _wfmt    = _wb_xl.add_format({'bg_color':'#FFFFFF','border':1})
                                    _yfmt_r  = _wb_xl.add_format({'bg_color':'#FFE699','border':1,'font_color':'#FF0000','bold':True})
                                    _wfmt_r  = _wb_xl.add_format({'bg_color':'#FFFFFF','border':1,'font_color':'#FF0000','bold':True})
                                    _ynfmt   = _wb_xl.add_format({'bg_color':'#FFE699','border':1,'num_format':'#,##0.00'})
                                    _wnfmt   = _wb_xl.add_format({'bg_color':'#FFFFFF','border':1,'num_format':'#,##0.00'})
                                    _ynfmt_r = _wb_xl.add_format({'bg_color':'#FFE699','border':1,'num_format':'#,##0.00','font_color':'#FF0000','bold':True})
                                    _wnfmt_r = _wb_xl.add_format({'bg_color':'#FFFFFF','border':1,'num_format':'#,##0.00','font_color':'#FF0000','bold':True})

                                    _hdrs = ['Sep.','BU','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤','‡∏£‡∏´‡∏±‡∏™ WMS','‡∏™‡∏≤‡∏Ç‡∏≤','‡∏ï‡∏≥‡∏ö‡∏•','‡∏≠‡∏≥‡πÄ‡∏†‡∏≠','‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î','Route',
                                             'Total Cube','Total Wgt','Original QTY','Trip','Trip no']
                                    _ws_xl.write_row(0, 0, _hdrs, _hdr_fmt)
                                    _ws_xl.set_row(0, 18)
                                    for _ci_w, _cw in enumerate([6,6,12,12,30,14,14,16,12,11,11,12,6,10]):
                                        _ws_xl.set_column(_ci_w, _ci_w, _cw)

                                    use_yellow = True
                                    _row_xl = 1
                                    sep_num = 1

                                    for _tnum in sorted_trips:
                                        _rows = _trip_rows.get(_tnum, [])
                                        _tno  = trip_no_map.get(_tnum, '')
                                        _is_f = _tnum in failed_trips
                                        _tf = (_yfmt_r if _is_f else _yfmt) if use_yellow else (_wfmt_r if _is_f else _wfmt)
                                        _nf = (_ynfmt_r if _is_f else _ynfmt) if use_yellow else (_wnfmt_r if _is_f else _wnfmt)
                                        use_yellow = not use_yellow
                                        _tnum_int = int(_tnum)
                                        _tno_str  = str(_tno)
                                        for _rec in _rows:
                                            _bc = str(_rec.get('Code', ''))
                                            _ws_xl.write_row(_row_xl, 0, [
                                                sep_num,
                                                _rec.get('BU', 211),
                                                _bc, _bc,
                                                str(_rec.get('Name', '')),
                                                str(_rec.get('_sp_eff', '') or _rec.get('_sp', '')),
                                                str(_rec.get('_sd_eff', '') or _rec.get('_sd', '')),
                                                str(_rec.get('_sv_eff', '') or _rec.get('_sv', '')),
                                                str(_rec.get('_rt', '')),
                                            ], _tf)
                                            _ws_xl.write(_row_xl,  9, round(float(_rec.get('Cube',        0) or 0), 2), _nf)
                                            _ws_xl.write(_row_xl, 10, round(float(_rec.get('Weight',      0) or 0), 2), _nf)
                                            _ws_xl.write(_row_xl, 11, int(  float(_rec.get('OriginalQty', 0) or 0)), _tf)
                                            _ws_xl.write(_row_xl, 12, _tnum_int, _tf)
                                            _ws_xl.write(_row_xl, 13, _tno_str,  _tf)
                                            _row_xl += 1
                                            sep_num  += 1

                                    _wb_xl.close()
                                    _output.seek(0)

                                except Exception as _xe:
                                    st.warning(f"‚ö†Ô∏è xlsxwriter error: {_xe} ‚Äî fallback to basic")
                                    _output = io.BytesIO()
                                    with pd.ExcelWriter(_output, engine='xlsxwriter') as _writer:
                                        _exp = _rd.drop(columns=[c for c in ['_key_u','_sp','_sd','_sv','_rt','_trip_order','_sp_eff','_sd_eff','_sv_eff','_rorder'] if c in _rd.columns], errors='ignore').copy()
                                        _exp['Trip_No'] = _exp['Trip'].map(lambda x: trip_no_map.get(x, ''))
                                        _exp.to_excel(_writer, sheet_name='‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏£‡∏¥‡∏õ', index=False)
                                        summary.to_excel(_writer, sheet_name='‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ', index=False)

                                st.session_state['_excel_bytes']  = _output.getvalue()
                                st.session_state['_excel_key']    = _xl_key
                                st.session_state['_trip_no_map']  = trip_no_map

                        # trip_no_map ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                        trip_no_map = st.session_state.get('_trip_no_map', {})

                        st.download_button(
                            label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Excel)",
                            data=st.session_state.get('_excel_bytes', b''),
                            file_name=f"‡∏ú‡∏•‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏¥‡∏õ_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                            type="primary",
                            width="stretch"
                        )
                        
                        st.markdown("---")
                        
                        # üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (Interactive - Leaflet.js)
                        with st.expander("üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (Interactive)", expanded=True):
                            try:
                                from trip_map_interactive import build_interactive_map_html as _build_imap
                                import streamlit.components.v1 as _cmp2
                                import hashlib as _hl

                                _imap_sig = f"v8|{len(assigned_df)}|{int(assigned_df['Trip'].max())}|{sorted(assigned_df['Trip'].unique().tolist())}"
                                _imap_key = _hl.md5(_imap_sig.encode()).hexdigest()[:12]

                                if st.session_state.get('_imap_key') != _imap_key:
                                    with st.spinner("üó∫Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà..."):
                                        _t_map = time_module.time()
                                        st.session_state['_imap_html'] = _build_imap(
                                            result_df=assigned_df,
                                            summary_df=summary,
                                            limits=LIMITS,
                                            punthai_limits=PUNTHAI_LIMITS,
                                            trip_no_map=trip_no_map,
                                            dc_lat=14.1459, dc_lon=100.6873,
                                        )
                                        st.session_state['_imap_key'] = _imap_key
                                        st.session_state['_imap_build_time'] = time_module.time() - _t_map

                                _cmp2.html(st.session_state['_imap_html'], height=780, scrolling=False)
                            except Exception as _e:
                                import traceback as _tb
                                st.error(f"‚ùå Interactive map error: {_e}")
                                st.code(_tb.format_exc(), language='text')
                                st.info(f"üìã assigned_df columns: {list(assigned_df.columns)}\n\nrows: {len(assigned_df)}, trips: {sorted(assigned_df['Trip'].unique().tolist())}")
                            else:
                                _FOLIUM_FALLBACK_ = False

                        # ‚îÄ‚îÄ FOLIUM FALLBACK (‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ interactive map error) ‚îÄ‚îÄ
                        if 'FOLIUM_AVAILABLE' in dir() and FOLIUM_AVAILABLE and locals().get('_FOLIUM_FALLBACK_', False):
                            with st.expander("üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ (Fallback)", expanded=True):
                                # ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                                col_filter1, col_filter2, col_filter3 = st.columns([1, 1, 1])
                                
                                with col_filter1:
                                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏¥‡∏õ - ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ
                                    trip_distances = {}
                                    for t in assigned_df['Trip'].unique():
                                        if t > 0 and '_distance_from_dc' in assigned_df.columns:
                                            max_dist = assigned_df[assigned_df['Trip'] == t]['_distance_from_dc'].max()
                                            trip_distances[t] = max_dist if pd.notna(max_dist) else 0
                                    sorted_trips = sorted(trip_distances.keys(), key=lambda x: trip_distances.get(x, 0), reverse=True)
                                    trip_options = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'] + [f"Trip {t} ({trip_distances.get(t, 0):.0f}km)" for t in sorted_trips]
                                    selected_trip = st.selectbox("üöö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏£‡∏¥‡∏õ (‡πÑ‡∏Å‡∏•‚Üí‡πÉ‡∏Å‡∏•‡πâ)", trip_options, key="map_trip_filter")
                                
                                with col_filter2:
                                    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ
                                    truck_types = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î']
                                    if 'Truck' in assigned_df.columns:
                                        unique_trucks = assigned_df['Truck'].dropna().unique()
                                        truck_types.extend(sorted(set([t.split()[0] for t in unique_trucks if t])))
                                    selected_truck = st.selectbox("üöõ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ", truck_types, key="map_truck_filter")
                                
                                with col_filter3:
                                    # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                                    show_route = st.checkbox("üõ£Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á", value=True, key="map_show_route")
                                
                                # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                map_df = assigned_df.copy()
                                if selected_trip != '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î':
                                    trip_num = int(selected_trip.split()[1])
                                    map_df = map_df[map_df['Trip'] == trip_num]
                                if selected_truck != '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î':
                                    map_df = map_df[map_df['Truck'].str.startswith(selected_truck, na=False)]
                                
                                if len(map_df) == 0:
                                    st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å")
                                else:
                                    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î
                                    if '_lat' in map_df.columns and '_lon' in map_df.columns:
                                        valid_coords = map_df[(map_df['_lat'] > 0) & (map_df['_lon'] > 0)]
                                        
                                        if len(valid_coords) == 0:
                                            st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà")
                                        else:
                                            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° progress
                                            # Map cache - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà cached ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                                            map_cache_key = f'map|{selected_trip}|{selected_truck}|{show_route}|{len(valid_coords)}'
                                            _map_is_cached = (st.session_state.get('_map_cache_key') == map_cache_key and '_map_html' in st.session_state)
                                            if not _map_is_cached:
                                                with st.spinner("üó∫Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà..."):
                                                    # DC Wang Noi coordinates
                                                    DC_LAT, DC_LON = 14.1459, 100.6873
                                                
                                                    # ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
                                                    center_lat = valid_coords['_lat'].mean()
                                                    center_lon = valid_coords['_lon'].mean()
                                                
                                                    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                                                    m = folium.Map(
                                                        location=[center_lat, center_lon],
                                                        zoom_start=8,
                                                        tiles='OpenStreetMap',
                                                        prefer_canvas=True  # ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
                                                    )
                                                
                                                    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Fullscreen
                                                    plugins.Fullscreen(
                                                        position='topleft',
                                                        title='‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠',
                                                        title_cancel='‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠',
                                                        force_separate_button=True
                                                    ).add_to(m)
                                                
                                                    # ‡πÄ‡∏û‡∏¥‡πà‡∏° DC Marker
                                                    folium.Marker(
                                                        location=[DC_LAT, DC_LON],
                                                        popup="<b>üè≠ DC Wang Noi</b>",
                                                        tooltip="DC Wang Noi",
                                                        icon=folium.Icon(color='black', icon='home', prefix='fa')
                                                    ).add_to(m)
                                                
                                                    # ‡∏™‡∏µ palette ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ - 50 ‡∏™‡∏µ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
                                                    colors = [
                                                        '#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00',  # 1-5
                                                        '#a65628', '#f781bf', '#1b9e77', '#d95f02', '#7570b3',  # 6-10
                                                        '#e7298a', '#66a61e', '#e6ab02', '#a6761d', '#666666',  # 11-15
                                                        '#1f78b4', '#33a02c', '#fb9a99', '#fdbf6f', '#cab2d6',  # 16-20
                                                        '#b15928', '#8dd3c7', '#ffffb3', '#bebada', '#fb8072',  # 21-25
                                                        '#80b1d3', '#fdb462', '#b3de69', '#fccde5', '#d9d9d9',  # 26-30
                                                        '#bc80bd', '#ccebc5', '#ffed6f', '#e31a1c', '#1b7837',  # 31-35
                                                        '#762a83', '#e66101', '#5e3c99', '#d53e4f', '#3288bd',  # 36-40
                                                        '#f46d43', '#fdae61', '#fee08b', '#66c2a5', '#3d9970',  # 41-45
                                                        '#001f3f', '#39cccc', '#85144b', '#ff4136', '#2ecc40'   # 46-50
                                                    ]
                                                
                                                    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç (Trip 1, 2, 3...) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ renumber ‡πÅ‡∏•‡πâ‡∏ß
                                                    trip_max_dist = {}
                                                    for trip_id in valid_coords['Trip'].unique():
                                                        if '_distance_from_dc' in valid_coords.columns:
                                                            max_d = valid_coords[valid_coords['Trip'] == trip_id]['_distance_from_dc'].max()
                                                            trip_max_dist[trip_id] = max_d if pd.notna(max_d) else 0
                                                        else:
                                                            trip_max_dist[trip_id] = 0
                                                    sorted_trip_ids = sorted(trip_max_dist.keys(), key=lambda x: trip_max_dist[x], reverse=True)
                                                
                                                    # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏ö‡∏ö Nearest Neighbor (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î)
                                                    def optimize_branch_order(trip_df, dc_lat, dc_lon):
                                                        """‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô: DC ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î ‚Üí nearest ‚Üí nearest ‚Üí ... ‚Üí DC"""
                                                        if len(trip_df) <= 1:
                                                            return trip_df
                                                    
                                                        df = trip_df.copy()
                                                        # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î
                                                        ordered = []
                                                        remaining = df.to_dict('records')
                                                    
                                                        # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                                                        farthest_idx = max(range(len(remaining)), key=lambda i: remaining[i]['_distance_from_dc'])
                                                        current = remaining.pop(farthest_idx)
                                                        ordered.append(current)
                                                    
                                                        # Nearest neighbor: ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                                                        while remaining:
                                                            current_lat, current_lon = current['_lat'], current['_lon']
                                                            nearest_idx = 0
                                                            nearest_dist = float('inf')
                                                        
                                                            for i, branch in enumerate(remaining):
                                                                # ‡πÉ‡∏ä‡πâ cache distance
                                                                dist_key = f"{current_lat:.4f},{current_lon:.4f}_{branch['_lat']:.4f},{branch['_lon']:.4f}"
                                                                dist_key_rev = f"{branch['_lat']:.4f},{branch['_lon']:.4f}_{current_lat:.4f},{current_lon:.4f}"
                                                            
                                                                if dist_key in DISTANCE_CACHE:
                                                                    dist = DISTANCE_CACHE[dist_key]
                                                                elif dist_key_rev in DISTANCE_CACHE:
                                                                    dist = DISTANCE_CACHE[dist_key_rev]
                                                                else:
                                                                    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì haversine
                                                                    dlat = radians(branch['_lat'] - current_lat)
                                                                    dlon = radians(branch['_lon'] - current_lon)
                                                                    a = sin(dlat/2)**2 + cos(radians(current_lat)) * cos(radians(branch['_lat'])) * sin(dlon/2)**2
                                                                    c = 2 * atan2(sqrt(a), sqrt(1-a))
                                                                    dist = 6371 * c
                                                            
                                                                if dist < nearest_dist:
                                                                    nearest_dist = dist
                                                                    nearest_idx = i
                                                        
                                                            current = remaining.pop(nearest_idx)
                                                            ordered.append(current)
                                                    
                                                        return pd.DataFrame(ordered)
                                                
                                                    # ‡∏™‡∏£‡πâ‡∏≤‡∏á Feature Groups ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Layer Control
                                                    trip_groups = {}
                                                
                                                    # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ
                                                    for idx, trip_id in enumerate(sorted_trip_ids):
                                                        trip_data = valid_coords[valid_coords['Trip'] == trip_id].copy()
                                                        # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏ö‡∏ö Nearest Neighbor (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î)
                                                        trip_data = optimize_branch_order(trip_data, DC_LAT, DC_LON)
                                                    
                                                        trip_color = colors[idx % len(colors)]
                                                        max_dist = trip_max_dist.get(trip_id, 0)
                                                    
                                                        # ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏à‡∏≤‡∏Å summary
                                                        truck_info = summary[summary['Trip'] == trip_id]['Truck'].iloc[0] if trip_id in summary['Trip'].values else 'N/A'
                                                    
                                                        # ‡∏™‡∏£‡πâ‡∏≤‡∏á Feature Group ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ
                                                        fg = folium.FeatureGroup(name=f"Trip {trip_id} ({max_dist:.0f}km) - {truck_info}")
                                                        trip_groups[trip_id] = fg
                                                    
                                                        # ‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏Ç‡∏≤
                                                        points = []
                                                        point_names = []
                                                        point_distances = []
                                                    
                                                        for _, row in trip_data.iterrows():
                                                            if row['_lat'] > 0 and row['_lon'] > 0:
                                                                points.append([row['_lat'], row['_lon']])
                                                                point_names.append(f"{row.get('Name', row.get('Code', 'Unknown'))}")
                                                                point_distances.append(row.get('_distance_from_dc', 0))
                                                    
                                                        if len(points) == 0:
                                                            continue
                                                    
                                                        # üõ£Ô∏è ‡∏î‡∏∂‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å OSRM (DC ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤1 ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤2 ‚Üí ... ‚Üí DC)
                                                        waypoints = [[DC_LAT, DC_LON]] + points + [[DC_LAT, DC_LON]]
                                                    
                                                        # ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á - ‡πÉ‡∏ä‡πâ cache
                                                        cache_key = f"route_{trip_id}_{len(points)}"
                                                        if 'route_cache' not in st.session_state:
                                                            st.session_state['route_cache'] = {}
                                                    
                                                        if cache_key in st.session_state['route_cache']:
                                                            real_route_coords, total_trip_distance = st.session_state['route_cache'][cache_key]
                                                        else:
                                                            real_route_coords, total_trip_distance = get_multi_point_route_osrm(waypoints)
                                                            st.session_state['route_cache'][cache_key] = (real_route_coords, total_trip_distance)
                                                    
                                                        # ‡∏ñ‡πâ‡∏≤ OSRM ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‚Üí ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å DISTANCE_CACHE ‡πÅ‡∏ó‡∏ô
                                                        if total_trip_distance == 0:
                                                            for i in range(len(waypoints) - 1):
                                                                lat1, lon1 = waypoints[i]
                                                                lat2, lon2 = waypoints[i + 1]
                                                                seg_dist = haversine_distance(lat1, lon1, lat2, lon2)
                                                                if seg_dist < 9999:
                                                                    total_trip_distance += seg_dist
                                                    
                                                        # ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î
                                                        for i, (point, name, dist) in enumerate(zip(points, point_names, point_distances)):
                                                            # üéØ ‡πÅ‡∏™‡∏î‡∏á T{trip}({‡∏•‡∏≥‡∏î‡∏±‡∏ö}) ‡∏ö‡∏ô‡∏´‡∏°‡∏∏‡∏î ‡πÄ‡∏ä‡πà‡∏ô T1(1), T1(2)
                                                            trip_label = f'<div style="background-color:{trip_color};color:#fff;border-radius:12px;min-width:50px;height:24px;text-align:center;line-height:24px;font-weight:bold;font-size:10px;border:2px solid #000;box-shadow:2px 2px 6px rgba(0,0,0,0.5);padding:0 4px;">T{trip_id}({i+1})</div>'
                                                        
                                                            popup_html = f"""
                                                            <div style="font-family:Arial;min-width:200px;">
                                                                <h4 style="margin:0;color:{trip_color};">üöö Trip {trip_id}</h4>
                                                                <hr style="margin:5px 0;">
                                                                <b>‡∏•‡∏≥‡∏î‡∏±‡∏ö:</b> {i+1}/{len(points)}<br>
                                                                <b>‡∏™‡∏≤‡∏Ç‡∏≤:</b> {name}<br>
                                                                <b>‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å DC:</b> {dist:.1f} km<br>
                                                                <b>‡∏£‡∏ñ:</b> {truck_info}<br>
                                                                <hr style="margin:5px 0;">
                                                                <b>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏¥‡∏õ:</b> {total_trip_distance:.1f} km<br>
                                                                <b>üìç ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î:</b> {len(points)} ‡∏™‡∏≤‡∏Ç‡∏≤
                                                            </div>
                                                            """
                                                        
                                                            folium.Marker(
                                                                location=point,
                                                                popup=folium.Popup(popup_html, max_width=300),
                                                                tooltip=f"Trip {trip_id} - {i+1}. {name} ({dist:.1f}km)",
                                                                icon=folium.DivIcon(html=trip_label)
                                                            ).add_to(fg)
                                                    
                                                        # ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á DC ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤ ‚Üí DC (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î)
                                                        if show_route and len(points) >= 1:
                                                            # ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å OSRM
                                                            folium.PolyLine(
                                                                locations=real_route_coords,
                                                                weight=4,
                                                                color=trip_color,
                                                                opacity=0.8,
                                                                popup=f"Trip {trip_id}: {total_trip_distance:.1f} km (‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á)",
                                                                tooltip=f"üõ£Ô∏è Trip {trip_id} - ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á {total_trip_distance:.1f} km"
                                                            ).add_to(fg)
                                                    
                                                        fg.add_to(m)
                                                
                                                    # ‡πÄ‡∏û‡∏¥‡πà‡∏° Layer Control ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ
                                                    folium.LayerControl(collapsed=False).add_to(m)
                                            
                                                # ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                                                folium_static(m, width=1200, height=700)

                                                # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Map Cache
                                                st.session_state['_map_cache_key'] = map_cache_key
                                                st.session_state['_map_html'] = m._repr_html_()

                                            # ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å cache ‡πÄ‡∏°‡∏∑‡πà‡∏≠ cached
                                            if _map_is_cached and '_map_html' in st.session_state:
                                                import streamlit.components.v1 as _cmp
                                                _cmp.html(st.session_state['_map_html'], height=720, scrolling=False)
                                            
                                            # ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                            st.markdown("#### üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏£‡∏¥‡∏õ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏Å‡∏•‚Üí‡πÉ‡∏Å‡∏•‡πâ)")
                                            
                                            # ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                            trip_details = []
                                            for trip_id in sorted_trip_ids:
                                                trip_data = valid_coords[valid_coords['Trip'] == trip_id].copy()
                                                if len(trip_data) == 0:
                                                    continue
                                                
                                                # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å DC (‡πÑ‡∏Å‡∏• ‚Üí ‡πÉ‡∏Å‡∏•‡πâ)
                                                trip_data = trip_data.sort_values('_distance_from_dc', ascending=False).reset_index(drop=True)
                                                
                                                # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏à‡∏≤‡∏Å summary
                                                truck_info = summary[summary['Trip'] == trip_id]['Truck'].iloc[0] if trip_id in summary['Trip'].values else 'N/A'
                                                truck_type = truck_info.split()[0] if truck_info else 'N/A'
                                                
                                                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°
                                                total_weight = trip_data['Weight'].sum()
                                                total_cube = trip_data['Cube'].sum()
                                                
                                                # ‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å DC
                                                max_dist_from_dc = trip_data['_distance_from_dc'].max()
                                                
                                                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (DC ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤1 ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤2 ‚Üí ... ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢) - ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏±‡∏ö DC
                                                points = []
                                                for _, row in trip_data.iterrows():
                                                    if row['_lat'] > 0 and row['_lon'] > 0:
                                                        points.append([row['_lat'], row['_lon']])
                                                
                                                route_distance = 0  # DC ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤1 ‚Üí ... ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                                                inter_branch_distance = 0  # ‡∏™‡∏≤‡∏Ç‡∏≤ ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° DC)
                                                
                                                if len(points) > 0:
                                                    # DC ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å (‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î)
                                                    route_distance += haversine_distance(DC_LAT, DC_LON, points[0][0], points[0][1])
                                                    
                                                    # ‡∏™‡∏≤‡∏Ç‡∏≤ ‚Üí ‡∏™‡∏≤‡∏Ç‡∏≤
                                                    for j in range(len(points) - 1):
                                                        seg_dist = haversine_distance(points[j][0], points[j][1], points[j+1][0], points[j+1][1])
                                                        route_distance += seg_dist
                                                        inter_branch_distance += seg_dist
                                                
                                                trip_details.append({
                                                    '‡∏ó‡∏£‡∏¥‡∏õ': trip_id,
                                                    '‡∏£‡∏ñ': truck_type,
                                                    '‡∏™‡∏≤‡∏Ç‡∏≤': len(trip_data),
                                                    '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)': f"{total_weight:,.0f}",
                                                    '‡∏Ñ‡∏¥‡∏ß (m¬≥)': f"{total_cube:.1f}",
                                                    '‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å DC': f"{max_dist_from_dc:.1f} km",
                                                    '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°': f"{route_distance:.1f} km",
                                                    '‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤': f"{inter_branch_distance:.1f} km"
                                                })
                                            
                                            # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å trip ‡πÅ‡∏•‡πâ‡∏ß)
                                            if trip_details:
                                                trip_df = pd.DataFrame(trip_details)
                                                st.dataframe(
                                                    trip_df,
                                                    width="stretch",
                                                    hide_index=True,
                                                    column_config={
                                                        '‡∏ó‡∏£‡∏¥‡∏õ': st.column_config.NumberColumn('üöö ‡∏ó‡∏£‡∏¥‡∏õ', width='small'),
                                                        '‡∏£‡∏ñ': st.column_config.TextColumn('üöõ ‡∏£‡∏ñ', width='small'),
                                                        '‡∏™‡∏≤‡∏Ç‡∏≤': st.column_config.NumberColumn('üìç ‡∏™‡∏≤‡∏Ç‡∏≤', width='small'),
                                                        '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)': st.column_config.TextColumn('‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', width='small'),
                                                        '‡∏Ñ‡∏¥‡∏ß (m¬≥)': st.column_config.TextColumn('üì¶ ‡∏Ñ‡∏¥‡∏ß', width='small'),
                                                        '‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å DC': st.column_config.TextColumn('üéØ ‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î', width='small'),
                                                        '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°': st.column_config.TextColumn('üìè ‡∏£‡∏ß‡∏° (DC‚Üí‡∏™‡∏≤‡∏Ç‡∏≤)', width='medium'),
                                                        '‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤': st.column_config.TextColumn('‚ÜîÔ∏è ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤', width='small')
                                                    }
                                                )
                                                
                                                # ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°
                                                total_route = sum(float(d['‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°'].replace(' km', '').replace(',', '')) for d in trip_details)
                                                total_inter = sum(float(d['‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤'].replace(' km', '').replace(',', '')) for d in trip_details)
                                                st.caption(f"üìä **‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:** {len(trip_details)} ‡∏ó‡∏£‡∏¥‡∏õ | ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°: {total_route:,.1f} km | ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤: {total_inter:,.1f} km")
                                            
                                            st.caption(f"üìç ‡πÅ‡∏™‡∏î‡∏á {len(valid_coords)} ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô {len(sorted_trip_ids)} ‡∏ó‡∏£‡∏¥‡∏õ | üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ | ‡πÉ‡∏ä‡πâ Layer Control ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏¥‡∏õ")
                                    else:
                                        st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå _lat ‡πÅ‡∏•‡∏∞ _lon)")
                        
                # ==========================================
                # ‡πÅ‡∏ó‡πá‡∏ö 2: ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)
                # ==========================================
                with tab2:
                    df_region = df.copy()
                    
                    # ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ
                    branch_info = model_data.get('branch_info', {})
                    trip_pairs = model_data.get('trip_pairs', set())
                    
                    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏Ñ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
                    region_groups = {
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ô': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≠‡∏Å': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•': ['‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô': ['‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤'],
                        '‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á-‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á': ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ'],
                        '‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å': ['‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ'],
                        '‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': ['‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ï‡∏£‡∏≤‡∏î', '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å', '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß', '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤'],
                        '‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô-‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': ['‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡πÄ‡∏•‡∏¢'],
                        '‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô-‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': ['‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥', '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î'],
                        '‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô-‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÉ‡∏ï‡πâ': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä', '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ'],
                        '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠-‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô': ['‡∏ô‡πà‡∏≤‡∏ô', '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', '‡∏•‡∏≥‡∏û‡∏π‡∏ô', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡πÅ‡∏û‡∏£‡πà', '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô'],
                        '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠-‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á': ['‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', '‡∏ï‡∏≤‡∏Å', '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå'],
                        '‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ-‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô': ['‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏ï‡∏£‡∏±‡∏á', '‡∏û‡∏±‡∏á‡∏á‡∏≤', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', '‡∏™‡∏ï‡∏π‡∏•'],
                        '‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ-‡πÉ‡∏ï‡πâ‡∏ù‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢': ['‡∏ä‡∏∏‡∏°‡∏û‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™']
                    }
                    
                    def get_region(province):
                        if pd.isna(province) or not province or str(province).strip() in ['', 'nan', 'UNKNOWN']:
                            return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                        
                        # üö® Override: ‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤ ‚Üí ‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•)
                        if '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤' in str(province):
                            return '‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'
                        
                        for region, provinces in region_groups.items():
                            if any(p in str(province) for p in provinces):
                                return region
                        return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
                    
                    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏†‡∏≤‡∏Ñ - ‡∏î‡∏∂‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å Master ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
                    # ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (Province) ‡πÅ‡∏•‡∏∞‡πÑ‡∏ó‡∏¢ (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                    province_col = None
                    if 'Province' in df_region.columns:
                        province_col = 'Province'
                    elif '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in df_region.columns:
                        province_col = '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
                    
                    # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏•‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô NaN ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å MASTER_DATA
                    # Vectorized: ‡∏™‡∏£‡πâ‡∏≤‡∏á province_map ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ó‡∏ô iterrows
                    _prov_map = {}
                    if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns and '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' in MASTER_DATA.columns:
                        _pm = MASTER_DATA[['Plan Code', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î']].dropna(subset=['Plan Code'])
                        _prov_map = dict(zip(_pm['Plan Code'].astype(str).str.strip(), _pm['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'].fillna('')))
                    
                    if not province_col or df_region[province_col].isna().all():
                        df_region['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] = df_region['Code'].astype(str).map(_prov_map).fillna('UNKNOWN')
                        province_col = '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
                    elif province_col and df_region[province_col].isna().any():
                        # ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô NaN
                        _missing = df_region[province_col].isna()
                        df_region.loc[_missing, province_col] = df_region.loc[_missing, 'Code'].astype(str).map(_prov_map).fillna('UNKNOWN')
                    
                    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß
                    if not province_col or province_col not in df_region.columns:
                        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
                        return
                    
                    df_region['Region'] = df_region[province_col].apply(get_region)
                    
                    # ‡∏´‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÉ‡∏ä‡πâ Booking No. ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å)
                    def find_paired_branches(code, code_province, df_data):
                        paired = set()
                        
                        # ‡∏´‡∏≤ Booking No. ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ
                        code_rows = df_data[df_data['Code'] == code]
                        if len(code_rows) == 0:
                            return paired
                        
                        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Booking ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        if 'Booking' not in df_data.columns and 'Trip' not in df_data.columns:
                            return paired
                        
                        booking_col = 'Booking' if 'Booking' in df_data.columns else 'Trip'
                        code_bookings = set(code_rows[booking_col].dropna().astype(str))
                        
                        if not code_bookings:
                            return paired
                        
                        # ‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà Booking ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                        for booking in code_bookings:
                            if booking == 'nan' or not booking.strip():
                                continue
                            
                            same_booking = df_data[df_data[booking_col].astype(str) == booking]
                            for _, other_row in same_booking.iterrows():
                                other_code = other_row['Code']
                                
                                # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: Booking ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô = ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                                if other_code != code:
                                    paired.add(other_code)
                        
                        return paired
                    
                    all_codes_set = set(df_region['Code'].unique())
                    
                    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏ö‡∏ö Union-Find (‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                    # Step 1: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÜ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Master
                    initial_groups = {}
                    for code in all_codes_set:
                        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Master
                        location = {}
                        if not MASTER_DATA.empty and 'Plan Code' in MASTER_DATA.columns:
                            master_row = MASTER_DATA[MASTER_DATA['Plan Code'] == code]
                            if len(master_row) > 0:
                                master_row = master_row.iloc[0]
                                location = {
                                    'subdistrict': master_row.get('‡∏ï‡∏≥‡∏ö‡∏•', ''),
                                    'district': master_row.get('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', ''),
                                    'province': master_row.get('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', 'UNKNOWN'),
                                    'lat': master_row.get('‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0),
                                    'lon': master_row.get('‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î', 0)
                                }
                        
                        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Master ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                        if not location or location.get('province', 'UNKNOWN') == 'UNKNOWN':
                            c_row = df_region[df_region['Code'] == code].iloc[0] if len(df_region[df_region['Code'] == code]) > 0 else None
                            if c_row is not None:
                                location = {
                                    'subdistrict': '',
                                    'district': '',
                                    'province': c_row.get('Province', 'UNKNOWN'),
                                    'lat': 0,
                                    'lon': 0
                                }
                        
                        if location:
                            initial_groups[(code,)] = {code: location}
                    
                    # ‡πÉ‡∏ä‡πâ initial_groups ‡πÅ‡∏ó‡∏ô booking_groups
                    booking_groups = initial_groups
                    
                    # Step 2: ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                    def groups_can_merge(locs1, locs2):
                        """‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ 2 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏° (‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)"""
                        # 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•)
                        subdistricts1 = set(loc.get('subdistrict', '') for loc in locs1.values() if loc.get('subdistrict', ''))
                        subdistricts2 = set(loc.get('subdistrict', '') for loc in locs2.values() if loc.get('subdistrict', ''))
                        if subdistricts1 and subdistricts2 and (subdistricts1 & subdistricts2):
                            return True, '‡∏ï‡∏≥‡∏ö‡∏•'
                        
                        # 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
                        districts1 = {(loc.get('district', ''), loc.get('province', '')) for loc in locs1.values() if loc.get('district', '')}
                        districts2 = {(loc.get('district', ''), loc.get('province', '')) for loc in locs2.values() if loc.get('district', '')}
                        if districts1 and districts2:
                            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
                            for d1, p1 in districts1:
                                for d2, p2 in districts2:
                                    if d1 == d2 and p1 == p2 and p1:
                                        return True, '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠'
                        
                        # 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                        provinces1 = set(loc.get('province', '') for loc in locs1.values() if loc.get('province', ''))
                        provinces2 = set(loc.get('province', '') for loc in locs2.values() if loc.get('province', ''))
                        if provinces1 & provinces2:
                            return True, '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
                        
                        return False, None
                    
                    merged_groups = []
                    used_groups = set()
                    
                    for group1, locs1 in booking_groups.items():
                        if group1 in used_groups:
                            continue
                        
                        merged_codes = set(group1)
                        merged_locs = locs1.copy()
                        used_groups.add(group1)
                        
                        # ‡∏´‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
                        changed = True
                        while changed:
                            changed = False
                            for group2, locs2 in booking_groups.items():
                                if group2 in used_groups:
                                    continue
                                can_merge, level = groups_can_merge(merged_locs, locs2)
                                if can_merge:
                                    merged_codes |= set(group2)
                                    merged_locs.update(locs2)
                                    used_groups.add(group2)
                                    changed = True
                        
                        merged_groups.append({
                            'codes': merged_codes,
                            'locations': merged_locs
                        })
                    
                    # Step 3: ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô groups format
                    groups = []
                    for mg in merged_groups:
                        rep_code = list(mg['codes'])[0]
                        rep_row = df_region[df_region['Code'] == rep_code].iloc[0]
                        # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà UNKNOWN ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô NaN
                        provinces = set(
                            str(loc.get('province', '')).strip() 
                            for loc in mg['locations'].values() 
                            if loc.get('province') and str(loc.get('province', '')).strip() not in ['UNKNOWN', 'nan', '']
                        )
                        
                        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏•‡∏¢ ‡πÉ‡∏™‡πà "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
                        province_str = ', '.join(sorted(provinces)) if provinces else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                        
                        groups.append({
                            'codes': mg['codes'],
                            'region': str(rep_row.get('Region') or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'),
                            'province': province_str
                        })
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                    st.markdown("---")
                    st.markdown("### üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°")
                    
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        st.metric("üìç ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤", df_region['Code'].nunique())
                    with col2:
                        st.metric("üóÇÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°", len(groups))
                    with col3:
                        regions_count = df_region['Region'].nunique()
                        st.metric("üó∫Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏Ñ", regions_count)
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ
                    st.markdown("---")
                    st.markdown("### üó∫Ô∏è ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ")
                    
                    region_summary = df_region.groupby('Region').agg({
                        'Code': 'nunique',
                        'Weight': 'sum',
                        'Cube': 'sum'
                    }).reset_index()
                    region_summary.columns = ['‡∏†‡∏≤‡∏Ñ', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°', '‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°']
                    st.dataframe(region_summary, width="stretch")
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ
                    for region in sorted(df_region['Region'].unique()):
                        region_data = df_region[df_region['Region'] == region]
                        with st.expander(f"üìç {region} ({region_data['Code'].nunique()} ‡∏™‡∏≤‡∏Ç‡∏≤)"):
                            display_cols = ['Code', 'Name', 'Province', 'Weight', 'Cube']
                            display_cols = [c for c in display_cols if c in region_data.columns]
                            
                            region_display = region_data[display_cols].drop_duplicates('Code')
                            col_names = {'Code': '‡∏£‡∏´‡∏±‡∏™', 'Name': '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤', 'Province': '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', 'Weight': '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', 'Cube': '‡∏Ñ‡∏¥‡∏ß'}
                            region_display.columns = [col_names.get(c, c) for c in display_cols]
                            st.dataframe(region_display, width="stretch")
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
                    st.markdown("---")
                    st.markdown("### üîó ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)")
                    
                    paired_groups = [g for g in groups if len(g['codes']) > 1]
                    if paired_groups:
                        for i, group in enumerate(paired_groups, 1):
                            codes_list = list(group['codes'])
                            names = []
                            for c in codes_list:
                                name_row = df_region[df_region['Code'] == c]
                                if len(name_row) > 0 and 'Name' in name_row.columns:
                                    _nm = name_row['Name'].iloc[0]
                                    _nm_str = str(_nm) if (_nm is not None and not (isinstance(_nm, float) and pd.isna(_nm))) else ''
                                    names.append(f"{c}" + (f" ({_nm_str})" if _nm_str else ''))
                                else:
                                    names.append(str(c))
                            
                            region_label = group['region'] or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                            st.write(f"**‡∏Å‡∏•‡∏∏‡πà‡∏° {i}** ‚Äî {region_label}: {', '.join(names)}")
                    else:
                        st.info("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ")
                    
                    # ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    st.markdown("---")
                    output_region = io.BytesIO()
                    with pd.ExcelWriter(output_region, engine='xlsxwriter') as writer:
                        df_region.to_excel(writer, sheet_name='‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', index=False)
                        region_summary.to_excel(writer, sheet_name='‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ', index=False)
                    
                    st.download_button(
                        label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° (Excel)",
                        data=output_region.getvalue(),
                        file_name=f"‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        type="primary",
                        width="stretch"
                    )

if __name__ == "__main__":
    try:
        main()
    finally:
        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°
        if USE_CACHE:
            save_distance_cache(DISTANCE_CACHE)
            save_route_cache(ROUTE_CACHE_DATA)
            safe_print(f"üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache: {len(DISTANCE_CACHE)} ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á, {len(ROUTE_CACHE_DATA)} ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á")

