import streamlit as st
import pandas as pd
import io

# ==========================================
# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (UI Setup)
# ==========================================
st.set_page_config(page_title="Logistics Planner", layout="wide", page_icon="üöõ")

st.title("üöõ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏£‡∏ñ (Logistics Dashboard)")
st.markdown("‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ (Booking) ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏ñ (Optimization Plan)")

# ==========================================
# 2. ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Mock Data) - ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏£‡∏¥‡∏á
# ==========================================

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Input Data) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤
input_data = [
    ["PTGLG", "B001-250224863", "4 ‡∏•‡πâ‡∏≠ ‡∏à‡∏±‡∏°‡πÇ‡∏ö‡πâ ‡∏ï‡∏π‡πâ‡∏ó‡∏∂‡∏ö", "67-0927", "‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò", "PTDC", "PTG Distribution Center", "6,470", 771],
    ["PTGLG", "B001-250224863", "4 ‡∏•‡πâ‡∏≠ ‡∏à‡∏±‡∏°‡πÇ‡∏ö‡πâ ‡∏ï‡∏π‡πâ‡∏ó‡∏∂‡∏ö", "67-0927", "‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò", "CU154", "GFA-‡∏à‡∏±‡∏î‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á Moto GP", "", ""],
    # ... (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
]
df_input = pd.DataFrame(input_data, columns=[
    "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤", "Booking No", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ", "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ", "‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö", "‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏™‡∏≤‡∏Ç‡∏≤", "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤", "‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á", "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á"
])

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Output Data) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤
output_data = [
    ["BKK", "4 ‡∏•‡πâ‡∏≠ ‡∏ï‡∏π‡πâ‡∏ó‡∏∂‡∏ö", 200, 0.5, "Cube 10%"],
    ["Central", "6 ‡∏•‡πâ‡∏≠ ‡∏ï‡∏π‡πâ‡∏ó‡∏∂‡∏ö", 1500, 3.0, "Weight 27%"],
    ["NE_Deep", "6 ‡∏•‡πâ‡∏≠ ‡∏ï‡∏π‡πâ‡∏ó‡∏∂‡∏ö", 2500, 5.0, "Weight 45%"],
    ["NE_Gate", "6 ‡∏•‡πâ‡∏≠ ‡∏ï‡∏π‡πâ‡∏ó‡∏∂‡∏ö", 1200, 3.5, "Weight 22%"],
    ["Other", "4 ‡∏•‡πâ‡∏≠ ‡∏à‡∏±‡∏°‡πÇ‡∏ö‡πâ ‡∏ï‡∏π‡πâ‡∏ó‡∏∂‡∏ö", 1800, 4.0, "Cube 57%"]
]
df_output = pd.DataFrame(output_data, columns=[
    "Zone", "Truck_Type", "Total_Weight", "Total_Cube", "Utilization"
])

# ==========================================
# 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Display Section)
# ==========================================

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Tab ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤
tab1, tab2 = st.tabs(["üìÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (Raw Data)", "‚úÖ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏ñ (Optimization Result)"])

with tab1:
    st.subheader("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (Input)")
    st.dataframe(df_input, use_container_width=True)
    st.info(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {len(df_input)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")

with tab2:
    st.subheader("‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà (Output)")
    
    # ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏™‡∏µ‡∏ï‡∏≤‡∏° Utilization (‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°)
    def highlight_util(val):
        color = 'red' if '9' in str(val) else 'green' # ‡∏ñ‡πâ‡∏≤ 90%+ ‡πÉ‡∏´‡πâ‡πÅ‡∏î‡∏á
        return f'color: {color}'

    st.dataframe(df_output.style.applymap(highlight_util, subset=['Utilization']), use_container_width=True)
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ Metric
    c1, c2, c3 = st.columns(3)
    c1.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á", f"{len(df_output)} ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß")
    c2.metric("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°", f"{df_output['Total_Weight'].sum():,.0f} kg")
    c3.metric("‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏° (CBM)", f"{df_output['Total_Cube'].sum():,.1f}")

    # ==========================================
    # 4. ‡∏õ‡∏∏‡πà‡∏° Export Excel (‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô)
    # ==========================================
    st.divider()
    st.subheader("üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô")
    
    # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå Excel ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
    buffer = io.BytesIO()
    with pd.ExcelWriter(buffer, engine='xlsxwriter') as writer:
        df_output.to_excel(writer, sheet_name='Plan_Result', index=False)
        df_input.to_excel(writer, sheet_name='Raw_Data', index=False)
    
    # ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    st.download_button(
        label="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (Result.xlsx)",
        data=buffer.getvalue(),
        file_name="Logistics_Plan_Result.xlsx",
        mime="application/vnd.ms-excel",
        type="primary" # ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏î‡πà‡∏ô
    )
    